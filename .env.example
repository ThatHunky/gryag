# ═══════════════════════════════════════════════════════════════════════════════
# Required Configuration
# ═══════════════════════════════════════════════════════════════════════════════

TELEGRAM_TOKEN=                    # REQUIRED: Get from @BotFather on Telegram
GEMINI_API_KEY=                    # REQUIRED: Primary Gemini API key
GEMINI_API_KEYS=                   # Optional: Comma-separated backup keys (used with FREE_TIER_MODE)
FREE_TIER_MODE=false               # Enable rotation across GEMINI_API_KEYS (set to true for free-tier pooling)
GEMINI_QUOTA_BLOCK_SECONDS=86400   # Seconds to sideline a key after quota exhaustion (24h default)

# ═══════════════════════════════════════════════════════════════════════════════
# Database Configuration
# ═══════════════════════════════════════════════════════════════════════════════

# PostgreSQL connection string (replaces old SQLite DB_PATH)
DATABASE_URL=postgresql://gryag:gryag@localhost:5433/gryag

# ═══════════════════════════════════════════════════════════════════════════════
# Gemini Model Configuration
# ═══════════════════════════════════════════════════════════════════════════════

GEMINI_MODEL=gemini-2.5-flash
GEMINI_EMBED_MODEL=models/text-embedding-004
GEMINI_ENABLE_THINKING=true        # Extended thinking tokens for complex reasoning
SHOW_THINKING_TO_USERS=true        # Display thinking process to users
THINKING_BUDGET_TOKENS=1024        # Maximum thinking tokens (64-4096)

# ═══════════════════════════════════════════════════════════════════════════════
# Context Settings
# ═══════════════════════════════════════════════════════════════════════════════

# MAX_MESSAGES: Maximum number of messages to retrieve for context (default: 40)
# WARNING: Higher values can cause token overflow errors!
# Recommended: 40-60 for normal use, 100-150 for long conversations
MAX_MESSAGES=40

CONTEXT_SUMMARY_THRESHOLD=30       # Summarize context if message count exceeds this
CONTEXT_TOKEN_BUDGET=8000          # Maximum tokens for context (1000-30000)

# System context block (monospace history injected into system prompt)
ENABLE_SYSTEM_CONTEXT_BLOCK=false
SYSTEM_CONTEXT_BLOCK_MAX_MESSAGES=60
SYSTEM_CONTEXT_BLOCK_INCLUDE_META=true
SYSTEM_CONTEXT_BLOCK_THREAD_ONLY=true
SYSTEM_CONTEXT_BLOCK_MEDIA_SCOPE=trigger_and_reply

# ═══════════════════════════════════════════════════════════════════════════════
# Multi-Level Context (Phase 3)
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_MULTI_LEVEL_CONTEXT=true   # Use layered context (immediate, recent, relevant, background, episodic)
IMMEDIATE_CONTEXT_SIZE=5           # Recent messages in active conversation (1-20)
RECENT_CONTEXT_SIZE=30             # Messages from recent conversation window (5-100)
RELEVANT_CONTEXT_SIZE=10           # Relevant messages from search (1-50)

# ═══════════════════════════════════════════════════════════════════════════════
# Hybrid Search Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_HYBRID_SEARCH=true          # Semantic + keyword + temporal search
ENABLE_KEYWORD_SEARCH=true         # Enable keyword matching
ENABLE_TEMPORAL_BOOSTING=true      # Boost recent messages
TEMPORAL_HALF_LIFE_DAYS=7          # Recency decay (1-90 days)
MAX_SEARCH_CANDIDATES=500          # Max candidates to evaluate (50-2000)
SEMANTIC_WEIGHT=0.5                # Weight for semantic similarity (0.0-1.0)
KEYWORD_WEIGHT=0.3                 # Weight for keyword matching (0.0-1.0)
TEMPORAL_WEIGHT=0.2                # Weight for recency (0.0-1.0)
# Note: semantic_weight + keyword_weight + temporal_weight must sum to 1.0

# ═══════════════════════════════════════════════════════════════════════════════
# Episodic Memory Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_EPISODIC_MEMORY=true        # Store and retrieve memorable conversation events
EPISODE_MIN_IMPORTANCE=0.6         # Minimum importance to create episode (0.0-1.0)
EPISODE_MIN_MESSAGES=5             # Minimum messages per episode (3-50)
AUTO_CREATE_EPISODES=true          # Automatically create episodes from conversations
EPISODE_DETECTION_INTERVAL=300     # Background check interval in seconds (60-3600)

# Episode Boundary Detection
EPISODE_BOUNDARY_THRESHOLD=0.6     # Combined score threshold for boundary (0.0-1.0)
EPISODE_SHORT_GAP_SECONDS=120      # Short gap threshold (30-600)
EPISODE_MEDIUM_GAP_SECONDS=900     # Medium gap threshold (300-3600)
EPISODE_LONG_GAP_SECONDS=3600      # Long gap threshold (600-86400)
EPISODE_LOW_SIMILARITY_THRESHOLD=0.3
EPISODE_MEDIUM_SIMILARITY_THRESHOLD=0.5
EPISODE_HIGH_SIMILARITY_THRESHOLD=0.7

# Episode Monitoring
EPISODE_WINDOW_TIMEOUT=1800        # Seconds before window closes (300-7200)
EPISODE_WINDOW_MAX_MESSAGES=50     # Max messages per window (10-200)
EPISODE_MONITOR_INTERVAL=300       # Background check interval (60-3600)

# ═══════════════════════════════════════════════════════════════════════════════
# Command and Feature Throttling System
# ═══════════════════════════════════════════════════════════════════════════════

# Command Throttling - Limits ALL bot commands (prevents command spam)
ENABLE_COMMAND_THROTTLING=true    # Enable command cooldown (recommended)
COMMAND_COOLDOWN_SECONDS=300       # Cooldown between commands (60-3600 seconds)

# Feature-Specific Throttling - Per-feature rate limits
ENABLE_FEATURE_THROTTLING=true    # Enable per-feature throttling
ENABLE_ADAPTIVE_THROTTLING=true   # Enable reputation-based limit adjustments

# Per-feature hourly limits (admins bypass all limits)
WEATHER_LIMIT_PER_HOUR=10         # Weather API calls per hour (1-100)
CURRENCY_LIMIT_PER_HOUR=20        # Currency conversions per hour (1-100)
WEB_SEARCH_LIMIT_PER_HOUR=5       # Web searches per hour (1-50)
MEMORY_LIMIT_PER_HOUR=30          # Memory operations per hour (1-100)
POLL_LIMIT_PER_DAY=5              # Poll creations per day (1-20)

# ═══════════════════════════════════════════════════════════════════════════════
# Message Processing Lock
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_PROCESSING_LOCK=true       # Prevent multiple simultaneous messages per user
PROCESSING_LOCK_USE_REDIS=true    # Use Redis for distributed locks (recommended)
PROCESSING_LOCK_TTL_SECONDS=300   # Lock timeout (30-3600 seconds)

# ═══════════════════════════════════════════════════════════════════════════════
# Redis Configuration
# ═══════════════════════════════════════════════════════════════════════════════

USE_REDIS=false
REDIS_URL=redis://localhost:6379/0

# ═══════════════════════════════════════════════════════════════════════════════
# Admin & Retention Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ADMIN_USER_IDS=                    # Comma-separated user IDs (e.g., "123456789,987654321")
RETENTION_DAYS=7                   # Message retention period (1+ days)
RETENTION_ENABLED=true             # Enable automatic retention pruning
RETENTION_PRUNE_INTERVAL_SECONDS=172800  # Pruning interval (60+ seconds, default: 2 days)

# ═══════════════════════════════════════════════════════════════════════════════
# Media Handling Configuration
# ═══════════════════════════════════════════════════════════════════════════════

# Maximum media items in context history
GEMINI_MAX_MEDIA_ITEMS=28         # Total media items (1-100)
GEMINI_MAX_MEDIA_ITEMS_CURRENT=8  # Media from current message (1-50)
GEMINI_MAX_MEDIA_ITEMS_HISTORICAL=5  # Historical media (0-50, 0=disable)
GEMINI_MAX_VIDEO_ITEMS=1          # Maximum videos/animations (0-10, 0=exclude all)

# ═══════════════════════════════════════════════════════════════════════════════
# External API Configuration
# ═══════════════════════════════════════════════════════════════════════════════

# Web Search
ENABLE_WEB_SEARCH=false            # Enable DuckDuckGo web search (no API key needed)

# Weather API (OpenWeatherMap)
OPENWEATHER_API_KEY=               # Optional: OpenWeatherMap API key
OPENWEATHER_BASE_URL=https://api.openweathermap.org/data/2.5

# Currency API (ExchangeRate-API)
EXCHANGE_RATE_API_KEY=             # Optional: ExchangeRate-API key
EXCHANGE_RATE_BASE_URL=https://v6.exchangerate-api.com

# ═══════════════════════════════════════════════════════════════════════════════
# Image Generation Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_IMAGE_GENERATION=false      # Enable Gemini 2.5 Flash Image generation
IMAGE_GENERATION_API_KEY=          # Optional: Separate API key (defaults to GEMINI_API_KEY)
IMAGE_GENERATION_DAILY_LIMIT=3     # Images per user per day (1-10, admins unlimited)

# ═══════════════════════════════════════════════════════════════════════════════
# Donation Scheduler Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_DONATION_SCHEDULER=true    # Send periodic donation reminders
DONATION_IGNORED_CHAT_IDS=         # Comma-separated chat IDs to exclude

# ═══════════════════════════════════════════════════════════════════════════════
# User Profiling Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_USER_PROFILING=true         # Extract and store user facts
USER_PROFILE_RETENTION_DAYS=365    # Profile retention period (1+ days)
MAX_FACTS_PER_USER=100             # Maximum facts per user (1+)
FACT_CONFIDENCE_THRESHOLD=0.7      # Minimum confidence for facts (0.0-1.0)
FACT_EXTRACTION_ENABLED=true       # Enable fact extraction
MIN_MESSAGES_FOR_EXTRACTION=5      # Minimum messages before extraction (1+)

# Personal-Only Memory Policy
ENABLE_PERSONAL_ONLY_MEMORY=true   # Store only user-centric facts
PERSONAL_MEMORY_ALLOWED_TYPES=personal,preference,skill,trait  # Excludes 'opinion'

# Profile Summarization
ENABLE_PROFILE_SUMMARIZATION=false # Background profile summarization
PROFILE_SUMMARIZATION_HOUR=3       # Hour to run (0-23)
PROFILE_SUMMARIZATION_BATCH_SIZE=30  # Batch size (10-100)
MAX_PROFILES_PER_DAY=50            # Max profiles per day (1+)
PROFILE_SUMMARIZATION_INTERVAL_HOURS=24  # Interval between runs (1+ hours)

# Fact Extraction
ENABLE_GEMINI_FACT_EXTRACTION=true  # Use Gemini API for complex fact extraction

# ═══════════════════════════════════════════════════════════════════════════════
# Chat Public Memory Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_CHAT_MEMORY=true            # Enable group-level memory
ENABLE_CHAT_FACT_EXTRACTION=true   # Extract chat-wide facts
CHAT_FACT_MIN_CONFIDENCE=0.6       # Minimum confidence (0.0-1.0)
CHAT_FACT_EXTRACTION_METHOD=hybrid # pattern, statistical, llm, hybrid
CHAT_FACTS_IN_CONTEXT=true         # Include chat facts in context
MAX_CHAT_FACTS_IN_CONTEXT=8        # Max facts in context (1-20)
CHAT_CONTEXT_TOKEN_BUDGET=480      # Token budget for chat facts (100-2000)
ENABLE_CHAT_FACT_DEDUPLICATION=true
CHAT_FACT_SIMILARITY_THRESHOLD=0.85
CHAT_FACT_TEMPORAL_HALF_LIFE_DAYS=30

# ═══════════════════════════════════════════════════════════════════════════════
# Continuous Learning System
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_CONTINUOUS_MONITORING=true  # Intelligent continuous monitoring
ENABLE_MESSAGE_FILTERING=false    # Filter low-value messages (Phase 3)
ENABLE_ASYNC_PROCESSING=false     # Async fact extraction (Phase 3)

# Conversation Window Settings
CONVERSATION_WINDOW_SIZE=8         # Messages per window (3-20)
CONVERSATION_WINDOW_TIMEOUT=180    # Seconds before close (60-600)
MAX_CONCURRENT_WINDOWS=100         # Max windows (10-500)

# Event Queue Settings
MONITORING_WORKERS=3               # Async workers (1-10)
MAX_QUEUE_SIZE=1000                # Max queued events (100-10000)
ENABLE_CIRCUIT_BREAKER=true        # Fault tolerance
CIRCUIT_BREAKER_THRESHOLD=5        # Failures before open (3-20)
CIRCUIT_BREAKER_TIMEOUT=60         # Seconds before retry (30-300)

# Proactive Response Settings
ENABLE_PROACTIVE_RESPONSES=false   # Proactively join conversations
PROACTIVE_CONFIDENCE_THRESHOLD=0.75 # Minimum confidence (0.5-1.0)
PROACTIVE_COOLDOWN_SECONDS=300     # Min seconds between responses (60-1800)

# System Health Monitoring
ENABLE_HEALTH_METRICS=true         # Track system health
HEALTH_CHECK_INTERVAL=300          # Seconds between checks (60-3600)

# ═══════════════════════════════════════════════════════════════════════════════
# Fact Graphs & Temporal Awareness
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_FACT_GRAPHS=true            # Enable fact relationship graphs
AUTO_INFER_RELATIONSHIPS=true      # Automatically infer relationships
MAX_GRAPH_HOPS=2                   # Max relationship hops (1-5)
SEMANTIC_SIMILARITY_THRESHOLD=0.7   # Similarity threshold (0.0-1.0)
FACT_RELATIONSHIP_MIN_WEIGHT=0.3    # Minimum relationship weight (0.0-1.0)

# Temporal Awareness
ENABLE_FACT_VERSIONING=true        # Track fact changes over time
TRACK_FACT_CHANGES=true            # Log fact modifications
RECENCY_WEIGHT=0.3                  # Recency importance (0.0-1.0)

# Adaptive Memory
ENABLE_ADAPTIVE_RETENTION=true     # Adjust retention based on importance
ENABLE_MEMORY_CONSOLIDATION=true   # Consolidate similar memories
CONSOLIDATION_INTERVAL_HOURS=24    # Consolidation interval (1-168 hours)
MIN_RETENTION_DAYS=30              # Minimum retention (7-90 days)
MAX_RETENTION_DAYS=365             # Maximum retention (30-3650 days)
BASE_RETENTION_DAYS=90             # Base retention (30-365 days)

# ═══════════════════════════════════════════════════════════════════════════════
# Token Optimization
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_TOKEN_TRACKING=true         # Track token usage
ENABLE_EMBEDDING_QUANTIZATION=false  # 8-bit quantization (reduces storage)
ENABLE_RESPONSE_COMPRESSION=true   # Compress long responses
ENABLE_SEMANTIC_DEDUPLICATION=true # Collapse similar search results
DEDUPLICATION_SIMILARITY_THRESHOLD=0.85  # Deduplication threshold (0.7-0.99)
MAX_TOOL_RESPONSE_TOKENS=300       # Max tokens per tool response (100-1000)

# Compact Conversation Format
ENABLE_COMPACT_CONVERSATION_FORMAT=false  # Use plain text instead of JSON (70-80% token savings)
COMPACT_FORMAT_MAX_HISTORY=50      # Max history in compact format (10-100)
COMPACT_FORMAT_USE_FULL_IDS=true  # Use full user IDs vs last 6 digits

# Reply Chain Context
INCLUDE_REPLY_EXCERPT=true         # Include replied message content
REPLY_EXCERPT_MAX_CHARS=200        # Max characters for excerpts (50-500)

# ═══════════════════════════════════════════════════════════════════════════════
# Bot Self-Learning Configuration
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_BOT_SELF_LEARNING=true     # Bot learns from interactions
BOT_LEARNING_CONFIDENCE_THRESHOLD=0.5  # Confidence threshold (0.0-1.0)
BOT_LEARNING_MIN_EVIDENCE=3       # Minimum evidence (1-20)
ENABLE_BOT_PERSONA_ADAPTATION=true # Adapt persona based on feedback
ENABLE_TEMPORAL_DECAY=true         # Outdated facts lose confidence
ENABLE_SEMANTIC_DEDUP=true         # Use embeddings for fact deduplication
ENABLE_GEMINI_INSIGHTS=true        # Self-reflection via Gemini
BOT_INSIGHT_INTERVAL_HOURS=168    # Insight interval (24-720 hours)
BOT_REACTION_TIMEOUT_SECONDS=300   # Wait time for user reaction (30-3600)

# Memory Tool Configuration
ENABLE_TOOL_BASED_MEMORY=true      # Enable memory tool calling
MEMORY_TOOL_ASYNC=true             # Run memory ops in background
MEMORY_TOOL_TIMEOUT_MS=200         # Tool timeout (50-1000 ms)
MEMORY_TOOL_QUEUE_SIZE=1000        # Queue size (100-10000)
ENABLE_AUTOMATED_MEMORY_FALLBACK=true

# ═══════════════════════════════════════════════════════════════════════════════
# Universal Bot Configuration
# ═══════════════════════════════════════════════════════════════════════════════

# Bot Identity
BOT_NAME=gryag                     # Display name
BOT_USERNAME=                      # Telegram username (auto-detected if empty)
BOT_TRIGGER_PATTERNS=              # Comma-separated trigger words (empty = use persona)
COMMAND_PREFIX=gryag               # Prefix for admin commands

# Personality Configuration
PERSONA_CONFIG=                    # Path to persona YAML (empty = use default)
RESPONSE_TEMPLATES=                # Path to templates JSON (empty = use default)
BOT_LANGUAGE=uk                    # Primary language code
ENABLE_PROFANITY=true              # Allow strong language

# Chat Management
BOT_BEHAVIOR_MODE=global           # global, whitelist, blacklist
DEFAULT_MUTE_DURATION_MINUTES=30   # Default mute time (1-10080 minutes)
ALLOWED_CHAT_IDS=                  # Comma-separated for whitelist mode
BLOCKED_CHAT_IDS=                  # Comma-separated for blacklist mode
ADMIN_CHAT_IDS=                    # Comma-separated where admin commands work
IGNORE_PRIVATE_CHATS=false         # Only operate in groups

# Feature Toggles
ENABLE_CHAT_FILTERING=false        # Enable chat restrictions
ENABLE_CUSTOM_COMMANDS=false       # Use configurable command names
ENABLE_PERSONA_TEMPLATES=true      # Use template-based responses

# ═══════════════════════════════════════════════════════════════════════════════
# Performance & Caching
# ═══════════════════════════════════════════════════════════════════════════════

ENABLE_RESULT_CACHING=true         # Cache search results
CACHE_TTL_SECONDS=3600             # Cache TTL (60-86400 seconds)
MAX_CACHE_SIZE_MB=100              # Max cache size (10-1000 MB)
ENABLE_EMBEDDING_CACHE=true        # Cache embeddings

# ═══════════════════════════════════════════════════════════════════════════════
# Logging Configuration
# ═══════════════════════════════════════════════════════════════════════════════

LOG_DIR=./logs                     # Log directory (created automatically)
LOG_LEVEL=INFO                     # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FORMAT=text                    # text or json
LOG_RETENTION_DAYS=7               # Auto-delete logs older than this (1-90 days)
LOG_MAX_BYTES=10485760             # Max size per log file (10 MB default)
LOG_BACKUP_COUNT=5                 # Number of rotated backups (1-30)
ENABLE_CONSOLE_LOGGING=true        # Enable stdout/stderr output
ENABLE_FILE_LOGGING=true           # Enable file logging
