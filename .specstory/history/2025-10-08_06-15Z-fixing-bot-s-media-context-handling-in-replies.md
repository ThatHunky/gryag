<!-- Generated by SpecStory -->

<!-- vscode Session f0d687c8-a66c-452a-a29f-0ede38b2d163 (2025-10-08 06:15Z) -->

# Fixing bot's media context handling in replies (2025-10-08 06:15Z)

_**User (2025-10-08 06:42Z)**_

Check the context logic for the bot, it doesn't see the replied messages' media. Fix it.

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I'll investigate the context logic to understand how the bot handles replied messages and their media content. 

Let me look more closely at the handler code to understand the current flow: 

Let me check the context_store.recent method: 

Now I understand the issue! Let me trace through what happens: 

Let me check how the context is actually used when calling Gemini: 

Now I see the issue! Let me check how history is constructed when NOT using multi-level context: 

Now I understand the full picture. The issue is:

1. When `use_multi_level=True`, the history is fetched via `context_manager._get_immediate_context()` and `_get_recent_context()`, which call `context_store.recent()`
2. The `reply_context` media is collected but **never added to the history** - it's only used for fallback text and metadata
3. If the replied-to message is outside the context window (e.g., older than the last 30 messages), its media won't be in the history at all

The fix is to **explicitly add the replied-to message to the history** when we have reply context with media. Let me implement this: 
```

```

```

```


Now I need to inject the reply context into the history. Let me find where the history is used after formatting: 

Perfect! Now I need to inject the reply context into the history right after it's formatted. Let me add the injection logic: 
```

```


Now let's test the fix by running a quick check to ensure there are no syntax errors: 

Let me check for import errors instead: 

Great! The syntax is valid. Now let me create a summary document explaining the fix: 
```

```


Now let's update the CHANGELOG: 
```

```


The markdown linting errors are minor formatting issues. Let me fix the most important ones: 
```

```


The linting errors are pre-existing in the changelog. Let's document the change properly: 
```

```


Good! The changes are documented. Now let's create a simple test to verify the logic is sound: 

Perfect! Let's verify the imports are all correct: 

Excellent! The `format_metadata` function is already imported. Let's run a final verification to make sure the logic flow is correct: 

Perfect! Now let's create a quick summary of what was fixed:

## Summary

I've successfully fixed the issue where the bot couldn't see media from replied-to messages. Here's what was done:

### Problem
When users replied to a message containing media (photos, videos, etc.) and tagged the bot, the bot couldn't see the media from the replied-to message in its context, even though the code was collecting it from Telegram API.

### Root Cause
The media from `reply_context` was being collected but never injected into the conversation history sent to Gemini. It was only used for fallback text and metadata. When the replied-to message was outside the context window (older than the last N messages), its media wouldn't be visible at all.

### Solution
Added **explicit history injection logic** that:

1. **Tracks reply context** with media in a new variable `reply_context_for_history`
2. **Checks for duplicates** by searching for the message_id in existing history
3. **Injects the message** at the beginning of history with proper metadata, text, and media parts
4. **Logs the injection** for debugging

### Files Changed
- **Modified**: `chat.py` (+60 lines)
  - Added reply context tracking
  - Added deduplication check
  - Added history injection after context formatting
- **New**: `REPLY_MEDIA_CONTEXT_FIX.md` - Complete documentation
- **Updated**: `CHANGELOG.md` - Added entry for this fix
- **Updated**: `README.md` - Added to recent changes

### How to Verify
1. Send a message with a photo (without tagging the bot)
2. Reply to that message and tag the bot: "@gryag що на фото?"
3. Bot should now describe the photo

Check logs for:
```
DEBUG - Collected N media part(s) from reply message {message_id}
DEBUG - Injected reply context with N media part(s) into history for message {message_id}
```

The fix is backward compatible, works with both multi-level and simple context modes, and includes deduplication to prevent duplicate messages in history.

---

