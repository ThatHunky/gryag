# gryag

Telegram груповий бот з характером: короткі дотепні відповіді українською, живиться Gemini Flash 2.5 та пам'ятає контекст бесіди. Вивчає користувачів та запам'ятовує факти про них для персоналізації.

## Фічі

- Відповідає лише коли тегнули, відповіді чи згадали «гряг/gryag».
- Підтягує останні репліки з SQLite (опціонально Redis для швидкого тротлінгу).
- **Профілювання користувачів**: автоматично вивчає та запам'ятовує інформацію про користувачів (локація, вподобання, навички, мови).
- **Гібридне витягування фактів**: 95% випадків без API — використовує regex паттерни та локальну LLM (Phi-3-mini).
- Підтримує зображення та голосові повідомлення — коротко описує їх у відповіді.
- Адаптивно обмежує звернення: спокійні користувачі отримують більший ліміт, спамери стискаються.
- Гострий сарказм, чорний гумор, українська за замовчуванням.
- Адміни з білого списку можуть банити або розбанювати користувачів для бота.
- Адміни не підпадають під ліміти чи бани.gram груповий бот з характером: короткі дотепні відповіді українською, живиться Gemini Flash 2.5 та пам'ятає контекст бесіди.

## Фічі

- Відповідає лише коли тегнули, відповіли або згадали «гряг/gryag».
- Підтягує останні репліки з SQLite (опціонально Redis для швидкого тротлінгу).
- Підтримує зображення та голосові повідомлення — коротко описує їх у відповіді.
- Адаптивно обмежує звернення: спокійні користувачі отримують більший ліміт, спамери стискаються.
- Гострий сарказм, чорний гумор, українська за замовчуванням.
- Адміни з білого списку можуть банити або розбанювати користувачів для бота.
- Адміни не підпадають під ліміти чи бани.

## Швидкий старт

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
# заповніть TELEGRAM_TOKEN та GEMINI_API_KEY
python -m app.main
```

### Опціонально: Локальна модель для витягування фактів

Для роботи без Gemini API для профілювання користувачів (95% випадків):

```bash
# Завантажити модель Phi-3-mini (~2.2GB)
bash download_model.sh

# або вручну:
# wget https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf -O models/phi-3-mini-q4.gguf

# Додати у .env:
FACT_EXTRACTION_METHOD=hybrid
LOCAL_MODEL_PATH=models/phi-3-mini-q4.gguf
LOCAL_MODEL_THREADS=4
```

**Методи витягування фактів:**
- `rule_based` - Лише regex паттерни (миттєво, 70% покриття, 0 вартість)
- `local_model` - Локальна LLM (100-500мс, 85% покриття, потрібна модель)
- `hybrid` - Regex + локальна LLM + опціональний Gemini fallback (рекомендовано)
- `gemini` - Тільки Gemini API (застарілий режим)

Детальна документація: [HYBRID_EXTRACTION_COMPLETE.md](HYBRID_EXTRACTION_COMPLETE.md)

## Налаштування

- Змінні середовища описані в `.env.example` (модель відповіді, модель ембедингів, шлях до БД, ліміт історії, тротлінг, список адмінів, веб-пошук).
- Щоб увімкнути Google Search Grounding, додайте `ENABLE_SEARCH_GROUNDING=true` у `.env`. У безоплатному (Free) тарифі Gemini 2.5 Flash/Flash-Lite діє ліміт **500 запитів на день** на проєкт. Пошук виконується через динамічний `google_search_retrieval`, тож модель сама вирішує, коли ходити в Google.
- База `SQLite` зберігає повідомлення й квоти; схема лежить у `db/schema.sql`.
- Увімкніть Redis (опціонально) через `USE_REDIS=true` та вкажіть `REDIS_URL` — тротлінг працюватиме через Redis, але SQLite лишаться як бек-ап для історії.

## Поведінка

- Контекст: зберігаються до 50 останніх повідомлень для кожної пари `chat_id + thread`, плюс вбудований семантичний пошук по старих обговореннях.
- Тригери: бот реагує на `@username`, реплай власного повідомлення або згадку «гряг/gryag» без модераційних фільтрів.
- Якщо файл — фото/документ з MIME `image/*` чи `audio/*`, або voice — бот завантажує його та відправляє в Gemini.
- При перевищенні ліміту: миттєва різка відповідь ігнорує подальшу обробку протягом години.
- Retention: історія, квоти й бани зберігаються до 30 днів (налаштовується).

## Адмін-команди

- `ADMIN_USER_IDS` — комою розділений список Telegram user_id, які можуть керувати ботом.
- `/gryagban` — виконайте команду у відповіді на повідомлення користувача або передайте user_id після команди, щоб забанити.
- `/gryagunban` — аналогічно знімає бан.

## Ліцензія

MIT
