2025-11-18T07:14:11.1118500Z ##[group]Run make ci
2025-11-18T07:14:11.1118756Z [36;1mmake ci[0m
2025-11-18T07:14:11.1151797Z shell: /usr/bin/bash -e {0}
2025-11-18T07:14:11.1152023Z env:
2025-11-18T07:14:11.1152265Z   pythonLocation: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-18T07:14:11.1152659Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.11.14/x64/lib/pkgconfig
2025-11-18T07:14:11.1153052Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-18T07:14:11.1153395Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-18T07:14:11.1153728Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-18T07:14:11.1154069Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.11.14/x64/lib
2025-11-18T07:14:11.1154522Z   TELEGRAM_TOKEN: test-token
2025-11-18T07:14:11.1154732Z   GEMINI_API_KEY: test-key
2025-11-18T07:14:11.1154928Z   GEMINI_API_KEYS: test-key
2025-11-18T07:14:11.1155120Z ##[endgroup]
2025-11-18T07:14:11.1220970Z . .venv/bin/activate && ruff check app/ tests/
2025-11-18T07:14:11.1257429Z warning: The top-level linter settings are deprecated in favour of their counterparts in the `lint` section. Please update the following options in `pyproject.toml`:
2025-11-18T07:14:11.1258594Z   - 'ignore' -> 'lint.ignore'
2025-11-18T07:14:11.1259000Z   - 'select' -> 'lint.select'
2025-11-18T07:14:11.1259429Z   - 'per-file-ignores' -> 'lint.per-file-ignores'
2025-11-18T07:14:11.1658068Z B018 Found useless expression. Either assign it to a variable or remove it.
2025-11-18T07:14:11.1658844Z    --> app/config.py:842:17
2025-11-18T07:14:11.1659152Z     |
2025-11-18T07:14:11.1659451Z 840 |         if self.admin_user_ids:
2025-11-18T07:14:11.1659842Z 841 |             try:
2025-11-18T07:14:11.1660360Z 842 |                 self.admin_user_ids_list  # This will raise if format is invalid
2025-11-18T07:14:11.1660945Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1661394Z 843 |             except Exception as e:
2025-11-18T07:14:11.1661831Z 844 |                 raise ValueError(
2025-11-18T07:14:11.1662241Z     |
2025-11-18T07:14:11.1662390Z 
2025-11-18T07:14:11.1663037Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.1663960Z    --> app/config.py:844:17
2025-11-18T07:14:11.1664299Z     |
2025-11-18T07:14:11.1664700Z 842 |                   self.admin_user_ids_list  # This will raise if format is invalid
2025-11-18T07:14:11.1665256Z 843 |               except Exception as e:
2025-11-18T07:14:11.1665667Z 844 | /                 raise ValueError(
2025-11-18T07:14:11.1666101Z 845 | |                     f"Invalid ADMIN_USER_IDS format: {e}. "
2025-11-18T07:14:11.1666650Z 846 | |                     "Use comma-separated integers: 123456789,987654321"
2025-11-18T07:14:11.1667332Z 847 | |                 )
2025-11-18T07:14:11.1667684Z     | |_________________^
2025-11-18T07:14:11.1667991Z 848 |
2025-11-18T07:14:11.1668318Z 849 |           # Check Redis configuration if enabled
2025-11-18T07:14:11.1668741Z     |
2025-11-18T07:14:11.1668891Z 
2025-11-18T07:14:11.1669217Z F403 `from app.core.exceptions import *` used; unable to detect undefined names
2025-11-18T07:14:11.1669827Z  --> app/core/__init__.py:3:1
2025-11-18T07:14:11.1670161Z   |
2025-11-18T07:14:11.1670451Z 1 | """Core infrastructure components."""
2025-11-18T07:14:11.1670831Z 2 |
2025-11-18T07:14:11.1671113Z 3 | from app.core.exceptions import *
2025-11-18T07:14:11.1671491Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1671825Z 4 |
2025-11-18T07:14:11.1672058Z 5 | __all__ = [
2025-11-18T07:14:11.1672324Z   |
2025-11-18T07:14:11.1672455Z 
2025-11-18T07:14:11.1672737Z F405 `GryagException` may be undefined, or defined from star imports
2025-11-18T07:14:11.1673290Z  --> app/core/__init__.py:6:5
2025-11-18T07:14:11.1673640Z   |
2025-11-18T07:14:11.1673899Z 5 | __all__ = [
2025-11-18T07:14:11.1674199Z 6 |     "GryagException",
2025-11-18T07:14:11.1674524Z   |     ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1674855Z 7 |     "UserProfileNotFoundError",
2025-11-18T07:14:11.1675551Z 8 |     "FactExtractionError",
2025-11-18T07:14:11.1675878Z   |
2025-11-18T07:14:11.1676014Z 
2025-11-18T07:14:11.1676373Z F405 `UserProfileNotFoundError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1677191Z  --> app/core/__init__.py:7:5
2025-11-18T07:14:11.1677542Z   |
2025-11-18T07:14:11.1677778Z 5 | __all__ = [
2025-11-18T07:14:11.1678140Z 6 |     "GryagException",
2025-11-18T07:14:11.1678529Z 7 |     "UserProfileNotFoundError",
2025-11-18T07:14:11.1678900Z   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1679264Z 8 |     "FactExtractionError",
2025-11-18T07:14:11.1679629Z 9 |     "ConversationWindowError",
2025-11-18T07:14:11.1680193Z   |
2025-11-18T07:14:11.1680333Z 
2025-11-18T07:14:11.1680663Z F405 `FactExtractionError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1681245Z   --> app/core/__init__.py:8:5
2025-11-18T07:14:11.1681578Z    |
2025-11-18T07:14:11.1681833Z  6 |     "GryagException",
2025-11-18T07:14:11.1682193Z  7 |     "UserProfileNotFoundError",
2025-11-18T07:14:11.1682587Z  8 |     "FactExtractionError",
2025-11-18T07:14:11.1682930Z    |     ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1683268Z  9 |     "ConversationWindowError",
2025-11-18T07:14:11.1683642Z 10 |     "DatabaseError",
2025-11-18T07:14:11.1683961Z    |
2025-11-18T07:14:11.1684099Z 
2025-11-18T07:14:11.1684436Z F405 `ConversationWindowError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1685050Z   --> app/core/__init__.py:9:5
2025-11-18T07:14:11.1685369Z    |
2025-11-18T07:14:11.1685641Z  7 |     "UserProfileNotFoundError",
2025-11-18T07:14:11.1686026Z  8 |     "FactExtractionError",
2025-11-18T07:14:11.1686405Z  9 |     "ConversationWindowError",
2025-11-18T07:14:11.1686770Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1687358Z 10 |     "DatabaseError",
2025-11-18T07:14:11.1687699Z 11 |     "ExternalAPIError",
2025-11-18T07:14:11.1688017Z    |
2025-11-18T07:14:11.1688160Z 
2025-11-18T07:14:11.1688441Z F405 `DatabaseError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1688974Z   --> app/core/__init__.py:10:5
2025-11-18T07:14:11.1689306Z    |
2025-11-18T07:14:11.1689563Z  8 |     "FactExtractionError",
2025-11-18T07:14:11.1689933Z  9 |     "ConversationWindowError",
2025-11-18T07:14:11.1690301Z 10 |     "DatabaseError",
2025-11-18T07:14:11.1690616Z    |     ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1690943Z 11 |     "ExternalAPIError",
2025-11-18T07:14:11.1691286Z 12 |     "GeminiError",
2025-11-18T07:14:11.1691583Z    |
2025-11-18T07:14:11.1691714Z 
2025-11-18T07:14:11.1692006Z F405 `ExternalAPIError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1692570Z   --> app/core/__init__.py:11:5
2025-11-18T07:14:11.1692892Z    |
2025-11-18T07:14:11.1693169Z  9 |     "ConversationWindowError",
2025-11-18T07:14:11.1693538Z 10 |     "DatabaseError",
2025-11-18T07:14:11.1693868Z 11 |     "ExternalAPIError",
2025-11-18T07:14:11.1694193Z    |     ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1694515Z 12 |     "GeminiError",
2025-11-18T07:14:11.1694822Z 13 |     "TelegramError",
2025-11-18T07:14:11.1695112Z    |
2025-11-18T07:14:11.1695247Z 
2025-11-18T07:14:11.1695510Z F405 `GeminiError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1696020Z   --> app/core/__init__.py:12:5
2025-11-18T07:14:11.1696345Z    |
2025-11-18T07:14:11.1696589Z 10 |     "DatabaseError",
2025-11-18T07:14:11.1696912Z 11 |     "ExternalAPIError",
2025-11-18T07:14:11.1697401Z 12 |     "GeminiError",
2025-11-18T07:14:11.1697699Z    |     ^^^^^^^^^^^^^
2025-11-18T07:14:11.1697998Z 13 |     "TelegramError",
2025-11-18T07:14:11.1698331Z 14 |     "RateLimitExceededError",
2025-11-18T07:14:11.1698689Z    |
2025-11-18T07:14:11.1698824Z 
2025-11-18T07:14:11.1699085Z F405 `TelegramError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1699617Z   --> app/core/__init__.py:13:5
2025-11-18T07:14:11.1699935Z    |
2025-11-18T07:14:11.1700193Z 11 |     "ExternalAPIError",
2025-11-18T07:14:11.1700738Z 12 |     "GeminiError",
2025-11-18T07:14:11.1701053Z 13 |     "TelegramError",
2025-11-18T07:14:11.1701366Z    |     ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1701689Z 14 |     "RateLimitExceededError",
2025-11-18T07:14:11.1702083Z 15 |     "CircuitBreakerOpenError",
2025-11-18T07:14:11.1702435Z    |
2025-11-18T07:14:11.1702570Z 
2025-11-18T07:14:11.1702906Z F405 `RateLimitExceededError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1703501Z   --> app/core/__init__.py:14:5
2025-11-18T07:14:11.1703831Z    |
2025-11-18T07:14:11.1704073Z 12 |     "GeminiError",
2025-11-18T07:14:11.1704383Z 13 |     "TelegramError",
2025-11-18T07:14:11.1704711Z 14 |     "RateLimitExceededError",
2025-11-18T07:14:11.1705247Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1705613Z 15 |     "CircuitBreakerOpenError",
2025-11-18T07:14:11.1705983Z 16 |     "ValidationError",
2025-11-18T07:14:11.1706307Z    |
2025-11-18T07:14:11.1706442Z 
2025-11-18T07:14:11.1706777Z F405 `CircuitBreakerOpenError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1707545Z   --> app/core/__init__.py:15:5
2025-11-18T07:14:11.1707869Z    |
2025-11-18T07:14:11.1708122Z 13 |     "TelegramError",
2025-11-18T07:14:11.1708454Z 14 |     "RateLimitExceededError",
2025-11-18T07:14:11.1708842Z 15 |     "CircuitBreakerOpenError",
2025-11-18T07:14:11.1709211Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1709558Z 16 |     "ValidationError",
2025-11-18T07:14:11.1709868Z 17 | ]
2025-11-18T07:14:11.1710098Z    |
2025-11-18T07:14:11.1710237Z 
2025-11-18T07:14:11.1710511Z F405 `ValidationError` may be undefined, or defined from star imports
2025-11-18T07:14:11.1711049Z   --> app/core/__init__.py:16:5
2025-11-18T07:14:11.1711387Z    |
2025-11-18T07:14:11.1711648Z 14 |     "RateLimitExceededError",
2025-11-18T07:14:11.1712031Z 15 |     "CircuitBreakerOpenError",
2025-11-18T07:14:11.1712408Z 16 |     "ValidationError",
2025-11-18T07:14:11.1712723Z    |     ^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1713038Z 17 | ]
2025-11-18T07:14:11.1713281Z    |
2025-11-18T07:14:11.1713423Z 
2025-11-18T07:14:11.1713620Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.1714084Z  --> app/core/exceptions.py:9:1
2025-11-18T07:14:11.1714419Z   |
2025-11-18T07:14:11.1714688Z 7 | from __future__ import annotations
2025-11-18T07:14:11.1715052Z 8 |
2025-11-18T07:14:11.1715336Z 9 | from typing import Any, Dict, Optional
2025-11-18T07:14:11.1715732Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1716082Z   |
2025-11-18T07:14:11.1716213Z 
2025-11-18T07:14:11.1716379Z F401 [*] `typing.Optional` imported but unused
2025-11-18T07:14:11.1716819Z  --> app/core/exceptions.py:9:31
2025-11-18T07:14:11.1717304Z   |
2025-11-18T07:14:11.1717587Z 7 | from __future__ import annotations
2025-11-18T07:14:11.1717944Z 8 |
2025-11-18T07:14:11.1718224Z 9 | from typing import Any, Dict, Optional
2025-11-18T07:14:11.1718620Z   |                               ^^^^^^^^
2025-11-18T07:14:11.1718958Z   |
2025-11-18T07:14:11.1719260Z help: Remove unused import: `typing.Optional`
2025-11-18T07:14:11.1719573Z 
2025-11-18T07:14:11.1719775Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.1720257Z   --> app/core/exceptions.py:38:18
2025-11-18T07:14:11.1720603Z    |
2025-11-18T07:14:11.1720856Z 36 |         message: str,
2025-11-18T07:14:11.1721161Z 37 |         *,
2025-11-18T07:14:11.1721479Z 38 |         context: Dict[str, Any] | None = None,
2025-11-18T07:14:11.1721882Z    |                  ^^^^
2025-11-18T07:14:11.1722220Z 39 |         cause: Exception | None = None,
2025-11-18T07:14:11.1722598Z 40 |     ):
2025-11-18T07:14:11.1722836Z    |
2025-11-18T07:14:11.1723101Z help: Replace with `dict`
2025-11-18T07:14:11.1723323Z 
2025-11-18T07:14:11.1723518Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.1723992Z   --> app/core/exceptions.py:46:26
2025-11-18T07:14:11.1724341Z    |
2025-11-18T07:14:11.1724598Z 44 |         self.cause = cause
2025-11-18T07:14:11.1724916Z 45 |
2025-11-18T07:14:11.1725452Z 46 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.1725852Z    |                          ^^^^
2025-11-18T07:14:11.1726330Z 47 |         """Convert exception to dictionary for logging/serialization.
2025-11-18T07:14:11.1726820Z    |
2025-11-18T07:14:11.1727230Z help: Replace with `dict`
2025-11-18T07:14:11.1727446Z 
2025-11-18T07:14:11.1727603Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.1728050Z   --> app/core/initialization.py:28:52
2025-11-18T07:14:11.1728426Z    |
2025-11-18T07:14:11.1728872Z 28 | async def init_redis_client(settings: Settings) -> Optional[RedisClient]:
2025-11-18T07:14:11.1729459Z    |                                                    ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1730123Z 29 |     """Initialize Redis client if enabled and available.
2025-11-18T07:14:11.1730562Z    |
2025-11-18T07:14:11.1730816Z help: Convert to `X | None`
2025-11-18T07:14:11.1731043Z 
2025-11-18T07:14:11.1731183Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.1731604Z   --> app/core/initialization.py:45:1
2025-11-18T07:14:11.1731972Z    |
2025-11-18T07:14:11.1732223Z 44 |     import asyncio
2025-11-18T07:14:11.1732512Z 45 |     
2025-11-18T07:14:11.1732757Z    | ^^^^
2025-11-18T07:14:11.1733005Z 46 |     max_retries = 3
2025-11-18T07:14:11.1733328Z 47 |     retry_delay = 2.0
2025-11-18T07:14:11.1733629Z    |
2025-11-18T07:14:11.1733909Z help: Remove whitespace from blank line
2025-11-18T07:14:11.1734186Z 
2025-11-18T07:14:11.1734323Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.1734735Z   --> app/core/initialization.py:48:1
2025-11-18T07:14:11.1735095Z    |
2025-11-18T07:14:11.1735356Z 46 |     max_retries = 3
2025-11-18T07:14:11.1735677Z 47 |     retry_delay = 2.0
2025-11-18T07:14:11.1735972Z 48 |     
2025-11-18T07:14:11.1736213Z    | ^^^^
2025-11-18T07:14:11.1736488Z 49 |     for attempt in range(max_retries):
2025-11-18T07:14:11.1736873Z 50 |         try:
2025-11-18T07:14:11.1737276Z    |
2025-11-18T07:14:11.1737557Z help: Remove whitespace from blank line
2025-11-18T07:14:11.1737836Z 
2025-11-18T07:14:11.1737979Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.1738392Z   --> app/core/initialization.py:69:1
2025-11-18T07:14:11.1738751Z    |
2025-11-18T07:14:11.1739556Z 67 |                 logger.warning(f"Не вдалося під'єднати Redis після {max_retries} спроб: {exc}")
2025-11-18T07:14:11.1740100Z 68 |                 return None
2025-11-18T07:14:11.1740426Z 69 |     
2025-11-18T07:14:11.1740671Z    | ^^^^
2025-11-18T07:14:11.1740917Z 70 |     return None
2025-11-18T07:14:11.1741197Z    |
2025-11-18T07:14:11.1741468Z help: Remove whitespace from blank line
2025-11-18T07:14:11.1741748Z 
2025-11-18T07:14:11.1741919Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.1742346Z   --> app/core/logging_config.py:8:21
2025-11-18T07:14:11.1742709Z    |
2025-11-18T07:14:11.1742963Z  6 | import logging
2025-11-18T07:14:11.1743262Z  7 | import logging.handlers
2025-11-18T07:14:11.1743622Z  8 | from pathlib import Path
2025-11-18T07:14:11.1743974Z    |                     ^^^^
2025-11-18T07:14:11.1744288Z  9 |
2025-11-18T07:14:11.1744553Z 10 | from app.config import Settings
2025-11-18T07:14:11.1744912Z    |
2025-11-18T07:14:11.1745200Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.1745502Z 
2025-11-18T07:14:11.1745674Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.1746131Z   --> app/handlers/admin.py:1:1
2025-11-18T07:14:11.1746461Z    |
2025-11-18T07:14:11.1746743Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.1747250Z  2 | |
2025-11-18T07:14:11.1747507Z  3 | | import logging
2025-11-18T07:14:11.1747817Z  4 | | from typing import Any
2025-11-18T07:14:11.1748148Z  5 | |
2025-11-18T07:14:11.1748417Z  6 | | from aiogram import Bot, Router
2025-11-18T07:14:11.1748882Z  7 | | from aiogram.exceptions import TelegramBadRequest
2025-11-18T07:14:11.1749365Z  8 | | from aiogram.filters import Command
2025-11-18T07:14:11.1749830Z  9 | | from aiogram.types import BotCommand, Message
2025-11-18T07:14:11.1750431Z 10 | |
2025-11-18T07:14:11.1750705Z 11 | | from app.config import Settings
2025-11-18T07:14:11.1751209Z 12 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.1751898Z 13 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.1752622Z 14 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.1753210Z 15 | | from app.services.donation_scheduler import DONATION_MESSAGE
2025-11-18T07:14:11.1753782Z 16 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.1754301Z 17 | | from app.services.rate_limiter import RateLimiter
2025-11-18T07:14:11.1754833Z 18 | | from app.utils.persona_helpers import get_response
2025-11-18T07:14:11.1755488Z    | |__________________________________________________^
2025-11-18T07:14:11.1755864Z 19 |
2025-11-18T07:14:11.1756115Z 20 |   router = Router()
2025-11-18T07:14:11.1756410Z    |
2025-11-18T07:14:11.1756667Z help: Organize imports
2025-11-18T07:14:11.1756873Z 
2025-11-18T07:14:11.1758236Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1758667Z    --> app/handlers/admin.py:297:16
2025-11-18T07:14:11.1759030Z     |
2025-11-18T07:14:11.1759323Z 296 |     # Build response with chat information
2025-11-18T07:14:11.1759926Z 297 |     response = f"📊 <b>Інформація про чат</b>\n\n"
2025-11-18T07:14:11.1760360Z     |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1760924Z 298 |     response += f"🆔 Chat ID: <code>{chat_id}</code>\n"
2025-11-18T07:14:11.1761482Z 299 |     response += f"📱 Тип: {chat_type}\n"
2025-11-18T07:14:11.1761887Z     |
2025-11-18T07:14:11.1762061Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1762233Z 
2025-11-18T07:14:11.1762324Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1762578Z    --> app/handlers/admin.py:308:17
2025-11-18T07:14:11.1762947Z     |
2025-11-18T07:14:11.1763221Z 307 |     # Add configuration hints
2025-11-18T07:14:11.1763905Z 308 |     response += f"\n💡 <b>Використання:</b>\n"
2025-11-18T07:14:11.1764363Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1764726Z 309 |
2025-11-18T07:14:11.1765020Z 310 |     if chat_id < 0:  # Group/supergroup
2025-11-18T07:14:11.1765398Z     |
2025-11-18T07:14:11.1765676Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1765905Z 
2025-11-18T07:14:11.1766074Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1766520Z    --> app/handlers/admin.py:311:21
2025-11-18T07:14:11.1766876Z     |
2025-11-18T07:14:11.1767304Z 310 |     if chat_id < 0:  # Group/supergroup
2025-11-18T07:14:11.1767852Z 311 |         response += f"Для whitelist режиму:\n"
2025-11-18T07:14:11.1768286Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1768787Z 312 |         response += f"<code>ALLOWED_CHAT_IDS={chat_id}</code>\n\n"
2025-11-18T07:14:11.1769257Z 313 |         response += f"Для blacklist режиму:\n"
2025-11-18T07:14:11.1769488Z     |
2025-11-18T07:14:11.1769662Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1769834Z 
2025-11-18T07:14:11.1769933Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1770250Z    --> app/handlers/admin.py:313:21
2025-11-18T07:14:11.1770616Z     |
2025-11-18T07:14:11.1771005Z 311 |         response += f"Для whitelist режиму:\n"
2025-11-18T07:14:11.1771537Z 312 |         response += f"<code>ALLOWED_CHAT_IDS={chat_id}</code>\n\n"
2025-11-18T07:14:11.1772152Z 313 |         response += f"Для blacklist режиму:\n"
2025-11-18T07:14:11.1772570Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1773057Z 314 |         response += f"<code>BLOCKED_CHAT_IDS={chat_id}</code>\n\n"
2025-11-18T07:14:11.1773699Z 315 |         response += f"Кілька чатів через кому:\n"
2025-11-18T07:14:11.1774108Z     |
2025-11-18T07:14:11.1774387Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1774643Z 
2025-11-18T07:14:11.1774796Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1775221Z    --> app/handlers/admin.py:315:21
2025-11-18T07:14:11.1775796Z     |
2025-11-18T07:14:11.1776185Z 313 |         response += f"Для blacklist режиму:\n"
2025-11-18T07:14:11.1776717Z 314 |         response += f"<code>BLOCKED_CHAT_IDS={chat_id}</code>\n\n"
2025-11-18T07:14:11.1777355Z 315 |         response += f"Кілька чатів через кому:\n"
2025-11-18T07:14:11.1777616Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1778119Z 316 |         response += f"<code>ALLOWED_CHAT_IDS={chat_id},-100456,...</code>"
2025-11-18T07:14:11.1778657Z 317 |     else:  # Private chat
2025-11-18T07:14:11.1778989Z     |
2025-11-18T07:14:11.1779260Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1779518Z 
2025-11-18T07:14:11.1779874Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1780299Z    --> app/handlers/admin.py:318:21
2025-11-18T07:14:11.1780659Z     |
2025-11-18T07:14:11.1781041Z 316 |         response += f"<code>ALLOWED_CHAT_IDS={chat_id},-100456,...</code>"
2025-11-18T07:14:11.1781568Z 317 |     else:  # Private chat
2025-11-18T07:14:11.1782084Z 318 |         response += f"Це приватний чат (ID > 0).\n"
2025-11-18T07:14:11.1782519Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1783120Z 319 |         response += f"Приватні чати з адмінами завжди дозволені."
2025-11-18T07:14:11.1783574Z     |
2025-11-18T07:14:11.1783859Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1784119Z 
2025-11-18T07:14:11.1784274Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1784703Z    --> app/handlers/admin.py:319:21
2025-11-18T07:14:11.1785053Z     |
2025-11-18T07:14:11.1785315Z 317 |     else:  # Private chat
2025-11-18T07:14:11.1785790Z 318 |         response += f"Це приватний чат (ID > 0).\n"
2025-11-18T07:14:11.1786419Z 319 |         response += f"Приватні чати з адмінами завжди дозволені."
2025-11-18T07:14:11.1786913Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1787452Z 320 |
2025-11-18T07:14:11.1787731Z 321 |     # Show current configuration
2025-11-18T07:14:11.1788105Z     |
2025-11-18T07:14:11.1788384Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1788640Z 
2025-11-18T07:14:11.1788794Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1789215Z    --> app/handlers/admin.py:322:17
2025-11-18T07:14:11.1789576Z     |
2025-11-18T07:14:11.1789842Z 321 |     # Show current configuration
2025-11-18T07:14:11.1790414Z 322 |     response += f"\n\n⚙️ <b>Поточна конфігурація:</b>\n"
2025-11-18T07:14:11.1790880Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1791509Z 323 |     response += f"Режим: <code>{settings.bot_behavior_mode}</code>\n"
2025-11-18T07:14:11.1792001Z     |
2025-11-18T07:14:11.1792299Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1792556Z 
2025-11-18T07:14:11.1792708Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1793125Z    --> app/handlers/admin.py:334:25
2025-11-18T07:14:11.1793488Z     |
2025-11-18T07:14:11.1793798Z 332 |     if settings.bot_behavior_mode == "whitelist":
2025-11-18T07:14:11.1794364Z 333 |         if chat_id in settings.allowed_chat_ids_list or chat_id > 0:
2025-11-18T07:14:11.1795020Z 334 |             response += f"\n✅ Цей чат <b>дозволений</b>"
2025-11-18T07:14:11.1795471Z     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1795855Z 335 |         else:
2025-11-18T07:14:11.1796315Z 336 |             response += f"\n❌ Цей чат <b>НЕ в whitelist</b>"
2025-11-18T07:14:11.1796750Z     |
2025-11-18T07:14:11.1797156Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1797414Z 
2025-11-18T07:14:11.1797575Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1797983Z    --> app/handlers/admin.py:336:25
2025-11-18T07:14:11.1798534Z     |
2025-11-18T07:14:11.1798954Z 334 |             response += f"\n✅ Цей чат <b>дозволений</b>"
2025-11-18T07:14:11.1799385Z 335 |         else:
2025-11-18T07:14:11.1799841Z 336 |             response += f"\n❌ Цей чат <b>НЕ в whitelist</b>"
2025-11-18T07:14:11.1800539Z     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1801016Z 337 |     elif settings.bot_behavior_mode == "blacklist":
2025-11-18T07:14:11.1801532Z 338 |         if chat_id in settings.blocked_chat_ids_list:
2025-11-18T07:14:11.1801966Z     |
2025-11-18T07:14:11.1802245Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1802517Z 
2025-11-18T07:14:11.1802673Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1803092Z    --> app/handlers/admin.py:339:25
2025-11-18T07:14:11.1803451Z     |
2025-11-18T07:14:11.1803774Z 337 |     elif settings.bot_behavior_mode == "blacklist":
2025-11-18T07:14:11.1804289Z 338 |         if chat_id in settings.blocked_chat_ids_list:
2025-11-18T07:14:11.1804917Z 339 |             response += f"\n❌ Цей чат <b>заблокований</b>"
2025-11-18T07:14:11.1805373Z     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1805760Z 340 |         else:
2025-11-18T07:14:11.1806198Z 341 |             response += f"\n✅ Цей чат <b>дозволений</b>"
2025-11-18T07:14:11.1806623Z     |
2025-11-18T07:14:11.1806898Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1807317Z 
2025-11-18T07:14:11.1807472Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1807898Z    --> app/handlers/admin.py:341:25
2025-11-18T07:14:11.1808244Z     |
2025-11-18T07:14:11.1808659Z 339 |             response += f"\n❌ Цей чат <b>заблокований</b>"
2025-11-18T07:14:11.1809076Z 340 |         else:
2025-11-18T07:14:11.1809510Z 341 |             response += f"\n✅ Цей чат <b>дозволений</b>"
2025-11-18T07:14:11.1809948Z     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1810343Z 342 |     else:  # global
2025-11-18T07:14:11.1810847Z 343 |         response += f"\n✅ Всі чати дозволені (global режим)"
2025-11-18T07:14:11.1811287Z     |
2025-11-18T07:14:11.1811561Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1811812Z 
2025-11-18T07:14:11.1811964Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1812402Z    --> app/handlers/admin.py:343:21
2025-11-18T07:14:11.1812747Z     |
2025-11-18T07:14:11.1813145Z 341 |             response += f"\n✅ Цей чат <b>дозволений</b>"
2025-11-18T07:14:11.1813563Z 342 |     else:  # global
2025-11-18T07:14:11.1814054Z 343 |         response += f"\n✅ Всі чати дозволені (global режим)"
2025-11-18T07:14:11.1814522Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1814901Z 344 |
2025-11-18T07:14:11.1815178Z 345 |     await message.reply(response)
2025-11-18T07:14:11.1815545Z     |
2025-11-18T07:14:11.1815821Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1816071Z 
2025-11-18T07:14:11.1816210Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.1816630Z    --> app/handlers/admin.py:368:1
2025-11-18T07:14:11.1817105Z     |
2025-11-18T07:14:11.1817446Z 366 |     command_text = (message.text or "").strip().lower()
2025-11-18T07:14:11.1817924Z 367 |     is_confirmation = False
2025-11-18T07:14:11.1818262Z 368 |     
2025-11-18T07:14:11.1818522Z     | ^^^^
2025-11-18T07:14:11.1819092Z 369 |     # Check if command has confirm/yes flag (e.g., "/broadcastdonate confirm" or "/broadcastdonate yes")
2025-11-18T07:14:11.1819929Z 370 |     if "confirm" in command_text or command_text.endswith(" yes"):
2025-11-18T07:14:11.1820226Z     |
2025-11-18T07:14:11.1820398Z help: Remove whitespace from blank line
2025-11-18T07:14:11.1820562Z 
2025-11-18T07:14:11.1820645Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.1820895Z    --> app/handlers/admin.py:372:1
2025-11-18T07:14:11.1821104Z     |
2025-11-18T07:14:11.1821324Z 370 |     if "confirm" in command_text or command_text.endswith(" yes"):
2025-11-18T07:14:11.1821793Z 371 |         is_confirmation = True
2025-11-18T07:14:11.1821997Z 372 |     
2025-11-18T07:14:11.1822145Z     | ^^^^
2025-11-18T07:14:11.1822386Z 373 |     # Check if message is a reply to a confirmation message from the bot
2025-11-18T07:14:11.1822796Z 374 |     if message.reply_to_message and message.reply_to_message.from_user:
2025-11-18T07:14:11.1823208Z     |
2025-11-18T07:14:11.1823386Z help: Remove whitespace from blank line
2025-11-18T07:14:11.1823550Z 
2025-11-18T07:14:11.1823647Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.1823892Z    --> app/handlers/admin.py:460:24
2025-11-18T07:14:11.1824101Z     |
2025-11-18T07:14:11.1824280Z 458 |         if failed_count > 0 and failed_count <= 10:
2025-11-18T07:14:11.1824581Z 459 |             # Show failed chat IDs if there are few failures
2025-11-18T07:14:11.1824971Z 460 |             summary += f"\n\n❌ Не вдалося відправити до чатів:\n"
2025-11-18T07:14:11.1825254Z     |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1825561Z 461 |             summary += ", ".join(str(cid) for cid in failed_chats[:10])
2025-11-18T07:14:11.1825860Z 462 |         elif failed_count > 10:
2025-11-18T07:14:11.1826068Z     |
2025-11-18T07:14:11.1826229Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.1826385Z 
2025-11-18T07:14:11.1826496Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.1826785Z   --> app/handlers/bot_learning_integration.py:8:1
2025-11-18T07:14:11.1827244Z    |
2025-11-18T07:14:11.1827390Z  6 |   """
2025-11-18T07:14:11.1827536Z  7 |
2025-11-18T07:14:11.1827779Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.1828001Z  9 | |
2025-11-18T07:14:11.1828158Z 10 | | import asyncio
2025-11-18T07:14:11.1828335Z 11 | | import logging
2025-11-18T07:14:11.1828517Z 12 | | import time
2025-11-18T07:14:11.1828697Z 13 | | from datetime import datetime
2025-11-18T07:14:11.1828929Z 14 | | from typing import Any
2025-11-18T07:14:11.1829116Z 15 | |
2025-11-18T07:14:11.1829305Z 16 | | from aiogram.types import Message
2025-11-18T07:14:11.1829526Z 17 | |
2025-11-18T07:14:11.1829736Z 18 | | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.1830100Z 19 | | from app.services.bot_learning import BotLearningEngine
2025-11-18T07:14:11.1830435Z 20 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.1830733Z    | |___________________________________________________^
2025-11-18T07:14:11.1830954Z 21 |
2025-11-18T07:14:11.1831126Z 22 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.1831354Z    |
2025-11-18T07:14:11.1831513Z help: Organize imports
2025-11-18T07:14:11.1831635Z 
2025-11-18T07:14:11.1831716Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.1832003Z   --> app/handlers/bot_learning_integration.py:10:8
2025-11-18T07:14:11.1832270Z    |
2025-11-18T07:14:11.1832437Z  8 | from __future__ import annotations
2025-11-18T07:14:11.1832660Z  9 |
2025-11-18T07:14:11.1832804Z 10 | import asyncio
2025-11-18T07:14:11.1832978Z    |        ^^^^^^^
2025-11-18T07:14:11.1833136Z 11 | import logging
2025-11-18T07:14:11.1833303Z 12 | import time
2025-11-18T07:14:11.1833458Z    |
2025-11-18T07:14:11.1833629Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.1833790Z 
2025-11-18T07:14:11.1833881Z F401 [*] `typing.Any` imported but unused
2025-11-18T07:14:11.1834172Z   --> app/handlers/bot_learning_integration.py:14:20
2025-11-18T07:14:11.1834429Z    |
2025-11-18T07:14:11.1834573Z 12 | import time
2025-11-18T07:14:11.1834759Z 13 | from datetime import datetime
2025-11-18T07:14:11.1834985Z 14 | from typing import Any
2025-11-18T07:14:11.1835188Z    |                    ^^^
2025-11-18T07:14:11.1835359Z 15 |
2025-11-18T07:14:11.1835527Z 16 | from aiogram.types import Message
2025-11-18T07:14:11.1835912Z    |
2025-11-18T07:14:11.1836202Z help: Remove unused import: `typing.Any`
2025-11-18T07:14:11.1836496Z 
2025-11-18T07:14:11.1836675Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.1837256Z   --> app/handlers/chat.py:1:1
2025-11-18T07:14:11.1837784Z    |
2025-11-18T07:14:11.1838060Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.1838439Z  2 | |
2025-11-18T07:14:11.1838687Z  3 | | import asyncio
2025-11-18T07:14:11.1838996Z  4 | | import hashlib
2025-11-18T07:14:11.1839282Z  5 | | import json
2025-11-18T07:14:11.1839732Z  6 | | import logging
2025-11-18T07:14:11.1840020Z  7 | | import math
2025-11-18T07:14:11.1840297Z  8 | | import re
2025-11-18T07:14:11.1840576Z  9 | | import time
2025-11-18T07:14:11.1840879Z 10 | | from collections import deque
2025-11-18T07:14:11.1841277Z 11 | | from datetime import datetime
2025-11-18T07:14:11.1841658Z 12 | | from zoneinfo import ZoneInfo
2025-11-18T07:14:11.1842062Z 13 | | from typing import Any, TypedDict
2025-11-18T07:14:11.1842480Z 14 | | from dataclasses import dataclass
2025-11-18T07:14:11.1842849Z 15 | |
2025-11-18T07:14:11.1843119Z 16 | | from aiogram import Bot, Router
2025-11-18T07:14:11.1843548Z 17 | | from aiogram.enums import ParseMode
2025-11-18T07:14:11.1844043Z 18 | | from aiogram.exceptions import TelegramBadRequest
2025-11-18T07:14:11.1844529Z 19 | | from aiogram.types import Message
2025-11-18T07:14:11.1844934Z 20 | | from html import escape
2025-11-18T07:14:11.1845259Z 21 | |
2025-11-18T07:14:11.1845540Z 22 | | from app.config import Settings
2025-11-18T07:14:11.1845967Z 23 | | from app.persona import SYSTEM_PERSONA
2025-11-18T07:14:11.1846614Z 24 | | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1847566Z 25 | | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1848339Z 26 | | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1849157Z 27 | | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1849978Z 28 | | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1850654Z 29 | | from app.services.image_generation import (
2025-11-18T07:14:11.1851109Z 30 | |     ImageGenerationService,
2025-11-18T07:14:11.1851513Z 31 | |     GENERATE_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1851917Z 32 | |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1852307Z 33 | |     QuotaExceededError,
2025-11-18T07:14:11.1852712Z 34 | |     ImageGenerationError,
2025-11-18T07:14:11.1853057Z 35 | | )
2025-11-18T07:14:11.1853413Z 36 | | from app.services.system_prompt_manager import SystemPromptManager
2025-11-18T07:14:11.1853753Z 37 | | from app.services.tools import (
2025-11-18T07:14:11.1854064Z 38 | |     remember_memory_tool,
2025-11-18T07:14:11.1854424Z 39 | |     recall_memories_tool,
2025-11-18T07:14:11.1854781Z 40 | |     forget_memory_tool,
2025-11-18T07:14:11.1855130Z 41 | |     forget_all_memories_tool,
2025-11-18T07:14:11.1855515Z 42 | |     set_pronouns_tool,
2025-11-18T07:14:11.1855872Z 43 | |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.1856259Z 44 | |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.1856649Z 45 | |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.1857199Z 46 | |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.1857636Z 47 | |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.1857982Z 48 | | )
2025-11-18T07:14:11.1858333Z 49 | | from app.services.tools.moderation_tools import (
2025-11-18T07:14:11.1858924Z 50 | |     build_tool_definitions as build_moderation_tool_definitions,
2025-11-18T07:14:11.1859549Z 51 | |     build_tool_callbacks as build_moderation_tool_callbacks,
2025-11-18T07:14:11.1860017Z 52 | | )
2025-11-18T07:14:11.1860358Z 53 | | from app.handlers.chat_tools import (
2025-11-18T07:14:11.1860899Z 54 | |     build_tool_definitions as build_tool_definitions_registry,
2025-11-18T07:14:11.1861511Z 55 | |     build_tool_callbacks as build_tool_callbacks_registry,
2025-11-18T07:14:11.1862026Z 56 | |     create_search_messages_tool,
2025-11-18T07:14:11.1862402Z 57 | | )
2025-11-18T07:14:11.1862717Z 58 | | from app.services.context_store import (
2025-11-18T07:14:11.1863145Z 59 | |     ContextStore,
2025-11-18T07:14:11.1863663Z 60 | |     MessageSender,
2025-11-18T07:14:11.1864058Z 61 | |     TurnSender,  # Backward compatibility alias
2025-11-18T07:14:11.1864503Z 62 | |     format_metadata,
2025-11-18T07:14:11.1865098Z 63 | |     format_speaker_header,
2025-11-18T07:14:11.1865594Z 64 | | )
2025-11-18T07:14:11.1866359Z 65 | | from app.services.gemini import GeminiClient, GeminiError, GeminiContentBlockedError
2025-11-18T07:14:11.1867490Z 66 | | from app.services.media import collect_media_parts
2025-11-18T07:14:11.1868175Z 67 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.1868804Z 68 | | from app.services.triggers import addressed_to_bot
2025-11-18T07:14:11.1869550Z 69 | | from app.services.user_profile import UserProfileStore
2025-11-18T07:14:11.1933124Z 70 | | from app.repositories.memory_repository import MemoryRepository
2025-11-18T07:14:11.1933882Z 71 | | from app.services import telemetry
2025-11-18T07:14:11.1934336Z 72 | | from app.services.context import (
2025-11-18T07:14:11.1934754Z 73 | |     MultiLevelContextManager,
2025-11-18T07:14:11.1935150Z 74 | |     HybridSearchEngine,
2025-11-18T07:14:11.1935523Z 75 | |     EpisodicMemoryStore,
2025-11-18T07:14:11.1935861Z 76 | | )
2025-11-18T07:14:11.1936256Z 77 | | from app.services.telegram_service import TelegramService
2025-11-18T07:14:11.1936860Z 78 | | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.1937584Z 79 | | from app.services.bot_learning import BotLearningEngine
2025-11-18T07:14:11.1938112Z 80 | | from app.services.rate_limiter import RateLimiter
2025-11-18T07:14:11.1938625Z 81 | | from app.handlers.bot_learning_integration import (
2025-11-18T07:14:11.1939069Z 82 | |     track_bot_interaction,
2025-11-18T07:14:11.1939400Z 83 | |     process_potential_reaction,
2025-11-18T07:14:11.1939652Z 84 | |     estimate_token_count,
2025-11-18T07:14:11.1939864Z 85 | | )
2025-11-18T07:14:11.1940086Z 86 | | from app.services.typing import typing_indicator
2025-11-18T07:14:11.1940487Z 87 | | from app.services.conversation_formatter import sanitize_placeholder_text
2025-11-18T07:14:11.1940920Z 88 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.1941267Z 89 | | from app.utils.persona_helpers import get_response
2025-11-18T07:14:11.1941560Z    | |__________________________________________________^
2025-11-18T07:14:11.1941790Z 90 |
2025-11-18T07:14:11.1941951Z 91 |   router = Router()
2025-11-18T07:14:11.1942135Z    |
2025-11-18T07:14:11.1942286Z help: Organize imports
2025-11-18T07:14:11.1942406Z 
2025-11-18T07:14:11.1942497Z F401 [*] `math` imported but unused
2025-11-18T07:14:11.1942734Z  --> app/handlers/chat.py:7:8
2025-11-18T07:14:11.1942935Z   |
2025-11-18T07:14:11.1943077Z 5 | import json
2025-11-18T07:14:11.1943250Z 6 | import logging
2025-11-18T07:14:11.1943415Z 7 | import math
2025-11-18T07:14:11.1943582Z   |        ^^^^
2025-11-18T07:14:11.1943736Z 8 | import re
2025-11-18T07:14:11.1943900Z 9 | import time
2025-11-18T07:14:11.1944055Z   |
2025-11-18T07:14:11.1944219Z help: Remove unused import: `math`
2025-11-18T07:14:11.1944374Z 
2025-11-18T07:14:11.1944545Z F401 [*] `aiogram.exceptions.TelegramBadRequest` imported but unused
2025-11-18T07:14:11.1944872Z   --> app/handlers/chat.py:18:32
2025-11-18T07:14:11.1945084Z    |
2025-11-18T07:14:11.1945242Z 16 | from aiogram import Bot, Router
2025-11-18T07:14:11.1945495Z 17 | from aiogram.enums import ParseMode
2025-11-18T07:14:11.1945789Z 18 | from aiogram.exceptions import TelegramBadRequest
2025-11-18T07:14:11.1946081Z    |                                ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1946329Z 19 | from aiogram.types import Message
2025-11-18T07:14:11.1946565Z 20 | from html import escape
2025-11-18T07:14:11.1946763Z    |
2025-11-18T07:14:11.1947264Z help: Remove unused import: `aiogram.exceptions.TelegramBadRequest`
2025-11-18T07:14:11.1947626Z 
2025-11-18T07:14:11.1947796Z F401 [*] `app.services.calculator.calculator_tool` imported but unused
2025-11-18T07:14:11.1948133Z   --> app/handlers/chat.py:24:37
2025-11-18T07:14:11.1948532Z    |
2025-11-18T07:14:11.1948698Z 22 | from app.config import Settings
2025-11-18T07:14:11.1948956Z 23 | from app.persona import SYSTEM_PERSONA
2025-11-18T07:14:11.1949330Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1949703Z    |                                     ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1950161Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1950598Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1950940Z    |
2025-11-18T07:14:11.1951097Z help: Remove unused import
2025-11-18T07:14:11.1951236Z 
2025-11-18T07:14:11.1951432Z F401 [*] `app.services.calculator.CALCULATOR_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1951803Z   --> app/handlers/chat.py:24:54
2025-11-18T07:14:11.1952005Z    |
2025-11-18T07:14:11.1952170Z 22 | from app.config import Settings
2025-11-18T07:14:11.1952416Z 23 | from app.persona import SYSTEM_PERSONA
2025-11-18T07:14:11.1952843Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1953215Z    |                                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1953561Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1954000Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1954319Z    |
2025-11-18T07:14:11.1954481Z help: Remove unused import
2025-11-18T07:14:11.1954615Z 
2025-11-18T07:14:11.1954759Z F401 [*] `app.services.weather.weather_tool` imported but unused
2025-11-18T07:14:11.1955072Z   --> app/handlers/chat.py:25:34
2025-11-18T07:14:11.1955268Z    |
2025-11-18T07:14:11.1955446Z 23 | from app.persona import SYSTEM_PERSONA
2025-11-18T07:14:11.1955806Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1956255Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1956595Z    |                                  ^^^^^^^^^^^^
2025-11-18T07:14:11.1956936Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1957625Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1957969Z    |
2025-11-18T07:14:11.1958128Z help: Remove unused import
2025-11-18T07:14:11.1958259Z 
2025-11-18T07:14:11.1958433Z F401 [*] `app.services.weather.WEATHER_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1958763Z   --> app/handlers/chat.py:25:48
2025-11-18T07:14:11.1958969Z    |
2025-11-18T07:14:11.1959135Z 23 | from app.persona import SYSTEM_PERSONA
2025-11-18T07:14:11.1959501Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1959943Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1960275Z    |                                                ^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1960616Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1961082Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1961423Z    |
2025-11-18T07:14:11.1961577Z help: Remove unused import
2025-11-18T07:14:11.1961719Z 
2025-11-18T07:14:11.1961869Z F401 [*] `app.services.currency.currency_tool` imported but unused
2025-11-18T07:14:11.1962187Z   --> app/handlers/chat.py:26:35
2025-11-18T07:14:11.1962399Z    |
2025-11-18T07:14:11.1962674Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1963121Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1963552Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1963889Z    |                                   ^^^^^^^^^^^^^
2025-11-18T07:14:11.1964242Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1964848Z 28 | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1965191Z    |
2025-11-18T07:14:11.1965343Z help: Remove unused import
2025-11-18T07:14:11.1965481Z 
2025-11-18T07:14:11.1965764Z F401 [*] `app.services.currency.CURRENCY_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1966118Z   --> app/handlers/chat.py:26:50
2025-11-18T07:14:11.1966319Z    |
2025-11-18T07:14:11.1966611Z 24 | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.1967232Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1967674Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1968013Z    |                                                  ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1968383Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1968860Z 28 | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1969208Z    |
2025-11-18T07:14:11.1969368Z help: Remove unused import
2025-11-18T07:14:11.1969501Z 
2025-11-18T07:14:11.1969667Z F401 [*] `app.services.polls.POLLS_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1969999Z   --> app/handlers/chat.py:27:44
2025-11-18T07:14:11.1970198Z    |
2025-11-18T07:14:11.1970452Z 25 | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.1970880Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1971328Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1971694Z    |                                            ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1972051Z 28 | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1972466Z 29 | from app.services.image_generation import (
2025-11-18T07:14:11.1972705Z    |
2025-11-18T07:14:11.1972954Z help: Remove unused import: `app.services.polls.POLLS_TOOL_DEFINITION`
2025-11-18T07:14:11.1973204Z 
2025-11-18T07:14:11.1973372Z F401 [*] `app.services.search_tool.search_web_tool` imported but unused
2025-11-18T07:14:11.1973691Z   --> app/handlers/chat.py:28:38
2025-11-18T07:14:11.1973893Z    |
2025-11-18T07:14:11.1974143Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1974600Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1975063Z 28 | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1975423Z    |                                      ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1975688Z 29 | from app.services.image_generation import (
2025-11-18T07:14:11.1975943Z 30 |     ImageGenerationService,
2025-11-18T07:14:11.1976147Z    |
2025-11-18T07:14:11.1976307Z help: Remove unused import
2025-11-18T07:14:11.1976444Z 
2025-11-18T07:14:11.1976639Z F401 [*] `app.services.search_tool.SEARCH_WEB_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1977180Z   --> app/handlers/chat.py:28:55
2025-11-18T07:14:11.1977394Z    |
2025-11-18T07:14:11.1977661Z 26 | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.1978126Z 27 | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION, _active_polls
2025-11-18T07:14:11.1978601Z 28 | from app.services.search_tool import search_web_tool, SEARCH_WEB_TOOL_DEFINITION
2025-11-18T07:14:11.1978964Z    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1979243Z 29 | from app.services.image_generation import (
2025-11-18T07:14:11.1979504Z 30 |     ImageGenerationService,
2025-11-18T07:14:11.1979713Z    |
2025-11-18T07:14:11.1979870Z help: Remove unused import
2025-11-18T07:14:11.1980006Z 
2025-11-18T07:14:11.1980351Z F401 [*] `app.services.image_generation.GENERATE_IMAGE_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1980738Z   --> app/handlers/chat.py:31:5
2025-11-18T07:14:11.1980943Z    |
2025-11-18T07:14:11.1981128Z 29 | from app.services.image_generation import (
2025-11-18T07:14:11.1981381Z 30 |     ImageGenerationService,
2025-11-18T07:14:11.1981708Z 31 |     GENERATE_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1981934Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1982156Z 32 |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1982379Z 33 |     QuotaExceededError,
2025-11-18T07:14:11.1982573Z    |
2025-11-18T07:14:11.1982722Z help: Remove unused import
2025-11-18T07:14:11.1982856Z 
2025-11-18T07:14:11.1983062Z F401 [*] `app.services.image_generation.EDIT_IMAGE_TOOL_DEFINITION` imported but unused
2025-11-18T07:14:11.1983434Z   --> app/handlers/chat.py:32:5
2025-11-18T07:14:11.1983627Z    |
2025-11-18T07:14:11.1983785Z 30 |     ImageGenerationService,
2025-11-18T07:14:11.1984008Z 31 |     GENERATE_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1984253Z 32 |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1984464Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1984680Z 33 |     QuotaExceededError,
2025-11-18T07:14:11.1984881Z 34 |     ImageGenerationError,
2025-11-18T07:14:11.1985074Z    |
2025-11-18T07:14:11.1985229Z help: Remove unused import
2025-11-18T07:14:11.1985360Z 
2025-11-18T07:14:11.1985549Z F401 [*] `app.services.image_generation.QuotaExceededError` imported but unused
2025-11-18T07:14:11.1985909Z   --> app/handlers/chat.py:33:5
2025-11-18T07:14:11.1986096Z    |
2025-11-18T07:14:11.1986261Z 31 |     GENERATE_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1986495Z 32 |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1986714Z 33 |     QuotaExceededError,
2025-11-18T07:14:11.1986902Z    |     ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1987288Z 34 |     ImageGenerationError,
2025-11-18T07:14:11.1987486Z 35 | )
2025-11-18T07:14:11.1987630Z    |
2025-11-18T07:14:11.1987780Z help: Remove unused import
2025-11-18T07:14:11.1987910Z 
2025-11-18T07:14:11.1988100Z F401 [*] `app.services.image_generation.ImageGenerationError` imported but unused
2025-11-18T07:14:11.1988457Z   --> app/handlers/chat.py:34:5
2025-11-18T07:14:11.1988649Z    |
2025-11-18T07:14:11.1988804Z 32 |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.1989020Z 33 |     QuotaExceededError,
2025-11-18T07:14:11.1989227Z 34 |     ImageGenerationError,
2025-11-18T07:14:11.1989421Z    |     ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1989606Z 35 | )
2025-11-18T07:14:11.1989854Z 36 | from app.services.system_prompt_manager import SystemPromptManager
2025-11-18T07:14:11.1990165Z    |
2025-11-18T07:14:11.1990319Z help: Remove unused import
2025-11-18T07:14:11.1990445Z 
2025-11-18T07:14:11.1990602Z F401 [*] `app.services.tools.remember_memory_tool` imported but unused
2025-11-18T07:14:11.1990919Z   --> app/handlers/chat.py:38:5
2025-11-18T07:14:11.1991106Z    |
2025-11-18T07:14:11.1991345Z 36 | from app.services.system_prompt_manager import SystemPromptManager
2025-11-18T07:14:11.1991679Z 37 | from app.services.tools import (
2025-11-18T07:14:11.1991911Z 38 |     remember_memory_tool,
2025-11-18T07:14:11.1992113Z    |     ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1992300Z 39 |     recall_memories_tool,
2025-11-18T07:14:11.1992491Z 40 |     forget_memory_tool,
2025-11-18T07:14:11.1992677Z    |
2025-11-18T07:14:11.1992822Z help: Remove unused import
2025-11-18T07:14:11.1992947Z 
2025-11-18T07:14:11.1993109Z F401 [*] `app.services.tools.recall_memories_tool` imported but unused
2025-11-18T07:14:11.1993417Z   --> app/handlers/chat.py:39:5
2025-11-18T07:14:11.1993607Z    |
2025-11-18T07:14:11.1993760Z 37 | from app.services.tools import (
2025-11-18T07:14:11.1993985Z 38 |     remember_memory_tool,
2025-11-18T07:14:11.1994180Z 39 |     recall_memories_tool,
2025-11-18T07:14:11.1994373Z    |     ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1994560Z 40 |     forget_memory_tool,
2025-11-18T07:14:11.1994756Z 41 |     forget_all_memories_tool,
2025-11-18T07:14:11.1995086Z    |
2025-11-18T07:14:11.1995233Z help: Remove unused import
2025-11-18T07:14:11.1995357Z 
2025-11-18T07:14:11.1995507Z F401 [*] `app.services.tools.forget_memory_tool` imported but unused
2025-11-18T07:14:11.1995810Z   --> app/handlers/chat.py:40:5
2025-11-18T07:14:11.1995996Z    |
2025-11-18T07:14:11.1996243Z 38 |     remember_memory_tool,
2025-11-18T07:14:11.1996436Z 39 |     recall_memories_tool,
2025-11-18T07:14:11.1996625Z 40 |     forget_memory_tool,
2025-11-18T07:14:11.1996811Z    |     ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1997186Z 41 |     forget_all_memories_tool,
2025-11-18T07:14:11.1997418Z 42 |     set_pronouns_tool,
2025-11-18T07:14:11.1997600Z    |
2025-11-18T07:14:11.1997746Z help: Remove unused import
2025-11-18T07:14:11.1997871Z 
2025-11-18T07:14:11.1998037Z F401 [*] `app.services.tools.forget_all_memories_tool` imported but unused
2025-11-18T07:14:11.1998356Z   --> app/handlers/chat.py:41:5
2025-11-18T07:14:11.1998547Z    |
2025-11-18T07:14:11.1998689Z 39 |     recall_memories_tool,
2025-11-18T07:14:11.1998889Z 40 |     forget_memory_tool,
2025-11-18T07:14:11.1999082Z 41 |     forget_all_memories_tool,
2025-11-18T07:14:11.1999281Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.1999481Z 42 |     set_pronouns_tool,
2025-11-18T07:14:11.1999675Z 43 |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.1999876Z    |
2025-11-18T07:14:11.2000020Z help: Remove unused import
2025-11-18T07:14:11.2000146Z 
2025-11-18T07:14:11.2000292Z F401 [*] `app.services.tools.set_pronouns_tool` imported but unused
2025-11-18T07:14:11.2000590Z   --> app/handlers/chat.py:42:5
2025-11-18T07:14:11.2000780Z    |
2025-11-18T07:14:11.2000924Z 40 |     forget_memory_tool,
2025-11-18T07:14:11.2001115Z 41 |     forget_all_memories_tool,
2025-11-18T07:14:11.2001321Z 42 |     set_pronouns_tool,
2025-11-18T07:14:11.2001502Z    |     ^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2001690Z 43 |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2001903Z 44 |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2002100Z    |
2025-11-18T07:14:11.2002243Z help: Remove unused import
2025-11-18T07:14:11.2002368Z 
2025-11-18T07:14:11.2002543Z F401 [*] `app.services.tools.REMEMBER_MEMORY_DEFINITION` imported but unused
2025-11-18T07:14:11.2002876Z   --> app/handlers/chat.py:43:5
2025-11-18T07:14:11.2003066Z    |
2025-11-18T07:14:11.2003218Z 41 |     forget_all_memories_tool,
2025-11-18T07:14:11.2003422Z 42 |     set_pronouns_tool,
2025-11-18T07:14:11.2003617Z 43 |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2003821Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2004029Z 44 |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2004238Z 45 |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2004432Z    |
2025-11-18T07:14:11.2004576Z help: Remove unused import
2025-11-18T07:14:11.2004700Z 
2025-11-18T07:14:11.2004871Z F401 [*] `app.services.tools.RECALL_MEMORIES_DEFINITION` imported but unused
2025-11-18T07:14:11.2005201Z   --> app/handlers/chat.py:44:5
2025-11-18T07:14:11.2005386Z    |
2025-11-18T07:14:11.2005532Z 42 |     set_pronouns_tool,
2025-11-18T07:14:11.2005721Z 43 |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2005935Z 44 |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2006134Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2006337Z 45 |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2006558Z 46 |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2006775Z    |
2025-11-18T07:14:11.2006924Z help: Remove unused import
2025-11-18T07:14:11.2007240Z 
2025-11-18T07:14:11.2007408Z F401 [*] `app.services.tools.FORGET_MEMORY_DEFINITION` imported but unused
2025-11-18T07:14:11.2007735Z   --> app/handlers/chat.py:45:5
2025-11-18T07:14:11.2007921Z    |
2025-11-18T07:14:11.2008067Z 43 |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2008277Z 44 |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2008486Z 45 |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2008685Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2008902Z 46 |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2009275Z 47 |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.2009467Z    |
2025-11-18T07:14:11.2009614Z help: Remove unused import
2025-11-18T07:14:11.2009745Z 
2025-11-18T07:14:11.2009926Z F401 [*] `app.services.tools.FORGET_ALL_MEMORIES_DEFINITION` imported but unused
2025-11-18T07:14:11.2010268Z   --> app/handlers/chat.py:46:5
2025-11-18T07:14:11.2010560Z    |
2025-11-18T07:14:11.2010710Z 44 |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2010920Z 45 |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2011136Z 46 |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2011357Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2011568Z 47 |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.2011763Z 48 | )
2025-11-18T07:14:11.2011899Z    |
2025-11-18T07:14:11.2012049Z help: Remove unused import
2025-11-18T07:14:11.2012172Z 
2025-11-18T07:14:11.2012334Z F401 [*] `app.services.tools.SET_PRONOUNS_DEFINITION` imported but unused
2025-11-18T07:14:11.2012658Z   --> app/handlers/chat.py:47:5
2025-11-18T07:14:11.2012847Z    |
2025-11-18T07:14:11.2012998Z 45 |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2013219Z 46 |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2013440Z 47 |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.2013641Z    |     ^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2013828Z 48 | )
2025-11-18T07:14:11.2014027Z 49 | from app.services.tools.moderation_tools import (
2025-11-18T07:14:11.2014278Z    |
2025-11-18T07:14:11.2014427Z help: Remove unused import
2025-11-18T07:14:11.2014551Z 
2025-11-18T07:14:11.2014767Z F401 [*] `app.services.tools.moderation_tools.build_tool_definitions` imported but unused
2025-11-18T07:14:11.2015147Z   --> app/handlers/chat.py:50:31
2025-11-18T07:14:11.2015344Z    |
2025-11-18T07:14:11.2015471Z 48 | )
2025-11-18T07:14:11.2015666Z 49 | from app.services.tools.moderation_tools import (
2025-11-18T07:14:11.2016005Z 50 |     build_tool_definitions as build_moderation_tool_definitions,
2025-11-18T07:14:11.2016312Z    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2016599Z 51 |     build_tool_callbacks as build_moderation_tool_callbacks,
2025-11-18T07:14:11.2016863Z 52 | )
2025-11-18T07:14:11.2017170Z    |
2025-11-18T07:14:11.2017328Z help: Remove unused import
2025-11-18T07:14:11.2017452Z 
2025-11-18T07:14:11.2017669Z F401 [*] `app.services.tools.moderation_tools.build_tool_callbacks` imported but unused
2025-11-18T07:14:11.2018038Z   --> app/handlers/chat.py:51:29
2025-11-18T07:14:11.2018233Z    |
2025-11-18T07:14:11.2018422Z 49 | from app.services.tools.moderation_tools import (
2025-11-18T07:14:11.2018753Z 50 |     build_tool_definitions as build_moderation_tool_definitions,
2025-11-18T07:14:11.2019092Z 51 |     build_tool_callbacks as build_moderation_tool_callbacks,
2025-11-18T07:14:11.2019377Z    |                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2019597Z 52 | )
2025-11-18T07:14:11.2019766Z 53 | from app.handlers.chat_tools import (
2025-11-18T07:14:11.2019986Z    |
2025-11-18T07:14:11.2020134Z help: Remove unused import
2025-11-18T07:14:11.2020256Z 
2025-11-18T07:14:11.2020444Z F401 [*] `app.handlers.chat_tools.create_search_messages_tool` imported but unused
2025-11-18T07:14:11.2020785Z   --> app/handlers/chat.py:56:5
2025-11-18T07:14:11.2020977Z    |
2025-11-18T07:14:11.2021179Z 54 |     build_tool_definitions as build_tool_definitions_registry,
2025-11-18T07:14:11.2021516Z 55 |     build_tool_callbacks as build_tool_callbacks_registry,
2025-11-18T07:14:11.2021792Z 56 |     create_search_messages_tool,
2025-11-18T07:14:11.2022002Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2022193Z 57 | )
2025-11-18T07:14:11.2022365Z 58 | from app.services.context_store import (
2025-11-18T07:14:11.2022593Z    |
2025-11-18T07:14:11.2022857Z help: Remove unused import: `app.handlers.chat_tools.create_search_messages_tool`
2025-11-18T07:14:11.2023135Z 
2025-11-18T07:14:11.2023282Z F401 [*] `app.services.context_store.TurnSender` imported but unused
2025-11-18T07:14:11.2023715Z   --> app/handlers/chat.py:61:5
2025-11-18T07:14:11.2023907Z    |
2025-11-18T07:14:11.2024047Z 59 |     ContextStore,
2025-11-18T07:14:11.2024218Z 60 |     MessageSender,
2025-11-18T07:14:11.2024432Z 61 |     TurnSender,  # Backward compatibility alias
2025-11-18T07:14:11.2024671Z    |     ^^^^^^^^^^
2025-11-18T07:14:11.2024946Z 62 |     format_metadata,
2025-11-18T07:14:11.2025137Z 63 |     format_speaker_header,
2025-11-18T07:14:11.2025326Z    |
2025-11-18T07:14:11.2025558Z help: Remove unused import: `app.services.context_store.TurnSender`
2025-11-18T07:14:11.2025802Z 
2025-11-18T07:14:11.2025883Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2026111Z    --> app/handlers/chat.py:217:1
2025-11-18T07:14:11.2026310Z     |
2025-11-18T07:14:11.2026448Z 215 |     """
2025-11-18T07:14:11.2026710Z 216 |     Check if a message from the database was addressed to the bot (a trigger).
2025-11-18T07:14:11.2027222Z 217 |     
2025-11-18T07:14:11.2027371Z     | ^^^^
2025-11-18T07:14:11.2027517Z 218 |     Args:
2025-11-18T07:14:11.2027699Z 219 |         conn: Database connection
2025-11-18T07:14:11.2027912Z     |
2025-11-18T07:14:11.2028071Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2028231Z 
2025-11-18T07:14:11.2028309Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2028531Z    --> app/handlers/chat.py:225:1
2025-11-18T07:14:11.2028733Z     |
2025-11-18T07:14:11.2028907Z 223 |         bot_username: Bot username (without @)
2025-11-18T07:14:11.2029146Z 224 |         bot_id: Bot user ID
2025-11-18T07:14:11.2029335Z 225 |         
2025-11-18T07:14:11.2029486Z     | ^^^^^^^^
2025-11-18T07:14:11.2029640Z 226 |     Returns:
2025-11-18T07:14:11.2029857Z 227 |         True if the message was a trigger, False otherwise
2025-11-18T07:14:11.2030113Z     |
2025-11-18T07:14:11.2030276Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2030447Z 
2025-11-18T07:14:11.2030527Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2030753Z    --> app/handlers/chat.py:231:1
2025-11-18T07:14:11.2030948Z     |
2025-11-18T07:14:11.2031104Z 229 |     text = message_row.get("text")
2025-11-18T07:14:11.2031459Z 230 |     reply_to_external_message_id = message_row.get("reply_to_external_message_id")
2025-11-18T07:14:11.2031794Z 231 |     
2025-11-18T07:14:11.2031930Z     | ^^^^
2025-11-18T07:14:11.2032127Z 232 |     # Check 1: If message is a reply to a bot message
2025-11-18T07:14:11.2032404Z 233 |     if reply_to_external_message_id:
2025-11-18T07:14:11.2032617Z     |
2025-11-18T07:14:11.2032777Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2032935Z 
2025-11-18T07:14:11.2033007Z W291 Trailing whitespace
2025-11-18T07:14:11.2033209Z    --> app/handlers/chat.py:238:57
2025-11-18T07:14:11.2033406Z     |
2025-11-18T07:14:11.2033555Z 236 |             reply_query = """
2025-11-18T07:14:11.2033777Z 237 |                 SELECT role FROM messages
2025-11-18T07:14:11.2034041Z 238 |                 WHERE chat_id = $1 AND thread_id IS NULL 
2025-11-18T07:14:11.2034303Z     |                                                         ^
2025-11-18T07:14:11.2034549Z 239 |                 AND external_message_id = $2
2025-11-18T07:14:11.2034786Z 240 |                 LIMIT 1
2025-11-18T07:14:11.2034964Z     |
2025-11-18T07:14:11.2035123Z help: Remove trailing whitespace
2025-11-18T07:14:11.2035264Z 
2025-11-18T07:14:11.2035339Z W291 Trailing whitespace
2025-11-18T07:14:11.2035536Z    --> app/handlers/chat.py:246:54
2025-11-18T07:14:11.2035732Z     |
2025-11-18T07:14:11.2035879Z 244 |             reply_query = """
2025-11-18T07:14:11.2036102Z 245 |                 SELECT role FROM messages
2025-11-18T07:14:11.2036364Z 246 |                 WHERE chat_id = $1 AND thread_id = $2 
2025-11-18T07:14:11.2036623Z     |                                                      ^
2025-11-18T07:14:11.2036862Z 247 |                 AND external_message_id = $3
2025-11-18T07:14:11.2037203Z 248 |                 LIMIT 1
2025-11-18T07:14:11.2037380Z     |
2025-11-18T07:14:11.2037533Z help: Remove trailing whitespace
2025-11-18T07:14:11.2037806Z 
2025-11-18T07:14:11.2037887Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2038216Z    --> app/handlers/chat.py:251:1
2025-11-18T07:14:11.2038418Z     |
2025-11-18T07:14:11.2038558Z 249 |             """
2025-11-18T07:14:11.2038822Z 250 |             reply_params = (chat_id, thread_id, reply_to_external_message_id)
2025-11-18T07:14:11.2039229Z 251 |         
2025-11-18T07:14:11.2039382Z     | ^^^^^^^^
2025-11-18T07:14:11.2039612Z 252 |         reply_row = await conn.fetchrow(reply_query, *reply_params)
2025-11-18T07:14:11.2039954Z 253 |         if reply_row and reply_row.get("role") == "model":
2025-11-18T07:14:11.2040204Z     |
2025-11-18T07:14:11.2040366Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2040522Z 
2025-11-18T07:14:11.2040605Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2040828Z    --> app/handlers/chat.py:255:1
2025-11-18T07:14:11.2041029Z     |
2025-11-18T07:14:11.2041214Z 253 |         if reply_row and reply_row.get("role") == "model":
2025-11-18T07:14:11.2041482Z 254 |             return True
2025-11-18T07:14:11.2041664Z 255 |     
2025-11-18T07:14:11.2041807Z     | ^^^^
2025-11-18T07:14:11.2042195Z 256 |     # Check 2: If text contains trigger keywords (гряг, gryag, etc.)
2025-11-18T07:14:11.2042483Z 257 |     if text:
2025-11-18T07:14:11.2042647Z     |
2025-11-18T07:14:11.2042806Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2042962Z 
2025-11-18T07:14:11.2043047Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2043269Z    --> app/handlers/chat.py:264:1
2025-11-18T07:14:11.2043468Z     |
2025-11-18T07:14:11.2043635Z 262 |         if trigger_pattern.search(text):
2025-11-18T07:14:11.2043874Z 263 |             return True
2025-11-18T07:14:11.2044056Z 264 |         
2025-11-18T07:14:11.2044211Z     | ^^^^^^^^
2025-11-18T07:14:11.2044403Z 265 |         # Check 3: If text contains @mention of bot
2025-11-18T07:14:11.2044654Z 266 |         if bot_username:
2025-11-18T07:14:11.2044839Z     |
2025-11-18T07:14:11.2045007Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2045160Z 
2025-11-18T07:14:11.2045244Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2045470Z    --> app/handlers/chat.py:274:1
2025-11-18T07:14:11.2045670Z     |
2025-11-18T07:14:11.2045838Z 272 |             if mention_pattern.search(text):
2025-11-18T07:14:11.2046086Z 273 |                 return True
2025-11-18T07:14:11.2046278Z 274 |     
2025-11-18T07:14:11.2046415Z     | ^^^^
2025-11-18T07:14:11.2046653Z 275 |     # Check 4: In personal chats (chat_id > 0), all messages are triggers
2025-11-18T07:14:11.2047141Z 276 |     if chat_id > 0:
2025-11-18T07:14:11.2047346Z     |
2025-11-18T07:14:11.2047513Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2047683Z 
2025-11-18T07:14:11.2047764Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2047995Z    --> app/handlers/chat.py:278:1
2025-11-18T07:14:11.2048199Z     |
2025-11-18T07:14:11.2048344Z 276 |     if chat_id > 0:
2025-11-18T07:14:11.2048532Z 277 |         return True
2025-11-18T07:14:11.2048704Z 278 |     
2025-11-18T07:14:11.2048844Z     | ^^^^
2025-11-18T07:14:11.2048989Z 279 |     return False
2025-11-18T07:14:11.2049152Z     |
2025-11-18T07:14:11.2049319Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2049479Z 
2025-11-18T07:14:11.2049560Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2049789Z    --> app/handlers/chat.py:294:1
2025-11-18T07:14:11.2049985Z     |
2025-11-18T07:14:11.2050132Z 292 |     """
2025-11-18T07:14:11.2050342Z 293 |     Get skip count and last skip timestamp for a user.
2025-11-18T07:14:11.2050604Z 294 |     
2025-11-18T07:14:11.2050757Z     | ^^^^
2025-11-18T07:14:11.2050898Z 295 |     Returns:
2025-11-18T07:14:11.2051095Z 296 |         Tuple of (skip_count, last_skip_ts)
2025-11-18T07:14:11.2051325Z     |
2025-11-18T07:14:11.2051495Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2051501Z 
2025-11-18T07:14:11.2051581Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2051791Z    --> app/handlers/chat.py:300:1
2025-11-18T07:14:11.2051852Z     |
2025-11-18T07:14:11.2051926Z 298 |     lock_key = (chat_id, user_id)
2025-11-18T07:14:11.2052048Z 299 |     redis_key = f"gryag:skip_count:{chat_id}:{user_id}"
2025-11-18T07:14:11.2052108Z 300 |     
2025-11-18T07:14:11.2052164Z     | ^^^^
2025-11-18T07:14:11.2052388Z 301 |     # Try Redis first if available
2025-11-18T07:14:11.2052468Z 302 |     if redis_client is not None:
2025-11-18T07:14:11.2052528Z     |
2025-11-18T07:14:11.2052645Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2052651Z 
2025-11-18T07:14:11.2052730Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2052812Z    --> app/handlers/chat.py:310:1
2025-11-18T07:14:11.2052870Z     |
2025-11-18T07:14:11.2052946Z 308 |         except Exception:
2025-11-18T07:14:11.2053157Z 309 |             LOGGER.debug(f"Failed to get skip count from Redis for {lock_key}, using fallback")
2025-11-18T07:14:11.2053224Z 310 |     
2025-11-18T07:14:11.2053282Z     | ^^^^
2025-11-18T07:14:11.2053363Z 311 |     # Fallback to in-memory
2025-11-18T07:14:11.2053474Z 312 |     return _skip_counters.get(lock_key, (0, 0))
2025-11-18T07:14:11.2053532Z     |
2025-11-18T07:14:11.2053616Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2053622Z 
2025-11-18T07:14:11.2053703Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2053784Z    --> app/handlers/chat.py:322:1
2025-11-18T07:14:11.2053842Z     |
2025-11-18T07:14:11.2053900Z 320 |     """
2025-11-18T07:14:11.2053990Z 321 |     Increment skip count for a user.
2025-11-18T07:14:11.2054049Z 322 |     
2025-11-18T07:14:11.2054107Z     | ^^^^
2025-11-18T07:14:11.2054172Z 323 |     Returns:
2025-11-18T07:14:11.2054243Z 324 |         New skip count
2025-11-18T07:14:11.2054301Z     |
2025-11-18T07:14:11.2054384Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2054394Z 
2025-11-18T07:14:11.2054470Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2054547Z    --> app/handlers/chat.py:329:1
2025-11-18T07:14:11.2054608Z     |
2025-11-18T07:14:11.2054728Z 327 |     redis_key = f"gryag:skip_count:{chat_id}:{user_id}"
2025-11-18T07:14:11.2054806Z 328 |     current_ts = int(time.time())
2025-11-18T07:14:11.2054864Z 329 |     
2025-11-18T07:14:11.2054921Z     | ^^^^
2025-11-18T07:14:11.2055002Z 330 |     # Try Redis first if available
2025-11-18T07:14:11.2055084Z 331 |     if redis_client is not None:
2025-11-18T07:14:11.2055142Z     |
2025-11-18T07:14:11.2055233Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2055238Z 
2025-11-18T07:14:11.2055316Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2055392Z    --> app/handlers/chat.py:339:1
2025-11-18T07:14:11.2055453Z     |
2025-11-18T07:14:11.2055518Z 337 |             else:
2025-11-18T07:14:11.2055585Z 338 |                 count = 1
2025-11-18T07:14:11.2055645Z 339 |             
2025-11-18T07:14:11.2055709Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2055829Z 340 |             data = {"count": count, "last_skip_ts": current_ts}
2025-11-18T07:14:11.2056090Z 341 |             await redis_client.setex(redis_key, UNANSWERED_TRIGGER_THRESHOLD_SECONDS + 10, json.dumps(data))
2025-11-18T07:14:11.2056156Z     |
2025-11-18T07:14:11.2056241Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2056246Z 
2025-11-18T07:14:11.2056325Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2056409Z    --> app/handlers/chat.py:345:1
2025-11-18T07:14:11.2056465Z     |
2025-11-18T07:14:11.2056536Z 343 |         except Exception:
2025-11-18T07:14:11.2056756Z 344 |             LOGGER.debug(f"Failed to increment skip count in Redis for {lock_key}, using fallback")
2025-11-18T07:14:11.2056818Z 345 |     
2025-11-18T07:14:11.2056878Z     | ^^^^
2025-11-18T07:14:11.2057051Z 346 |     # Fallback to in-memory
2025-11-18T07:14:11.2057194Z 347 |     current_count, _ = _skip_counters.get(lock_key, (0, 0))
2025-11-18T07:14:11.2057253Z     |
2025-11-18T07:14:11.2057339Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2057344Z 
2025-11-18T07:14:11.2057545Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2057626Z    --> app/handlers/chat.py:361:1
2025-11-18T07:14:11.2057685Z     |
2025-11-18T07:14:11.2057763Z 359 |     lock_key = (chat_id, user_id)
2025-11-18T07:14:11.2057887Z 360 |     redis_key = f"gryag:skip_count:{chat_id}:{user_id}"
2025-11-18T07:14:11.2058051Z 361 |     
2025-11-18T07:14:11.2058112Z     | ^^^^
2025-11-18T07:14:11.2058199Z 362 |     # Try Redis first if available
2025-11-18T07:14:11.2058279Z 363 |     if redis_client is not None:
2025-11-18T07:14:11.2058336Z     |
2025-11-18T07:14:11.2058419Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2058430Z 
2025-11-18T07:14:11.2058507Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2058585Z    --> app/handlers/chat.py:369:1
2025-11-18T07:14:11.2058644Z     |
2025-11-18T07:14:11.2058720Z 367 |         except Exception:
2025-11-18T07:14:11.2058925Z 368 |             LOGGER.debug(f"Failed to reset skip count in Redis for {lock_key}, using fallback")
2025-11-18T07:14:11.2058990Z 369 |     
2025-11-18T07:14:11.2059052Z     | ^^^^
2025-11-18T07:14:11.2059126Z 370 |     # Fallback to in-memory
2025-11-18T07:14:11.2059221Z 371 |     _skip_counters.pop(lock_key, None)
2025-11-18T07:14:11.2059279Z     |
2025-11-18T07:14:11.2059370Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2059379Z 
2025-11-18T07:14:11.2059459Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2059538Z    --> app/handlers/chat.py:386:1
2025-11-18T07:14:11.2059598Z     |
2025-11-18T07:14:11.2059741Z 385 |     Returns True if message should be skipped, False otherwise.
2025-11-18T07:14:11.2059800Z 386 |     
2025-11-18T07:14:11.2059862Z     | ^^^^
2025-11-18T07:14:11.2060045Z 387 |     This function handles race conditions where a bot response may have been
2025-11-18T07:14:11.2060215Z 388 |     saved to the database but isn't yet visible to this connection. It uses:
2025-11-18T07:14:11.2060274Z     |
2025-11-18T07:14:11.2060363Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2060372Z 
2025-11-18T07:14:11.2060453Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2060530Z    --> app/handlers/chat.py:395:1
2025-11-18T07:14:11.2060590Z     |
2025-11-18T07:14:11.2060648Z 393 |     """
2025-11-18T07:14:11.2060726Z 394 |     current_ts = int(time.time())
2025-11-18T07:14:11.2060783Z 395 |     
2025-11-18T07:14:11.2060847Z     | ^^^^
2025-11-18T07:14:11.2060943Z 396 |     # Get Redis client from data if available
2025-11-18T07:14:11.2061039Z 397 |     redis_client = data.get("redis_client")
2025-11-18T07:14:11.2061101Z     |
2025-11-18T07:14:11.2061185Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2061190Z 
2025-11-18T07:14:11.2061268Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2061348Z    --> app/handlers/chat.py:398:1
2025-11-18T07:14:11.2061408Z     |
2025-11-18T07:14:11.2061501Z 396 |     # Get Redis client from data if available
2025-11-18T07:14:11.2061595Z 397 |     redis_client = data.get("redis_client")
2025-11-18T07:14:11.2061664Z 398 |     
2025-11-18T07:14:11.2061723Z     | ^^^^
2025-11-18T07:14:11.2061856Z 399 |     # Get current skip count and check if we should override
2025-11-18T07:14:11.2062056Z 400 |     skip_count, last_skip_ts = await _get_skip_count(chat_id, user_id, redis_client)
2025-11-18T07:14:11.2062117Z     |
2025-11-18T07:14:11.2062206Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2062212Z 
2025-11-18T07:14:11.2062295Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2062370Z    --> app/handlers/chat.py:401:1
2025-11-18T07:14:11.2062428Z     |
2025-11-18T07:14:11.2062553Z 399 |     # Get current skip count and check if we should override
2025-11-18T07:14:11.2062739Z 400 |     skip_count, last_skip_ts = await _get_skip_count(chat_id, user_id, redis_client)
2025-11-18T07:14:11.2062798Z 401 |     
2025-11-18T07:14:11.2062854Z     | ^^^^
2025-11-18T07:14:11.2063028Z 402 |     # Reset skip count if it's been more than threshold_seconds since last skip
2025-11-18T07:14:11.2063190Z 403 |     if last_skip_ts > 0 and (current_ts - last_skip_ts) > threshold_seconds:
2025-11-18T07:14:11.2063333Z     |
2025-11-18T07:14:11.2063423Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2063429Z 
2025-11-18T07:14:11.2063508Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2063585Z    --> app/handlers/chat.py:409:1
2025-11-18T07:14:11.2063715Z     |
2025-11-18T07:14:11.2063904Z 407 |             f"Reset skip count for user {user_id} in chat {chat_id} (threshold exceeded)"
2025-11-18T07:14:11.2063966Z 408 |         )
2025-11-18T07:14:11.2064025Z 409 |     
2025-11-18T07:14:11.2064087Z     | ^^^^
2025-11-18T07:14:11.2064243Z 410 |     # Allow message if we've already skipped MAX_SKIP_ATTEMPTS times
2025-11-18T07:14:11.2064338Z 411 |     if skip_count >= MAX_SKIP_ATTEMPTS:
2025-11-18T07:14:11.2064397Z     |
2025-11-18T07:14:11.2064484Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2064489Z 
2025-11-18T07:14:11.2064568Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2064652Z    --> app/handlers/chat.py:437:1
2025-11-18T07:14:11.2064712Z     |
2025-11-18T07:14:11.2064770Z 435 |         """
2025-11-18T07:14:11.2064947Z 436 |         Check for bot responses after user message using both ID and timestamp.
2025-11-18T07:14:11.2065014Z 437 |         
2025-11-18T07:14:11.2065073Z     | ^^^^^^^^
2025-11-18T07:14:11.2065184Z 438 |         Returns the count of bot responses found.
2025-11-18T07:14:11.2065245Z 439 |         """
2025-11-18T07:14:11.2065308Z     |
2025-11-18T07:14:11.2065391Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2065396Z 
2025-11-18T07:14:11.2065468Z W291 Trailing whitespace
2025-11-18T07:14:11.2065555Z    --> app/handlers/chat.py:469:57
2025-11-18T07:14:11.2065614Z     |
2025-11-18T07:14:11.2065685Z 467 |             ts_query = """
2025-11-18T07:14:11.2065791Z 468 |                 SELECT COUNT(*) as count FROM messages
2025-11-18T07:14:11.2065896Z 469 |                 WHERE chat_id = $1 AND thread_id IS NULL 
2025-11-18T07:14:11.2065975Z     |                                                         ^
2025-11-18T07:14:11.2066086Z 470 |                 AND ts >= $2 AND role = 'model' AND id != $3
2025-11-18T07:14:11.2066161Z 471 |                 LIMIT 1
2025-11-18T07:14:11.2066219Z     |
2025-11-18T07:14:11.2066298Z help: Remove trailing whitespace
2025-11-18T07:14:11.2066306Z 
2025-11-18T07:14:11.2066384Z W291 Trailing whitespace
2025-11-18T07:14:11.2066463Z    --> app/handlers/chat.py:477:54
2025-11-18T07:14:11.2066520Z     |
2025-11-18T07:14:11.2066592Z 475 |             ts_query = """
2025-11-18T07:14:11.2066690Z 476 |                 SELECT COUNT(*) as count FROM messages
2025-11-18T07:14:11.2066784Z 477 |                 WHERE chat_id = $1 AND thread_id = $2 
2025-11-18T07:14:11.2066860Z     |                                                      ^
2025-11-18T07:14:11.2067066Z 478 |                 AND ts >= $3 AND role = 'model' AND id != $4
2025-11-18T07:14:11.2067136Z 479 |                 LIMIT 1
2025-11-18T07:14:11.2067194Z     |
2025-11-18T07:14:11.2067282Z help: Remove trailing whitespace
2025-11-18T07:14:11.2067287Z 
2025-11-18T07:14:11.2067368Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2067445Z    --> app/handlers/chat.py:539:1
2025-11-18T07:14:11.2067506Z     |
2025-11-18T07:14:11.2067575Z 537 |                     bot_id,
2025-11-18T07:14:11.2067642Z 538 |                 )
2025-11-18T07:14:11.2067704Z 539 |                 
2025-11-18T07:14:11.2067770Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2067851Z 540 |                 if not was_trigger:
2025-11-18T07:14:11.2068002Z 541 |                     # Previous message was NOT a trigger - allow this message
2025-11-18T07:14:11.2068062Z     |
2025-11-18T07:14:11.2068147Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2068153Z 
2025-11-18T07:14:11.2068233Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2068311Z    --> app/handlers/chat.py:554:1
2025-11-18T07:14:11.2068374Z     |
2025-11-18T07:14:11.2068509Z 552 |                     await _reset_skip_count(chat_id, user_id, redis_client)
2025-11-18T07:14:11.2068699Z 553 |                     return False
2025-11-18T07:14:11.2068767Z 554 |                 
2025-11-18T07:14:11.2068831Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2069025Z 555 |                 # Previous message WAS a trigger - proceed with checking if it was answered
2025-11-18T07:14:11.2069295Z 556 |                 # Check if the unanswered trigger is recent enough to still block
2025-11-18T07:14:11.2069353Z     |
2025-11-18T07:14:11.2069440Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2069445Z 
2025-11-18T07:14:11.2069614Z F841 Local variable `model_embedding_time` is assigned to but never used
2025-11-18T07:14:11.2069702Z     --> app/handlers/chat.py:1202:5
2025-11-18T07:14:11.2069763Z      |
2025-11-18T07:14:11.2069858Z 1200 |     model_embedding_start = time.time()
2025-11-18T07:14:11.2070034Z 1201 |     model_embedding = await ctx.gemini_client.embed_text(reply_trimmed)
2025-11-18T07:14:11.2070212Z 1202 |     model_embedding_time = int((time.time() - model_embedding_start) * 1000)
2025-11-18T07:14:11.2070282Z      |     ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2070344Z 1203 |
2025-11-18T07:14:11.2070421Z 1204 |     db_save_start = time.time()
2025-11-18T07:14:11.2070478Z      |
2025-11-18T07:14:11.2070629Z help: Remove assignment to unused variable `model_embedding_time`
2025-11-18T07:14:11.2070641Z 
2025-11-18T07:14:11.2070719Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2070796Z     --> app/handlers/chat.py:1539:1
2025-11-18T07:14:11.2070853Z      |
2025-11-18T07:14:11.2070917Z 1537 |     """
2025-11-18T07:14:11.2071059Z 1538 |     Extract MIME type from a media item in Gemini API format.
2025-11-18T07:14:11.2071119Z 1539 |     
2025-11-18T07:14:11.2071182Z      | ^^^^
2025-11-18T07:14:11.2071259Z 1540 |     Supports both formats:
2025-11-18T07:14:11.2071438Z 1541 |     - New format: {"inline_data": {...}, "mime": "video/mp4", "kind": "video"}
2025-11-18T07:14:11.2071497Z      |
2025-11-18T07:14:11.2071587Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2071596Z 
2025-11-18T07:14:11.2071679Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2071760Z     --> app/handlers/chat.py:1544:1
2025-11-18T07:14:11.2071829Z      |
2025-11-18T07:14:11.2071985Z 1542 |     - Legacy format: {"inline_data": {"mime_type": "video/mp4", ...}}
2025-11-18T07:14:11.2072155Z 1543 |     - File URI format: {"file_data": {"file_uri": "..."}, "mime": "video/mp4"}
2025-11-18T07:14:11.2072218Z 1544 |     
2025-11-18T07:14:11.2072276Z      | ^^^^
2025-11-18T07:14:11.2072413Z 1545 |     Returns empty string if MIME type cannot be determined.
2025-11-18T07:14:11.2072471Z 1546 |     """
2025-11-18T07:14:11.2072534Z      |
2025-11-18T07:14:11.2072618Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2072623Z 
2025-11-18T07:14:11.2072702Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2072785Z     --> app/handlers/chat.py:1551:1
2025-11-18T07:14:11.2072842Z      |
2025-11-18T07:14:11.2072905Z 1549 |     if mime:
2025-11-18T07:14:11.2072978Z 1550 |         return mime
2025-11-18T07:14:11.2073045Z 1551 |     
2025-11-18T07:14:11.2073103Z      | ^^^^
2025-11-18T07:14:11.2073204Z 1552 |     # Fallback: check inline_data.mime_type
2025-11-18T07:14:11.2073328Z 1553 |     inline_data = media_item.get("inline_data", {})
2025-11-18T07:14:11.2073391Z      |
2025-11-18T07:14:11.2073475Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2073480Z 
2025-11-18T07:14:11.2073560Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2073640Z     --> app/handlers/chat.py:1558:1
2025-11-18T07:14:11.2073697Z      |
2025-11-18T07:14:11.2073762Z 1556 |         if mime:
2025-11-18T07:14:11.2073838Z 1557 |             return mime
2025-11-18T07:14:11.2073897Z 1558 |     
2025-11-18T07:14:11.2073954Z      | ^^^^
2025-11-18T07:14:11.2074140Z 1559 |     # Fallback: check file_data.file_uri (YouTube URLs are typically video/mp4)
2025-11-18T07:14:11.2074245Z 1560 |     file_data = media_item.get("file_data", {})
2025-11-18T07:14:11.2074387Z      |
2025-11-18T07:14:11.2074470Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2074478Z 
2025-11-18T07:14:11.2074556Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2074634Z     --> app/handlers/chat.py:1565:1
2025-11-18T07:14:11.2074692Z      |
2025-11-18T07:14:11.2074920Z 1563 |         if "youtube.com" in file_data.get("file_uri", "") or "youtu.be" in file_data.get("file_uri", ""):
2025-11-18T07:14:11.2075071Z 1564 |             return "video/mp4"
2025-11-18T07:14:11.2075130Z 1565 |     
2025-11-18T07:14:11.2075197Z      | ^^^^
2025-11-18T07:14:11.2075262Z 1566 |     return ""
2025-11-18T07:14:11.2075323Z      |
2025-11-18T07:14:11.2075411Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2075417Z 
2025-11-18T07:14:11.2075499Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2075575Z     --> app/handlers/chat.py:1609:1
2025-11-18T07:14:11.2075632Z      |
2025-11-18T07:14:11.2075695Z 1607 |     """
2025-11-18T07:14:11.2075869Z 1608 |     Deduplicate media items by content (base64 data hash or file_uri).
2025-11-18T07:14:11.2075932Z 1609 |     
2025-11-18T07:14:11.2075991Z      | ^^^^
2025-11-18T07:14:11.2076088Z 1610 |     Uses a more robust key generation:
2025-11-18T07:14:11.2076271Z 1611 |     - For inline_data: hash of full base64 data + mime_type for better uniqueness
2025-11-18T07:14:11.2076334Z      |
2025-11-18T07:14:11.2076419Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2076424Z 
2025-11-18T07:14:11.2076573Z F841 Local variable `summary_parts` is assigned to but never used
2025-11-18T07:14:11.2076651Z     --> app/handlers/chat.py:2441:5
2025-11-18T07:14:11.2076715Z      |
2025-11-18T07:14:11.2076820Z 2440 |     # Create a simple summary of older context
2025-11-18T07:14:11.2076895Z 2441 |     summary_parts = []
2025-11-18T07:14:11.2077054Z      |     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2077129Z 2442 |     user_count = 0
2025-11-18T07:14:11.2077201Z 2443 |     model_count = 0
2025-11-18T07:14:11.2077260Z      |
2025-11-18T07:14:11.2077401Z help: Remove assignment to unused variable `summary_parts`
2025-11-18T07:14:11.2077407Z 
2025-11-18T07:14:11.2077488Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2077566Z     --> app/handlers/chat.py:2921:1
2025-11-18T07:14:11.2077630Z      |
2025-11-18T07:14:11.2077819Z 2919 |     media_parts = ctx.gemini_client.build_media_parts(media_raw, logger=LOGGER)
2025-11-18T07:14:11.2077930Z 2920 |     media_parts_after_filter = len(media_parts)
2025-11-18T07:14:11.2077991Z 2921 |     
2025-11-18T07:14:11.2078056Z      | ^^^^
2025-11-18T07:14:11.2078147Z 2922 |     # Check if media was filtered out
2025-11-18T07:14:11.2078332Z 2923 |     filtered_media_count = media_parts_before_filter - media_parts_after_filter
2025-11-18T07:14:11.2078397Z      |
2025-11-18T07:14:11.2078481Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2078487Z 
2025-11-18T07:14:11.2078567Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2078647Z     --> app/handlers/chat.py:2924:1
2025-11-18T07:14:11.2078707Z      |
2025-11-18T07:14:11.2078793Z 2922 |     # Check if media was filtered out
2025-11-18T07:14:11.2078973Z 2923 |     filtered_media_count = media_parts_before_filter - media_parts_after_filter
2025-11-18T07:14:11.2079036Z 2924 |     
2025-11-18T07:14:11.2079095Z      | ^^^^
2025-11-18T07:14:11.2079212Z 2925 |     # Check if media was expected but not collected
2025-11-18T07:14:11.2079294Z 2926 |     has_expected_media = (
2025-11-18T07:14:11.2079352Z      |
2025-11-18T07:14:11.2079436Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2079442Z 
2025-11-18T07:14:11.2079522Z W291 [*] Trailing whitespace
2025-11-18T07:14:11.2079604Z     --> app/handlers/chat.py:2934:72
2025-11-18T07:14:11.2079663Z      |
2025-11-18T07:14:11.2079740Z 2932 |         or ctx.message.audio
2025-11-18T07:14:11.2079831Z 2933 |         or ctx.message.video_note
2025-11-18T07:14:11.2080002Z 2934 |         or (ctx.message.document and ctx.message.document.mime_type and 
2025-11-18T07:14:11.2080090Z      |                                                                        ^
2025-11-18T07:14:11.2080416Z 2935 |             ctx.message.document.mime_type.startswith(("image/", "audio/", "video/")))
2025-11-18T07:14:11.2080477Z 2936 |     )
2025-11-18T07:14:11.2080535Z      |
2025-11-18T07:14:11.2080616Z help: Remove trailing whitespace
2025-11-18T07:14:11.2080724Z 
2025-11-18T07:14:11.2080805Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2080885Z     --> app/handlers/chat.py:2937:1
2025-11-18T07:14:11.2080943Z      |
2025-11-18T07:14:11.2081137Z 2935 |             ctx.message.document.mime_type.startswith(("image/", "audio/", "video/")))
2025-11-18T07:14:11.2081200Z 2936 |     )
2025-11-18T07:14:11.2081259Z 2937 |     
2025-11-18T07:14:11.2081320Z      | ^^^^
2025-11-18T07:14:11.2081428Z 2938 |     # Build user-facing error messages if needed
2025-11-18T07:14:11.2081508Z 2939 |     media_error_messages = []
2025-11-18T07:14:11.2081568Z      |
2025-11-18T07:14:11.2081659Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2081668Z 
2025-11-18T07:14:11.2081748Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2081827Z     --> app/handlers/chat.py:3441:1
2025-11-18T07:14:11.2081889Z      |
2025-11-18T07:14:11.2081955Z 3439 |             else:
2025-11-18T07:14:11.2082090Z 3440 |                 full_conversation = conversation_text or "[RESPOND]"
2025-11-18T07:14:11.2082161Z 3441 |             
2025-11-18T07:14:11.2082222Z      | ^^^^^^^^^^^^
2025-11-18T07:14:11.2082322Z 3442 |             # Add media error messages if any
2025-11-18T07:14:11.2082407Z 3443 |             if media_error_messages:
2025-11-18T07:14:11.2082470Z      |
2025-11-18T07:14:11.2082553Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2082559Z 
2025-11-18T07:14:11.2082638Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2082719Z     --> app/handlers/chat.py:3492:1
2025-11-18T07:14:11.2082775Z      |
2025-11-18T07:14:11.2083064Z 3490 |                     "Using reply_media_parts_for_block as fallback for compact format (reply_context_for_history has no media)"
2025-11-18T07:14:11.2083134Z 3491 |                 )
2025-11-18T07:14:11.2083195Z 3492 |             
2025-11-18T07:14:11.2083254Z      | ^^^^^^^^^^^^
2025-11-18T07:14:11.2083335Z 3493 |             if reply_media_source:
2025-11-18T07:14:11.2083498Z 3494 |                 # Phase 1: Check if reply message is already in historical_media
2025-11-18T07:14:11.2083556Z      |
2025-11-18T07:14:11.2083641Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2083647Z 
2025-11-18T07:14:11.2083729Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2083808Z     --> app/handlers/chat.py:3547:1
2025-11-18T07:14:11.2083867Z      |
2025-11-18T07:14:11.2083942Z 3545 |                             continue
2025-11-18T07:14:11.2084060Z 3546 |                         valid_reply_media.append(media_item)
2025-11-18T07:14:11.2084127Z 3547 |                     
2025-11-18T07:14:11.2084191Z      | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2084288Z 3548 |                     if invalid_count > 0:
2025-11-18T07:14:11.2084498Z 3549 |                         telemetry.increment_counter("context.reply_media_invalid", invalid_count)
2025-11-18T07:14:11.2084557Z      |
2025-11-18T07:14:11.2084644Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2084652Z 
2025-11-18T07:14:11.2084732Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2084810Z     --> app/handlers/chat.py:3553:1
2025-11-18T07:14:11.2084870Z      |
2025-11-18T07:14:11.2085073Z 3551 |                             "Filtered out %d invalid reply media item(s) in compact format", invalid_count
2025-11-18T07:14:11.2085141Z 3552 |                         )
2025-11-18T07:14:11.2085207Z 3553 |                     
2025-11-18T07:14:11.2085277Z      | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2085382Z 3554 |                     if not valid_reply_media:
2025-11-18T07:14:11.2085541Z 3555 |                         LOGGER.warning(
2025-11-18T07:14:11.2085650Z      |
2025-11-18T07:14:11.2085871Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2085878Z 
2025-11-18T07:14:11.2085971Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2086056Z     --> app/handlers/chat.py:3886:1
2025-11-18T07:14:11.2086121Z      |
2025-11-18T07:14:11.2086369Z 3884 |                     "Using reply_media_parts_for_block for JSON format (reply_context_for_history has no media)"
2025-11-18T07:14:11.2086512Z 3885 |                 )
2025-11-18T07:14:11.2086577Z 3886 |             
2025-11-18T07:14:11.2086637Z      | ^^^^^^^^^^^^
2025-11-18T07:14:11.2086711Z 3887 |             if reply_media:
2025-11-18T07:14:11.2086836Z 3888 |                 # Validate media format before processing
2025-11-18T07:14:11.2086897Z      |
2025-11-18T07:14:11.2087098Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2087106Z 
2025-11-18T07:14:11.2087187Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2087273Z     --> app/handlers/chat.py:3906:1
2025-11-18T07:14:11.2087332Z      |
2025-11-18T07:14:11.2087405Z 3904 |                         continue
2025-11-18T07:14:11.2087521Z 3905 |                     valid_reply_media.append(media_item)
2025-11-18T07:14:11.2087586Z 3906 |                 
2025-11-18T07:14:11.2087649Z      | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2087735Z 3907 |                 if invalid_count > 0:
2025-11-18T07:14:11.2087951Z 3908 |                     telemetry.increment_counter("context.reply_media_invalid", invalid_count)
2025-11-18T07:14:11.2088009Z      |
2025-11-18T07:14:11.2088093Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2088099Z 
2025-11-18T07:14:11.2088181Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2088259Z     --> app/handlers/chat.py:3912:1
2025-11-18T07:14:11.2088315Z      |
2025-11-18T07:14:11.2088474Z 3910 |                         "Filtered out %d invalid reply media item(s)", invalid_count
2025-11-18T07:14:11.2088541Z 3911 |                     )
2025-11-18T07:14:11.2088603Z 3912 |                 
2025-11-18T07:14:11.2088672Z      | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2088762Z 3913 |                 if not valid_reply_media:
2025-11-18T07:14:11.2088848Z 3914 |                     LOGGER.warning(
2025-11-18T07:14:11.2088907Z      |
2025-11-18T07:14:11.2088997Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2089002Z 
2025-11-18T07:14:11.2089085Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2089163Z     --> app/handlers/chat.py:3985:1
2025-11-18T07:14:11.2089226Z      |
2025-11-18T07:14:11.2089332Z 3983 |                                     key[:80] if len(key) > 80 else key,
2025-11-18T07:14:11.2089404Z 3984 |                                 )
2025-11-18T07:14:11.2089473Z 3985 |                         
2025-11-18T07:14:11.2089544Z      | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2089643Z 3986 |                         if duplicate_count > 0:
2025-11-18T07:14:11.2089730Z 3987 |                             LOGGER.info(
2025-11-18T07:14:11.2089792Z      |
2025-11-18T07:14:11.2089876Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2089885Z 
2025-11-18T07:14:11.2090031Z F841 Local variable `fallback_text` is assigned to but never used
2025-11-18T07:14:11.2090113Z     --> app/handlers/chat.py:4284:5
2025-11-18T07:14:11.2090171Z      |
2025-11-18T07:14:11.2090301Z 4282 |     tool_definitions = context_result["tool_definitions"]
2025-11-18T07:14:11.2090399Z 4283 |     raw_text = context_result["raw_text"]
2025-11-18T07:14:11.2090521Z 4284 |     fallback_text = context_result["fallback_text"]
2025-11-18T07:14:11.2090590Z      |     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2090767Z 4285 |     reply_context_for_history = context_result["reply_context_for_history"]
2025-11-18T07:14:11.2090933Z 4286 |     reply_context_for_block = context_result["reply_context_for_block"]
2025-11-18T07:14:11.2090993Z      |
2025-11-18T07:14:11.2091122Z help: Remove assignment to unused variable `fallback_text`
2025-11-18T07:14:11.2091128Z 
2025-11-18T07:14:11.2091309Z F841 Local variable `reply_context_for_history` is assigned to but never used
2025-11-18T07:14:11.2091512Z     --> app/handlers/chat.py:4285:5
2025-11-18T07:14:11.2091573Z      |
2025-11-18T07:14:11.2091671Z 4283 |     raw_text = context_result["raw_text"]
2025-11-18T07:14:11.2091786Z 4284 |     fallback_text = context_result["fallback_text"]
2025-11-18T07:14:11.2091956Z 4285 |     reply_context_for_history = context_result["reply_context_for_history"]
2025-11-18T07:14:11.2092128Z      |     ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2092291Z 4286 |     reply_context_for_block = context_result["reply_context_for_block"]
2025-11-18T07:14:11.2092455Z 4287 |     reply_media_raw_for_block = context_result["reply_media_raw_for_block"]
2025-11-18T07:14:11.2092514Z      |
2025-11-18T07:14:11.2092680Z help: Remove assignment to unused variable `reply_context_for_history`
2025-11-18T07:14:11.2092686Z 
2025-11-18T07:14:11.2092856Z F841 Local variable `reply_context_for_block` is assigned to but never used
2025-11-18T07:14:11.2092935Z     --> app/handlers/chat.py:4286:5
2025-11-18T07:14:11.2093002Z      |
2025-11-18T07:14:11.2093114Z 4284 |     fallback_text = context_result["fallback_text"]
2025-11-18T07:14:11.2093284Z 4285 |     reply_context_for_history = context_result["reply_context_for_history"]
2025-11-18T07:14:11.2093441Z 4286 |     reply_context_for_block = context_result["reply_context_for_block"]
2025-11-18T07:14:11.2093520Z      |     ^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2093682Z 4287 |     reply_media_raw_for_block = context_result["reply_media_raw_for_block"]
2025-11-18T07:14:11.2093864Z 4288 |     reply_media_parts_for_block = context_result["reply_media_parts_for_block"]
2025-11-18T07:14:11.2093928Z      |
2025-11-18T07:14:11.2094087Z help: Remove assignment to unused variable `reply_context_for_block`
2025-11-18T07:14:11.2094093Z 
2025-11-18T07:14:11.2094268Z F841 Local variable `reply_media_raw_for_block` is assigned to but never used
2025-11-18T07:14:11.2094350Z     --> app/handlers/chat.py:4287:5
2025-11-18T07:14:11.2094409Z      |
2025-11-18T07:14:11.2094581Z 4285 |     reply_context_for_history = context_result["reply_context_for_history"]
2025-11-18T07:14:11.2094740Z 4286 |     reply_context_for_block = context_result["reply_context_for_block"]
2025-11-18T07:14:11.2094901Z 4287 |     reply_media_raw_for_block = context_result["reply_media_raw_for_block"]
2025-11-18T07:14:11.2094974Z      |     ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2095153Z 4288 |     reply_media_parts_for_block = context_result["reply_media_parts_for_block"]
2025-11-18T07:14:11.2095339Z 4289 |     history_messages_for_block = context_result["history_messages_for_block"]
2025-11-18T07:14:11.2095400Z      |
2025-11-18T07:14:11.2095560Z help: Remove assignment to unused variable `reply_media_raw_for_block`
2025-11-18T07:14:11.2095565Z 
2025-11-18T07:14:11.2095753Z F841 Local variable `reply_media_parts_for_block` is assigned to but never used
2025-11-18T07:14:11.2095830Z     --> app/handlers/chat.py:4288:5
2025-11-18T07:14:11.2095890Z      |
2025-11-18T07:14:11.2096052Z 4286 |     reply_context_for_block = context_result["reply_context_for_block"]
2025-11-18T07:14:11.2096215Z 4287 |     reply_media_raw_for_block = context_result["reply_media_raw_for_block"]
2025-11-18T07:14:11.2096391Z 4288 |     reply_media_parts_for_block = context_result["reply_media_parts_for_block"]
2025-11-18T07:14:11.2096473Z      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2096651Z 4289 |     history_messages_for_block = context_result["history_messages_for_block"]
2025-11-18T07:14:11.2096820Z 4290 |     use_system_context_block = context_result["use_system_context_block"]
2025-11-18T07:14:11.2096886Z      |
2025-11-18T07:14:11.2097154Z help: Remove assignment to unused variable `reply_media_parts_for_block`
2025-11-18T07:14:11.2097161Z 
2025-11-18T07:14:11.2097340Z F841 Local variable `history_messages_for_block` is assigned to but never used
2025-11-18T07:14:11.2097420Z     --> app/handlers/chat.py:4289:5
2025-11-18T07:14:11.2097488Z      |
2025-11-18T07:14:11.2097652Z 4287 |     reply_media_raw_for_block = context_result["reply_media_raw_for_block"]
2025-11-18T07:14:11.2097987Z 4288 |     reply_media_parts_for_block = context_result["reply_media_parts_for_block"]
2025-11-18T07:14:11.2098172Z 4289 |     history_messages_for_block = context_result["history_messages_for_block"]
2025-11-18T07:14:11.2098244Z      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2098509Z 4290 |     use_system_context_block = context_result["use_system_context_block"]
2025-11-18T07:14:11.2098643Z 4291 |     context_assembly = context_result["context_assembly"]
2025-11-18T07:14:11.2098702Z      |
2025-11-18T07:14:11.2098870Z help: Remove assignment to unused variable `history_messages_for_block`
2025-11-18T07:14:11.2098876Z 
2025-11-18T07:14:11.2099046Z F841 Local variable `use_system_context_block` is assigned to but never used
2025-11-18T07:14:11.2099121Z     --> app/handlers/chat.py:4290:5
2025-11-18T07:14:11.2099181Z      |
2025-11-18T07:14:11.2099357Z 4288 |     reply_media_parts_for_block = context_result["reply_media_parts_for_block"]
2025-11-18T07:14:11.2099539Z 4289 |     history_messages_for_block = context_result["history_messages_for_block"]
2025-11-18T07:14:11.2099701Z 4290 |     use_system_context_block = context_result["use_system_context_block"]
2025-11-18T07:14:11.2099765Z      |     ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2099901Z 4291 |     context_assembly = context_result["context_assembly"]
2025-11-18T07:14:11.2100024Z 4292 |     context_manager = context_result["context_manager"]
2025-11-18T07:14:11.2100083Z      |
2025-11-18T07:14:11.2100249Z help: Remove assignment to unused variable `use_system_context_block`
2025-11-18T07:14:11.2100256Z 
2025-11-18T07:14:11.2100409Z F841 Local variable `context_assembly` is assigned to but never used
2025-11-18T07:14:11.2100488Z     --> app/handlers/chat.py:4291:5
2025-11-18T07:14:11.2100550Z      |
2025-11-18T07:14:11.2100725Z 4289 |     history_messages_for_block = context_result["history_messages_for_block"]
2025-11-18T07:14:11.2100885Z 4290 |     use_system_context_block = context_result["use_system_context_block"]
2025-11-18T07:14:11.2101013Z 4291 |     context_assembly = context_result["context_assembly"]
2025-11-18T07:14:11.2101085Z      |     ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2101205Z 4292 |     context_manager = context_result["context_manager"]
2025-11-18T07:14:11.2101324Z 4293 |     use_multi_level = context_result["use_multi_level"]
2025-11-18T07:14:11.2101387Z      |
2025-11-18T07:14:11.2101522Z help: Remove assignment to unused variable `context_assembly`
2025-11-18T07:14:11.2101528Z 
2025-11-18T07:14:11.2101679Z F841 Local variable `context_manager` is assigned to but never used
2025-11-18T07:14:11.2101761Z     --> app/handlers/chat.py:4292:5
2025-11-18T07:14:11.2101819Z      |
2025-11-18T07:14:11.2101980Z 4290 |     use_system_context_block = context_result["use_system_context_block"]
2025-11-18T07:14:11.2102102Z 4291 |     context_assembly = context_result["context_assembly"]
2025-11-18T07:14:11.2102222Z 4292 |     context_manager = context_result["context_manager"]
2025-11-18T07:14:11.2102293Z      |     ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2102408Z 4293 |     use_multi_level = context_result["use_multi_level"]
2025-11-18T07:14:11.2102521Z 4294 |     text_content = context_result["text_content"]
2025-11-18T07:14:11.2102580Z      |
2025-11-18T07:14:11.2102715Z help: Remove assignment to unused variable `context_manager`
2025-11-18T07:14:11.2102721Z 
2025-11-18T07:14:11.2102877Z F841 Local variable `use_multi_level` is assigned to but never used
2025-11-18T07:14:11.2102956Z     --> app/handlers/chat.py:4293:5
2025-11-18T07:14:11.2103015Z      |
2025-11-18T07:14:11.2103142Z 4291 |     context_assembly = context_result["context_assembly"]
2025-11-18T07:14:11.2103264Z 4292 |     context_manager = context_result["context_manager"]
2025-11-18T07:14:11.2103378Z 4293 |     use_multi_level = context_result["use_multi_level"]
2025-11-18T07:14:11.2103443Z      |     ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2103556Z 4294 |     text_content = context_result["text_content"]
2025-11-18T07:14:11.2103755Z 4295 |     media_summary = context_result["media_summary"]
2025-11-18T07:14:11.2103816Z      |
2025-11-18T07:14:11.2103952Z help: Remove assignment to unused variable `use_multi_level`
2025-11-18T07:14:11.2103958Z 
2025-11-18T07:14:11.2104104Z F841 Local variable `media_summary` is assigned to but never used
2025-11-18T07:14:11.2104257Z     --> app/handlers/chat.py:4295:5
2025-11-18T07:14:11.2104319Z      |
2025-11-18T07:14:11.2104432Z 4293 |     use_multi_level = context_result["use_multi_level"]
2025-11-18T07:14:11.2104537Z 4294 |     text_content = context_result["text_content"]
2025-11-18T07:14:11.2104647Z 4295 |     media_summary = context_result["media_summary"]
2025-11-18T07:14:11.2104715Z      |     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2104810Z 4296 |     user_meta = context_result["user_meta"]
2025-11-18T07:14:11.2104868Z      |
2025-11-18T07:14:11.2105000Z help: Remove assignment to unused variable `media_summary`
2025-11-18T07:14:11.2105005Z 
2025-11-18T07:14:11.2105141Z F841 Local variable `user_meta` is assigned to but never used
2025-11-18T07:14:11.2105221Z     --> app/handlers/chat.py:4296:5
2025-11-18T07:14:11.2105286Z      |
2025-11-18T07:14:11.2105394Z 4294 |     text_content = context_result["text_content"]
2025-11-18T07:14:11.2105502Z 4295 |     media_summary = context_result["media_summary"]
2025-11-18T07:14:11.2105597Z 4296 |     user_meta = context_result["user_meta"]
2025-11-18T07:14:11.2105663Z      |     ^^^^^^^^^
2025-11-18T07:14:11.2105721Z 4297 |
2025-11-18T07:14:11.2105825Z 4298 |     # Track which tools were used in this request
2025-11-18T07:14:11.2105887Z      |
2025-11-18T07:14:11.2106005Z help: Remove assignment to unused variable `user_meta`
2025-11-18T07:14:11.2106011Z 
2025-11-18T07:14:11.2106164Z F841 Local variable `response_message` is assigned to but never used
2025-11-18T07:14:11.2106251Z     --> app/handlers/chat.py:4372:5
2025-11-18T07:14:11.2106310Z      |
2025-11-18T07:14:11.2106398Z 4371 |     # Process and send response
2025-11-18T07:14:11.2106538Z 4372 |     response_message = await _process_and_send_response(
2025-11-18T07:14:11.2106612Z      |     ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2106677Z 4373 |         ctx=ctx,
2025-11-18T07:14:11.2106761Z 4374 |         reply_text=reply_text,
2025-11-18T07:14:11.2106826Z      |
2025-11-18T07:14:11.2107066Z help: Remove assignment to unused variable `response_message`
2025-11-18T07:14:11.2107073Z 
2025-11-18T07:14:11.2107176Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2107263Z   --> app/handlers/chat_tools.py:17:1
2025-11-18T07:14:11.2107326Z    |
2025-11-18T07:14:11.2107385Z 15 |   """
2025-11-18T07:14:11.2107443Z 16 |
2025-11-18T07:14:11.2107532Z 17 | / from __future__ import annotations
2025-11-18T07:14:11.2107589Z 18 | |
2025-11-18T07:14:11.2107657Z 19 | | import asyncio
2025-11-18T07:14:11.2107721Z 20 | | import json
2025-11-18T07:14:11.2107791Z 21 | | import logging
2025-11-18T07:14:11.2107889Z 22 | | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2107968Z 23 | | from io import BytesIO
2025-11-18T07:14:11.2108032Z 24 | |
2025-11-18T07:14:11.2108099Z 25 | | import aiohttp
2025-11-18T07:14:11.2108306Z 26 | | from app.services.calculator import calculator_tool, CALCULATOR_TOOL_DEFINITION
2025-11-18T07:14:11.2108483Z 27 | | from app.services.weather import weather_tool, WEATHER_TOOL_DEFINITION
2025-11-18T07:14:11.2108668Z 28 | | from app.services.currency import currency_tool, CURRENCY_TOOL_DEFINITION
2025-11-18T07:14:11.2108825Z 29 | | from app.services.polls import polls_tool, POLLS_TOOL_DEFINITION
2025-11-18T07:14:11.2108924Z 30 | | from app.services.search_tool import (
2025-11-18T07:14:11.2109005Z 31 | |     analyze_image_results,
2025-11-18T07:14:11.2109080Z 32 | |     analyze_text_results,
2025-11-18T07:14:11.2109154Z 33 | |     analyze_video_results,
2025-11-18T07:14:11.2109233Z 34 | |     fetch_web_content_tool,
2025-11-18T07:14:11.2109320Z 35 | |     FETCH_WEB_CONTENT_TOOL_DEFINITION,
2025-11-18T07:14:11.2109392Z 36 | |     search_web_tool,
2025-11-18T07:14:11.2109592Z 37 | |     SEARCH_WEB_TOOL_DEFINITION,
2025-11-18T07:14:11.2109653Z 38 | | )
2025-11-18T07:14:11.2109751Z 39 | | from app.services.image_generation import (
2025-11-18T07:14:11.2109835Z 40 | |     GENERATE_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.2109922Z 41 | |     EDIT_IMAGE_TOOL_DEFINITION,
2025-11-18T07:14:11.2110101Z 42 | |     QuotaExceededError,
2025-11-18T07:14:11.2110181Z 43 | |     ImageGenerationError,
2025-11-18T07:14:11.2110248Z 44 | | )
2025-11-18T07:14:11.2110337Z 45 | | from app.services.tools import (
2025-11-18T07:14:11.2110417Z 46 | |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2110498Z 47 | |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2110579Z 48 | |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2110663Z 49 | |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2110740Z 50 | |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.2110820Z 51 | |     remember_memory_tool,
2025-11-18T07:14:11.2110894Z 52 | |     recall_memories_tool,
2025-11-18T07:14:11.2110972Z 53 | |     forget_memory_tool,
2025-11-18T07:14:11.2111048Z 54 | |     forget_all_memories_tool,
2025-11-18T07:14:11.2111128Z 55 | |     set_pronouns_tool,
2025-11-18T07:14:11.2111188Z 56 | | )
2025-11-18T07:14:11.2111359Z 57 | | from app.services.context_store import ContextStore, format_metadata
2025-11-18T07:14:11.2111474Z 58 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2111607Z 59 | | from app.services.user_profile import UserProfileStore
2025-11-18T07:14:11.2111770Z 60 | | from app.repositories.memory_repository import MemoryRepository
2025-11-18T07:14:11.2111854Z 61 | | from app.config import Settings
2025-11-18T07:14:11.2111974Z 62 | | from app.services.media import collect_media_parts
2025-11-18T07:14:11.2112135Z 63 | | from app.services.profile_photo_tool import get_user_profile_photo
2025-11-18T07:14:11.2112255Z 64 | | from app.services.tools.moderation_tools import (
2025-11-18T07:14:11.2112406Z 65 | |     build_tool_definitions as build_moderation_tool_definitions,
2025-11-18T07:14:11.2112538Z 66 | |     build_tool_callbacks as build_moderation_tool_callbacks,
2025-11-18T07:14:11.2112601Z 67 | | )
2025-11-18T07:14:11.2112721Z 68 | | from aiogram.exceptions import TelegramBadRequest
2025-11-18T07:14:11.2112821Z 69 | | from aiogram.types import BufferedInputFile
2025-11-18T07:14:11.2112903Z    | |___________________________________________^
2025-11-18T07:14:11.2112964Z 70 |
2025-11-18T07:14:11.2113056Z 71 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2113114Z    |
2025-11-18T07:14:11.2113187Z help: Organize imports
2025-11-18T07:14:11.2113193Z 
2025-11-18T07:14:11.2113360Z UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`
2025-11-18T07:14:11.2113446Z   --> app/handlers/chat_tools.py:22:1
2025-11-18T07:14:11.2113504Z    |
2025-11-18T07:14:11.2113573Z 20 | import json
2025-11-18T07:14:11.2113642Z 21 | import logging
2025-11-18T07:14:11.2113741Z 22 | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2113822Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2113898Z 23 | from io import BytesIO
2025-11-18T07:14:11.2113957Z    |
2025-11-18T07:14:11.2114042Z help: Import from `collections.abc`
2025-11-18T07:14:11.2114048Z 
2025-11-18T07:14:11.2114141Z F401 [*] `io.BytesIO` imported but unused
2025-11-18T07:14:11.2114230Z   --> app/handlers/chat_tools.py:23:16
2025-11-18T07:14:11.2114288Z    |
2025-11-18T07:14:11.2114356Z 21 | import logging
2025-11-18T07:14:11.2114450Z 22 | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2114521Z 23 | from io import BytesIO
2025-11-18T07:14:11.2114586Z    |                ^^^^^^^
2025-11-18T07:14:11.2114650Z 24 |
2025-11-18T07:14:11.2114717Z 25 | import aiohttp
2025-11-18T07:14:11.2114775Z    |
2025-11-18T07:14:11.2114866Z help: Remove unused import: `io.BytesIO`
2025-11-18T07:14:11.2114873Z 
2025-11-18T07:14:11.2114954Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2115041Z    --> app/handlers/chat_tools.py:444:1
2025-11-18T07:14:11.2115189Z     |
2025-11-18T07:14:11.2115255Z 442 |                 }
2025-11-18T07:14:11.2115316Z 443 |             )
2025-11-18T07:14:11.2115375Z 444 |             
2025-11-18T07:14:11.2115440Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2115542Z 445 |             # Call the original search_web_tool
2025-11-18T07:14:11.2115801Z 446 |             result_json = await search_web_tool(params, gemini_client, api_key=None)
2025-11-18T07:14:11.2115866Z     |
2025-11-18T07:14:11.2115955Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2115962Z 
2025-11-18T07:14:11.2124572Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2124720Z    --> app/handlers/chat_tools.py:456:1
2025-11-18T07:14:11.2124789Z     |
2025-11-18T07:14:11.2124930Z 454 |             search_type = params.get("search_type", "text")
2025-11-18T07:14:11.2125030Z 455 |             results = result.get("results", [])
2025-11-18T07:14:11.2125096Z 456 |             
2025-11-18T07:14:11.2125156Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2125266Z 457 |             # Smart search analysis (if enabled)
2025-11-18T07:14:11.2125350Z 458 |             analysis_result = None
2025-11-18T07:14:11.2125415Z     |
2025-11-18T07:14:11.2125506Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2125513Z 
2025-11-18T07:14:11.2125600Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2125697Z    --> app/handlers/chat_tools.py:464:1
2025-11-18T07:14:11.2125756Z     |
2025-11-18T07:14:11.2125830Z 462 |                     len(results)
2025-11-18T07:14:11.2125900Z 463 |                 )
2025-11-18T07:14:11.2125963Z 464 |                 
2025-11-18T07:14:11.2126028Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2126096Z 465 |                 try:
2025-11-18T07:14:11.2126209Z 466 |                     if search_type in ("text", "news"):
2025-11-18T07:14:11.2126271Z     |
2025-11-18T07:14:11.2126367Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2126373Z 
2025-11-18T07:14:11.2126461Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2126548Z    --> app/handlers/chat_tools.py:474:1
2025-11-18T07:14:11.2126607Z     |
2025-11-18T07:14:11.2126772Z 472 | …                     if not url:
2025-11-18T07:14:11.2126899Z 473 | …                         continue
2025-11-18T07:14:11.2127128Z 474 | …                     
2025-11-18T07:14:11.2127199Z ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2127316Z 475 | …                     try:
2025-11-18T07:14:11.2127494Z 476 | …                         # Fetch content using fetch_web_content_tool
2025-11-18T07:14:11.2127554Z     |
2025-11-18T07:14:11.2127642Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2127654Z 
2025-11-18T07:14:11.2127734Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2127819Z    --> app/handlers/chat_tools.py:484:1
2025-11-18T07:14:11.2127879Z     |
2025-11-18T07:14:11.2128101Z 482 | …                     content_json = await fetch_web_content_tool(content_params)
2025-11-18T07:14:11.2128264Z 483 | …                     content_data = json.loads(content_json)
2025-11-18T07:14:11.2128368Z 484 | …                     
2025-11-18T07:14:11.2128440Z ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2128585Z 485 | …                     if "error" not in content_data:
2025-11-18T07:14:11.2128734Z 486 | …                         fetched_content.append({
2025-11-18T07:14:11.2128803Z     |
2025-11-18T07:14:11.2128895Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2128901Z 
2025-11-18T07:14:11.2128982Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2129070Z    --> app/handlers/chat_tools.py:499:1
2025-11-18T07:14:11.2129133Z     |
2025-11-18T07:14:11.2129261Z 497 |                                     "content": result_item.get("description", ""),
2025-11-18T07:14:11.2129336Z 498 |                                 })
2025-11-18T07:14:11.2129406Z 499 |                         
2025-11-18T07:14:11.2129471Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2129560Z 500 |                         if fetched_content:
2025-11-18T07:14:11.2129855Z 501 |                             analysis_result = await analyze_text_results(
2025-11-18T07:14:11.2129917Z     |
2025-11-18T07:14:11.2130003Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2130008Z 
2025-11-18T07:14:11.2130087Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2130173Z    --> app/handlers/chat_tools.py:507:1
2025-11-18T07:14:11.2130343Z     |
2025-11-18T07:14:11.2130448Z 505 |                                 gemini_client=gemini_client,
2025-11-18T07:14:11.2130522Z 506 |                             )
2025-11-18T07:14:11.2130588Z 507 |                     
2025-11-18T07:14:11.2130652Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2130750Z 508 |                     elif search_type == "videos":
2025-11-18T07:14:11.2130851Z 509 |                         # Analyze video metadata
2025-11-18T07:14:11.2130911Z     |
2025-11-18T07:14:11.2130999Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2131005Z 
2025-11-18T07:14:11.2131094Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2131183Z    --> app/handlers/chat_tools.py:517:1
2025-11-18T07:14:11.2131240Z     |
2025-11-18T07:14:11.2131345Z 515 |                                 gemini_client=gemini_client,
2025-11-18T07:14:11.2131413Z 516 |                             )
2025-11-18T07:14:11.2131477Z 517 |                     
2025-11-18T07:14:11.2131544Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2131701Z 518 |                     # Note: Image analysis happens after downloading (see below)
2025-11-18T07:14:11.2131760Z     |
2025-11-18T07:14:11.2131845Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2131850Z 
2025-11-18T07:14:11.2131935Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2132017Z    --> app/handlers/chat_tools.py:519:1
2025-11-18T07:14:11.2132076Z     |
2025-11-18T07:14:11.2132221Z 518 |                     # Note: Image analysis happens after downloading (see below)
2025-11-18T07:14:11.2132285Z 519 |                     
2025-11-18T07:14:11.2132348Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2132442Z 520 |                 except Exception as e:
2025-11-18T07:14:11.2132628Z 521 |                     logger.warning(f"Smart search analysis failed: {e}", exc_info=True)
2025-11-18T07:14:11.2132690Z     |
2025-11-18T07:14:11.2132773Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2132782Z 
2025-11-18T07:14:11.2132896Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2132983Z    --> app/handlers/chat_tools.py:577:28
2025-11-18T07:14:11.2133040Z     |
2025-11-18T07:14:11.2133214Z 575 |                                             f"Downloaded image {len(downloaded_images)}: {image_url[:50]}"
2025-11-18T07:14:11.2133295Z 576 |                                         )
2025-11-18T07:14:11.2133395Z 577 |                     except asyncio.TimeoutError:
2025-11-18T07:14:11.2133475Z     |                            ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2133656Z 578 |                         logger.warning(f"Timeout downloading image: {image_url[:50]}")
2025-11-18T07:14:11.2133764Z 579 |                         failed_urls.append(image_url)
2025-11-18T07:14:11.2133821Z     |
2025-11-18T07:14:11.2133983Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2133989Z 
2025-11-18T07:14:11.2134074Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2134164Z    --> app/handlers/chat_tools.py:669:1
2025-11-18T07:14:11.2134227Z     |
2025-11-18T07:14:11.2134302Z 667 |                 if failed_urls:
2025-11-18T07:14:11.2134474Z 668 |                     result["_failed_urls"] = failed_urls[:3]  # Keep first 3 for debugging
2025-11-18T07:14:11.2134542Z 669 |                 
2025-11-18T07:14:11.2134606Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2134714Z 670 |                 # Analyze images if smart search is enabled
2025-11-18T07:14:11.2134935Z 671 |                 if settings.enable_smart_search_analysis and gemini_client and downloaded_images:
2025-11-18T07:14:11.2135003Z     |
2025-11-18T07:14:11.2135175Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2135182Z 
2025-11-18T07:14:11.2135262Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2135347Z    --> app/handlers/chat_tools.py:679:1
2025-11-18T07:14:11.2135403Z     |
2025-11-18T07:14:11.2135541Z 677 |                         images_to_analyze = downloaded_images[:max_to_analyze]
2025-11-18T07:14:11.2135738Z 678 |                         results_to_analyze = results[:max_to_analyze]
2025-11-18T07:14:11.2135809Z 679 |                         
2025-11-18T07:14:11.2135874Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2135994Z 680 |                         analysis_result = await analyze_image_results(
2025-11-18T07:14:11.2136083Z 681 |                             query=query,
2025-11-18T07:14:11.2136141Z     |
2025-11-18T07:14:11.2136224Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2136230Z 
2025-11-18T07:14:11.2136313Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2136394Z    --> app/handlers/chat_tools.py:689:1
2025-11-18T07:14:11.2136457Z     |
2025-11-18T07:14:11.2136617Z 687 |                         logger.warning(f"Image analysis failed: {e}", exc_info=True)
2025-11-18T07:14:11.2136713Z 688 |                         analysis_result = None
2025-11-18T07:14:11.2136774Z 689 |             
2025-11-18T07:14:11.2136836Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2137062Z 690 |             # Add analysis results to response if available
2025-11-18T07:14:11.2137143Z 691 |             if analysis_result:
2025-11-18T07:14:11.2137202Z     |
2025-11-18T07:14:11.2137289Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2137294Z 
2025-11-18T07:14:11.2137371Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2137450Z    --> app/handlers/chat_tools.py:695:1
2025-11-18T07:14:11.2137510Z     |
2025-11-18T07:14:11.2137601Z 693 |                 # Preserve original results
2025-11-18T07:14:11.2137716Z 694 |                 result["original_results"] = results.copy()
2025-11-18T07:14:11.2137776Z 695 |             
2025-11-18T07:14:11.2137843Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2137932Z 696 |             return json.dumps(result)
2025-11-18T07:14:11.2137991Z     |
2025-11-18T07:14:11.2138081Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2138086Z 
2025-11-18T07:14:11.2138164Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2138249Z    --> app/handlers/chat_tools.py:699:1
2025-11-18T07:14:11.2138313Z     |
2025-11-18T07:14:11.2138514Z 698 |         callbacks["search_web"] = make_tracked_callback("search_web", search_web_callback)
2025-11-18T07:14:11.2138575Z 699 |         
2025-11-18T07:14:11.2138634Z     | ^^^^^^^^
2025-11-18T07:14:11.2138718Z 700 |         # Fetch web content tool
2025-11-18T07:14:11.2138852Z 701 |         callbacks["fetch_web_content"] = make_tracked_callback(
2025-11-18T07:14:11.2138911Z     |
2025-11-18T07:14:11.2139001Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2139006Z 
2025-11-18T07:14:11.2139108Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2139201Z    --> app/handlers/chat_tools.py:892:17
2025-11-18T07:14:11.2139261Z     |
2025-11-18T07:14:11.2139380Z 890 |               detected_aspect_ratio = "1:1"  # Default fallback
2025-11-18T07:14:11.2139447Z 891 |               try:
2025-11-18T07:14:11.2139536Z 892 | /                 from PIL import Image
2025-11-18T07:14:11.2139629Z 893 | |                 from io import BytesIO
2025-11-18T07:14:11.2139704Z     | |______________________________________^
2025-11-18T07:14:11.2139762Z 894 |
2025-11-18T07:14:11.2139871Z 895 |                   img = Image.open(BytesIO(image_bytes))
2025-11-18T07:14:11.2139930Z     |
2025-11-18T07:14:11.2140002Z help: Organize imports
2025-11-18T07:14:11.2140007Z 
2025-11-18T07:14:11.2140096Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2140186Z     --> app/handlers/chat_tools.py:1190:22
2025-11-18T07:14:11.2140243Z      |
2025-11-18T07:14:11.2140415Z 1188 |     # Bot can use autonomously; Telegram API enforces actual permissions
2025-11-18T07:14:11.2140634Z 1189 |     if telegram_service is not None:
2025-11-18T07:14:11.2140844Z 1190 |         logger.debug(f"Building moderation tool callbacks (bot can use autonomously)")
2025-11-18T07:14:11.2140934Z      |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2141228Z 1191 |         moderation_callbacks = build_moderation_tool_callbacks(telegram_service)
2025-11-18T07:14:11.2141337Z 1192 |         callbacks.update(moderation_callbacks)
2025-11-18T07:14:11.2141396Z      |
2025-11-18T07:14:11.2141481Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2141492Z 
2025-11-18T07:14:11.2141579Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2141664Z     --> app/handlers/chat_tools.py:1195:24
2025-11-18T07:14:11.2141723Z      |
2025-11-18T07:14:11.2141905Z 1193 |         logger.debug(f"Added {len(moderation_callbacks)} moderation callbacks")
2025-11-18T07:14:11.2141967Z 1194 |     else:
2025-11-18T07:14:11.2142176Z 1195 |         logger.warning(f"telegram_service is None - moderation tools not available")
2025-11-18T07:14:11.2142268Z      |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2142327Z 1196 |
2025-11-18T07:14:11.2142536Z 1197 |     logger.info(f"Built {len(callbacks)} tool callbacks: {', '.join(callbacks.keys())}")
2025-11-18T07:14:11.2142602Z      |
2025-11-18T07:14:11.2142686Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2142691Z 
2025-11-18T07:14:11.2142793Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2142878Z   --> app/handlers/checkers.py:3:1
2025-11-18T07:14:11.2142941Z    |
2025-11-18T07:14:11.2143042Z  1 |   """Checkers game handlers for Telegram bot."""
2025-11-18T07:14:11.2143101Z  2 |
2025-11-18T07:14:11.2143189Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.2143248Z  4 | |
2025-11-18T07:14:11.2143318Z  5 | | import logging
2025-11-18T07:14:11.2143397Z  6 | | from typing import Any
2025-11-18T07:14:11.2143460Z  7 | |
2025-11-18T07:14:11.2143542Z  8 | | from aiogram import Bot, Router
2025-11-18T07:14:11.2143628Z  9 | | from aiogram.filters import Command
2025-11-18T07:14:11.2143720Z 10 | | from aiogram.types import (
2025-11-18T07:14:11.2143792Z 11 | |     CallbackQuery,
2025-11-18T07:14:11.2143873Z 12 | |     InlineKeyboardButton,
2025-11-18T07:14:11.2143959Z 13 | |     InlineKeyboardMarkup,
2025-11-18T07:14:11.2144022Z 14 | |     Message,
2025-11-18T07:14:11.2144099Z 15 | |     InaccessibleMessage,
2025-11-18T07:14:11.2144159Z 16 | | )
2025-11-18T07:14:11.2144256Z 17 | | from aiogram.enums import ParseMode
2025-11-18T07:14:11.2144315Z 18 | |
2025-11-18T07:14:11.2144397Z 19 | | from app.config import Settings
2025-11-18T07:14:11.2144577Z 20 | | from app.services.checkers.game_engine import CheckersGame, Player
2025-11-18T07:14:11.2144729Z 21 | | from app.services.checkers.board_renderer import render_board
2025-11-18T07:14:11.2144881Z 22 | | from app.services.checkers.game_store import CheckersGameStore
2025-11-18T07:14:11.2144984Z    | |______________________________________________________________^
2025-11-18T07:14:11.2145049Z 23 |
2025-11-18T07:14:11.2145119Z 24 |   router = Router()
2025-11-18T07:14:11.2145176Z    |
2025-11-18T07:14:11.2145249Z help: Organize imports
2025-11-18T07:14:11.2145255Z 
2025-11-18T07:14:11.2145344Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2145432Z   --> app/handlers/checkers.py:92:1
2025-11-18T07:14:11.2145494Z    |
2025-11-18T07:14:11.2145568Z 90 |     board = game.get_board()
2025-11-18T07:14:11.2145635Z 91 |     keyboard = []
2025-11-18T07:14:11.2145695Z 92 |     
2025-11-18T07:14:11.2145758Z    | ^^^^
2025-11-18T07:14:11.2145850Z 93 |     # Get valid moves for current player
2025-11-18T07:14:11.2145969Z 94 |     valid_moves = game.get_valid_moves(current_player)
2025-11-18T07:14:11.2146031Z    |
2025-11-18T07:14:11.2146119Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2146125Z 
2025-11-18T07:14:11.2146278Z F841 Local variable `valid_to_squares` is assigned to but never used
2025-11-18T07:14:11.2146446Z   --> app/handlers/checkers.py:96:5
2025-11-18T07:14:11.2146508Z    |
2025-11-18T07:14:11.2146615Z 94 |     valid_moves = game.get_valid_moves(current_player)
2025-11-18T07:14:11.2146773Z 95 |     valid_from_squares = {(m.from_row, m.from_col) for m in valid_moves}
2025-11-18T07:14:11.2147123Z 96 |     valid_to_squares = {(m.to_row, m.to_col) for m in valid_moves}
2025-11-18T07:14:11.2147190Z    |     ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2147248Z 97 |     
2025-11-18T07:14:11.2147377Z 98 |     # If a square is selected, show valid destination squares
2025-11-18T07:14:11.2147434Z    |
2025-11-18T07:14:11.2147574Z help: Remove assignment to unused variable `valid_to_squares`
2025-11-18T07:14:11.2147579Z 
2025-11-18T07:14:11.2147660Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2147745Z   --> app/handlers/checkers.py:97:1
2025-11-18T07:14:11.2147803Z    |
2025-11-18T07:14:11.2147954Z 95 |     valid_from_squares = {(m.from_row, m.from_col) for m in valid_moves}
2025-11-18T07:14:11.2148093Z 96 |     valid_to_squares = {(m.to_row, m.to_col) for m in valid_moves}
2025-11-18T07:14:11.2148155Z 97 |     
2025-11-18T07:14:11.2148212Z    | ^^^^
2025-11-18T07:14:11.2148333Z 98 |     # If a square is selected, show valid destination squares
2025-11-18T07:14:11.2148410Z 99 |     if selected_square:
2025-11-18T07:14:11.2148467Z    |
2025-11-18T07:14:11.2148551Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2148557Z 
2025-11-18T07:14:11.2148639Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2148725Z    --> app/handlers/checkers.py:108:1
2025-11-18T07:14:11.2148783Z     |
2025-11-18T07:14:11.2148848Z 106 |     else:
2025-11-18T07:14:11.2148935Z 107 |         valid_destinations = set()
2025-11-18T07:14:11.2148995Z 108 |     
2025-11-18T07:14:11.2149053Z     | ^^^^
2025-11-18T07:14:11.2149217Z 109 |     # Only show playable squares (dark squares) for cleaner interface
2025-11-18T07:14:11.2149291Z 110 |     for row in range(8):
2025-11-18T07:14:11.2149352Z     |
2025-11-18T07:14:11.2149440Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2149446Z 
2025-11-18T07:14:11.2149522Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2149605Z    --> app/handlers/checkers.py:166:1
2025-11-18T07:14:11.2149666Z     |
2025-11-18T07:14:11.2149757Z 165 |         keyboard.append(row_buttons)
2025-11-18T07:14:11.2149817Z 166 |     
2025-11-18T07:14:11.2149874Z     | ^^^^
2025-11-18T07:14:11.2149950Z 167 |     if selected_square:
2025-11-18T07:14:11.2150025Z 168 |         keyboard.append(
2025-11-18T07:14:11.2150082Z     |
2025-11-18T07:14:11.2150172Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2150178Z 
2025-11-18T07:14:11.2150257Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2150337Z    --> app/handlers/checkers.py:181:1
2025-11-18T07:14:11.2150393Z     |
2025-11-18T07:14:11.2150690Z 179 |         InlineKeyboardButton(text="━━━━━━━━━━━━━━━━━━━━", callback_data="checkers:ignore")
2025-11-18T07:14:11.2150758Z 180 |     ])
2025-11-18T07:14:11.2150816Z 181 |     
2025-11-18T07:14:11.2150875Z     | ^^^^
2025-11-18T07:14:11.2150983Z 182 |     # Add control buttons with better visibility
2025-11-18T07:14:11.2151053Z 183 |     control_row = [
2025-11-18T07:14:11.2151114Z     |
2025-11-18T07:14:11.2151198Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2151209Z 
2025-11-18T07:14:11.2151286Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2151378Z    --> app/handlers/checkers.py:189:1
2025-11-18T07:14:11.2151437Z     |
2025-11-18T07:14:11.2151496Z 187 |     ]
2025-11-18T07:14:11.2151578Z 188 |     keyboard.append(control_row)
2025-11-18T07:14:11.2151640Z 189 |     
2025-11-18T07:14:11.2151697Z     | ^^^^
2025-11-18T07:14:11.2151834Z 190 |     return InlineKeyboardMarkup(inline_keyboard=keyboard)
2025-11-18T07:14:11.2151892Z     |
2025-11-18T07:14:11.2151983Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2151989Z 
2025-11-18T07:14:11.2152072Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2152274Z    --> app/handlers/checkers.py:259:1
2025-11-18T07:14:11.2152340Z     |
2025-11-18T07:14:11.2152530Z 257 |         await message.reply("❌ Помилка: невідомий користувач")
2025-11-18T07:14:11.2152636Z 258 |         return
2025-11-18T07:14:11.2152703Z 259 |     
2025-11-18T07:14:11.2152875Z     | ^^^^
2025-11-18T07:14:11.2152949Z 260 |     bot = message.bot
2025-11-18T07:14:11.2153033Z 261 |     user_id = message.from_user.id
2025-11-18T07:14:11.2153094Z     |
2025-11-18T07:14:11.2153177Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2153182Z 
2025-11-18T07:14:11.2153259Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2153345Z    --> app/handlers/checkers.py:265:1
2025-11-18T07:14:11.2153402Z     |
2025-11-18T07:14:11.2153498Z 263 |     thread_id = message.message_thread_id
2025-11-18T07:14:11.2153643Z 264 |     challenger_name = _get_user_display_name(message.from_user)
2025-11-18T07:14:11.2153707Z 265 |     
2025-11-18T07:14:11.2153771Z     | ^^^^
2025-11-18T07:14:11.2153898Z 266 |     game_store = CheckersGameStore(settings.database_url)
2025-11-18T07:14:11.2154089Z 267 |     existing_game = await game_store.get_open_game(chat_id, thread_id, user_id)
2025-11-18T07:14:11.2154147Z     |
2025-11-18T07:14:11.2154230Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2154239Z 
2025-11-18T07:14:11.2154322Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2154403Z    --> app/handlers/checkers.py:327:1
2025-11-18T07:14:11.2154462Z     |
2025-11-18T07:14:11.2154645Z 325 |         await message.reply("❌ Помилка: невідомий користувач")
2025-11-18T07:14:11.2154712Z 326 |         return
2025-11-18T07:14:11.2154772Z 327 |     
2025-11-18T07:14:11.2154831Z     | ^^^^
2025-11-18T07:14:11.2154906Z 328 |     bot = message.bot
2025-11-18T07:14:11.2154991Z 329 |     user_id = message.from_user.id
2025-11-18T07:14:11.2155049Z     |
2025-11-18T07:14:11.2155134Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2155145Z 
2025-11-18T07:14:11.2155230Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2155311Z    --> app/handlers/checkers.py:332:1
2025-11-18T07:14:11.2155369Z     |
2025-11-18T07:14:11.2155449Z 330 |     chat_id = message.chat.id
2025-11-18T07:14:11.2155542Z 331 |     thread_id = message.message_thread_id
2025-11-18T07:14:11.2155605Z 332 |     
2025-11-18T07:14:11.2155665Z     | ^^^^
2025-11-18T07:14:11.2155790Z 333 |     game_store = CheckersGameStore(settings.database_url)
2025-11-18T07:14:11.2155956Z 334 |     game_data = await game_store.get_open_game(chat_id, thread_id, user_id)
2025-11-18T07:14:11.2156014Z     |
2025-11-18T07:14:11.2156102Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2156108Z 
2025-11-18T07:14:11.2156210Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2156297Z   --> app/handlers/profile_admin.py:3:1
2025-11-18T07:14:11.2156359Z    |
2025-11-18T07:14:11.2156475Z  1 |   """Admin commands for user profile management."""
2025-11-18T07:14:11.2156537Z  2 |
2025-11-18T07:14:11.2156625Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.2156685Z  4 | |
2025-11-18T07:14:11.2156749Z  5 | | import html
2025-11-18T07:14:11.2156812Z  6 | | import json
2025-11-18T07:14:11.2156882Z  7 | | import logging
2025-11-18T07:14:11.2157069Z  8 | | from datetime import datetime
2025-11-18T07:14:11.2157151Z  9 | | from typing import Any
2025-11-18T07:14:11.2157214Z 10 | |
2025-11-18T07:14:11.2157296Z 11 | | from aiogram import Bot, Router
2025-11-18T07:14:11.2157383Z 12 | | from aiogram.filters import Command
2025-11-18T07:14:11.2157464Z 13 | | from aiogram.types import (
2025-11-18T07:14:11.2157532Z 14 | |     BotCommand,
2025-11-18T07:14:11.2157608Z 15 | |     BotCommandScopeChat,
2025-11-18T07:14:11.2157670Z 16 | |     Message,
2025-11-18T07:14:11.2157742Z 17 | |     CallbackQuery,
2025-11-18T07:14:11.2157822Z 18 | |     InlineKeyboardMarkup,
2025-11-18T07:14:11.2157896Z 19 | |     InlineKeyboardButton,
2025-11-18T07:14:11.2157970Z 20 | |     InaccessibleMessage,
2025-11-18T07:14:11.2158152Z 21 | | )
2025-11-18T07:14:11.2158212Z 22 | |
2025-11-18T07:14:11.2158297Z 23 | | from app.config import Settings
2025-11-18T07:14:11.2158439Z 24 | | from app.services.user_profile import UserProfileStore
2025-11-18T07:14:11.2158562Z 25 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.2158751Z 26 | | from app.services import telemetry
2025-11-18T07:14:11.2158875Z 27 | | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.2159012Z 28 | | from app.services.bot_learning import BotLearningEngine
2025-11-18T07:14:11.2159175Z 29 | | from app.repositories.memory_repository import MemoryRepository
2025-11-18T07:14:11.2159294Z 30 | | from app.utils.persona_helpers import get_response
2025-11-18T07:14:11.2159384Z    | |__________________________________________________^
2025-11-18T07:14:11.2159442Z 31 |
2025-11-18T07:14:11.2159511Z 32 |   router = Router()
2025-11-18T07:14:11.2159573Z    |
2025-11-18T07:14:11.2159643Z help: Organize imports
2025-11-18T07:14:11.2159652Z 
2025-11-18T07:14:11.2159741Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2159837Z    --> app/handlers/profile_admin.py:338:17
2025-11-18T07:14:11.2159902Z     |
2025-11-18T07:14:11.2160096Z 336 |         response += f"📝 Username: @{profile['username']}\n"
2025-11-18T07:14:11.2160161Z 337 |
2025-11-18T07:14:11.2160328Z 338 |     response += f"\n📊 <b>Статистика:</b>\n"
2025-11-18T07:14:11.2160403Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2160614Z 339 |     response += f"• Взаємодій: {profile.get('interaction_count', 0)}\n"
2025-11-18T07:14:11.2160749Z 340 |     response += f"• Фактів: {fact_count}\n"
2025-11-18T07:14:11.2160809Z     |
2025-11-18T07:14:11.2160892Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2160898Z 
2025-11-18T07:14:11.2160985Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2161081Z    --> app/handlers/profile_admin.py:987:17
2025-11-18T07:14:11.2161141Z     |
2025-11-18T07:14:11.2161333Z 986 |     response = "🤖 <b>Bot Self-Learning Profile</b>\n\n"
2025-11-18T07:14:11.2161516Z 987 |     response += f"📊 <b>Effectiveness (last 7 days)</b>\n"
2025-11-18T07:14:11.2161597Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2161826Z 988 |     response += f"• Overall score: {summary['effectiveness_score']:.1%}\n"
2025-11-18T07:14:11.2162048Z 989 |     response += f"• Recent score: {summary['recent_effectiveness']:.1%}\n"
2025-11-18T07:14:11.2162105Z     |
2025-11-18T07:14:11.2162189Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2162194Z 
2025-11-18T07:14:11.2162281Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2162370Z    --> app/handlers/profile_admin.py:994:17
2025-11-18T07:14:11.2162429Z     |
2025-11-18T07:14:11.2162867Z 992 |     response += f"• Negative: {summary['negative_interactions']} ({summary['negative_interactions']/max(summary['total_interactions']…
2025-11-18T07:14:11.2162927Z 993 |
2025-11-18T07:14:11.2163067Z 994 |     response += f"⚡ <b>Performance</b>\n"
2025-11-18T07:14:11.2163149Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2163388Z 995 |     response += f"• Avg response time: {summary['avg_response_time_ms']:.0f}ms\n"
2025-11-18T07:14:11.2163583Z 996 |     response += f"• Avg tokens: {summary['avg_token_count']:.0f}\n"
2025-11-18T07:14:11.2163652Z     |
2025-11-18T07:14:11.2163732Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2163736Z 
2025-11-18T07:14:11.2163822Z F401 [*] `aiogram.Bot` imported but unused
2025-11-18T07:14:11.2163914Z   --> app/handlers/prompt_admin.py:9:21
2025-11-18T07:14:11.2163970Z    |
2025-11-18T07:14:11.2164047Z  7 | from datetime import datetime
2025-11-18T07:14:11.2164107Z  8 |
2025-11-18T07:14:11.2164185Z  9 | from aiogram import Bot, Router
2025-11-18T07:14:11.2164251Z    |                     ^^^
2025-11-18T07:14:11.2164338Z 10 | from aiogram.filters import Command
2025-11-18T07:14:11.2164504Z 11 | from aiogram.types import BotCommand, BufferedInputFile, Message
2025-11-18T07:14:11.2164647Z    |
2025-11-18T07:14:11.2164737Z help: Remove unused import: `aiogram.Bot`
2025-11-18T07:14:11.2164743Z 
2025-11-18T07:14:11.2164832Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2164921Z    --> app/handlers/prompt_admin.py:486:20
2025-11-18T07:14:11.2164979Z     |
2025-11-18T07:14:11.2165128Z 484 |             return
2025-11-18T07:14:11.2165186Z 485 |
2025-11-18T07:14:11.2165363Z 486 |         response = f"📜 <b>Історія системних промптів</b>\n\n"
2025-11-18T07:14:11.2165443Z     |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2165536Z 487 |         response += f"Scope: {scope}\n"
2025-11-18T07:14:11.2165655Z 488 |         response += f"Chat ID: {chat_id_filter or 'Global'}\n"
2025-11-18T07:14:11.2165712Z     |
2025-11-18T07:14:11.2165792Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2165798Z 
2025-11-18T07:14:11.2165883Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2165969Z    --> app/handlers/prompt_admin.py:504:13
2025-11-18T07:14:11.2166036Z     |
2025-11-18T07:14:11.2166105Z 503 |         response += (
2025-11-18T07:14:11.2166241Z 504 |             f"💡 Щоб активувати стару версію:\n"
2025-11-18T07:14:11.2166316Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2166433Z 505 |             f"<code>/gryagactivateprompt VERSION</code>"
2025-11-18T07:14:11.2166501Z 506 |         )
2025-11-18T07:14:11.2166557Z     |
2025-11-18T07:14:11.2166637Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2166642Z 
2025-11-18T07:14:11.2166730Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2166819Z    --> app/handlers/prompt_admin.py:505:13
2025-11-18T07:14:11.2166875Z     |
2025-11-18T07:14:11.2167050Z 503 |         response += (
2025-11-18T07:14:11.2167183Z 504 |             f"💡 Щоб активувати стару версію:\n"
2025-11-18T07:14:11.2167298Z 505 |             f"<code>/gryagactivateprompt VERSION</code>"
2025-11-18T07:14:11.2167377Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2167444Z 506 |         )
2025-11-18T07:14:11.2167501Z     |
2025-11-18T07:14:11.2167581Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2167586Z 
2025-11-18T07:14:11.2167676Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2167778Z   --> app/infrastructure/database/cli.py:12:21
2025-11-18T07:14:11.2167840Z    |
2025-11-18T07:14:11.2167907Z 10 | import asyncio
2025-11-18T07:14:11.2167970Z 11 | import sys
2025-11-18T07:14:11.2168049Z 12 | from pathlib import Path
2025-11-18T07:14:11.2168117Z    |                     ^^^^
2025-11-18T07:14:11.2168173Z 13 |
2025-11-18T07:14:11.2168251Z 14 | from app.config import Settings
2025-11-18T07:14:11.2168307Z    |
2025-11-18T07:14:11.2168400Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2168405Z 
2025-11-18T07:14:11.2168522Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2168631Z   --> app/infrastructure/database/migrator.py:11:1
2025-11-18T07:14:11.2168695Z    |
2025-11-18T07:14:11.2168759Z  9 | import logging
2025-11-18T07:14:11.2168832Z 10 | from pathlib import Path
2025-11-18T07:14:11.2168911Z 11 | from typing import List
2025-11-18T07:14:11.2168975Z    | ^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2169031Z 12 |
2025-11-18T07:14:11.2169097Z 13 | import aiosqlite
2025-11-18T07:14:11.2169162Z    |
2025-11-18T07:14:11.2169168Z 
2025-11-18T07:14:11.2169537Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2169649Z   --> app/infrastructure/database/migrator.py:90:13
2025-11-18T07:14:11.2169708Z    |
2025-11-18T07:14:11.2169793Z 89 |           except aiosqlite.Error as e:
2025-11-18T07:14:11.2169873Z 90 | /             raise DatabaseError(
2025-11-18T07:14:11.2169955Z 91 | |                 "Migration failed",
2025-11-18T07:14:11.2170052Z 92 | |                 context={"db_path": str(self.db_path)},
2025-11-18T07:14:11.2170119Z 93 | |                 cause=e,
2025-11-18T07:14:11.2170300Z 94 | |             )
2025-11-18T07:14:11.2170365Z    | |_____________^
2025-11-18T07:14:11.2170422Z 95 |
2025-11-18T07:14:11.2170520Z 96 |       async def get_current_version(self) -> int:
2025-11-18T07:14:11.2170578Z    |
2025-11-18T07:14:11.2170583Z 
2025-11-18T07:14:11.2171041Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2171153Z    --> app/infrastructure/database/migrator.py:110:13
2025-11-18T07:14:11.2171212Z     |
2025-11-18T07:14:11.2171302Z 109 |           except aiosqlite.Error as e:
2025-11-18T07:14:11.2171382Z 110 | /             raise DatabaseError(
2025-11-18T07:14:11.2171481Z 111 | |                 "Failed to get database version",
2025-11-18T07:14:11.2171586Z 112 | |                 context={"db_path": str(self.db_path)},
2025-11-18T07:14:11.2171654Z 113 | |                 cause=e,
2025-11-18T07:14:11.2171719Z 114 | |             )
2025-11-18T07:14:11.2171783Z     | |_____________^
2025-11-18T07:14:11.2171840Z 115 |
2025-11-18T07:14:11.2171977Z 116 |       async def rollback(self, target_version: int = 0) -> int:
2025-11-18T07:14:11.2172034Z     |
2025-11-18T07:14:11.2172042Z 
2025-11-18T07:14:11.2172394Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2172506Z    --> app/infrastructure/database/migrator.py:152:13
2025-11-18T07:14:11.2172563Z     |
2025-11-18T07:14:11.2172655Z 151 |           except aiosqlite.Error as e:
2025-11-18T07:14:11.2172735Z 152 | /             raise DatabaseError(
2025-11-18T07:14:11.2172811Z 153 | |                 "Rollback failed",
2025-11-18T07:14:11.2172923Z 154 | |                 context={"target_version": target_version},
2025-11-18T07:14:11.2172989Z 155 | |                 cause=e,
2025-11-18T07:14:11.2173049Z 156 | |             )
2025-11-18T07:14:11.2173115Z     | |_____________^
2025-11-18T07:14:11.2173171Z 157 |
2025-11-18T07:14:11.2173367Z 158 |       async def _ensure_migrations_table(self, db: aiosqlite.Connection) -> None:
2025-11-18T07:14:11.2173424Z     |
2025-11-18T07:14:11.2173429Z 
2025-11-18T07:14:11.2173551Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2173660Z    --> app/infrastructure/database/migrator.py:171:74
2025-11-18T07:14:11.2173717Z     |
2025-11-18T07:14:11.2173790Z 169 |         await db.commit()
2025-11-18T07:14:11.2173848Z 170 |
2025-11-18T07:14:11.2174049Z 171 |     async def _get_applied_migrations(self, db: aiosqlite.Connection) -> List[int]:
2025-11-18T07:14:11.2174137Z     |                                                                          ^^^^
2025-11-18T07:14:11.2174246Z 172 |         """Get list of applied migration versions."""
2025-11-18T07:14:11.2174326Z 173 |         cursor = await db.execute(
2025-11-18T07:14:11.2174382Z     |
2025-11-18T07:14:11.2174459Z help: Replace with `list`
2025-11-18T07:14:11.2174468Z 
2025-11-18T07:14:11.2174821Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2174925Z    --> app/infrastructure/database/migrator.py:201:13
2025-11-18T07:14:11.2174989Z     |
2025-11-18T07:14:11.2175077Z 199 |           except aiosqlite.Error as e:
2025-11-18T07:14:11.2175152Z 200 |               await db.rollback()
2025-11-18T07:14:11.2175232Z 201 | /             raise DatabaseError(
2025-11-18T07:14:11.2175356Z 202 | |                 f"Failed to apply migration {migration.version}",
2025-11-18T07:14:11.2175457Z 203 | |                 context={"migration": migration.name},
2025-11-18T07:14:11.2175524Z 204 | |                 cause=e,
2025-11-18T07:14:11.2175584Z 205 | |             )
2025-11-18T07:14:11.2175645Z     | |_____________^
2025-11-18T07:14:11.2175701Z 206 |
2025-11-18T07:14:11.2175812Z 207 |       def _load_migrations(self) -> List[Migration]:
2025-11-18T07:14:11.2175956Z     |
2025-11-18T07:14:11.2175961Z 
2025-11-18T07:14:11.2176074Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2176183Z    --> app/infrastructure/database/migrator.py:207:35
2025-11-18T07:14:11.2176241Z     |
2025-11-18T07:14:11.2176301Z 205 |             )
2025-11-18T07:14:11.2176435Z 206 |
2025-11-18T07:14:11.2176546Z 207 |     def _load_migrations(self) -> List[Migration]:
2025-11-18T07:14:11.2176615Z     |                                   ^^^^
2025-11-18T07:14:11.2176736Z 208 |         """Load all migration files from migrations directory.
2025-11-18T07:14:11.2176798Z     |
2025-11-18T07:14:11.2176873Z help: Replace with `list`
2025-11-18T07:14:11.2176878Z 
2025-11-18T07:14:11.2177077Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2177176Z   --> app/infrastructure/db_utils.py:3:1
2025-11-18T07:14:11.2177232Z    |
2025-11-18T07:14:11.2177420Z  1 |   """Database connection utilities for PostgreSQL with connection pooling."""
2025-11-18T07:14:11.2177480Z  2 |
2025-11-18T07:14:11.2177568Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.2177626Z  4 | |
2025-11-18T07:14:11.2177691Z  5 | | import asyncio
2025-11-18T07:14:11.2177757Z  6 | | import logging
2025-11-18T07:14:11.2177857Z  7 | | from contextlib import asynccontextmanager
2025-11-18T07:14:11.2177942Z  8 | | from typing import AsyncIterator
2025-11-18T07:14:11.2177998Z  9 | |
2025-11-18T07:14:11.2178070Z 10 | | import asyncpg
2025-11-18T07:14:11.2178127Z 11 | |
2025-11-18T07:14:11.2178371Z 12 | | from app.infrastructure.postgres import get_db_connection as get_pg_connection, close_pool
2025-11-18T07:14:11.2178508Z    | |__________________________________________________________________________________________^
2025-11-18T07:14:11.2178565Z 13 |
2025-11-18T07:14:11.2178654Z 14 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2178709Z    |
2025-11-18T07:14:11.2178784Z help: Organize imports
2025-11-18T07:14:11.2178789Z 
2025-11-18T07:14:11.2178934Z UP035 [*] Import from `collections.abc` instead: `AsyncIterator`
2025-11-18T07:14:11.2179021Z   --> app/infrastructure/db_utils.py:8:1
2025-11-18T07:14:11.2179079Z    |
2025-11-18T07:14:11.2179144Z  6 | import logging
2025-11-18T07:14:11.2179243Z  7 | from contextlib import asynccontextmanager
2025-11-18T07:14:11.2179335Z  8 | from typing import AsyncIterator
2025-11-18T07:14:11.2179403Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2179460Z  9 |
2025-11-18T07:14:11.2179524Z 10 | import asyncpg
2025-11-18T07:14:11.2179582Z    |
2025-11-18T07:14:11.2179668Z help: Import from `collections.abc`
2025-11-18T07:14:11.2179673Z 
2025-11-18T07:14:11.2179839Z F401 [*] `app.infrastructure.postgres.close_pool` imported but unused
2025-11-18T07:14:11.2179936Z   --> app/infrastructure/db_utils.py:12:81
2025-11-18T07:14:11.2179993Z    |
2025-11-18T07:14:11.2180057Z 10 | import asyncpg
2025-11-18T07:14:11.2180114Z 11 |
2025-11-18T07:14:11.2180357Z 12 | from app.infrastructure.postgres import get_db_connection as get_pg_connection, close_pool
2025-11-18T07:14:11.2180450Z    |                                                                                 ^^^^^^^^^^
2025-11-18T07:14:11.2180506Z 13 |
2025-11-18T07:14:11.2180597Z 14 | logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2180654Z    |
2025-11-18T07:14:11.2180826Z help: Remove unused import: `app.infrastructure.postgres.close_pool`
2025-11-18T07:14:11.2180832Z 
2025-11-18T07:14:11.2180916Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2181006Z   --> app/infrastructure/db_utils.py:35:1
2025-11-18T07:14:11.2181061Z    |
2025-11-18T07:14:11.2181120Z 33 |     """
2025-11-18T07:14:11.2181202Z 34 |     import time as time_module
2025-11-18T07:14:11.2181263Z 35 |     
2025-11-18T07:14:11.2181322Z    | ^^^^
2025-11-18T07:14:11.2181396Z 36 |     last_error = None
2025-11-18T07:14:11.2181491Z 37 |     operation_start = time_module.time()
2025-11-18T07:14:11.2181547Z    |
2025-11-18T07:14:11.2181633Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2181761Z 
2025-11-18T07:14:11.2181843Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2181929Z   --> app/infrastructure/db_utils.py:38:1
2025-11-18T07:14:11.2181987Z    |
2025-11-18T07:14:11.2182061Z 36 |     last_error = None
2025-11-18T07:14:11.2182149Z 37 |     operation_start = time_module.time()
2025-11-18T07:14:11.2182309Z 38 |     
2025-11-18T07:14:11.2182370Z    | ^^^^
2025-11-18T07:14:11.2182458Z 39 |     for attempt in range(max_retries):
2025-11-18T07:14:11.2182520Z 40 |         try:
2025-11-18T07:14:11.2182577Z    |
2025-11-18T07:14:11.2182669Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2182675Z 
2025-11-18T07:14:11.2182755Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2182844Z   --> app/infrastructure/db_utils.py:43:1
2025-11-18T07:14:11.2182904Z    |
2025-11-18T07:14:11.2182984Z 41 |             result = await coro_func()
2025-11-18T07:14:11.2183150Z 42 |             operation_time = int((time_module.time() - operation_start) * 1000)
2025-11-18T07:14:11.2183216Z 43 |             
2025-11-18T07:14:11.2183273Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2183397Z 44 |             # Log slow operations (>500ms) to identify bottlenecks
2025-11-18T07:14:11.2183475Z 45 |             if operation_time > 500:
2025-11-18T07:14:11.2183532Z    |
2025-11-18T07:14:11.2183618Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2183624Z 
2025-11-18T07:14:11.2183700Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2183790Z   --> app/infrastructure/db_utils.py:49:1
2025-11-18T07:14:11.2183846Z    |
2025-11-18T07:14:11.2184012Z 47 |                     f"Slow {operation_name}: {operation_time}ms (attempt {attempt + 1})"
2025-11-18T07:14:11.2184075Z 48 |                 )
2025-11-18T07:14:11.2184133Z 49 |             
2025-11-18T07:14:11.2184192Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2184261Z 50 |             return result
2025-11-18T07:14:11.2184458Z 51 |         except (asyncpg.PostgresConnectionError, asyncpg.InterfaceError) as e:
2025-11-18T07:14:11.2184518Z    |
2025-11-18T07:14:11.2184603Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2184609Z 
2025-11-18T07:14:11.2184689Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2184774Z   --> app/infrastructure/db_utils.py:95:1
2025-11-18T07:14:11.2184830Z    |
2025-11-18T07:14:11.2184952Z 93 |     async with get_pg_connection(database_url) as conn:
2025-11-18T07:14:11.2185022Z 94 |         yield conn
2025-11-18T07:14:11.2185080Z 95 |     
2025-11-18T07:14:11.2185136Z    | ^^^^
2025-11-18T07:14:11.2185194Z 96 |
2025-11-18T07:14:11.2185312Z 97 | async def init_database(database_url: str) -> None:
2025-11-18T07:14:11.2185368Z    |
2025-11-18T07:14:11.2185456Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2185465Z 
2025-11-18T07:14:11.2185544Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2185635Z    --> app/infrastructure/db_utils.py:100:1
2025-11-18T07:14:11.2185692Z     |
2025-11-18T07:14:11.2185752Z  98 |     """
2025-11-18T07:14:11.2185909Z  99 |     Initialize PostgreSQL database by running schema migrations.
2025-11-18T07:14:11.2185971Z 100 |     
2025-11-18T07:14:11.2186031Z     | ^^^^
2025-11-18T07:14:11.2186090Z 101 |     Args:
2025-11-18T07:14:11.2186195Z 102 |         database_url: PostgreSQL connection string
2025-11-18T07:14:11.2186253Z     |
2025-11-18T07:14:11.2186342Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2186348Z 
2025-11-18T07:14:11.2186425Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2186515Z    --> app/infrastructure/db_utils.py:105:1
2025-11-18T07:14:11.2186577Z     |
2025-11-18T07:14:11.2186636Z 103 |     """
2025-11-18T07:14:11.2186713Z 104 |     from pathlib import Path
2025-11-18T07:14:11.2186773Z 105 |     
2025-11-18T07:14:11.2186835Z     | ^^^^
2025-11-18T07:14:11.2186910Z 106 |     # Read PostgreSQL schema
2025-11-18T07:14:11.2187200Z 107 |     schema_path = Path(__file__).resolve().parents[2] / "db" / "schema_postgresql.sql"
2025-11-18T07:14:11.2187262Z     |
2025-11-18T07:14:11.2187345Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2187469Z 
2025-11-18T07:14:11.2187547Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2187638Z    --> app/infrastructure/db_utils.py:111:1
2025-11-18T07:14:11.2187696Z     |
2025-11-18T07:14:11.2187777Z 109 |         # Fallback to legacy location
2025-11-18T07:14:11.2188085Z 110 |         schema_path = Path(__file__).resolve().parent.parent / "db" / "schema_postgresql.sql"
2025-11-18T07:14:11.2188147Z 111 |     
2025-11-18T07:14:11.2188203Z     | ^^^^
2025-11-18T07:14:11.2188284Z 112 |     if not schema_path.exists():
2025-11-18T07:14:11.2188523Z 113 |         logger.warning(f"PostgreSQL schema not found at {schema_path}, skipping initialization")
2025-11-18T07:14:11.2188581Z     |
2025-11-18T07:14:11.2188666Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2188671Z 
2025-11-18T07:14:11.2188749Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2188835Z    --> app/infrastructure/db_utils.py:115:1
2025-11-18T07:14:11.2188896Z     |
2025-11-18T07:14:11.2189118Z 113 |         logger.warning(f"PostgreSQL schema not found at {schema_path}, skipping initialization")
2025-11-18T07:14:11.2189183Z 114 |         return
2025-11-18T07:14:11.2189240Z 115 |     
2025-11-18T07:14:11.2189297Z     | ^^^^
2025-11-18T07:14:11.2189422Z 116 |     async with get_db_connection(database_url) as conn:
2025-11-18T07:14:11.2189554Z 117 |         schema_sql = schema_path.read_text(encoding="utf-8")
2025-11-18T07:14:11.2189612Z     |
2025-11-18T07:14:11.2189697Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2189703Z 
2025-11-18T07:14:11.2189782Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2189869Z    --> app/infrastructure/db_utils.py:137:1
2025-11-18T07:14:11.2189927Z     |
2025-11-18T07:14:11.2189989Z 135 |     """
2025-11-18T07:14:11.2190142Z 136 |     Apply versioned SQL migrations from db/migrations/ directory.
2025-11-18T07:14:11.2190200Z 137 |     
2025-11-18T07:14:11.2190264Z     | ^^^^
2025-11-18T07:14:11.2190502Z 138 |     - Creates a tracking table migrations_applied(filename TEXT PRIMARY KEY, applied_at BIGINT)
2025-11-18T07:14:11.2190648Z 139 |     - Applies any .sql files not yet recorded, in lexical order
2025-11-18T07:14:11.2190707Z     |
2025-11-18T07:14:11.2190790Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2190799Z 
2025-11-18T07:14:11.2190875Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2190962Z    --> app/infrastructure/db_utils.py:144:1
2025-11-18T07:14:11.2191022Z     |
2025-11-18T07:14:11.2191086Z 142 |     import time
2025-11-18T07:14:11.2191162Z 143 |     from pathlib import Path
2025-11-18T07:14:11.2191223Z 144 |     
2025-11-18T07:14:11.2191280Z     | ^^^^
2025-11-18T07:14:11.2191359Z 145 |     migrations_dir_candidates = [
2025-11-18T07:14:11.2191487Z 146 |         Path(__file__).resolve().parents[2] / "db" / "migrations",
2025-11-18T07:14:11.2191547Z     |
2025-11-18T07:14:11.2191630Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2191636Z 
2025-11-18T07:14:11.2191716Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2191807Z    --> app/infrastructure/db_utils.py:157:1
2025-11-18T07:14:11.2191864Z     |
2025-11-18T07:14:11.2192028Z 155 |         logger.info("No migrations directory found; skipping migrations")
2025-11-18T07:14:11.2192092Z 156 |         return
2025-11-18T07:14:11.2192153Z 157 |     
2025-11-18T07:14:11.2192209Z     | ^^^^
2025-11-18T07:14:11.2192437Z 158 |     migration_files = sorted([f for f in migrations_dir.iterdir() if f.suffix.lower() == ".sql"])
2025-11-18T07:14:11.2192517Z 159 |     if not migration_files:
2025-11-18T07:14:11.2192575Z     |
2025-11-18T07:14:11.2192657Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2192663Z 
2025-11-18T07:14:11.2192742Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2192829Z    --> app/infrastructure/db_utils.py:162:1
2025-11-18T07:14:11.2192887Z     |
2025-11-18T07:14:11.2193022Z 160 |         logger.info("No migration files found; nothing to apply")
2025-11-18T07:14:11.2193170Z 161 |         return
2025-11-18T07:14:11.2193228Z 162 |     
2025-11-18T07:14:11.2193284Z     | ^^^^
2025-11-18T07:14:11.2193405Z 163 |     async with get_db_connection(database_url) as conn:
2025-11-18T07:14:11.2193495Z 164 |         # Ensure tracking table exists
2025-11-18T07:14:11.2193551Z     |
2025-11-18T07:14:11.2193745Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2193751Z 
2025-11-18T07:14:11.2193828Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2193915Z    --> app/infrastructure/db_utils.py:175:1
2025-11-18T07:14:11.2193973Z     |
2025-11-18T07:14:11.2194136Z 173 |         rows = await conn.fetch("SELECT filename FROM migrations_applied")
2025-11-18T07:14:11.2194247Z 174 |         already_applied = {r["filename"] for r in rows}
2025-11-18T07:14:11.2194306Z 175 |         
2025-11-18T07:14:11.2194367Z     | ^^^^^^^^
2025-11-18T07:14:11.2194537Z 176 |         to_apply = [mf for mf in migration_files if mf.name not in already_applied]
2025-11-18T07:14:11.2194613Z 177 |         if not to_apply:
2025-11-18T07:14:11.2194672Z     |
2025-11-18T07:14:11.2194756Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2194761Z 
2025-11-18T07:14:11.2194837Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2194923Z    --> app/infrastructure/db_utils.py:180:1
2025-11-18T07:14:11.2194987Z     |
2025-11-18T07:14:11.2195104Z 178 |             logger.info("All migrations already applied")
2025-11-18T07:14:11.2195170Z 179 |             return
2025-11-18T07:14:11.2195230Z 180 |         
2025-11-18T07:14:11.2195288Z     | ^^^^^^^^
2025-11-18T07:14:11.2195356Z 181 |         logger.info(
2025-11-18T07:14:11.2195436Z 182 |             "Applying migrations",
2025-11-18T07:14:11.2195494Z     |
2025-11-18T07:14:11.2195577Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2195582Z 
2025-11-18T07:14:11.2195659Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2195749Z    --> app/infrastructure/db_utils.py:185:1
2025-11-18T07:14:11.2195806Z     |
2025-11-18T07:14:11.2195964Z 183 |             extra={"count": len(to_apply), "files": [f.name for f in to_apply]},
2025-11-18T07:14:11.2196025Z 184 |         )
2025-11-18T07:14:11.2196082Z 185 |         
2025-11-18T07:14:11.2196139Z     | ^^^^^^^^
2025-11-18T07:14:11.2196212Z 186 |         for mf in to_apply:
2025-11-18T07:14:11.2196316Z 187 |             sql = mf.read_text(encoding="utf-8")
2025-11-18T07:14:11.2196372Z     |
2025-11-18T07:14:11.2196454Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2196459Z 
2025-11-18T07:14:11.2196599Z UP035 [*] Import from `collections.abc` instead: `AsyncIterator`
2025-11-18T07:14:11.2196690Z   --> app/infrastructure/postgres.py:8:1
2025-11-18T07:14:11.2196746Z    |
2025-11-18T07:14:11.2196811Z  6 | import logging
2025-11-18T07:14:11.2196912Z  7 | from contextlib import asynccontextmanager
2025-11-18T07:14:11.2197091Z  8 | from typing import AsyncIterator
2025-11-18T07:14:11.2197160Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2197220Z  9 |
2025-11-18T07:14:11.2197287Z 10 | import asyncpg
2025-11-18T07:14:11.2197345Z    |
2025-11-18T07:14:11.2197431Z help: Import from `collections.abc`
2025-11-18T07:14:11.2197437Z 
2025-11-18T07:14:11.2197511Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2197602Z   --> app/infrastructure/postgres.py:21:1
2025-11-18T07:14:11.2197661Z    |
2025-11-18T07:14:11.2197887Z 19 | async def get_pool(database_url: str, min_size: int = 10, max_size: int = 20) -> asyncpg.Pool:
2025-11-18T07:14:11.2197990Z 20 |     """Get or create PostgreSQL connection pool.
2025-11-18T07:14:11.2198048Z 21 |     
2025-11-18T07:14:11.2198109Z    | ^^^^
2025-11-18T07:14:11.2198168Z 22 |     Args:
2025-11-18T07:14:11.2198920Z 23 |         database_url: PostgreSQL connection string (***host:port/dbname)
2025-11-18T07:14:11.2198988Z    |
2025-11-18T07:14:11.2199086Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2199093Z 
2025-11-18T07:14:11.2199181Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2199287Z   --> app/infrastructure/postgres.py:26:1
2025-11-18T07:14:11.2199480Z    |
2025-11-18T07:14:11.2199668Z 24 |         min_size: Minimum number of connections in pool (increased from 5 to 10)
2025-11-18T07:14:11.2199842Z 25 |         max_size: Maximum number of connections in pool (increased from 10 to 20)
2025-11-18T07:14:11.2199902Z 26 |         
2025-11-18T07:14:11.2200064Z    | ^^^^^^^^
2025-11-18T07:14:11.2200128Z 27 |     Returns:
2025-11-18T07:14:11.2200211Z 28 |         Connection pool instance
2025-11-18T07:14:11.2200268Z    |
2025-11-18T07:14:11.2200358Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2200363Z 
2025-11-18T07:14:11.2200442Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2200537Z   --> app/infrastructure/postgres.py:31:1
2025-11-18T07:14:11.2200599Z    |
2025-11-18T07:14:11.2200658Z 29 |     """
2025-11-18T07:14:11.2200725Z 30 |     global _pool
2025-11-18T07:14:11.2200783Z 31 |     
2025-11-18T07:14:11.2200844Z    | ^^^^
2025-11-18T07:14:11.2200920Z 32 |     async with _pool_lock:
2025-11-18T07:14:11.2200997Z 33 |         if _pool is None:
2025-11-18T07:14:11.2201056Z    |
2025-11-18T07:14:11.2201141Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2201147Z 
2025-11-18T07:14:11.2201224Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2201318Z   --> app/infrastructure/postgres.py:43:1
2025-11-18T07:14:11.2201380Z    |
2025-11-18T07:14:11.2201616Z 41 |                 f"PostgreSQL connection pool created (min={min_size}, max={max_size}, command_timeout=60s)"
2025-11-18T07:14:11.2201679Z 42 |             )
2025-11-18T07:14:11.2201740Z 43 |     
2025-11-18T07:14:11.2201798Z    | ^^^^
2025-11-18T07:14:11.2201863Z 44 |     return _pool
2025-11-18T07:14:11.2201922Z    |
2025-11-18T07:14:11.2202005Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2202011Z 
2025-11-18T07:14:11.2202088Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2202178Z   --> app/infrastructure/postgres.py:50:1
2025-11-18T07:14:11.2202239Z    |
2025-11-18T07:14:11.2202338Z 48 |     """Close the global connection pool."""
2025-11-18T07:14:11.2202403Z 49 |     global _pool
2025-11-18T07:14:11.2202466Z 50 |     
2025-11-18T07:14:11.2202525Z    | ^^^^
2025-11-18T07:14:11.2202597Z 51 |     async with _pool_lock:
2025-11-18T07:14:11.2202672Z 52 |         if _pool is not None:
2025-11-18T07:14:11.2202737Z    |
2025-11-18T07:14:11.2202821Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2202826Z 
2025-11-18T07:14:11.2202907Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2203000Z   --> app/infrastructure/postgres.py:61:1
2025-11-18T07:14:11.2203056Z    |
2025-11-18T07:14:11.2203269Z 59 | async def get_db_connection(database_url: str) -> AsyncIterator[asyncpg.Connection]:
2025-11-18T07:14:11.2203375Z 60 |     """Get a database connection from the pool.
2025-11-18T07:14:11.2203433Z 61 |     
2025-11-18T07:14:11.2203489Z    | ^^^^
2025-11-18T07:14:11.2203548Z 62 |     Args:
2025-11-18T07:14:11.2203657Z 63 |         database_url: PostgreSQL connection string
2025-11-18T07:14:11.2203718Z    |
2025-11-18T07:14:11.2203801Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2203807Z 
2025-11-18T07:14:11.2203887Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2203977Z   --> app/infrastructure/postgres.py:64:1
2025-11-18T07:14:11.2204034Z    |
2025-11-18T07:14:11.2204095Z 62 |     Args:
2025-11-18T07:14:11.2204199Z 63 |         database_url: PostgreSQL connection string
2025-11-18T07:14:11.2204258Z 64 |         
2025-11-18T07:14:11.2204317Z    | ^^^^^^^^
2025-11-18T07:14:11.2204380Z 65 |     Yields:
2025-11-18T07:14:11.2204465Z 66 |         asyncpg.Connection from pool
2025-11-18T07:14:11.2204523Z    |
2025-11-18T07:14:11.2204611Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2204617Z 
2025-11-18T07:14:11.2204694Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2204783Z   --> app/infrastructure/postgres.py:67:1
2025-11-18T07:14:11.2204843Z    |
2025-11-18T07:14:11.2204908Z 65 |     Yields:
2025-11-18T07:14:11.2204991Z 66 |         asyncpg.Connection from pool
2025-11-18T07:14:11.2205136Z 67 |         
2025-11-18T07:14:11.2205196Z    | ^^^^^^^^
2025-11-18T07:14:11.2205419Z 68 |     Logs pool statistics when connection is acquired/released to help identify contention.
2025-11-18T07:14:11.2205479Z 69 |     """
2025-11-18T07:14:11.2205536Z    |
2025-11-18T07:14:11.2205695Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2205701Z 
2025-11-18T07:14:11.2205780Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2205870Z   --> app/infrastructure/postgres.py:71:1
2025-11-18T07:14:11.2205931Z    |
2025-11-18T07:14:11.2205990Z 69 |     """
2025-11-18T07:14:11.2206067Z 70 |     import time as time_module
2025-11-18T07:14:11.2206133Z 71 |     
2025-11-18T07:14:11.2206192Z    | ^^^^
2025-11-18T07:14:11.2206283Z 72 |     pool = await get_pool(database_url)
2025-11-18T07:14:11.2206373Z 73 |     acquire_start = time_module.time()
2025-11-18T07:14:11.2206437Z    |
2025-11-18T07:14:11.2206520Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2206530Z 
2025-11-18T07:14:11.2206610Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2206702Z   --> app/infrastructure/postgres.py:74:1
2025-11-18T07:14:11.2206759Z    |
2025-11-18T07:14:11.2206844Z 72 |     pool = await get_pool(database_url)
2025-11-18T07:14:11.2206928Z 73 |     acquire_start = time_module.time()
2025-11-18T07:14:11.2207102Z 74 |     
2025-11-18T07:14:11.2207161Z    | ^^^^
2025-11-18T07:14:11.2207243Z 75 |     # Log pool status before acquiring
2025-11-18T07:14:11.2207313Z 76 |     pool_stats = {
2025-11-18T07:14:11.2207370Z    |
2025-11-18T07:14:11.2207454Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2207460Z 
2025-11-18T07:14:11.2207542Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2207631Z   --> app/infrastructure/postgres.py:81:1
2025-11-18T07:14:11.2207688Z    |
2025-11-18T07:14:11.2207843Z 79 |         "active_connections": pool.get_size() - pool.get_idle_size(),
2025-11-18T07:14:11.2207906Z 80 |     }
2025-11-18T07:14:11.2207967Z 81 |     
2025-11-18T07:14:11.2208023Z    | ^^^^
2025-11-18T07:14:11.2208137Z 82 |     # Warn if pool is getting full (80% utilization)
2025-11-18T07:14:11.2208403Z 83 |     utilization = (pool_stats["active_connections"] / pool_stats["size"]) * 100 if pool_stats["size"] > 0 else 0
2025-11-18T07:14:11.2208462Z    |
2025-11-18T07:14:11.2208549Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2208557Z 
2025-11-18T07:14:11.2208635Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2208724Z   --> app/infrastructure/postgres.py:89:1
2025-11-18T07:14:11.2208779Z    |
2025-11-18T07:14:11.2208971Z 87 |             f"({pool_stats['active_connections']}/{pool_stats['size']} connections in use)"
2025-11-18T07:14:11.2209031Z 88 |         )
2025-11-18T07:14:11.2209088Z 89 |     
2025-11-18T07:14:11.2209147Z    | ^^^^
2025-11-18T07:14:11.2209227Z 90 |     conn = await pool.acquire()
2025-11-18T07:14:11.2209371Z 91 |     acquire_time = int((time_module.time() - acquire_start) * 1000)
2025-11-18T07:14:11.2209431Z    |
2025-11-18T07:14:11.2209519Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2209524Z 
2025-11-18T07:14:11.2209603Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2209691Z   --> app/infrastructure/postgres.py:92:1
2025-11-18T07:14:11.2209753Z    |
2025-11-18T07:14:11.2209833Z 90 |     conn = await pool.acquire()
2025-11-18T07:14:11.2209973Z 91 |     acquire_time = int((time_module.time() - acquire_start) * 1000)
2025-11-18T07:14:11.2210035Z 92 |     
2025-11-18T07:14:11.2210092Z    | ^^^^
2025-11-18T07:14:11.2210235Z 93 |     # Log if connection acquisition took significant time (>100ms)
2025-11-18T07:14:11.2210309Z 94 |     if acquire_time > 100:
2025-11-18T07:14:11.2210370Z    |
2025-11-18T07:14:11.2210454Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2210459Z 
2025-11-18T07:14:11.2210537Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2210636Z    --> app/infrastructure/postgres.py:98:1
2025-11-18T07:14:11.2210694Z     |
2025-11-18T07:14:11.2211125Z  96 |             f"Slow connection acquisition: {acquire_time}ms (pool: {pool_stats['active_connections']}/{pool_stats['size']} active)"
2025-11-18T07:14:11.2211193Z  97 |         )
2025-11-18T07:14:11.2211252Z  98 |     
2025-11-18T07:14:11.2211308Z     | ^^^^
2025-11-18T07:14:11.2211367Z  99 |     try:
2025-11-18T07:14:11.2211540Z 100 |         yield conn
2025-11-18T07:14:11.2211598Z     |
2025-11-18T07:14:11.2211681Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2211686Z 
2025-11-18T07:14:11.2211766Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2211859Z    --> app/infrastructure/postgres.py:105:1
2025-11-18T07:14:11.2211917Z     |
2025-11-18T07:14:11.2211997Z 103 |         await pool.release(conn)
2025-11-18T07:14:11.2212152Z 104 |         release_time = int((time_module.time() - release_start) * 1000)
2025-11-18T07:14:11.2212212Z 105 |         
2025-11-18T07:14:11.2212270Z     | ^^^^^^^^
2025-11-18T07:14:11.2212405Z 106 |         # Log if connection release took significant time (>50ms)
2025-11-18T07:14:11.2212484Z 107 |         if release_time > 50:
2025-11-18T07:14:11.2212543Z     |
2025-11-18T07:14:11.2212627Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2212635Z 
2025-11-18T07:14:11.2212715Z F401 [*] `re` imported but unused
2025-11-18T07:14:11.2212821Z  --> app/infrastructure/query_converter.py:5:8
2025-11-18T07:14:11.2212884Z   |
2025-11-18T07:14:11.2212972Z 3 | from __future__ import annotations
2025-11-18T07:14:11.2213031Z 4 |
2025-11-18T07:14:11.2213093Z 5 | import re
2025-11-18T07:14:11.2213155Z   |        ^^
2025-11-18T07:14:11.2213230Z 6 | from typing import Any
2025-11-18T07:14:11.2213286Z   |
2025-11-18T07:14:11.2213366Z help: Remove unused import: `re`
2025-11-18T07:14:11.2213371Z 
2025-11-18T07:14:11.2213460Z F401 [*] `typing.Any` imported but unused
2025-11-18T07:14:11.2213566Z  --> app/infrastructure/query_converter.py:6:20
2025-11-18T07:14:11.2213622Z   |
2025-11-18T07:14:11.2213686Z 5 | import re
2025-11-18T07:14:11.2213763Z 6 | from typing import Any
2025-11-18T07:14:11.2213826Z   |                    ^^^
2025-11-18T07:14:11.2213882Z   |
2025-11-18T07:14:11.2213975Z help: Remove unused import: `typing.Any`
2025-11-18T07:14:11.2213981Z 
2025-11-18T07:14:11.2214059Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2214161Z   --> app/infrastructure/query_converter.py:11:1
2025-11-18T07:14:11.2214222Z    |
2025-11-18T07:14:11.2214501Z  9 | def convert_query_to_postgres(query: str, params: tuple | list | None = None) -> tuple[str, tuple | list | None]:
2025-11-18T07:14:11.2214680Z 10 |     """Convert SQLite query with ? placeholders to PostgreSQL with $1, $2, etc.
2025-11-18T07:14:11.2214741Z 11 |     
2025-11-18T07:14:11.2214799Z    | ^^^^
2025-11-18T07:14:11.2214859Z 12 |     Args:
2025-11-18T07:14:11.2214952Z 13 |         query: SQL query with ? placeholders
2025-11-18T07:14:11.2215012Z    |
2025-11-18T07:14:11.2215097Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2215102Z 
2025-11-18T07:14:11.2215179Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2215288Z   --> app/infrastructure/query_converter.py:15:1
2025-11-18T07:14:11.2215348Z    |
2025-11-18T07:14:11.2215437Z 13 |         query: SQL query with ? placeholders
2025-11-18T07:14:11.2215542Z 14 |         params: Query parameters (tuple or list)
2025-11-18T07:14:11.2215605Z 15 |         
2025-11-18T07:14:11.2215665Z    | ^^^^^^^^
2025-11-18T07:14:11.2215725Z 16 |     Returns:
2025-11-18T07:14:11.2215886Z 17 |         Tuple of (converted_query, params) - params unchanged for asyncpg
2025-11-18T07:14:11.2215944Z    |
2025-11-18T07:14:11.2216030Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2216036Z 
2025-11-18T07:14:11.2216119Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2216217Z   --> app/infrastructure/query_converter.py:21:1
2025-11-18T07:14:11.2216275Z    |
2025-11-18T07:14:11.2216346Z 19 |     if params is None:
2025-11-18T07:14:11.2216420Z 20 |         return query, None
2025-11-18T07:14:11.2216479Z 21 |     
2025-11-18T07:14:11.2216645Z    | ^^^^
2025-11-18T07:14:11.2216733Z 22 |     # Count number of ? placeholders
2025-11-18T07:14:11.2216825Z 23 |     placeholder_count = query.count('?')
2025-11-18T07:14:11.2216883Z    |
2025-11-18T07:14:11.2217062Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2217072Z 
2025-11-18T07:14:11.2217269Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2217371Z   --> app/infrastructure/query_converter.py:24:1
2025-11-18T07:14:11.2217429Z    |
2025-11-18T07:14:11.2217518Z 22 |     # Count number of ? placeholders
2025-11-18T07:14:11.2217610Z 23 |     placeholder_count = query.count('?')
2025-11-18T07:14:11.2217671Z 24 |     
2025-11-18T07:14:11.2217732Z    | ^^^^
2025-11-18T07:14:11.2217812Z 25 |     if placeholder_count == 0:
2025-11-18T07:14:11.2217887Z 26 |         return query, params
2025-11-18T07:14:11.2217946Z    |
2025-11-18T07:14:11.2218032Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2218037Z 
2025-11-18T07:14:11.2218114Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2218219Z   --> app/infrastructure/query_converter.py:27:1
2025-11-18T07:14:11.2218279Z    |
2025-11-18T07:14:11.2218355Z 25 |     if placeholder_count == 0:
2025-11-18T07:14:11.2218429Z 26 |         return query, params
2025-11-18T07:14:11.2218491Z 27 |     
2025-11-18T07:14:11.2218551Z    | ^^^^
2025-11-18T07:14:11.2218627Z 28 |     # Replace ? with $1, $2, etc.
2025-11-18T07:14:11.2218697Z 29 |     converted = query
2025-11-18T07:14:11.2218758Z    |
2025-11-18T07:14:11.2218842Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2218848Z 
2025-11-18T07:14:11.2218926Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2219026Z   --> app/infrastructure/query_converter.py:32:1
2025-11-18T07:14:11.2219084Z    |
2025-11-18T07:14:11.2219180Z 30 |     for i in range(1, placeholder_count + 1):
2025-11-18T07:14:11.2219295Z 31 |         converted = converted.replace('?', f'${i}', 1)
2025-11-18T07:14:11.2219358Z 32 |     
2025-11-18T07:14:11.2219417Z    | ^^^^
2025-11-18T07:14:11.2219498Z 33 |     return converted, params
2025-11-18T07:14:11.2219558Z    |
2025-11-18T07:14:11.2219641Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2219647Z 
2025-11-18T07:14:11.2219747Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2219822Z   --> app/main.py:1:1
2025-11-18T07:14:11.2219881Z    |
2025-11-18T07:14:11.2219964Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.2220021Z  2 | |
2025-11-18T07:14:11.2220091Z  3 | | import asyncio
2025-11-18T07:14:11.2220155Z  4 | | import logging
2025-11-18T07:14:11.2220220Z  5 | | import socket
2025-11-18T07:14:11.2220280Z  6 | |
2025-11-18T07:14:11.2220345Z  7 | | import aiohttp
2025-11-18T07:14:11.2220423Z  8 | | from typing import Any, cast
2025-11-18T07:14:11.2220480Z  9 | |
2025-11-18T07:14:11.2220574Z 10 | | from aiogram import Bot, Dispatcher
2025-11-18T07:14:11.2220718Z 11 | | from aiogram.client.default import DefaultBotProperties
2025-11-18T07:14:11.2220809Z 12 | | from aiogram.types import BotCommand
2025-11-18T07:14:11.2220876Z 13 | |
2025-11-18T07:14:11.2220963Z 14 | | from app.config import get_settings
2025-11-18T07:14:11.2221106Z 15 | | from app.constants import USER_COMMANDS, CHECKERS_COMMANDS
2025-11-18T07:14:11.2221276Z 16 | | from app.handlers.admin import router as admin_router, ADMIN_COMMANDS
2025-11-18T07:14:11.2221405Z 17 | | from app.handlers.chat import router as chat_router
2025-11-18T07:14:11.2221634Z 18 | | from app.handlers.profile_admin import router as profile_admin_router, PROFILE_COMMANDS
2025-11-18T07:14:11.2221824Z 19 | | from app.handlers.chat_admin import router as chat_admin_router, CHAT_COMMANDS
2025-11-18T07:14:11.2222043Z 20 | | from app.handlers.prompt_admin import router as prompt_admin_router, PROMPT_COMMANDS
2025-11-18T07:14:11.2222203Z 21 | | from app.handlers.chat_members import router as chat_members_router
2025-11-18T07:14:11.2222344Z 22 | | from app.handlers.checkers import router as checkers_router
2025-11-18T07:14:11.2222485Z 23 | | from app.handlers.handlers import router as handlers_router
2025-11-18T07:14:11.2222752Z 24 | | from app.middlewares.chat_filter import ChatFilterMiddleware
2025-11-18T07:14:11.2222886Z 25 | | from app.middlewares.chat_meta import ChatMetaMiddleware
2025-11-18T07:14:11.2223071Z 26 | | from app.middlewares.command_throttle import CommandThrottleMiddleware
2025-11-18T07:14:11.2223322Z 27 | | from app.middlewares.processing_lock import ProcessingLockMiddleware
2025-11-18T07:14:11.2223453Z 28 | | from app.core.initialization import init_redis_client
2025-11-18T07:14:11.2223657Z 29 | | from app.services.context_store import ContextStore, run_retention_pruning_task
2025-11-18T07:14:11.2223762Z 30 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2223932Z 31 | | from app.services.user_profile_adapter import UserProfileStoreAdapter
2025-11-18T07:14:11.2224090Z 32 | | from app.repositories.chat_profile import ChatProfileRepository
2025-11-18T07:14:11.2224250Z 33 | | from app.services.profile_summarization import ProfileSummarizer
2025-11-18T07:14:11.2224368Z 34 | | from app.services.rate_limiter import RateLimiter
2025-11-18T07:14:11.2224521Z 35 | | from app.services.feature_rate_limiter import FeatureRateLimiter
2025-11-18T07:14:11.2224672Z 36 | | from app.services.donation_scheduler import DonationScheduler
2025-11-18T07:14:11.2224777Z 37 | | from app.services.resource_monitor import (
2025-11-18T07:14:11.2224854Z 38 | |     get_resource_monitor,
2025-11-18T07:14:11.2224942Z 39 | |     run_resource_monitoring_task,
2025-11-18T07:14:11.2225004Z 40 | | )
2025-11-18T07:14:11.2225168Z 41 | | from app.services.system_prompt_manager import SystemPromptManager
2025-11-18T07:14:11.2225280Z 42 | | from app.services.resource_optimizer import (
2025-11-18T07:14:11.2225359Z 43 | |     get_resource_optimizer,
2025-11-18T07:14:11.2225443Z 44 | |     periodic_optimization_check,
2025-11-18T07:14:11.2225501Z 45 | | )
2025-11-18T07:14:11.2225691Z 46 | | from app.services.context import HybridSearchEngine, EpisodicMemoryStore
2025-11-18T07:14:11.2225914Z 47 | | from app.services.context.episode_boundary_detector import EpisodeBoundaryDetector
2025-11-18T07:14:11.2226070Z 48 | | from app.services.context.episode_monitor import EpisodeMonitor
2025-11-18T07:14:11.2226244Z 49 | | from app.services.context.episode_summarizer import EpisodeSummarizer
2025-11-18T07:14:11.2226369Z 50 | | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.2226500Z 51 | | from app.services.bot_learning import BotLearningEngine
2025-11-18T07:14:11.2226655Z 52 | | from app.repositories.memory_repository import MemoryRepository
2025-11-18T07:14:11.2226797Z 53 | | from app.services.telegram_service import TelegramService
2025-11-18T07:14:11.2226936Z 54 | | from app.observability.metrics import start_metrics_server
2025-11-18T07:14:11.2227129Z    | |__________________________________________________________^
2025-11-18T07:14:11.2227192Z    |
2025-11-18T07:14:11.2227264Z help: Organize imports
2025-11-18T07:14:11.2227270Z 
2025-11-18T07:14:11.2227391Z F401 [*] `aiogram.types.BotCommand` imported but unused
2025-11-18T07:14:11.2227469Z   --> app/main.py:12:27
2025-11-18T07:14:11.2227527Z    |
2025-11-18T07:14:11.2227613Z 10 | from aiogram import Bot, Dispatcher
2025-11-18T07:14:11.2227746Z 11 | from aiogram.client.default import DefaultBotProperties
2025-11-18T07:14:11.2227840Z 12 | from aiogram.types import BotCommand
2025-11-18T07:14:11.2227907Z    |                           ^^^^^^^^^^
2025-11-18T07:14:11.2227964Z 13 |
2025-11-18T07:14:11.2228052Z 14 | from app.config import get_settings
2025-11-18T07:14:11.2228109Z    |
2025-11-18T07:14:11.2228232Z help: Remove unused import: `aiogram.types.BotCommand`
2025-11-18T07:14:11.2228238Z 
2025-11-18T07:14:11.2228466Z F401 [*] `app.services.resource_optimizer.periodic_optimization_check` imported but unused
2025-11-18T07:14:11.2228538Z   --> app/main.py:44:5
2025-11-18T07:14:11.2228595Z    |
2025-11-18T07:14:11.2228701Z 42 | from app.services.resource_optimizer import (
2025-11-18T07:14:11.2228781Z 43 |     get_resource_optimizer,
2025-11-18T07:14:11.2228981Z 44 |     periodic_optimization_check,
2025-11-18T07:14:11.2229050Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2229112Z 45 | )
2025-11-18T07:14:11.2229297Z 46 | from app.services.context import HybridSearchEngine, EpisodicMemoryStore
2025-11-18T07:14:11.2229457Z    |
2025-11-18T07:14:11.2229684Z help: Remove unused import: `app.services.resource_optimizer.periodic_optimization_check`
2025-11-18T07:14:11.2229690Z 
2025-11-18T07:14:11.2229801Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2229872Z   --> app/main.py:72:20
2025-11-18T07:14:11.2229928Z    |
2025-11-18T07:14:11.2229997Z 70 |                         if ip:
2025-11-18T07:14:11.2230072Z 71 |                             return ip
2025-11-18T07:14:11.2230201Z 72 |             except (aiohttp.ClientError, asyncio.TimeoutError):
2025-11-18T07:14:11.2230285Z    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2230353Z 73 |                 continue
2025-11-18T07:14:11.2230417Z    |
2025-11-18T07:14:11.2230512Z help: Replace with builtin `TimeoutError`
2025-11-18T07:14:11.2230517Z 
2025-11-18T07:14:11.2230617Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2230692Z    --> app/main.py:145:5
2025-11-18T07:14:11.2230749Z     |
2025-11-18T07:14:11.2230843Z 144 |     # Initialize PostgreSQL database
2025-11-18T07:14:11.2231028Z 145 |     from app.infrastructure.db_utils import init_database, apply_migrations
2025-11-18T07:14:11.2231110Z     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2231170Z 146 |
2025-11-18T07:14:11.2231275Z 147 |     await init_database(settings.database_url)
2025-11-18T07:14:11.2231333Z     |
2025-11-18T07:14:11.2231404Z help: Organize imports
2025-11-18T07:14:11.2231410Z 
2025-11-18T07:14:11.2231504Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2231575Z    --> app/main.py:493:9
2025-11-18T07:14:11.2231632Z     |
2025-11-18T07:14:11.2231769Z 492 |           # Cleanup: Close aiohttp sessions for external services
2025-11-18T07:14:11.2231909Z 493 | /         from app.services.weather import cleanup_weather_service
2025-11-18T07:14:11.2232055Z 494 | |         from app.services.currency import cleanup_currency_service
2025-11-18T07:14:11.2232163Z     | |__________________________________________________________________^
2025-11-18T07:14:11.2232220Z 495 |
2025-11-18T07:14:11.2232284Z 496 |           try:
2025-11-18T07:14:11.2232343Z     |
2025-11-18T07:14:11.2232412Z help: Organize imports
2025-11-18T07:14:11.2232418Z 
2025-11-18T07:14:11.2232577Z UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`
2025-11-18T07:14:11.2232666Z  --> app/middlewares/chat_filter.py:6:1
2025-11-18T07:14:11.2232726Z   |
2025-11-18T07:14:11.2232791Z 5 | import logging
2025-11-18T07:14:11.2232888Z 6 | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2232963Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2233027Z 7 |
2025-11-18T07:14:11.2233115Z 8 | from aiogram import BaseMiddleware
2025-11-18T07:14:11.2233172Z   |
2025-11-18T07:14:11.2233259Z help: Import from `collections.abc`
2025-11-18T07:14:11.2233265Z 
2025-11-18T07:14:11.2233366Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2233456Z   --> app/middlewares/chat_meta.py:1:1
2025-11-18T07:14:11.2233516Z    |
2025-11-18T07:14:11.2233599Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.2233658Z  2 | |
2025-11-18T07:14:11.2233728Z  3 | | import asyncio
2025-11-18T07:14:11.2233820Z  4 | | from typing import TYPE_CHECKING, Any
2025-11-18T07:14:11.2233877Z  5 | |
2025-11-18T07:14:11.2233972Z  6 | | from aiogram import BaseMiddleware, Bot
2025-11-18T07:14:11.2234091Z  7 | | from aiogram.types import Message, CallbackQuery
2025-11-18T07:14:11.2234148Z  8 | |
2025-11-18T07:14:11.2234229Z  9 | | from app.config import Settings
2025-11-18T07:14:11.2234354Z 10 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.2234550Z 11 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2234661Z 12 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2234801Z 13 | | from app.services.telegram_service import TelegramService
2025-11-18T07:14:11.2234899Z    | |_________________________________________________________^
2025-11-18T07:14:11.2235030Z 14 |
2025-11-18T07:14:11.2235100Z 15 |   if TYPE_CHECKING:
2025-11-18T07:14:11.2235159Z    |
2025-11-18T07:14:11.2235230Z help: Organize imports
2025-11-18T07:14:11.2235235Z 
2025-11-18T07:14:11.2235332Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2235422Z   --> app/middlewares/chat_meta.py:22:1
2025-11-18T07:14:11.2235484Z    |
2025-11-18T07:14:11.2235544Z 20 |   else:
2025-11-18T07:14:11.2235624Z 21 |       ProfileStoreType = Any
2025-11-18T07:14:11.2235716Z 22 | / from app.services.context import (
2025-11-18T07:14:11.2235794Z 23 | |     HybridSearchEngine,
2025-11-18T07:14:11.2235869Z 24 | |     EpisodicMemoryStore,
2025-11-18T07:14:11.2235958Z 25 | |     MultiLevelContextManager,
2025-11-18T07:14:11.2236016Z 26 | | )
2025-11-18T07:14:11.2236175Z 27 | | from app.services.context.episode_monitor import EpisodeMonitor
2025-11-18T07:14:11.2236298Z 28 | | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.2236434Z 29 | | from app.services.bot_learning import BotLearningEngine
2025-11-18T07:14:11.2236600Z 30 | | from app.services.system_prompt_manager import SystemPromptManager
2025-11-18T07:14:11.2236714Z 31 | | from app.services.rate_limiter import RateLimiter
2025-11-18T07:14:11.2236834Z 32 | | from app.services.persona import PersonaLoader
2025-11-18T07:14:11.2237090Z 33 | | from app.repositories.memory_repository import MemoryRepository
2025-11-18T07:14:11.2237192Z    | |_______________________________________________________________^
2025-11-18T07:14:11.2237252Z    |
2025-11-18T07:14:11.2237324Z help: Organize imports
2025-11-18T07:14:11.2237329Z 
2025-11-18T07:14:11.2237488Z UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`
2025-11-18T07:14:11.2237596Z   --> app/middlewares/command_throttle.py:15:1
2025-11-18T07:14:11.2237654Z    |
2025-11-18T07:14:11.2237720Z 14 | import logging
2025-11-18T07:14:11.2237818Z 15 | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2237897Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2237953Z 16 |
2025-11-18T07:14:11.2238036Z 17 | from aiogram import BaseMiddleware
2025-11-18T07:14:11.2238095Z    |
2025-11-18T07:14:11.2238179Z help: Import from `collections.abc`
2025-11-18T07:14:11.2238184Z 
2025-11-18T07:14:11.2238281Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2238377Z   --> app/middlewares/processing_lock.py:8:1
2025-11-18T07:14:11.2238438Z    |
2025-11-18T07:14:11.2238496Z  6 |   """
2025-11-18T07:14:11.2238553Z  7 |
2025-11-18T07:14:11.2238637Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2238694Z  9 | |
2025-11-18T07:14:11.2238758Z 10 | | import asyncio
2025-11-18T07:14:11.2238828Z 11 | | import logging
2025-11-18T07:14:11.2238912Z 12 | | from typing import Any, Callable
2025-11-18T07:14:11.2238969Z 13 | |
2025-11-18T07:14:11.2239052Z 14 | | from aiogram import BaseMiddleware
2025-11-18T07:14:11.2239142Z 15 | | from aiogram.types import Message
2025-11-18T07:14:11.2239202Z 16 | |
2025-11-18T07:14:11.2239283Z 17 | | from app.config import Settings
2025-11-18T07:14:11.2239398Z 18 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2239481Z 19 | | from app.services import telemetry
2025-11-18T07:14:11.2239546Z    | |__________________________________^
2025-11-18T07:14:11.2239602Z 20 |
2025-11-18T07:14:11.2239693Z 21 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2239749Z    |
2025-11-18T07:14:11.2239819Z help: Organize imports
2025-11-18T07:14:11.2239824Z 
2025-11-18T07:14:11.2239953Z UP035 [*] Import from `collections.abc` instead: `Callable`
2025-11-18T07:14:11.2240050Z   --> app/middlewares/processing_lock.py:12:1
2025-11-18T07:14:11.2240262Z    |
2025-11-18T07:14:11.2240327Z 10 | import asyncio
2025-11-18T07:14:11.2240394Z 11 | import logging
2025-11-18T07:14:11.2240474Z 12 | from typing import Any, Callable
2025-11-18T07:14:11.2240541Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2240602Z 13 |
2025-11-18T07:14:11.2240789Z 14 | from aiogram import BaseMiddleware
2025-11-18T07:14:11.2240847Z    |
2025-11-18T07:14:11.2240931Z help: Import from `collections.abc`
2025-11-18T07:14:11.2240939Z 
2025-11-18T07:14:11.2241054Z F401 [*] `app.services.telemetry` imported but unused
2025-11-18T07:14:11.2241153Z   --> app/middlewares/processing_lock.py:19:26
2025-11-18T07:14:11.2241209Z    |
2025-11-18T07:14:11.2241293Z 17 | from app.config import Settings
2025-11-18T07:14:11.2241403Z 18 | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2241488Z 19 | from app.services import telemetry
2025-11-18T07:14:11.2241559Z    |                          ^^^^^^^^^
2025-11-18T07:14:11.2241616Z 20 |
2025-11-18T07:14:11.2241709Z 21 | LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2241765Z    |
2025-11-18T07:14:11.2241889Z help: Remove unused import: `app.services.telemetry`
2025-11-18T07:14:11.2241894Z 
2025-11-18T07:14:11.2242019Z UP035 [*] Import from `collections.abc` instead: `Callable`
2025-11-18T07:14:11.2242108Z  --> app/observability/metrics.py:4:1
2025-11-18T07:14:11.2242172Z   |
2025-11-18T07:14:11.2242236Z 3 | import logging
2025-11-18T07:14:11.2242313Z 4 | from typing import Callable
2025-11-18T07:14:11.2242380Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2242438Z 5 |
2025-11-18T07:14:11.2242607Z 6 | from prometheus_client import Counter, Histogram, start_http_server
2025-11-18T07:14:11.2242663Z   |
2025-11-18T07:14:11.2242750Z help: Import from `collections.abc`
2025-11-18T07:14:11.2242755Z 
2025-11-18T07:14:11.2242855Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2242939Z   --> app/repositories/__init__.py:7:1
2025-11-18T07:14:11.2242999Z    |
2025-11-18T07:14:11.2243061Z  5 |   """
2025-11-18T07:14:11.2243118Z  6 |
2025-11-18T07:14:11.2243224Z  7 | / from app.repositories.base import Repository
2025-11-18T07:14:11.2243393Z  8 | | from app.repositories.user_profile import UserProfileRepository
2025-11-18T07:14:11.2243556Z  9 | | from app.repositories.conversation import ConversationRepository
2025-11-18T07:14:11.2243659Z    | |________________________________________________________________^
2025-11-18T07:14:11.2243720Z 10 |
2025-11-18T07:14:11.2243784Z 11 |   __all__ = [
2025-11-18T07:14:11.2243842Z    |
2025-11-18T07:14:11.2243916Z help: Organize imports
2025-11-18T07:14:11.2243922Z 
2025-11-18T07:14:11.2244038Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.2244122Z   --> app/repositories/base.py:9:1
2025-11-18T07:14:11.2244179Z    |
2025-11-18T07:14:11.2244267Z  8 | from abc import ABC, abstractmethod
2025-11-18T07:14:11.2244413Z  9 | from typing import Any, Dict, Generic, List, Optional, TypeVar
2025-11-18T07:14:11.2244491Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2244554Z 10 |
2025-11-18T07:14:11.2244619Z 11 | import asyncpg
2025-11-18T07:14:11.2244677Z    |
2025-11-18T07:14:11.2244682Z 
2025-11-18T07:14:11.2244798Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2244878Z   --> app/repositories/base.py:9:1
2025-11-18T07:14:11.2244937Z    |
2025-11-18T07:14:11.2245019Z  8 | from abc import ABC, abstractmethod
2025-11-18T07:14:11.2245157Z  9 | from typing import Any, Dict, Generic, List, Optional, TypeVar
2025-11-18T07:14:11.2245231Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2245288Z 10 |
2025-11-18T07:14:11.2245355Z 11 | import asyncpg
2025-11-18T07:14:11.2245411Z    |
2025-11-18T07:14:11.2245415Z 
2025-11-18T07:14:11.2245496Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2245579Z   --> app/repositories/base.py:54:1
2025-11-18T07:14:11.2245641Z    |
2025-11-18T07:14:11.2245700Z 52 |         """
2025-11-18T07:14:11.2245897Z 53 |         return get_db_connection(self.database_url)
2025-11-18T07:14:11.2245960Z 54 |     
2025-11-18T07:14:11.2246018Z    | ^^^^
2025-11-18T07:14:11.2246075Z 55 |
2025-11-18T07:14:11.2246146Z 56 |     async def _execute(
2025-11-18T07:14:11.2246208Z    |
2025-11-18T07:14:11.2246294Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2246372Z 
2025-11-18T07:14:11.2246490Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2246579Z   --> app/repositories/base.py:59:25
2025-11-18T07:14:11.2246637Z    |
2025-11-18T07:14:11.2246698Z 57 |         self,
2025-11-18T07:14:11.2246768Z 58 |         query: str,
2025-11-18T07:14:11.2246871Z 59 |         params: tuple | Dict[str, Any] | None = None,
2025-11-18T07:14:11.2246939Z    |                         ^^^^
2025-11-18T07:14:11.2247098Z 60 |     ) -> str:
2025-11-18T07:14:11.2247191Z 61 |         """Execute query and return result.
2025-11-18T07:14:11.2247248Z    |
2025-11-18T07:14:11.2247323Z help: Replace with `dict`
2025-11-18T07:14:11.2247333Z 
2025-11-18T07:14:11.2247709Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2247793Z   --> app/repositories/base.py:84:13
2025-11-18T07:14:11.2247850Z    |
2025-11-18T07:14:11.2247923Z 82 |                   return result
2025-11-18T07:14:11.2248022Z 83 |           except asyncpg.PostgresError as e:
2025-11-18T07:14:11.2248099Z 84 | /             raise DatabaseError(
2025-11-18T07:14:11.2248184Z 85 | |                 "Query execution failed",
2025-11-18T07:14:11.2248331Z 86 | |                 context={"query": query[:100], "params": str(params)[:100]},
2025-11-18T07:14:11.2248398Z 87 | |                 cause=e,
2025-11-18T07:14:11.2248458Z 88 | |             )
2025-11-18T07:14:11.2248522Z    | |_____________^
2025-11-18T07:14:11.2248580Z 89 |
2025-11-18T07:14:11.2248652Z 90 |       async def _fetch_one(
2025-11-18T07:14:11.2248710Z    |
2025-11-18T07:14:11.2248722Z 
2025-11-18T07:14:11.2248839Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2248926Z   --> app/repositories/base.py:93:25
2025-11-18T07:14:11.2248984Z    |
2025-11-18T07:14:11.2249051Z 91 |         self,
2025-11-18T07:14:11.2249118Z 92 |         query: str,
2025-11-18T07:14:11.2249224Z 93 |         params: tuple | Dict[str, Any] | None = None,
2025-11-18T07:14:11.2249293Z    |                         ^^^^
2025-11-18T07:14:11.2249378Z 94 |     ) -> Optional[asyncpg.Record]:
2025-11-18T07:14:11.2249463Z 95 |         """Fetch single row from query.
2025-11-18T07:14:11.2249521Z    |
2025-11-18T07:14:11.2249600Z help: Replace with `dict`
2025-11-18T07:14:11.2249607Z 
2025-11-18T07:14:11.2249698Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2249780Z   --> app/repositories/base.py:94:10
2025-11-18T07:14:11.2249839Z    |
2025-11-18T07:14:11.2249905Z 92 |         query: str,
2025-11-18T07:14:11.2250004Z 93 |         params: tuple | Dict[str, Any] | None = None,
2025-11-18T07:14:11.2250090Z 94 |     ) -> Optional[asyncpg.Record]:
2025-11-18T07:14:11.2250159Z    |          ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2250243Z 95 |         """Fetch single row from query.
2025-11-18T07:14:11.2250300Z    |
2025-11-18T07:14:11.2250377Z help: Convert to `X | None`
2025-11-18T07:14:11.2250385Z 
2025-11-18T07:14:11.2250754Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2250841Z    --> app/repositories/base.py:118:13
2025-11-18T07:14:11.2250903Z     |
2025-11-18T07:14:11.2250971Z 116 |                   return row
2025-11-18T07:14:11.2251070Z 117 |           except asyncpg.PostgresError as e:
2025-11-18T07:14:11.2251152Z 118 | /             raise DatabaseError(
2025-11-18T07:14:11.2251235Z 119 | |                 "Failed to fetch row",
2025-11-18T07:14:11.2251328Z 120 | |                 context={"query": query[:100]},
2025-11-18T07:14:11.2251515Z 121 | |                 cause=e,
2025-11-18T07:14:11.2251581Z 122 | |             )
2025-11-18T07:14:11.2251644Z     | |_____________^
2025-11-18T07:14:11.2251701Z 123 |
2025-11-18T07:14:11.2251775Z 124 |       async def _fetch_all(
2025-11-18T07:14:11.2251832Z     |
2025-11-18T07:14:11.2251837Z 
2025-11-18T07:14:11.2252054Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2252141Z    --> app/repositories/base.py:127:25
2025-11-18T07:14:11.2252202Z     |
2025-11-18T07:14:11.2252263Z 125 |         self,
2025-11-18T07:14:11.2252329Z 126 |         query: str,
2025-11-18T07:14:11.2252440Z 127 |         params: tuple | Dict[str, Any] | None = None,
2025-11-18T07:14:11.2252506Z     |                         ^^^^
2025-11-18T07:14:11.2252582Z 128 |     ) -> List[asyncpg.Record]:
2025-11-18T07:14:11.2252706Z 129 |         """Fetch all rows from query.
2025-11-18T07:14:11.2252768Z     |
2025-11-18T07:14:11.2252841Z help: Replace with `dict`
2025-11-18T07:14:11.2252846Z 
2025-11-18T07:14:11.2252960Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2253048Z    --> app/repositories/base.py:128:10
2025-11-18T07:14:11.2253104Z     |
2025-11-18T07:14:11.2253171Z 126 |         query: str,
2025-11-18T07:14:11.2253278Z 127 |         params: tuple | Dict[str, Any] | None = None,
2025-11-18T07:14:11.2253357Z 128 |     ) -> List[asyncpg.Record]:
2025-11-18T07:14:11.2253416Z     |          ^^^^
2025-11-18T07:14:11.2253496Z 129 |         """Fetch all rows from query.
2025-11-18T07:14:11.2253557Z     |
2025-11-18T07:14:11.2253631Z help: Replace with `list`
2025-11-18T07:14:11.2253636Z 
2025-11-18T07:14:11.2254002Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2254088Z    --> app/repositories/base.py:152:13
2025-11-18T07:14:11.2254145Z     |
2025-11-18T07:14:11.2254224Z 150 |                   return list(rows)
2025-11-18T07:14:11.2254332Z 151 |           except asyncpg.PostgresError as e:
2025-11-18T07:14:11.2254413Z 152 | /             raise DatabaseError(
2025-11-18T07:14:11.2254499Z 153 | |                 "Failed to fetch rows",
2025-11-18T07:14:11.2254592Z 154 | |                 context={"query": query[:100]},
2025-11-18T07:14:11.2254664Z 155 | |                 cause=e,
2025-11-18T07:14:11.2254729Z 156 | |             )
2025-11-18T07:14:11.2254790Z     | |_____________^
2025-11-18T07:14:11.2254850Z 157 |
2025-11-18T07:14:11.2254922Z 158 |       @abstractmethod
2025-11-18T07:14:11.2254980Z     |
2025-11-18T07:14:11.2254985Z 
2025-11-18T07:14:11.2255081Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2255165Z    --> app/repositories/base.py:159:44
2025-11-18T07:14:11.2255224Z     |
2025-11-18T07:14:11.2255292Z 158 |     @abstractmethod
2025-11-18T07:14:11.2255419Z 159 |     async def find_by_id(self, id: Any) -> Optional[T]:
2025-11-18T07:14:11.2255499Z     |                                            ^^^^^^^^^^^
2025-11-18T07:14:11.2255577Z 160 |         """Find entity by ID.
2025-11-18T07:14:11.2255639Z     |
2025-11-18T07:14:11.2255712Z help: Convert to `X | None`
2025-11-18T07:14:11.2255718Z 
2025-11-18T07:14:11.2255791Z F401 [*] `json` imported but unused
2025-11-18T07:14:11.2255889Z   --> app/repositories/chat_profile.py:8:8
2025-11-18T07:14:11.2255949Z    |
2025-11-18T07:14:11.2256029Z  6 | from __future__ import annotations
2025-11-18T07:14:11.2256086Z  7 |
2025-11-18T07:14:11.2256152Z  8 | import json
2025-11-18T07:14:11.2256211Z    |        ^^^^
2025-11-18T07:14:11.2256272Z  9 | import math
2025-11-18T07:14:11.2256336Z 10 | import time
2025-11-18T07:14:11.2256391Z    |
2025-11-18T07:14:11.2256471Z help: Remove unused import: `json`
2025-11-18T07:14:11.2256477Z 
2025-11-18T07:14:11.2256575Z F401 [*] `datetime.datetime` imported but unused
2025-11-18T07:14:11.2256675Z   --> app/repositories/chat_profile.py:12:22
2025-11-18T07:14:11.2256731Z    |
2025-11-18T07:14:11.2256792Z 10 | import time
2025-11-18T07:14:11.2257057Z 11 | from dataclasses import dataclass
2025-11-18T07:14:11.2257136Z 12 | from datetime import datetime
2025-11-18T07:14:11.2257201Z    |                      ^^^^^^^^
2025-11-18T07:14:11.2257301Z 13 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2257360Z    |
2025-11-18T07:14:11.2257463Z help: Remove unused import: `datetime.datetime`
2025-11-18T07:14:11.2257576Z 
2025-11-18T07:14:11.2257694Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.2257791Z   --> app/repositories/chat_profile.py:13:1
2025-11-18T07:14:11.2257850Z    |
2025-11-18T07:14:11.2257934Z 11 | from dataclasses import dataclass
2025-11-18T07:14:11.2258020Z 12 | from datetime import datetime
2025-11-18T07:14:11.2258119Z 13 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2258190Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2258247Z 14 |
2025-11-18T07:14:11.2258353Z 15 | from app.repositories.base import Repository
2025-11-18T07:14:11.2258410Z    |
2025-11-18T07:14:11.2258419Z 
2025-11-18T07:14:11.2258532Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2258626Z   --> app/repositories/chat_profile.py:13:1
2025-11-18T07:14:11.2258682Z    |
2025-11-18T07:14:11.2258764Z 11 | from dataclasses import dataclass
2025-11-18T07:14:11.2258843Z 12 | from datetime import datetime
2025-11-18T07:14:11.2258940Z 13 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2259013Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2259070Z 14 |
2025-11-18T07:14:11.2259173Z 15 | from app.repositories.base import Repository
2025-11-18T07:14:11.2259231Z    |
2025-11-18T07:14:11.2259236Z 
2025-11-18T07:14:11.2259328Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2259425Z   --> app/repositories/chat_profile.py:24:17
2025-11-18T07:14:11.2259482Z    |
2025-11-18T07:14:11.2259546Z 22 |     chat_id: int
2025-11-18T07:14:11.2259615Z 23 |     chat_type: str
2025-11-18T07:14:11.2259702Z 24 |     chat_title: Optional[str] = None
2025-11-18T07:14:11.2259773Z    |                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2259854Z 25 |     participant_count: int = 0
2025-11-18T07:14:11.2259945Z 26 |     bot_joined_at: Optional[int] = None
2025-11-18T07:14:11.2260002Z    |
2025-11-18T07:14:11.2260076Z help: Convert to `X | None`
2025-11-18T07:14:11.2260085Z 
2025-11-18T07:14:11.2260179Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2260272Z   --> app/repositories/chat_profile.py:26:20
2025-11-18T07:14:11.2260328Z    |
2025-11-18T07:14:11.2260411Z 24 |     chat_title: Optional[str] = None
2025-11-18T07:14:11.2260492Z 25 |     participant_count: int = 0
2025-11-18T07:14:11.2260576Z 26 |     bot_joined_at: Optional[int] = None
2025-11-18T07:14:11.2260644Z    |                    ^^^^^^^^^^^^^
2025-11-18T07:14:11.2260732Z 27 |     last_active: Optional[int] = None
2025-11-18T07:14:11.2260820Z 28 |     culture_summary: Optional[str] = None
2025-11-18T07:14:11.2260876Z    |
2025-11-18T07:14:11.2260948Z help: Convert to `X | None`
2025-11-18T07:14:11.2260959Z 
2025-11-18T07:14:11.2261048Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2261140Z   --> app/repositories/chat_profile.py:27:18
2025-11-18T07:14:11.2261196Z    |
2025-11-18T07:14:11.2261274Z 25 |     participant_count: int = 0
2025-11-18T07:14:11.2261359Z 26 |     bot_joined_at: Optional[int] = None
2025-11-18T07:14:11.2261444Z 27 |     last_active: Optional[int] = None
2025-11-18T07:14:11.2261515Z    |                  ^^^^^^^^^^^^^
2025-11-18T07:14:11.2261603Z 28 |     culture_summary: Optional[str] = None
2025-11-18T07:14:11.2261679Z 29 |     profile_version: int = 1
2025-11-18T07:14:11.2261736Z    |
2025-11-18T07:14:11.2261817Z help: Convert to `X | None`
2025-11-18T07:14:11.2261822Z 
2025-11-18T07:14:11.2261914Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2262007Z   --> app/repositories/chat_profile.py:28:22
2025-11-18T07:14:11.2262070Z    |
2025-11-18T07:14:11.2262153Z 26 |     bot_joined_at: Optional[int] = None
2025-11-18T07:14:11.2262356Z 27 |     last_active: Optional[int] = None
2025-11-18T07:14:11.2262449Z 28 |     culture_summary: Optional[str] = None
2025-11-18T07:14:11.2262517Z    |                      ^^^^^^^^^^^^^
2025-11-18T07:14:11.2262594Z 29 |     profile_version: int = 1
2025-11-18T07:14:11.2262676Z 30 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2262807Z    |
2025-11-18T07:14:11.2262880Z help: Convert to `X | None`
2025-11-18T07:14:11.2262886Z 
2025-11-18T07:14:11.2262973Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2263069Z   --> app/repositories/chat_profile.py:30:17
2025-11-18T07:14:11.2263126Z    |
2025-11-18T07:14:11.2263213Z 28 |     culture_summary: Optional[str] = None
2025-11-18T07:14:11.2263287Z 29 |     profile_version: int = 1
2025-11-18T07:14:11.2263377Z 30 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2263443Z    |                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2263524Z 31 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2263587Z    |
2025-11-18T07:14:11.2263659Z help: Convert to `X | None`
2025-11-18T07:14:11.2263664Z 
2025-11-18T07:14:11.2263750Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2263844Z   --> app/repositories/chat_profile.py:31:17
2025-11-18T07:14:11.2263900Z    |
2025-11-18T07:14:11.2263972Z 29 |     profile_version: int = 1
2025-11-18T07:14:11.2264056Z 30 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2264139Z 31 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2264203Z    |                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2264259Z 32 |
2025-11-18T07:14:11.2264345Z 33 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.2264401Z    |
2025-11-18T07:14:11.2264471Z help: Convert to `X | None`
2025-11-18T07:14:11.2264476Z 
2025-11-18T07:14:11.2264592Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2264686Z   --> app/repositories/chat_profile.py:33:26
2025-11-18T07:14:11.2264742Z    |
2025-11-18T07:14:11.2264824Z 31 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2264889Z 32 |
2025-11-18T07:14:11.2264972Z 33 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.2265038Z    |                          ^^^^
2025-11-18T07:14:11.2265121Z 34 |         """Convert to dictionary."""
2025-11-18T07:14:11.2265185Z 35 |         return {
2025-11-18T07:14:11.2265245Z    |
2025-11-18T07:14:11.2265319Z help: Replace with `dict`
2025-11-18T07:14:11.2265324Z 
2025-11-18T07:14:11.2265415Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2265506Z   --> app/repositories/chat_profile.py:53:14
2025-11-18T07:14:11.2265562Z    |
2025-11-18T07:14:11.2265638Z 51 |     """Chat fact entity."""
2025-11-18T07:14:11.2265694Z 52 |
2025-11-18T07:14:11.2265767Z 53 |     fact_id: Optional[int]
2025-11-18T07:14:11.2265830Z    |              ^^^^^^^^^^^^^
2025-11-18T07:14:11.2265896Z 54 |     chat_id: int
2025-11-18T07:14:11.2265965Z 55 |     fact_category: str
2025-11-18T07:14:11.2266023Z    |
2025-11-18T07:14:11.2266101Z help: Convert to `X | None`
2025-11-18T07:14:11.2266110Z 
2025-11-18T07:14:11.2266197Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2266287Z   --> app/repositories/chat_profile.py:58:23
2025-11-18T07:14:11.2266347Z    |
2025-11-18T07:14:11.2266411Z 56 |     fact_key: str
2025-11-18T07:14:11.2266479Z 57 |     fact_value: str
2025-11-18T07:14:11.2266575Z 58 |     fact_description: Optional[str] = None
2025-11-18T07:14:11.2266648Z    |                       ^^^^^^^^^^^^^
2025-11-18T07:14:11.2266726Z 59 |     confidence: float = 0.7
2025-11-18T07:14:11.2266798Z 60 |     evidence_count: int = 1
2025-11-18T07:14:11.2266857Z    |
2025-11-18T07:14:11.2266927Z help: Convert to `X | None`
2025-11-18T07:14:11.2266933Z 
2025-11-18T07:14:11.2267149Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2267242Z   --> app/repositories/chat_profile.py:61:21
2025-11-18T07:14:11.2267300Z    |
2025-11-18T07:14:11.2267374Z 59 |     confidence: float = 0.7
2025-11-18T07:14:11.2267445Z 60 |     evidence_count: int = 1
2025-11-18T07:14:11.2267655Z 61 |     first_observed: Optional[int] = None
2025-11-18T07:14:11.2267722Z    |                     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2267810Z 62 |     last_reinforced: Optional[int] = None
2025-11-18T07:14:11.2267922Z 63 |     participant_consensus: Optional[float] = None
2025-11-18T07:14:11.2268079Z    |
2025-11-18T07:14:11.2268154Z help: Convert to `X | None`
2025-11-18T07:14:11.2268159Z 
2025-11-18T07:14:11.2268246Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2268341Z   --> app/repositories/chat_profile.py:62:22
2025-11-18T07:14:11.2268399Z    |
2025-11-18T07:14:11.2268475Z 60 |     evidence_count: int = 1
2025-11-18T07:14:11.2268562Z 61 |     first_observed: Optional[int] = None
2025-11-18T07:14:11.2268651Z 62 |     last_reinforced: Optional[int] = None
2025-11-18T07:14:11.2268716Z    |                      ^^^^^^^^^^^^^
2025-11-18T07:14:11.2268825Z 63 |     participant_consensus: Optional[float] = None
2025-11-18T07:14:11.2268892Z 64 |     is_active: int = 1
2025-11-18T07:14:11.2268952Z    |
2025-11-18T07:14:11.2269023Z help: Convert to `X | None`
2025-11-18T07:14:11.2269028Z 
2025-11-18T07:14:11.2269125Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2269222Z   --> app/repositories/chat_profile.py:63:28
2025-11-18T07:14:11.2269279Z    |
2025-11-18T07:14:11.2269374Z 61 |     first_observed: Optional[int] = None
2025-11-18T07:14:11.2269462Z 62 |     last_reinforced: Optional[int] = None
2025-11-18T07:14:11.2269569Z 63 |     participant_consensus: Optional[float] = None
2025-11-18T07:14:11.2269641Z    |                            ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2269713Z 64 |     is_active: int = 1
2025-11-18T07:14:11.2269784Z 65 |     decay_rate: float = 0.0
2025-11-18T07:14:11.2269841Z    |
2025-11-18T07:14:11.2269917Z help: Convert to `X | None`
2025-11-18T07:14:11.2269924Z 
2025-11-18T07:14:11.2270014Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2270108Z   --> app/repositories/chat_profile.py:66:17
2025-11-18T07:14:11.2270174Z    |
2025-11-18T07:14:11.2270244Z 64 |     is_active: int = 1
2025-11-18T07:14:11.2270316Z 65 |     decay_rate: float = 0.0
2025-11-18T07:14:11.2270400Z 66 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2270472Z    |                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2270558Z 67 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2270735Z 68 |     evidence_text: Optional[str] = None  # Temporary field for extraction
2025-11-18T07:14:11.2270798Z    |
2025-11-18T07:14:11.2270870Z help: Convert to `X | None`
2025-11-18T07:14:11.2270876Z 
2025-11-18T07:14:11.2287135Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2287377Z   --> app/repositories/chat_profile.py:67:17
2025-11-18T07:14:11.2287445Z    |
2025-11-18T07:14:11.2287531Z 65 |     decay_rate: float = 0.0
2025-11-18T07:14:11.2287631Z 66 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2287717Z 67 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2287786Z    |                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2287981Z 68 |     evidence_text: Optional[str] = None  # Temporary field for extraction
2025-11-18T07:14:11.2288038Z    |
2025-11-18T07:14:11.2288117Z help: Convert to `X | None`
2025-11-18T07:14:11.2288125Z 
2025-11-18T07:14:11.2288229Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2288342Z   --> app/repositories/chat_profile.py:68:20
2025-11-18T07:14:11.2288399Z    |
2025-11-18T07:14:11.2288489Z 66 |     created_at: Optional[int] = None
2025-11-18T07:14:11.2288575Z 67 |     updated_at: Optional[int] = None
2025-11-18T07:14:11.2288751Z 68 |     evidence_text: Optional[str] = None  # Temporary field for extraction
2025-11-18T07:14:11.2288822Z    |                    ^^^^^^^^^^^^^
2025-11-18T07:14:11.2288882Z 69 |
2025-11-18T07:14:11.2288974Z 70 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.2289030Z    |
2025-11-18T07:14:11.2289111Z help: Convert to `X | None`
2025-11-18T07:14:11.2289117Z 
2025-11-18T07:14:11.2289243Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2289520Z   --> app/repositories/chat_profile.py:70:26
2025-11-18T07:14:11.2289580Z    |
2025-11-18T07:14:11.2289753Z 68 |     evidence_text: Optional[str] = None  # Temporary field for extraction
2025-11-18T07:14:11.2289810Z 69 |
2025-11-18T07:14:11.2289902Z 70 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.2290078Z    |                          ^^^^
2025-11-18T07:14:11.2290164Z 71 |         """Convert to dictionary."""
2025-11-18T07:14:11.2290228Z 72 |         return {
2025-11-18T07:14:11.2290289Z    |
2025-11-18T07:14:11.2290364Z help: Replace with `dict`
2025-11-18T07:14:11.2290370Z 
2025-11-18T07:14:11.2290491Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2290590Z   --> app/repositories/chat_profile.py:91:28
2025-11-18T07:14:11.2290646Z    |
2025-11-18T07:14:11.2290710Z 90 |     @classmethod
2025-11-18T07:14:11.2290831Z 91 |     def from_row(cls, row: Dict[str, Any]) -> "ChatFact":
2025-11-18T07:14:11.2290908Z    |                            ^^^^
2025-11-18T07:14:11.2290995Z 92 |         """Create from database row."""
2025-11-18T07:14:11.2291062Z 93 |         return cls(
2025-11-18T07:14:11.2291121Z    |
2025-11-18T07:14:11.2291194Z help: Replace with `dict`
2025-11-18T07:14:11.2291200Z 
2025-11-18T07:14:11.2291290Z UP037 [*] Remove quotes from type annotation
2025-11-18T07:14:11.2291385Z   --> app/repositories/chat_profile.py:91:47
2025-11-18T07:14:11.2291444Z    |
2025-11-18T07:14:11.2291508Z 90 |     @classmethod
2025-11-18T07:14:11.2291624Z 91 |     def from_row(cls, row: Dict[str, Any]) -> "ChatFact":
2025-11-18T07:14:11.2291708Z    |                                               ^^^^^^^^^^
2025-11-18T07:14:11.2291788Z 92 |         """Create from database row."""
2025-11-18T07:14:11.2291852Z 93 |         return cls(
2025-11-18T07:14:11.2291909Z    |
2025-11-18T07:14:11.2291975Z help: Remove quotes
2025-11-18T07:14:11.2291981Z 
2025-11-18T07:14:11.2292069Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2292175Z    --> app/repositories/chat_profile.py:119:21
2025-11-18T07:14:11.2292235Z     |
2025-11-18T07:14:11.2292303Z 117 |         chat_id: int,
2025-11-18T07:14:11.2292376Z 118 |         chat_type: str,
2025-11-18T07:14:11.2292472Z 119 |         chat_title: Optional[str] = None,
2025-11-18T07:14:11.2292544Z     |                     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2292615Z 120 |     ) -> ChatProfile:
2025-11-18T07:14:11.2292705Z 121 |         """Get or create chat profile.
2025-11-18T07:14:11.2292763Z     |
2025-11-18T07:14:11.2292838Z help: Convert to `X | None`
2025-11-18T07:14:11.2292844Z 
2025-11-18T07:14:11.2292916Z W291 Trailing whitespace
2025-11-18T07:14:11.2293021Z    --> app/repositories/chat_profile.py:148:38
2025-11-18T07:14:11.2293081Z     |
2025-11-18T07:14:11.2293156Z 146 |         await self._execute(
2025-11-18T07:14:11.2293219Z 147 |             """
2025-11-18T07:14:11.2293308Z 148 |             INSERT INTO chat_profiles 
2025-11-18T07:14:11.2293377Z     |                                      ^
2025-11-18T07:14:11.2293586Z 149 |             (chat_id, chat_type, chat_title, bot_joined_at, last_active, created_at, updated_at)
2025-11-18T07:14:11.2293672Z 150 |             VALUES (?, ?, ?, ?, ?, ?, ?)
2025-11-18T07:14:11.2293729Z     |
2025-11-18T07:14:11.2293812Z help: Remove trailing whitespace
2025-11-18T07:14:11.2293822Z 
2025-11-18T07:14:11.2293916Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2294010Z    --> app/repositories/chat_profile.py:157:51
2025-11-18T07:14:11.2294068Z     |
2025-11-18T07:14:11.2294168Z 155 |         return await self._get_profile(chat_id)
2025-11-18T07:14:11.2294225Z 156 |
2025-11-18T07:14:11.2294393Z 157 |     async def _get_profile(self, chat_id: int) -> Optional[ChatProfile]:
2025-11-18T07:14:11.2294480Z     |                                                   ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2294571Z 158 |         """Get chat profile by ID."""
2025-11-18T07:14:11.2294701Z 159 |         query = "SELECT * FROM chat_profiles WHERE chat_id = ?"
2025-11-18T07:14:11.2294847Z     |
2025-11-18T07:14:11.2294925Z help: Convert to `X | None`
2025-11-18T07:14:11.2294931Z 
2025-11-18T07:14:11.2295021Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2295113Z    --> app/repositories/chat_profile.py:187:27
2025-11-18T07:14:11.2295246Z     |
2025-11-18T07:14:11.2295317Z 185 |         fact_key: str,
2025-11-18T07:14:11.2295387Z 186 |         fact_value: str,
2025-11-18T07:14:11.2295486Z 187 |         fact_description: Optional[str] = None,
2025-11-18T07:14:11.2295559Z     |                           ^^^^^^^^^^^^^
2025-11-18T07:14:11.2295638Z 188 |         confidence: float = 0.7,
2025-11-18T07:14:11.2295730Z 189 |         evidence_text: Optional[str] = None,
2025-11-18T07:14:11.2295790Z     |
2025-11-18T07:14:11.2295861Z help: Convert to `X | None`
2025-11-18T07:14:11.2295866Z 
2025-11-18T07:14:11.2295951Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2296046Z    --> app/repositories/chat_profile.py:189:24
2025-11-18T07:14:11.2296107Z     |
2025-11-18T07:14:11.2296203Z 187 |         fact_description: Optional[str] = None,
2025-11-18T07:14:11.2296280Z 188 |         confidence: float = 0.7,
2025-11-18T07:14:11.2296372Z 189 |         evidence_text: Optional[str] = None,
2025-11-18T07:14:11.2296442Z     |                        ^^^^^^^^^^^^^
2025-11-18T07:14:11.2296509Z 190 |     ) -> int:
2025-11-18T07:14:11.2296593Z 191 |         """Add or update a chat fact.
2025-11-18T07:14:11.2296649Z     |
2025-11-18T07:14:11.2296720Z help: Convert to `X | None`
2025-11-18T07:14:11.2296724Z 
2025-11-18T07:14:11.2296809Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2296903Z    --> app/repositories/chat_profile.py:332:10
2025-11-18T07:14:11.2297085Z     |
2025-11-18T07:14:11.2297169Z 330 |     async def _get_fact_by_key(
2025-11-18T07:14:11.2297261Z 331 |         self, chat_id: int, fact_key: str
2025-11-18T07:14:11.2297345Z 332 |     ) -> Optional[Dict[str, Any]]:
2025-11-18T07:14:11.2297415Z     |          ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2297501Z 333 |         """Get active fact by key."""
2025-11-18T07:14:11.2297568Z 334 |         query = """
2025-11-18T07:14:11.2297624Z     |
2025-11-18T07:14:11.2297693Z help: Convert to `X | None`
2025-11-18T07:14:11.2297699Z 
2025-11-18T07:14:11.2297822Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2297917Z    --> app/repositories/chat_profile.py:332:19
2025-11-18T07:14:11.2297974Z     |
2025-11-18T07:14:11.2298051Z 330 |     async def _get_fact_by_key(
2025-11-18T07:14:11.2298135Z 331 |         self, chat_id: int, fact_key: str
2025-11-18T07:14:11.2298214Z 332 |     ) -> Optional[Dict[str, Any]]:
2025-11-18T07:14:11.2298281Z     |                   ^^^^
2025-11-18T07:14:11.2298359Z 333 |         """Get active fact by key."""
2025-11-18T07:14:11.2298425Z 334 |         query = """
2025-11-18T07:14:11.2298482Z     |
2025-11-18T07:14:11.2298557Z help: Replace with `dict`
2025-11-18T07:14:11.2298563Z 
2025-11-18T07:14:11.2298651Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2298743Z    --> app/repositories/chat_profile.py:345:30
2025-11-18T07:14:11.2298801Z     |
2025-11-18T07:14:11.2298861Z 343 |         self,
2025-11-18T07:14:11.2298926Z 344 |         fact_id: int,
2025-11-18T07:14:11.2299020Z 345 |         previous_version_id: Optional[int],
2025-11-18T07:14:11.2299098Z     |                              ^^^^^^^^^^^^^
2025-11-18T07:14:11.2299171Z 346 |         version_number: int,
2025-11-18T07:14:11.2299243Z 347 |         change_type: str,
2025-11-18T07:14:11.2299302Z     |
2025-11-18T07:14:11.2299375Z help: Convert to `X | None`
2025-11-18T07:14:11.2299380Z 
2025-11-18T07:14:11.2299468Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2299562Z    --> app/repositories/chat_profile.py:376:21
2025-11-18T07:14:11.2299619Z     |
2025-11-18T07:14:11.2299687Z 374 |         limit: int = 10,
2025-11-18T07:14:11.2299768Z 375 |         min_confidence: float = 0.6,
2025-11-18T07:14:11.2300028Z 376 |         categories: Optional[List[str]] = None,
2025-11-18T07:14:11.2300100Z     |                     ^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2300173Z 377 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2300281Z 378 |         """Get top chat facts for context inclusion.
2025-11-18T07:14:11.2300338Z     |
2025-11-18T07:14:11.2300514Z help: Convert to `X | None`
2025-11-18T07:14:11.2300519Z 
2025-11-18T07:14:11.2300631Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2300725Z    --> app/repositories/chat_profile.py:376:30
2025-11-18T07:14:11.2300781Z     |
2025-11-18T07:14:11.2300850Z 374 |         limit: int = 10,
2025-11-18T07:14:11.2300936Z 375 |         min_confidence: float = 0.6,
2025-11-18T07:14:11.2301032Z 376 |         categories: Optional[List[str]] = None,
2025-11-18T07:14:11.2301100Z     |                              ^^^^
2025-11-18T07:14:11.2301172Z 377 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2301269Z 378 |         """Get top chat facts for context inclusion.
2025-11-18T07:14:11.2301331Z     |
2025-11-18T07:14:11.2301405Z help: Replace with `list`
2025-11-18T07:14:11.2301419Z 
2025-11-18T07:14:11.2301528Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2301621Z    --> app/repositories/chat_profile.py:377:10
2025-11-18T07:14:11.2301677Z     |
2025-11-18T07:14:11.2301765Z 375 |         min_confidence: float = 0.6,
2025-11-18T07:14:11.2301858Z 376 |         categories: Optional[List[str]] = None,
2025-11-18T07:14:11.2301927Z 377 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2301987Z     |          ^^^^
2025-11-18T07:14:11.2302083Z 378 |         """Get top chat facts for context inclusion.
2025-11-18T07:14:11.2302140Z     |
2025-11-18T07:14:11.2302212Z help: Replace with `list`
2025-11-18T07:14:11.2302221Z 
2025-11-18T07:14:11.2302309Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2302399Z    --> app/repositories/chat_profile.py:456:10
2025-11-18T07:14:11.2302454Z     |
2025-11-18T07:14:11.2302534Z 454 |     async def get_chat_summary(
2025-11-18T07:14:11.2302628Z 455 |         self, chat_id: int, max_facts: int = 10
2025-11-18T07:14:11.2302700Z 456 |     ) -> Optional[str]:
2025-11-18T07:14:11.2302766Z     |          ^^^^^^^^^^^^^
2025-11-18T07:14:11.2302893Z 457 |         """Generate concise chat profile summary for context.
2025-11-18T07:14:11.2302953Z     |
2025-11-18T07:14:11.2303026Z help: Convert to `X | None`
2025-11-18T07:14:11.2303032Z 
2025-11-18T07:14:11.2303143Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2303233Z    --> app/repositories/chat_profile.py:478:22
2025-11-18T07:14:11.2303289Z     |
2025-11-18T07:14:11.2303363Z 477 |         # Group by category
2025-11-18T07:14:11.2303467Z 478 |         by_category: Dict[str, List[ChatFact]] = {}
2025-11-18T07:14:11.2303532Z     |                      ^^^^
2025-11-18T07:14:11.2303607Z 479 |         for fact in facts:
2025-11-18T07:14:11.2303760Z 480 |             by_category.setdefault(fact.fact_category, []).append(fact)
2025-11-18T07:14:11.2303821Z     |
2025-11-18T07:14:11.2303894Z help: Replace with `dict`
2025-11-18T07:14:11.2303900Z 
2025-11-18T07:14:11.2304014Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2304106Z    --> app/repositories/chat_profile.py:478:32
2025-11-18T07:14:11.2304162Z     |
2025-11-18T07:14:11.2304238Z 477 |         # Group by category
2025-11-18T07:14:11.2304342Z 478 |         by_category: Dict[str, List[ChatFact]] = {}
2025-11-18T07:14:11.2304409Z     |                                ^^^^
2025-11-18T07:14:11.2304483Z 479 |         for fact in facts:
2025-11-18T07:14:11.2304627Z 480 |             by_category.setdefault(fact.fact_category, []).append(fact)
2025-11-18T07:14:11.2304683Z     |
2025-11-18T07:14:11.2304756Z help: Replace with `list`
2025-11-18T07:14:11.2304761Z 
2025-11-18T07:14:11.2304876Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2304966Z    --> app/repositories/chat_profile.py:522:10
2025-11-18T07:14:11.2305022Z     |
2025-11-18T07:14:11.2305183Z 520 |     async def get_all_facts(
2025-11-18T07:14:11.2305305Z 521 |         self, chat_id: int, include_inactive: bool = False
2025-11-18T07:14:11.2305376Z 522 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2305438Z     |          ^^^^
2025-11-18T07:14:11.2305518Z 523 |         """Get all facts for a chat.
2025-11-18T07:14:11.2305647Z     |
2025-11-18T07:14:11.2305719Z help: Replace with `list`
2025-11-18T07:14:11.2305725Z 
2025-11-18T07:14:11.2305814Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2305906Z    --> app/repositories/chat_profile.py:544:44
2025-11-18T07:14:11.2305962Z     |
2025-11-18T07:14:11.2306123Z 543 |     # Abstract method implementations (required by base Repository)
2025-11-18T07:14:11.2306270Z 544 |     async def find_by_id(self, id: int) -> Optional[ChatProfile]:
2025-11-18T07:14:11.2306354Z     |                                            ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2306439Z 545 |         """Find chat profile by ID.
2025-11-18T07:14:11.2306499Z     |
2025-11-18T07:14:11.2306570Z help: Convert to `X | None`
2025-11-18T07:14:11.2306576Z 
2025-11-18T07:14:11.2306690Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.2306785Z   --> app/repositories/conversation.py:10:1
2025-11-18T07:14:11.2306842Z    |
2025-11-18T07:14:11.2306909Z  8 | import json
2025-11-18T07:14:11.2307091Z  9 | from datetime import datetime
2025-11-18T07:14:11.2307197Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2307268Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2307324Z 11 |
2025-11-18T07:14:11.2307427Z 12 | from app.repositories.base import Repository
2025-11-18T07:14:11.2307482Z    |
2025-11-18T07:14:11.2307487Z 
2025-11-18T07:14:11.2307597Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2307691Z   --> app/repositories/conversation.py:10:1
2025-11-18T07:14:11.2307747Z    |
2025-11-18T07:14:11.2307809Z  8 | import json
2025-11-18T07:14:11.2307885Z  9 | from datetime import datetime
2025-11-18T07:14:11.2307984Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2308052Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2308108Z 11 |
2025-11-18T07:14:11.2308210Z 12 | from app.repositories.base import Repository
2025-11-18T07:14:11.2308269Z    |
2025-11-18T07:14:11.2308274Z 
2025-11-18T07:14:11.2308365Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2308463Z   --> app/repositories/conversation.py:23:21
2025-11-18T07:14:11.2308519Z    |
2025-11-18T07:14:11.2308583Z 21 |     def __init__(
2025-11-18T07:14:11.2308644Z 22 |         self,
2025-11-18T07:14:11.2308727Z 23 |         message_id: Optional[int],
2025-11-18T07:14:11.2308794Z    |                     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2308861Z 24 |         chat_id: int,
2025-11-18T07:14:11.2308938Z 25 |         thread_id: Optional[int],
2025-11-18T07:14:11.2308996Z    |
2025-11-18T07:14:11.2309068Z help: Convert to `X | None`
2025-11-18T07:14:11.2309077Z 
2025-11-18T07:14:11.2309167Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2309260Z   --> app/repositories/conversation.py:25:20
2025-11-18T07:14:11.2309315Z    |
2025-11-18T07:14:11.2309393Z 23 |         message_id: Optional[int],
2025-11-18T07:14:11.2309461Z 24 |         chat_id: int,
2025-11-18T07:14:11.2309540Z 25 |         thread_id: Optional[int],
2025-11-18T07:14:11.2309606Z    |                    ^^^^^^^^^^^^^
2025-11-18T07:14:11.2309676Z 26 |         user_id: int,
2025-11-18T07:14:11.2309740Z 27 |         role: str,
2025-11-18T07:14:11.2309796Z    |
2025-11-18T07:14:11.2309867Z help: Convert to `X | None`
2025-11-18T07:14:11.2309875Z 
2025-11-18T07:14:11.2309961Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2310052Z   --> app/repositories/conversation.py:29:16
2025-11-18T07:14:11.2310107Z    |
2025-11-18T07:14:11.2310173Z 27 |         role: str,
2025-11-18T07:14:11.2310236Z 28 |         text: str,
2025-11-18T07:14:11.2310329Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2310522Z    |                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2310622Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2310715Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2310771Z    |
2025-11-18T07:14:11.2310949Z help: Convert to `X | None`
2025-11-18T07:14:11.2310955Z 
2025-11-18T07:14:11.2311066Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2311159Z   --> app/repositories/conversation.py:29:25
2025-11-18T07:14:11.2311218Z    |
2025-11-18T07:14:11.2311289Z 27 |         role: str,
2025-11-18T07:14:11.2311351Z 28 |         text: str,
2025-11-18T07:14:11.2311444Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2311514Z    |                         ^^^^
2025-11-18T07:14:11.2311608Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2311697Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2311760Z    |
2025-11-18T07:14:11.2311833Z help: Replace with `dict`
2025-11-18T07:14:11.2311839Z 
2025-11-18T07:14:11.2311925Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2312020Z   --> app/repositories/conversation.py:30:19
2025-11-18T07:14:11.2312078Z    |
2025-11-18T07:14:11.2312143Z 28 |         text: str,
2025-11-18T07:14:11.2312238Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2312337Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2312410Z    |                   ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2312501Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2312596Z 32 |         created_at: Optional[datetime] = None,
2025-11-18T07:14:11.2312652Z    |
2025-11-18T07:14:11.2312723Z help: Convert to `X | None`
2025-11-18T07:14:11.2312728Z 
2025-11-18T07:14:11.2312841Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2312932Z   --> app/repositories/conversation.py:30:28
2025-11-18T07:14:11.2312991Z    |
2025-11-18T07:14:11.2313054Z 28 |         text: str,
2025-11-18T07:14:11.2313145Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2313235Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2313303Z    |                            ^^^^
2025-11-18T07:14:11.2313397Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2313485Z 32 |         created_at: Optional[datetime] = None,
2025-11-18T07:14:11.2313541Z    |
2025-11-18T07:14:11.2313616Z help: Replace with `dict`
2025-11-18T07:14:11.2313622Z 
2025-11-18T07:14:11.2313709Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2313798Z   --> app/repositories/conversation.py:31:20
2025-11-18T07:14:11.2313853Z    |
2025-11-18T07:14:11.2313942Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2314032Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2314123Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2314198Z    |                    ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2314283Z 32 |         created_at: Optional[datetime] = None,
2025-11-18T07:14:11.2314341Z 33 |     ):
2025-11-18T07:14:11.2314399Z    |
2025-11-18T07:14:11.2314470Z help: Convert to `X | None`
2025-11-18T07:14:11.2314479Z 
2025-11-18T07:14:11.2314586Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2314676Z   --> app/repositories/conversation.py:31:29
2025-11-18T07:14:11.2314737Z    |
2025-11-18T07:14:11.2314823Z 29 |         media: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2314913Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2315003Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2315070Z    |                             ^^^^
2025-11-18T07:14:11.2315156Z 32 |         created_at: Optional[datetime] = None,
2025-11-18T07:14:11.2315216Z 33 |     ):
2025-11-18T07:14:11.2315272Z    |
2025-11-18T07:14:11.2315428Z help: Replace with `list`
2025-11-18T07:14:11.2315434Z 
2025-11-18T07:14:11.2315522Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2315615Z   --> app/repositories/conversation.py:32:21
2025-11-18T07:14:11.2315671Z    |
2025-11-18T07:14:11.2315760Z 30 |         metadata: Optional[Dict[str, Any]] = None,
2025-11-18T07:14:11.2315926Z 31 |         embedding: Optional[List[float]] = None,
2025-11-18T07:14:11.2316012Z 32 |         created_at: Optional[datetime] = None,
2025-11-18T07:14:11.2316080Z    |                     ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2316139Z 33 |     ):
2025-11-18T07:14:11.2316223Z 34 |         self.message_id = message_id
2025-11-18T07:14:11.2316278Z    |
2025-11-18T07:14:11.2316347Z help: Convert to `X | None`
2025-11-18T07:14:11.2316352Z 
2025-11-18T07:14:11.2316463Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2316553Z   --> app/repositories/conversation.py:45:26
2025-11-18T07:14:11.2316612Z    |
2025-11-18T07:14:11.2316735Z 43 |         self.created_at = created_at or datetime.utcnow()
2025-11-18T07:14:11.2316790Z 44 |
2025-11-18T07:14:11.2316874Z 45 |     def to_dict(self) -> Dict[str, Any]:
2025-11-18T07:14:11.2316941Z    |                          ^^^^
2025-11-18T07:14:11.2317190Z 46 |         """Convert to dictionary."""
2025-11-18T07:14:11.2317258Z 47 |         return {
2025-11-18T07:14:11.2317314Z    |
2025-11-18T07:14:11.2317388Z help: Replace with `dict`
2025-11-18T07:14:11.2317394Z 
2025-11-18T07:14:11.2317478Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2317569Z   --> app/repositories/conversation.py:67:52
2025-11-18T07:14:11.2317627Z    |
2025-11-18T07:14:11.2317685Z 65 |     """
2025-11-18T07:14:11.2317741Z 66 |
2025-11-18T07:14:11.2317888Z 67 |     async def find_by_id(self, message_id: int) -> Optional[Message]:
2025-11-18T07:14:11.2317975Z    |                                                    ^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2318048Z 68 |         """Find message by ID.
2025-11-18T07:14:11.2318107Z    |
2025-11-18T07:14:11.2318182Z help: Convert to `X | None`
2025-11-18T07:14:11.2318188Z 
2025-11-18T07:14:11.2318272Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2318369Z    --> app/repositories/conversation.py:135:20
2025-11-18T07:14:11.2318426Z     |
2025-11-18T07:14:11.2318488Z 133 |         self,
2025-11-18T07:14:11.2318557Z 134 |         chat_id: int,
2025-11-18T07:14:11.2318645Z 135 |         thread_id: Optional[int] = None,
2025-11-18T07:14:11.2318714Z     |                    ^^^^^^^^^^^^^
2025-11-18T07:14:11.2318783Z 136 |         limit: int = 10,
2025-11-18T07:14:11.2318853Z 137 |     ) -> List[Message]:
2025-11-18T07:14:11.2318909Z     |
2025-11-18T07:14:11.2318984Z help: Convert to `X | None`
2025-11-18T07:14:11.2318989Z 
2025-11-18T07:14:11.2319103Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2319199Z    --> app/repositories/conversation.py:137:10
2025-11-18T07:14:11.2319258Z     |
2025-11-18T07:14:11.2319342Z 135 |         thread_id: Optional[int] = None,
2025-11-18T07:14:11.2319413Z 136 |         limit: int = 10,
2025-11-18T07:14:11.2319485Z 137 |     ) -> List[Message]:
2025-11-18T07:14:11.2319543Z     |          ^^^^
2025-11-18T07:14:11.2319635Z 138 |         """Get recent messages for a chat.
2025-11-18T07:14:11.2319691Z     |
2025-11-18T07:14:11.2319770Z help: Replace with `list`
2025-11-18T07:14:11.2319776Z 
2025-11-18T07:14:11.2319888Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2319983Z    --> app/repositories/conversation.py:172:10
2025-11-18T07:14:11.2320043Z     |
2025-11-18T07:14:11.2320109Z 170 |         user_id: int,
2025-11-18T07:14:11.2320178Z 171 |         limit: int = 100,
2025-11-18T07:14:11.2320250Z 172 |     ) -> List[Message]:
2025-11-18T07:14:11.2320308Z     |          ^^^^
2025-11-18T07:14:11.2320412Z 173 |         """Get messages from specific user in a chat.
2025-11-18T07:14:11.2320468Z     |
2025-11-18T07:14:11.2320544Z help: Replace with `list`
2025-11-18T07:14:11.2320666Z 
2025-11-18T07:14:11.2320784Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2320881Z    --> app/repositories/conversation.py:197:10
2025-11-18T07:14:11.2320946Z     |
2025-11-18T07:14:11.2321018Z 195 |         query_text: str,
2025-11-18T07:14:11.2321084Z 196 |         limit: int = 20,
2025-11-18T07:14:11.2321258Z 197 |     ) -> List[Message]:
2025-11-18T07:14:11.2321320Z     |          ^^^^
2025-11-18T07:14:11.2321401Z 198 |         """Search messages by text.
2025-11-18T07:14:11.2321459Z     |
2025-11-18T07:14:11.2321545Z help: Replace with `list`
2025-11-18T07:14:11.2321555Z 
2025-11-18T07:14:11.2321688Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2321782Z    --> app/repositories/conversation.py:220:26
2025-11-18T07:14:11.2321842Z     |
2025-11-18T07:14:11.2321901Z 218 |         self,
2025-11-18T07:14:11.2321969Z 219 |         chat_id: int,
2025-11-18T07:14:11.2322053Z 220 |         query_embedding: List[float],
2025-11-18T07:14:11.2322128Z     |                          ^^^^
2025-11-18T07:14:11.2322215Z 221 |         thread_id: Optional[int] = None,
2025-11-18T07:14:11.2322284Z 222 |         limit: int = 5,
2025-11-18T07:14:11.2322344Z     |
2025-11-18T07:14:11.2322417Z help: Replace with `list`
2025-11-18T07:14:11.2322422Z 
2025-11-18T07:14:11.2322516Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2322610Z    --> app/repositories/conversation.py:221:20
2025-11-18T07:14:11.2322667Z     |
2025-11-18T07:14:11.2322733Z 219 |         chat_id: int,
2025-11-18T07:14:11.2322815Z 220 |         query_embedding: List[float],
2025-11-18T07:14:11.2322902Z 221 |         thread_id: Optional[int] = None,
2025-11-18T07:14:11.2322971Z     |                    ^^^^^^^^^^^^^
2025-11-18T07:14:11.2323040Z 222 |         limit: int = 5,
2025-11-18T07:14:11.2323126Z 223 |     ) -> List[tuple[Message, float]]:
2025-11-18T07:14:11.2323183Z     |
2025-11-18T07:14:11.2323255Z help: Convert to `X | None`
2025-11-18T07:14:11.2323261Z 
2025-11-18T07:14:11.2323376Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2323470Z    --> app/repositories/conversation.py:223:10
2025-11-18T07:14:11.2323528Z     |
2025-11-18T07:14:11.2323612Z 221 |         thread_id: Optional[int] = None,
2025-11-18T07:14:11.2323682Z 222 |         limit: int = 5,
2025-11-18T07:14:11.2323766Z 223 |     ) -> List[tuple[Message, float]]:
2025-11-18T07:14:11.2323824Z     |          ^^^^
2025-11-18T07:14:11.2323932Z 224 |         """Search messages by embedding similarity.
2025-11-18T07:14:11.2323989Z     |
2025-11-18T07:14:11.2324063Z help: Replace with `list`
2025-11-18T07:14:11.2324069Z 
2025-11-18T07:14:11.2324176Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2324270Z    --> app/repositories/conversation.py:286:37
2025-11-18T07:14:11.2324329Z     |
2025-11-18T07:14:11.2324388Z 284 |         )
2025-11-18T07:14:11.2324446Z 285 |
2025-11-18T07:14:11.2324617Z 286 |     def _cosine_similarity(self, a: List[float], b: List[float]) -> float:
2025-11-18T07:14:11.2324689Z     |                                     ^^^^
2025-11-18T07:14:11.2324820Z 287 |         """Calculate cosine similarity between two vectors."""
2025-11-18T07:14:11.2324893Z 288 |         if len(a) != len(b):
2025-11-18T07:14:11.2324951Z     |
2025-11-18T07:14:11.2325030Z help: Replace with `list`
2025-11-18T07:14:11.2325036Z 
2025-11-18T07:14:11.2325149Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2325240Z    --> app/repositories/conversation.py:286:53
2025-11-18T07:14:11.2325296Z     |
2025-11-18T07:14:11.2325357Z 284 |         )
2025-11-18T07:14:11.2325415Z 285 |
2025-11-18T07:14:11.2325578Z 286 |     def _cosine_similarity(self, a: List[float], b: List[float]) -> float:
2025-11-18T07:14:11.2325658Z     |                                                     ^^^^
2025-11-18T07:14:11.2325786Z 287 |         """Calculate cosine similarity between two vectors."""
2025-11-18T07:14:11.2325854Z 288 |         if len(a) != len(b):
2025-11-18T07:14:11.2326007Z     |
2025-11-18T07:14:11.2326083Z help: Replace with `list`
2025-11-18T07:14:11.2326089Z 
2025-11-18T07:14:11.2326201Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2326295Z    --> app/repositories/conversation.py:291:45
2025-11-18T07:14:11.2326357Z     |
2025-11-18T07:14:11.2326502Z 289 |             return 0.0
2025-11-18T07:14:11.2326560Z 290 |
2025-11-18T07:14:11.2326669Z 291 |         dot_product = sum(x * y for x, y in zip(a, b))
2025-11-18T07:14:11.2326750Z     |                                             ^^^^^^^^^
2025-11-18T07:14:11.2326850Z 292 |         magnitude_a = sum(x * x for x in a) ** 0.5
2025-11-18T07:14:11.2327177Z 293 |         magnitude_b = sum(x * x for x in b) ** 0.5
2025-11-18T07:14:11.2327248Z     |
2025-11-18T07:14:11.2327360Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2327365Z 
2025-11-18T07:14:11.2327465Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2327567Z   --> app/repositories/fact_repository.py:12:1
2025-11-18T07:14:11.2327630Z    |
2025-11-18T07:14:11.2327692Z 10 |   """
2025-11-18T07:14:11.2327750Z 11 |
2025-11-18T07:14:11.2327838Z 12 | / from __future__ import annotations
2025-11-18T07:14:11.2327897Z 13 | |
2025-11-18T07:14:11.2327963Z 14 | | import json
2025-11-18T07:14:11.2328034Z 15 | | import logging
2025-11-18T07:14:11.2328102Z 16 | | import time
2025-11-18T07:14:11.2328181Z 17 | | from pathlib import Path
2025-11-18T07:14:11.2328262Z 18 | | from typing import Any, Literal
2025-11-18T07:14:11.2328325Z 19 | |
2025-11-18T07:14:11.2328391Z 20 | | import asyncpg
2025-11-18T07:14:11.2328580Z 21 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2328640Z 22 | |
2025-11-18T07:14:11.2328779Z 23 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2328873Z    | |_________________________________________________________^
2025-11-18T07:14:11.2328933Z 24 |
2025-11-18T07:14:11.2329020Z 25 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2329079Z    |
2025-11-18T07:14:11.2329148Z help: Organize imports
2025-11-18T07:14:11.2329153Z 
2025-11-18T07:14:11.2329244Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2329345Z   --> app/repositories/fact_repository.py:17:21
2025-11-18T07:14:11.2329403Z    |
2025-11-18T07:14:11.2329473Z 15 | import logging
2025-11-18T07:14:11.2329537Z 16 | import time
2025-11-18T07:14:11.2329615Z 17 | from pathlib import Path
2025-11-18T07:14:11.2329678Z    |                     ^^^^
2025-11-18T07:14:11.2329761Z 18 | from typing import Any, Literal
2025-11-18T07:14:11.2329817Z    |
2025-11-18T07:14:11.2329912Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2329918Z 
2025-11-18T07:14:11.2330001Z F401 [*] `asyncpg` imported but unused
2025-11-18T07:14:11.2330097Z   --> app/repositories/fact_repository.py:20:8
2025-11-18T07:14:11.2330153Z    |
2025-11-18T07:14:11.2330229Z 18 | from typing import Any, Literal
2025-11-18T07:14:11.2330288Z 19 |
2025-11-18T07:14:11.2330356Z 20 | import asyncpg
2025-11-18T07:14:11.2330416Z    |        ^^^^^^^
2025-11-18T07:14:11.2330601Z 21 | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2330657Z    |
2025-11-18T07:14:11.2330743Z help: Remove unused import: `asyncpg`
2025-11-18T07:14:11.2330751Z 
2025-11-18T07:14:11.2330826Z W291 Trailing whitespace
2025-11-18T07:14:11.2330928Z    --> app/repositories/fact_repository.py:163:19
2025-11-18T07:14:11.2330985Z     |
2025-11-18T07:14:11.2331054Z 162 |         query = """
2025-11-18T07:14:11.2331120Z 163 |             SELECT 
2025-11-18T07:14:11.2331182Z     |                   ^
2025-11-18T07:14:11.2331288Z 164 |                 id, entity_type, entity_id, chat_context,
2025-11-18T07:14:11.2331423Z 165 |                 fact_category, fact_key, fact_value, fact_description,
2025-11-18T07:14:11.2331480Z     |
2025-11-18T07:14:11.2331561Z help: Remove trailing whitespace
2025-11-18T07:14:11.2331567Z 
2025-11-18T07:14:11.2331652Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2331877Z    --> app/repositories/fact_repository.py:203:1
2025-11-18T07:14:11.2331934Z     |
2025-11-18T07:14:11.2331997Z 201 |             else:
2025-11-18T07:14:11.2332087Z 202 |                 query_pg_final += char
2025-11-18T07:14:11.2332148Z 203 |         
2025-11-18T07:14:11.2332308Z     | ^^^^^^^^
2025-11-18T07:14:11.2332449Z 204 |         async with get_db_connection(self.database_url) as conn:
2025-11-18T07:14:11.2332567Z 205 |             rows = await conn.fetch(query_pg_final, *params)
2025-11-18T07:14:11.2332624Z     |
2025-11-18T07:14:11.2332707Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2332716Z 
2025-11-18T07:14:11.2332793Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2332892Z    --> app/repositories/fact_repository.py:302:1
2025-11-18T07:14:11.2332949Z     |
2025-11-18T07:14:11.2333030Z 301 |         params.append(fact_id)
2025-11-18T07:14:11.2333089Z 302 |         
2025-11-18T07:14:11.2333146Z     | ^^^^^^^^
2025-11-18T07:14:11.2333330Z 303 |         query = f"UPDATE facts SET {', '.join(updates)} WHERE id = ${param_index}"
2025-11-18T07:14:11.2333388Z     |
2025-11-18T07:14:11.2333473Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2333479Z 
2025-11-18T07:14:11.2333555Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2333658Z    --> app/repositories/fact_repository.py:304:1
2025-11-18T07:14:11.2333715Z     |
2025-11-18T07:14:11.2333877Z 303 |         query = f"UPDATE facts SET {', '.join(updates)} WHERE id = ${param_index}"
2025-11-18T07:14:11.2333938Z 304 |         
2025-11-18T07:14:11.2333995Z     | ^^^^^^^^
2025-11-18T07:14:11.2334130Z 305 |         async with get_db_connection(self.database_url) as conn:
2025-11-18T07:14:11.2334245Z 306 |             result = await conn.execute(query, *params)
2025-11-18T07:14:11.2334303Z     |
2025-11-18T07:14:11.2334389Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2334395Z 
2025-11-18T07:14:11.2334473Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2334576Z    --> app/repositories/fact_repository.py:459:1
2025-11-18T07:14:11.2334635Z     |
2025-11-18T07:14:11.2334698Z 457 |             else:
2025-11-18T07:14:11.2334773Z 458 |                 sql_pg += char
2025-11-18T07:14:11.2334831Z 459 |         
2025-11-18T07:14:11.2334889Z     | ^^^^^^^^
2025-11-18T07:14:11.2335025Z 460 |         async with get_db_connection(self.database_url) as conn:
2025-11-18T07:14:11.2335131Z 461 |             rows = await conn.fetch(sql_pg, *params)
2025-11-18T07:14:11.2335188Z     |
2025-11-18T07:14:11.2335271Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2335276Z 
2025-11-18T07:14:11.2335395Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2335496Z   --> app/repositories/memory_repository.py:8:1
2025-11-18T07:14:11.2335553Z    |
2025-11-18T07:14:11.2335642Z  6 | from dataclasses import dataclass
2025-11-18T07:14:11.2335734Z  7 | from datetime import datetime, timezone
2025-11-18T07:14:11.2335822Z  8 | from typing import Any, List, Optional
2025-11-18T07:14:11.2335894Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2335954Z  9 |
2025-11-18T07:14:11.2336062Z 10 | from app.core.exceptions import DatabaseError
2025-11-18T07:14:11.2336118Z    |
2025-11-18T07:14:11.2336123Z 
2025-11-18T07:14:11.2336217Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2336324Z   --> app/repositories/memory_repository.py:35:44
2025-11-18T07:14:11.2336381Z    |
2025-11-18T07:14:11.2336445Z 33 |         pass
2025-11-18T07:14:11.2336501Z 34 |
2025-11-18T07:14:11.2336643Z 35 |     async def find_by_id(self, id: Any) -> Optional[UserMemory]:
2025-11-18T07:14:11.2336725Z    |                                            ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2336822Z 36 |         """Finds a memory by its primary key."""
2025-11-18T07:14:11.2336915Z 37 |         return await self.get_memory_by_id(id)
2025-11-18T07:14:11.2337076Z    |
2025-11-18T07:14:11.2337156Z help: Convert to `X | None`
2025-11-18T07:14:11.2337277Z 
2025-11-18T07:14:11.2337357Z UP017 [*] Use `datetime.UTC` alias
2025-11-18T07:14:11.2337459Z   --> app/repositories/memory_repository.py:67:32
2025-11-18T07:14:11.2337518Z    |
2025-11-18T07:14:11.2337699Z 65 |             If the user has 15 memories, the oldest one is automatically deleted (FIFO).
2025-11-18T07:14:11.2337862Z 66 |         """
2025-11-18T07:14:11.2337977Z 67 |         now = int(datetime.now(timezone.utc).timestamp())
2025-11-18T07:14:11.2338053Z    |                                ^^^^^^^^^^^^
2025-11-18T07:14:11.2338108Z 68 |
2025-11-18T07:14:11.2338214Z 69 |         # First, check if the user is at the memory limit
2025-11-18T07:14:11.2338273Z    |
2025-11-18T07:14:11.2338360Z help: Convert to `datetime.UTC` alias
2025-11-18T07:14:11.2338366Z 
2025-11-18T07:14:11.2338439Z W291 Trailing whitespace
2025-11-18T07:14:11.2338546Z   --> app/repositories/memory_repository.py:77:42
2025-11-18T07:14:11.2338605Z    |
2025-11-18T07:14:11.2338724Z 75 |             # Auto-delete the oldest memory (FIFO) to make room
2025-11-18T07:14:11.2338812Z 76 |             delete_oldest_query = """
2025-11-18T07:14:11.2338901Z 77 |                 DELETE FROM user_memories 
2025-11-18T07:14:11.2338971Z    |                                          ^
2025-11-18T07:14:11.2339042Z 78 |                 WHERE id = (
2025-11-18T07:14:11.2339137Z 79 |                     SELECT id FROM user_memories 
2025-11-18T07:14:11.2339196Z    |
2025-11-18T07:14:11.2339278Z help: Remove trailing whitespace
2025-11-18T07:14:11.2339283Z 
2025-11-18T07:14:11.2339353Z W291 Trailing whitespace
2025-11-18T07:14:11.2339456Z   --> app/repositories/memory_repository.py:79:49
2025-11-18T07:14:11.2339513Z    |
2025-11-18T07:14:11.2339592Z 77 |                 DELETE FROM user_memories 
2025-11-18T07:14:11.2339664Z 78 |                 WHERE id = (
2025-11-18T07:14:11.2339749Z 79 |                     SELECT id FROM user_memories 
2025-11-18T07:14:11.2339822Z    |                                                 ^
2025-11-18T07:14:11.2339920Z 80 |                     WHERE user_id = $1 AND chat_id = $2 
2025-11-18T07:14:11.2340001Z 81 |                     ORDER BY created_at ASC 
2025-11-18T07:14:11.2340057Z    |
2025-11-18T07:14:11.2340136Z help: Remove trailing whitespace
2025-11-18T07:14:11.2340141Z 
2025-11-18T07:14:11.2340213Z W291 Trailing whitespace
2025-11-18T07:14:11.2340315Z   --> app/repositories/memory_repository.py:80:56
2025-11-18T07:14:11.2340371Z    |
2025-11-18T07:14:11.2340442Z 78 |                 WHERE id = (
2025-11-18T07:14:11.2340524Z 79 |                     SELECT id FROM user_memories 
2025-11-18T07:14:11.2340613Z 80 |                     WHERE user_id = $1 AND chat_id = $2 
2025-11-18T07:14:11.2340690Z    |                                                        ^
2025-11-18T07:14:11.2340770Z 81 |                     ORDER BY created_at ASC 
2025-11-18T07:14:11.2340835Z 82 |                     LIMIT 1
2025-11-18T07:14:11.2340891Z    |
2025-11-18T07:14:11.2340969Z help: Remove trailing whitespace
2025-11-18T07:14:11.2340979Z 
2025-11-18T07:14:11.2341049Z W291 Trailing whitespace
2025-11-18T07:14:11.2341146Z   --> app/repositories/memory_repository.py:81:44
2025-11-18T07:14:11.2341206Z    |
2025-11-18T07:14:11.2341289Z 79 |                     SELECT id FROM user_memories 
2025-11-18T07:14:11.2341373Z 80 |                     WHERE user_id = $1 AND chat_id = $2 
2025-11-18T07:14:11.2341456Z 81 |                     ORDER BY created_at ASC 
2025-11-18T07:14:11.2341526Z    |                                            ^
2025-11-18T07:14:11.2341590Z 82 |                     LIMIT 1
2025-11-18T07:14:11.2341652Z 83 |                 )
2025-11-18T07:14:11.2341711Z    |
2025-11-18T07:14:11.2341786Z help: Remove trailing whitespace
2025-11-18T07:14:11.2341792Z 
2025-11-18T07:14:11.2342164Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2342278Z    --> app/repositories/memory_repository.py:111:17
2025-11-18T07:14:11.2342455Z     |
2025-11-18T07:14:11.2342542Z 109 |             error_str = str(e).lower()
2025-11-18T07:14:11.2342713Z 110 |             if "unique constraint" in error_str or "duplicate key" in error_str:
2025-11-18T07:14:11.2342876Z 111 |                 raise DatabaseError(f"This memory already exists for the user.")
2025-11-18T07:14:11.2343033Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2343175Z 112 |             raise DatabaseError(f"Failed to add memory: {e}") from e
2025-11-18T07:14:11.2343236Z     |
2025-11-18T07:14:11.2343241Z 
2025-11-18T07:14:11.2343332Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2343442Z    --> app/repositories/memory_repository.py:111:37
2025-11-18T07:14:11.2343504Z     |
2025-11-18T07:14:11.2343586Z 109 |             error_str = str(e).lower()
2025-11-18T07:14:11.2343743Z 110 |             if "unique constraint" in error_str or "duplicate key" in error_str:
2025-11-18T07:14:11.2343908Z 111 |                 raise DatabaseError(f"This memory already exists for the user.")
2025-11-18T07:14:11.2344009Z     |                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2344143Z 112 |             raise DatabaseError(f"Failed to add memory: {e}") from e
2025-11-18T07:14:11.2344206Z     |
2025-11-18T07:14:11.2344290Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2344296Z 
2025-11-18T07:14:11.2344417Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2344519Z    --> app/repositories/memory_repository.py:116:10
2025-11-18T07:14:11.2344579Z     |
2025-11-18T07:14:11.2344664Z 114 |     async def get_memories_for_user(
2025-11-18T07:14:11.2344750Z 115 |         self, user_id: int, chat_id: int
2025-11-18T07:14:11.2344830Z 116 |     ) -> List[UserMemory]:
2025-11-18T07:14:11.2344890Z     |          ^^^^
2025-11-18T07:14:11.2344948Z 117 |         """
2025-11-18T07:14:11.2345096Z 118 |         Retrieves all memories for a given user in a specific chat.
2025-11-18T07:14:11.2345157Z     |
2025-11-18T07:14:11.2345233Z help: Replace with `list`
2025-11-18T07:14:11.2345238Z 
2025-11-18T07:14:11.2345327Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2345430Z    --> app/repositories/memory_repository.py:131:57
2025-11-18T07:14:11.2345491Z     |
2025-11-18T07:14:11.2345594Z 129 |         return [UserMemory(**row) for row in rows]
2025-11-18T07:14:11.2345655Z 130 |
2025-11-18T07:14:11.2345832Z 131 |     async def get_memory_by_id(self, memory_id: int) -> Optional[UserMemory]:
2025-11-18T07:14:11.2345919Z     |                                                         ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2345981Z 132 |         """
2025-11-18T07:14:11.2346072Z 133 |         Retrieves a single memory by its ID.
2025-11-18T07:14:11.2346130Z     |
2025-11-18T07:14:11.2346204Z help: Convert to `X | None`
2025-11-18T07:14:11.2346210Z 
2025-11-18T07:14:11.2346315Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2346414Z   --> app/repositories/user_profile.py:6:1
2025-11-18T07:14:11.2346470Z    |
2025-11-18T07:14:11.2346532Z  4 |   """
2025-11-18T07:14:11.2346589Z  5 |
2025-11-18T07:14:11.2346673Z  6 | / from __future__ import annotations
2025-11-18T07:14:11.2346732Z  7 | |
2025-11-18T07:14:11.2346798Z  8 | | import json
2025-11-18T07:14:11.2346896Z  9 | | from datetime import datetime, timezone
2025-11-18T07:14:11.2347093Z 10 | | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2347155Z 11 | |
2025-11-18T07:14:11.2347340Z 12 | | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2347444Z 13 | | from app.repositories.base import Repository
2025-11-18T07:14:11.2347555Z 14 | | from app.models.user_profile import UserProfile
2025-11-18T07:14:11.2347635Z    | |_______________________________________________^
2025-11-18T07:14:11.2347691Z    |
2025-11-18T07:14:11.2347761Z help: Organize imports
2025-11-18T07:14:11.2347767Z 
2025-11-18T07:14:11.2347966Z F401 [*] `json` imported but unused
2025-11-18T07:14:11.2348061Z   --> app/repositories/user_profile.py:8:8
2025-11-18T07:14:11.2348117Z    |
2025-11-18T07:14:11.2348204Z  6 | from __future__ import annotations
2025-11-18T07:14:11.2348261Z  7 |
2025-11-18T07:14:11.2348324Z  8 | import json
2025-11-18T07:14:11.2348382Z    |        ^^^^
2025-11-18T07:14:11.2348595Z  9 | from datetime import datetime, timezone
2025-11-18T07:14:11.2348697Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2348753Z    |
2025-11-18T07:14:11.2348836Z help: Remove unused import: `json`
2025-11-18T07:14:11.2348842Z 
2025-11-18T07:14:11.2348958Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.2349049Z   --> app/repositories/user_profile.py:10:1
2025-11-18T07:14:11.2349107Z    |
2025-11-18T07:14:11.2349168Z  8 | import json
2025-11-18T07:14:11.2349255Z  9 | from datetime import datetime, timezone
2025-11-18T07:14:11.2349351Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2349427Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2349483Z 11 |
2025-11-18T07:14:11.2349662Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2349721Z    |
2025-11-18T07:14:11.2349726Z 
2025-11-18T07:14:11.2349836Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2349931Z   --> app/repositories/user_profile.py:10:1
2025-11-18T07:14:11.2349989Z    |
2025-11-18T07:14:11.2350049Z  8 | import json
2025-11-18T07:14:11.2350135Z  9 | from datetime import datetime, timezone
2025-11-18T07:14:11.2350229Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2350301Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2350357Z 11 |
2025-11-18T07:14:11.2350532Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2350590Z    |
2025-11-18T07:14:11.2350596Z 
2025-11-18T07:14:11.2350686Z F401 [*] `typing.Dict` imported but unused
2025-11-18T07:14:11.2350788Z   --> app/repositories/user_profile.py:10:25
2025-11-18T07:14:11.2350844Z    |
2025-11-18T07:14:11.2350909Z  8 | import json
2025-11-18T07:14:11.2351002Z  9 | from datetime import datetime, timezone
2025-11-18T07:14:11.2351100Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2351169Z    |                         ^^^^
2025-11-18T07:14:11.2351228Z 11 |
2025-11-18T07:14:11.2351409Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2351468Z    |
2025-11-18T07:14:11.2351544Z help: Remove unused import
2025-11-18T07:14:11.2351551Z 
2025-11-18T07:14:11.2351641Z F401 [*] `typing.List` imported but unused
2025-11-18T07:14:11.2351738Z   --> app/repositories/user_profile.py:10:31
2025-11-18T07:14:11.2351796Z    |
2025-11-18T07:14:11.2351857Z  8 | import json
2025-11-18T07:14:11.2351945Z  9 | from datetime import datetime, timezone
2025-11-18T07:14:11.2352049Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2352122Z    |                               ^^^^
2025-11-18T07:14:11.2352178Z 11 |
2025-11-18T07:14:11.2352362Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2352421Z    |
2025-11-18T07:14:11.2352494Z help: Remove unused import
2025-11-18T07:14:11.2352499Z 
2025-11-18T07:14:11.2352680Z F401 [*] `app.core.exceptions.DatabaseError` imported but unused
2025-11-18T07:14:11.2352779Z   --> app/repositories/user_profile.py:12:33
2025-11-18T07:14:11.2352837Z    |
2025-11-18T07:14:11.2352933Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2352993Z 11 |
2025-11-18T07:14:11.2353170Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2353244Z    |                                 ^^^^^^^^^^^^^
2025-11-18T07:14:11.2353342Z 13 | from app.repositories.base import Repository
2025-11-18T07:14:11.2353456Z 14 | from app.models.user_profile import UserProfile
2025-11-18T07:14:11.2353511Z    |
2025-11-18T07:14:11.2353671Z help: Remove unused import
2025-11-18T07:14:11.2353678Z 
2025-11-18T07:14:11.2353866Z F401 [*] `app.core.exceptions.UserProfileNotFoundError` imported but unused
2025-11-18T07:14:11.2353958Z   --> app/repositories/user_profile.py:12:48
2025-11-18T07:14:11.2354015Z    |
2025-11-18T07:14:11.2354116Z 10 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2354248Z 11 |
2025-11-18T07:14:11.2354425Z 12 | from app.core.exceptions import DatabaseError, UserProfileNotFoundError
2025-11-18T07:14:11.2354504Z    |                                                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2354607Z 13 | from app.repositories.base import Repository
2025-11-18T07:14:11.2354715Z 14 | from app.models.user_profile import UserProfile
2025-11-18T07:14:11.2354773Z    |
2025-11-18T07:14:11.2354850Z help: Remove unused import
2025-11-18T07:14:11.2354855Z 
2025-11-18T07:14:11.2354947Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2355037Z   --> app/repositories/user_profile.py:78:44
2025-11-18T07:14:11.2355100Z    |
2025-11-18T07:14:11.2355159Z 76 |     """
2025-11-18T07:14:11.2355214Z 77 |
2025-11-18T07:14:11.2355359Z 78 |     async def find_by_id(self, id: Any) -> Optional[UserProfile]:
2025-11-18T07:14:11.2355444Z    |                                            ^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2355582Z 79 |         """Find user profile by a composite ID (user_id, chat_id).
2025-11-18T07:14:11.2355639Z    |
2025-11-18T07:14:11.2355716Z help: Convert to `X | None`
2025-11-18T07:14:11.2355721Z 
2025-11-18T07:14:11.2355798Z UP017 [*] Use `datetime.UTC` alias
2025-11-18T07:14:11.2355896Z    --> app/repositories/user_profile.py:123:32
2025-11-18T07:14:11.2355956Z     |
2025-11-18T07:14:11.2356027Z 121 |             Saved profile
2025-11-18T07:14:11.2356087Z 122 |         """
2025-11-18T07:14:11.2356207Z 123 |         now = int(datetime.now(timezone.utc).timestamp())
2025-11-18T07:14:11.2356282Z     |                                ^^^^^^^^^^^^
2025-11-18T07:14:11.2356348Z 124 |         query = """
2025-11-18T07:14:11.2356446Z 125 |             INSERT INTO user_profiles (
2025-11-18T07:14:11.2356505Z     |
2025-11-18T07:14:11.2356591Z help: Convert to `datetime.UTC` alias
2025-11-18T07:14:11.2356598Z 
2025-11-18T07:14:11.2356674Z F401 [*] `math` imported but unused
2025-11-18T07:14:11.2356767Z   --> app/services/adaptive_throttle.py:25:8
2025-11-18T07:14:11.2356829Z    |
2025-11-18T07:14:11.2356893Z 24 | import asyncio
2025-11-18T07:14:11.2357168Z 25 | import math
2025-11-18T07:14:11.2357271Z    |        ^^^^
2025-11-18T07:14:11.2357336Z 26 | import time
2025-11-18T07:14:11.2357416Z 27 | from pathlib import Path
2025-11-18T07:14:11.2357473Z    |
2025-11-18T07:14:11.2357556Z help: Remove unused import: `math`
2025-11-18T07:14:11.2357563Z 
2025-11-18T07:14:11.2357646Z F401 [*] `aiosqlite` imported but unused
2025-11-18T07:14:11.2357739Z   --> app/services/adaptive_throttle.py:29:8
2025-11-18T07:14:11.2357799Z    |
2025-11-18T07:14:11.2357874Z 27 | from pathlib import Path
2025-11-18T07:14:11.2357935Z 28 |
2025-11-18T07:14:11.2358003Z 29 | import aiosqlite
2025-11-18T07:14:11.2358063Z    |        ^^^^^^^^^
2025-11-18T07:14:11.2358119Z 30 |
2025-11-18T07:14:11.2358259Z 31 | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2358319Z    |
2025-11-18T07:14:11.2358404Z help: Remove unused import: `aiosqlite`
2025-11-18T07:14:11.2358414Z 
2025-11-18T07:14:11.2358491Z F401 [*] `time` imported but unused
2025-11-18T07:14:11.2358578Z   --> app/services/bot_learning.py:12:8
2025-11-18T07:14:11.2358635Z    |
2025-11-18T07:14:11.2358700Z 10 | import logging
2025-11-18T07:14:11.2358762Z 11 | import re
2025-11-18T07:14:11.2358827Z 12 | import time
2025-11-18T07:14:11.2358886Z    |        ^^^^
2025-11-18T07:14:11.2358959Z 13 | from typing import Any
2025-11-18T07:14:11.2359019Z    |
2025-11-18T07:14:11.2359099Z help: Remove unused import: `time`
2025-11-18T07:14:11.2359105Z 
2025-11-18T07:14:11.2359243Z F841 Local variable `text_lower` is assigned to but never used
2025-11-18T07:14:11.2359461Z   --> app/services/bot_learning.py:68:9
2025-11-18T07:14:11.2359518Z    |
2025-11-18T07:14:11.2359627Z 66 |         Returns (sentiment_label, confidence_score).
2025-11-18T07:14:11.2359685Z 67 |         """
2025-11-18T07:14:11.2359766Z 68 |         text_lower = text.lower()
2025-11-18T07:14:11.2359829Z    |         ^^^^^^^^^^
2025-11-18T07:14:11.2359988Z 69 |
2025-11-18T07:14:11.2360074Z 70 |         # Check for explicit patterns
2025-11-18T07:14:11.2360131Z    |
2025-11-18T07:14:11.2360249Z help: Remove assignment to unused variable `text_lower`
2025-11-18T07:14:11.2360255Z 
2025-11-18T07:14:11.2360409Z F841 Local variable `sentiment_score` is assigned to but never used
2025-11-18T07:14:11.2360498Z    --> app/services/bot_learning.py:115:9
2025-11-18T07:14:11.2360555Z     |
2025-11-18T07:14:11.2360614Z 113 |         """
2025-11-18T07:14:11.2360779Z 114 |         sentiment, confidence = self.detect_user_sentiment(user_message)
2025-11-18T07:14:11.2360928Z 115 |         sentiment_score = self.calculate_sentiment_score(sentiment)
2025-11-18T07:14:11.2360998Z     |         ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2361058Z 116 |
2025-11-18T07:14:11.2361153Z 117 |         # Learn communication style patterns
2025-11-18T07:14:11.2361210Z     |
2025-11-18T07:14:11.2361345Z help: Remove assignment to unused variable `sentiment_score`
2025-11-18T07:14:11.2361354Z 
2025-11-18T07:14:11.2361444Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2361530Z    --> app/services/bot_learning.py:141:21
2025-11-18T07:14:11.2361586Z     |
2025-11-18T07:14:11.2361677Z 139 |             await self.bot_profile.add_fact(
2025-11-18T07:14:11.2361773Z 140 |                 category="communication_style",
2025-11-18T07:14:11.2361860Z 141 |                 key=f"preferred_length",
2025-11-18T07:14:11.2361935Z     |                     ^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2362015Z 142 |                 value=length_category,
2025-11-18T07:14:11.2362102Z 143 |                 confidence=confidence * 0.6,
2025-11-18T07:14:11.2362162Z     |
2025-11-18T07:14:11.2362244Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2362250Z 
2025-11-18T07:14:11.2362353Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2362438Z    --> app/services/bot_profile.py:114:45
2025-11-18T07:14:11.2362497Z     |
2025-11-18T07:14:11.2362568Z 112 |             return 0.0
2025-11-18T07:14:11.2362624Z 113 |
2025-11-18T07:14:11.2362747Z 114 |         dot_product = sum(a * b for a, b in zip(vec1, vec2))
2025-11-18T07:14:11.2362833Z     |                                             ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2362943Z 115 |         magnitude1 = math.sqrt(sum(a * a for a in vec1))
2025-11-18T07:14:11.2363051Z 116 |         magnitude2 = math.sqrt(sum(b * b for b in vec2))
2025-11-18T07:14:11.2363110Z     |
2025-11-18T07:14:11.2363213Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2363219Z 
2025-11-18T07:14:11.2363358Z B007 Loop control variable `fact_key` not used within loop body
2025-11-18T07:14:11.2363453Z    --> app/services/bot_profile.py:167:22
2025-11-18T07:14:11.2363509Z     |
2025-11-18T07:14:11.2363583Z 165 |         best_similarity = 0.0
2025-11-18T07:14:11.2363642Z 166 |
2025-11-18T07:14:11.2363783Z 167 |         for fact_id, fact_key, fact_value, fact_embedding_json in rows:
2025-11-18T07:14:11.2363852Z     |                      ^^^^^^^^
2025-11-18T07:14:11.2363914Z 168 |             try:
2025-11-18T07:14:11.2364032Z 169 |                 fact_embedding = json.loads(fact_embedding_json)
2025-11-18T07:14:11.2364089Z     |
2025-11-18T07:14:11.2364181Z help: Rename unused `fact_key` to `_fact_key`
2025-11-18T07:14:11.2364188Z 
2025-11-18T07:14:11.2364333Z B007 Loop control variable `fact_value` not used within loop body
2025-11-18T07:14:11.2364417Z    --> app/services/bot_profile.py:167:32
2025-11-18T07:14:11.2364475Z     |
2025-11-18T07:14:11.2364549Z 165 |         best_similarity = 0.0
2025-11-18T07:14:11.2364606Z 166 |
2025-11-18T07:14:11.2364742Z 167 |         for fact_id, fact_key, fact_value, fact_embedding_json in rows:
2025-11-18T07:14:11.2364901Z     |                                ^^^^^^^^^^
2025-11-18T07:14:11.2364967Z 168 |             try:
2025-11-18T07:14:11.2365081Z 169 |                 fact_embedding = json.loads(fact_embedding_json)
2025-11-18T07:14:11.2365138Z     |
2025-11-18T07:14:11.2365318Z help: Rename unused `fact_value` to `_fact_value`
2025-11-18T07:14:11.2365324Z 
2025-11-18T07:14:11.2365421Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2365506Z   --> app/services/calculator.py:20:5
2025-11-18T07:14:11.2365566Z    |
2025-11-18T07:14:11.2365653Z 18 |   # Import telemetry for usage tracking
2025-11-18T07:14:11.2365714Z 19 |   try:
2025-11-18T07:14:11.2365801Z 20 | /     from app.services import telemetry
2025-11-18T07:14:11.2365974Z 21 | |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2366087Z    | |________________________________________________________________________^
2025-11-18T07:14:11.2366165Z 22 |   except ImportError:
2025-11-18T07:14:11.2366256Z 23 |       # Fallback if telemetry not available
2025-11-18T07:14:11.2366312Z    |
2025-11-18T07:14:11.2366382Z help: Organize imports
2025-11-18T07:14:11.2366388Z 
2025-11-18T07:14:11.2366506Z E731 Do not assign a `lambda` expression, use a `def`
2025-11-18T07:14:11.2366599Z   --> app/services/calculator.py:25:5
2025-11-18T07:14:11.2366656Z    |
2025-11-18T07:14:11.2366744Z 23 |     # Fallback if telemetry not available
2025-11-18T07:14:11.2366818Z 24 |     telemetry = None
2025-11-18T07:14:11.2367126Z 25 |     log_tool_execution = lambda name: lambda f: f  # No-op decorator
2025-11-18T07:14:11.2367208Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2367280Z 26 |     ToolLogger = None
2025-11-18T07:14:11.2367336Z    |
2025-11-18T07:14:11.2367429Z help: Rewrite `log_tool_execution` as a `def`
2025-11-18T07:14:11.2367435Z 
2025-11-18T07:14:11.2367807Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2367902Z    --> app/services/calculator.py:125:17
2025-11-18T07:14:11.2367958Z     |
2025-11-18T07:14:11.2368025Z 123 |                 return result
2025-11-18T07:14:11.2368114Z 124 |             except ZeroDivisionError:
2025-11-18T07:14:11.2368219Z 125 |                 raise ValueError("Division by zero")
2025-11-18T07:14:11.2368295Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2368397Z 126 |             except (OverflowError, ValueError) as e:
2025-11-18T07:14:11.2368511Z 127 |                 raise ValueError(f"Mathematical error: {e}")
2025-11-18T07:14:11.2368568Z     |
2025-11-18T07:14:11.2368573Z 
2025-11-18T07:14:11.2368930Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2369014Z    --> app/services/calculator.py:127:17
2025-11-18T07:14:11.2369073Z     |
2025-11-18T07:14:11.2369168Z 125 |                 raise ValueError("Division by zero")
2025-11-18T07:14:11.2369270Z 126 |             except (OverflowError, ValueError) as e:
2025-11-18T07:14:11.2369381Z 127 |                 raise ValueError(f"Mathematical error: {e}")
2025-11-18T07:14:11.2369462Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2369525Z 128 |
2025-11-18T07:14:11.2369619Z 129 |         elif isinstance(node, ast.UnaryOp):
2025-11-18T07:14:11.2369678Z     |
2025-11-18T07:14:11.2369683Z 
2025-11-18T07:14:11.2370041Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2370127Z    --> app/services/calculator.py:155:17
2025-11-18T07:14:11.2370186Z     |
2025-11-18T07:14:11.2370260Z 153 |                 return result
2025-11-18T07:14:11.2370385Z 154 |             except (TypeError, ValueError, OverflowError) as e:
2025-11-18T07:14:11.2370614Z 155 |                 raise ValueError(f"Function error: {e}")
2025-11-18T07:14:11.2370693Z     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2370754Z 156 |
2025-11-18T07:14:11.2370816Z 157 |         else:
2025-11-18T07:14:11.2370873Z     |
2025-11-18T07:14:11.2370877Z 
2025-11-18T07:14:11.2371355Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2371451Z    --> app/services/calculator.py:227:13
2025-11-18T07:14:11.2371507Z     |
2025-11-18T07:14:11.2371651Z 225 |                 extra={"expression": expression, "syntax_error": str(e)},
2025-11-18T07:14:11.2371710Z 226 |             )
2025-11-18T07:14:11.2371814Z 227 |             raise ValueError(f"Invalid syntax: {e}")
2025-11-18T07:14:11.2371889Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2371988Z 228 |         except (TypeError, ValueError) as e:
2025-11-18T07:14:11.2372073Z 229 |             self.logger.warning(
2025-11-18T07:14:11.2372130Z     |
2025-11-18T07:14:11.2372135Z 
2025-11-18T07:14:11.2372497Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2372589Z    --> app/services/calculator.py:237:13
2025-11-18T07:14:11.2372646Z     |
2025-11-18T07:14:11.2372713Z 235 |                 },
2025-11-18T07:14:11.2372772Z 236 |             )
2025-11-18T07:14:11.2372852Z 237 |             raise ValueError(str(e))
2025-11-18T07:14:11.2372919Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2372998Z 238 |         except Exception as e:
2025-11-18T07:14:11.2373076Z 239 |             self.logger.error(
2025-11-18T07:14:11.2373134Z     |
2025-11-18T07:14:11.2373139Z 
2025-11-18T07:14:11.2373494Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2373581Z    --> app/services/calculator.py:248:13
2025-11-18T07:14:11.2373638Z     |
2025-11-18T07:14:11.2373709Z 246 |                 exc_info=True,
2025-11-18T07:14:11.2373768Z 247 |             )
2025-11-18T07:14:11.2373880Z 248 |             raise ValueError(f"Calculation error: {e}")
2025-11-18T07:14:11.2373958Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2374019Z     |
2025-11-18T07:14:11.2374024Z 
2025-11-18T07:14:11.2374105Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2374214Z   --> app/services/checkers/board_renderer.py:12:1
2025-11-18T07:14:11.2374274Z    |
2025-11-18T07:14:11.2374351Z 10 |     board = game.get_board()
2025-11-18T07:14:11.2374413Z 11 |     lines = []
2025-11-18T07:14:11.2374474Z 12 |     
2025-11-18T07:14:11.2374531Z    | ^^^^
2025-11-18T07:14:11.2374605Z 13 |     # Header with column labels
2025-11-18T07:14:11.2374696Z 14 |     lines.append("   a  b  c  d  e  f  g  h")
2025-11-18T07:14:11.2374759Z    |
2025-11-18T07:14:11.2374847Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2374852Z 
2025-11-18T07:14:11.2374930Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2375033Z   --> app/services/checkers/board_renderer.py:16:1
2025-11-18T07:14:11.2375091Z    |
2025-11-18T07:14:11.2375180Z 14 |     lines.append("   a  b  c  d  e  f  g  h")
2025-11-18T07:14:11.2375255Z 15 |     lines.append("")
2025-11-18T07:14:11.2375316Z 16 |     
2025-11-18T07:14:11.2375374Z    | ^^^^
2025-11-18T07:14:11.2375439Z 17 |     # Board rows
2025-11-18T07:14:11.2375514Z 18 |     for row in range(8):
2025-11-18T07:14:11.2375570Z    |
2025-11-18T07:14:11.2375654Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2375660Z 
2025-11-18T07:14:11.2375739Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2375840Z   --> app/services/checkers/board_renderer.py:20:1
2025-11-18T07:14:11.2375897Z    |
2025-11-18T07:14:11.2375966Z 18 |     for row in range(8):
2025-11-18T07:14:11.2376156Z 19 |         line = f"{8 - row} "  # Row number (8 to 1)
2025-11-18T07:14:11.2376218Z 20 |         
2025-11-18T07:14:11.2376277Z    | ^^^^^^^^
2025-11-18T07:14:11.2376352Z 21 |         for col in range(8):
2025-11-18T07:14:11.2376432Z 22 |             piece = board[row][col]
2025-11-18T07:14:11.2376490Z    |
2025-11-18T07:14:11.2376653Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2376663Z 
2025-11-18T07:14:11.2376741Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2376842Z   --> app/services/checkers/board_renderer.py:24:1
2025-11-18T07:14:11.2376899Z    |
2025-11-18T07:14:11.2377080Z 22 |             piece = board[row][col]
2025-11-18T07:14:11.2377168Z 23 |             square_type = (row + col) % 2
2025-11-18T07:14:11.2377228Z 24 |             
2025-11-18T07:14:11.2377289Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2377411Z 25 |             if square_type == 0:  # Light square (not playable)
2025-11-18T07:14:11.2377584Z 26 |                 line += "⬜"
2025-11-18T07:14:11.2377647Z    |
2025-11-18T07:14:11.2377739Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2377745Z 
2025-11-18T07:14:11.2377825Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2377930Z   --> app/services/checkers/board_renderer.py:40:1
2025-11-18T07:14:11.2377989Z    |
2025-11-18T07:14:11.2378055Z 38 |                 else:
2025-11-18T07:14:11.2378192Z 39 |                     line += "❓"  # Unknown
2025-11-18T07:14:11.2378255Z 40 |             
2025-11-18T07:14:11.2378312Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2378380Z 41 |             line += " "
2025-11-18T07:14:11.2378437Z    |
2025-11-18T07:14:11.2378523Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2378529Z 
2025-11-18T07:14:11.2378608Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2378709Z   --> app/services/checkers/board_renderer.py:42:1
2025-11-18T07:14:11.2378770Z    |
2025-11-18T07:14:11.2378835Z 41 |             line += " "
2025-11-18T07:14:11.2378893Z 42 |         
2025-11-18T07:14:11.2378952Z    | ^^^^^^^^
2025-11-18T07:14:11.2379064Z 43 |         line += f" {8 - row}"  # Row number on right
2025-11-18T07:14:11.2379142Z 44 |         lines.append(line)
2025-11-18T07:14:11.2379198Z    |
2025-11-18T07:14:11.2379287Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2379292Z 
2025-11-18T07:14:11.2379370Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2379476Z   --> app/services/checkers/board_renderer.py:45:1
2025-11-18T07:14:11.2379536Z    |
2025-11-18T07:14:11.2379631Z 43 |         line += f" {8 - row}"  # Row number on right
2025-11-18T07:14:11.2379703Z 44 |         lines.append(line)
2025-11-18T07:14:11.2379761Z 45 |     
2025-11-18T07:14:11.2379822Z    | ^^^^
2025-11-18T07:14:11.2379883Z 46 |     # Footer
2025-11-18T07:14:11.2379955Z 47 |     lines.append("")
2025-11-18T07:14:11.2380013Z    |
2025-11-18T07:14:11.2380096Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2380102Z 
2025-11-18T07:14:11.2380179Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2380281Z   --> app/services/checkers/board_renderer.py:49:1
2025-11-18T07:14:11.2380342Z    |
2025-11-18T07:14:11.2380412Z 47 |     lines.append("")
2025-11-18T07:14:11.2380499Z 48 |     lines.append("   a  b  c  d  e  f  g  h")
2025-11-18T07:14:11.2380558Z 49 |     
2025-11-18T07:14:11.2380616Z    | ^^^^
2025-11-18T07:14:11.2380684Z 50 |     # Game status
2025-11-18T07:14:11.2380763Z 51 |     forced_capture_hint = False
2025-11-18T07:14:11.2380826Z    |
2025-11-18T07:14:11.2380910Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2380916Z 
2025-11-18T07:14:11.2380993Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2381096Z   --> app/services/checkers/board_renderer.py:63:1
2025-11-18T07:14:11.2381153Z    |
2025-11-18T07:14:11.2381292Z 61 |         if valid_moves and any(move.jumps for move in valid_moves):
2025-11-18T07:14:11.2381379Z 62 |             forced_capture_hint = True
2025-11-18T07:14:11.2381438Z 63 |     
2025-11-18T07:14:11.2381494Z    | ^^^^
2025-11-18T07:14:11.2381711Z 64 |     is_over, winner = game.check_game_over()
2025-11-18T07:14:11.2381778Z 65 |     if is_over:
2025-11-18T07:14:11.2381834Z    |
2025-11-18T07:14:11.2381917Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2381922Z 
2025-11-18T07:14:11.2382005Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2382248Z   --> app/services/checkers/board_renderer.py:73:1
2025-11-18T07:14:11.2382306Z    |
2025-11-18T07:14:11.2382384Z 71 |     elif forced_capture_hint:
2025-11-18T07:14:11.2382637Z 72 |         lines.append("⚠️ Є обов'язковий удар. Обери фігуру, що може бити суперника.")
2025-11-18T07:14:11.2382697Z 73 |     
2025-11-18T07:14:11.2382754Z    | ^^^^
2025-11-18T07:14:11.2382831Z 74 |     return "\n".join(lines)
2025-11-18T07:14:11.2382886Z    |
2025-11-18T07:14:11.2382971Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2382976Z 
2025-11-18T07:14:11.2383058Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2383162Z   --> app/services/checkers/board_renderer.py:81:1
2025-11-18T07:14:11.2383227Z    |
2025-11-18T07:14:11.2383302Z 79 |     board = game.get_board()
2025-11-18T07:14:11.2383368Z 80 |     lines = []
2025-11-18T07:14:11.2383424Z 81 |     
2025-11-18T07:14:11.2383482Z    | ^^^^
2025-11-18T07:14:11.2383557Z 82 |     # Compact header
2025-11-18T07:14:11.2383646Z 83 |     lines.append("`  a b c d e f g h`")
2025-11-18T07:14:11.2383710Z    |
2025-11-18T07:14:11.2383795Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2383804Z 
2025-11-18T07:14:11.2383885Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2383986Z   --> app/services/checkers/board_renderer.py:84:1
2025-11-18T07:14:11.2384043Z    |
2025-11-18T07:14:11.2384116Z 82 |     # Compact header
2025-11-18T07:14:11.2384201Z 83 |     lines.append("`  a b c d e f g h`")
2025-11-18T07:14:11.2384260Z 84 |     
2025-11-18T07:14:11.2384318Z    | ^^^^
2025-11-18T07:14:11.2384387Z 85 |     for row in range(8):
2025-11-18T07:14:11.2384460Z 86 |         line = f"`{8 - row}`"
2025-11-18T07:14:11.2384521Z    |
2025-11-18T07:14:11.2384607Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2384613Z 
2025-11-18T07:14:11.2384690Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2384789Z   --> app/services/checkers/board_renderer.py:90:1
2025-11-18T07:14:11.2384850Z    |
2025-11-18T07:14:11.2384928Z 88 |             piece = board[row][col]
2025-11-18T07:14:11.2385017Z 89 |             square_type = (row + col) % 2
2025-11-18T07:14:11.2385076Z 90 |             
2025-11-18T07:14:11.2385136Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2385211Z 91 |             if square_type == 0:
2025-11-18T07:14:11.2385319Z 92 |                 line += "⬜"
2025-11-18T07:14:11.2385379Z    |
2025-11-18T07:14:11.2385464Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2385469Z 
2025-11-18T07:14:11.2385547Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2385660Z    --> app/services/checkers/board_renderer.py:109:1
2025-11-18T07:14:11.2385719Z     |
2025-11-18T07:14:11.2385791Z 107 |         line += f"`{8 - row}`"
2025-11-18T07:14:11.2385872Z 108 |         lines.append(line)
2025-11-18T07:14:11.2385934Z 109 |     
2025-11-18T07:14:11.2385991Z     | ^^^^
2025-11-18T07:14:11.2386082Z 110 |     lines.append("`  a b c d e f g h`")
2025-11-18T07:14:11.2386145Z     |
2025-11-18T07:14:11.2386228Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2386239Z 
2025-11-18T07:14:11.2386318Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2386425Z    --> app/services/checkers/board_renderer.py:111:1
2025-11-18T07:14:11.2386485Z     |
2025-11-18T07:14:11.2386568Z 110 |     lines.append("`  a b c d e f g h`")
2025-11-18T07:14:11.2386627Z 111 |     
2025-11-18T07:14:11.2386686Z     | ^^^^
2025-11-18T07:14:11.2386757Z 112 |     if current_player:
2025-11-18T07:14:11.2386940Z 113 |         player_emoji = "⚫" if current_player == 1 else "⚪"
2025-11-18T07:14:11.2387109Z     |
2025-11-18T07:14:11.2387196Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2387201Z 
2025-11-18T07:14:11.2387405Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2387508Z    --> app/services/checkers/board_renderer.py:115:1
2025-11-18T07:14:11.2387569Z     |
2025-11-18T07:14:11.2387740Z 113 |         player_emoji = "⚫" if current_player == 1 else "⚪"
2025-11-18T07:14:11.2387881Z 114 |         lines.append(f"\n{player_emoji} Хід")
2025-11-18T07:14:11.2388049Z 115 |     
2025-11-18T07:14:11.2388106Z     | ^^^^
2025-11-18T07:14:11.2388181Z 116 |     return "\n".join(lines)
2025-11-18T07:14:11.2388237Z     |
2025-11-18T07:14:11.2388327Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2388333Z 
2025-11-18T07:14:11.2388432Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2388531Z  --> app/services/checkers/game_engine.py:3:1
2025-11-18T07:14:11.2388594Z   |
2025-11-18T07:14:11.2388770Z 1 |   """Checkers game engine with move validation and game state management."""
2025-11-18T07:14:11.2388828Z 2 |
2025-11-18T07:14:11.2388913Z 3 | / from __future__ import annotations
2025-11-18T07:14:11.2388975Z 4 | |
2025-11-18T07:14:11.2389039Z 5 | | import json
2025-11-18T07:14:11.2389114Z 6 | | from typing import Literal
2025-11-18T07:14:11.2389197Z 7 | | from dataclasses import dataclass
2025-11-18T07:14:11.2389263Z   | |_________________________________^
2025-11-18T07:14:11.2389320Z   |
2025-11-18T07:14:11.2389400Z help: Organize imports
2025-11-18T07:14:11.2389406Z 
2025-11-18T07:14:11.2389483Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2389581Z   --> app/services/checkers/game_engine.py:26:1
2025-11-18T07:14:11.2389638Z    |
2025-11-18T07:14:11.2389720Z 24 | class CheckersGame:
2025-11-18T07:14:11.2389911Z 25 |     """Manages checkers game state, validates moves, and checks win conditions."""
2025-11-18T07:14:11.2389970Z 26 |     
2025-11-18T07:14:11.2390033Z    | ^^^^
2025-11-18T07:14:11.2390101Z 27 |     BOARD_SIZE = 8
2025-11-18T07:14:11.2390159Z    |
2025-11-18T07:14:11.2390244Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2390256Z 
2025-11-18T07:14:11.2390344Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2390440Z   --> app/services/checkers/game_engine.py:28:1
2025-11-18T07:14:11.2390511Z    |
2025-11-18T07:14:11.2390594Z 27 |     BOARD_SIZE = 8
2025-11-18T07:14:11.2390654Z 28 |     
2025-11-18T07:14:11.2390711Z    | ^^^^
2025-11-18T07:14:11.2390888Z 29 |     def _find_matching_move(self, move: Move, player: Player) -> Move | None:
2025-11-18T07:14:11.2391076Z 30 |         """Return the engine-generated move that matches supplied coordinates."""
2025-11-18T07:14:11.2391133Z    |
2025-11-18T07:14:11.2391215Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2391225Z 
2025-11-18T07:14:11.2391304Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2391397Z   --> app/services/checkers/game_engine.py:40:1
2025-11-18T07:14:11.2391456Z    |
2025-11-18T07:14:11.2391533Z 38 |                 return candidate
2025-11-18T07:14:11.2391600Z 39 |         return None
2025-11-18T07:14:11.2391657Z 40 |     
2025-11-18T07:14:11.2391717Z    | ^^^^
2025-11-18T07:14:11.2391884Z 41 |     def _validate_simple_move(self, move: Move, player: Player) -> bool:
2025-11-18T07:14:11.2392046Z 42 |         """Validate a non-capturing move lands on an adjacent dark square."""
2025-11-18T07:14:11.2392105Z    |
2025-11-18T07:14:11.2392195Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2392204Z 
2025-11-18T07:14:11.2392282Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2392378Z   --> app/services/checkers/game_engine.py:45:1
2025-11-18T07:14:11.2392438Z    |
2025-11-18T07:14:11.2392512Z 43 |         if move.jumps:
2025-11-18T07:14:11.2392584Z 44 |             return False
2025-11-18T07:14:11.2392649Z 45 |         
2025-11-18T07:14:11.2392710Z    | ^^^^^^^^
2025-11-18T07:14:11.2392797Z 46 |         dr = move.to_row - move.from_row
2025-11-18T07:14:11.2392882Z 47 |         dc = move.to_col - move.from_col
2025-11-18T07:14:11.2392946Z    |
2025-11-18T07:14:11.2393029Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2393035Z 
2025-11-18T07:14:11.2393201Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2393304Z   --> app/services/checkers/game_engine.py:48:1
2025-11-18T07:14:11.2393363Z    |
2025-11-18T07:14:11.2393499Z 46 |         dr = move.to_row - move.from_row
2025-11-18T07:14:11.2393621Z 47 |         dc = move.to_col - move.from_col
2025-11-18T07:14:11.2393825Z 48 |         
2025-11-18T07:14:11.2393917Z    | ^^^^^^^^
2025-11-18T07:14:11.2394138Z 49 |         # Check if move is diagonal
2025-11-18T07:14:11.2394265Z 50 |         if abs(dr) != abs(dc):
2025-11-18T07:14:11.2394394Z    |
2025-11-18T07:14:11.2394515Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2394522Z 
2025-11-18T07:14:11.2394669Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2394803Z   --> app/services/checkers/game_engine.py:52:1
2025-11-18T07:14:11.2394978Z    |
2025-11-18T07:14:11.2395099Z 50 |         if abs(dr) != abs(dc):
2025-11-18T07:14:11.2395205Z 51 |             return False
2025-11-18T07:14:11.2395332Z 52 |         
2025-11-18T07:14:11.2395431Z    | ^^^^^^^^
2025-11-18T07:14:11.2395599Z 53 |         if not self._is_valid_position(move.to_row, move.to_col):
2025-11-18T07:14:11.2395777Z 54 |             return False
2025-11-18T07:14:11.2395884Z    |
2025-11-18T07:14:11.2396004Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2396014Z 
2025-11-18T07:14:11.2396129Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2396331Z   --> app/services/checkers/game_engine.py:59:1
2025-11-18T07:14:11.2396424Z    |
2025-11-18T07:14:11.2396550Z 57 |         if self.board[move.to_row][move.to_col] != 0:
2025-11-18T07:14:11.2396757Z 58 |             return False
2025-11-18T07:14:11.2396850Z 59 |         
2025-11-18T07:14:11.2397112Z    | ^^^^^^^^
2025-11-18T07:14:11.2397311Z 60 |         piece = self.board[move.from_row][move.from_col]
2025-11-18T07:14:11.2397453Z 61 |         if not self._is_player_piece(piece, player):
2025-11-18T07:14:11.2397530Z    |
2025-11-18T07:14:11.2397719Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2397731Z 
2025-11-18T07:14:11.2397899Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2398034Z   --> app/services/checkers/game_engine.py:63:1
2025-11-18T07:14:11.2398159Z    |
2025-11-18T07:14:11.2398337Z 61 |         if not self._is_player_piece(piece, player):
2025-11-18T07:14:11.2398429Z 62 |             return False
2025-11-18T07:14:11.2398576Z 63 |         
2025-11-18T07:14:11.2398726Z    | ^^^^^^^^
2025-11-18T07:14:11.2398907Z 64 |         if not self._is_playable_square(move.from_row, move.from_col):
2025-11-18T07:14:11.2399009Z 65 |             return False
2025-11-18T07:14:11.2399101Z    |
2025-11-18T07:14:11.2399243Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2399250Z 
2025-11-18T07:14:11.2399414Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2399561Z   --> app/services/checkers/game_engine.py:66:1
2025-11-18T07:14:11.2399690Z    |
2025-11-18T07:14:11.2399894Z 64 |         if not self._is_playable_square(move.from_row, move.from_col):
2025-11-18T07:14:11.2399999Z 65 |             return False
2025-11-18T07:14:11.2400110Z 66 |         
2025-11-18T07:14:11.2400251Z    | ^^^^^^^^
2025-11-18T07:14:11.2400381Z 67 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2400486Z 68 |         distance = abs(dr)
2025-11-18T07:14:11.2400617Z    |
2025-11-18T07:14:11.2400741Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2400747Z 
2025-11-18T07:14:11.2400859Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2401059Z   --> app/services/checkers/game_engine.py:69:1
2025-11-18T07:14:11.2401171Z    |
2025-11-18T07:14:11.2401283Z 67 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2401455Z 68 |         distance = abs(dr)
2025-11-18T07:14:11.2401548Z 69 |         
2025-11-18T07:14:11.2401640Z    | ^^^^^^^^
2025-11-18T07:14:11.2401723Z 70 |         if is_king:
2025-11-18T07:14:11.2402009Z 71 |             # Ukrainian checkers: queen can move any diagonal distance
2025-11-18T07:14:11.2402101Z    |
2025-11-18T07:14:11.2402351Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2402357Z 
2025-11-18T07:14:11.2402505Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2402645Z   --> app/services/checkers/game_engine.py:88:1
2025-11-18T07:14:11.2402720Z    |
2025-11-18T07:14:11.2402939Z 86 |                 return False
2025-11-18T07:14:11.2403188Z 87 |             return True
2025-11-18T07:14:11.2403282Z 88 |     
2025-11-18T07:14:11.2403373Z    | ^^^^
2025-11-18T07:14:11.2403621Z 89 |     def _validate_jump_sequence(self, move: Move, player: Player) -> bool:
2025-11-18T07:14:11.2403761Z 90 |         """Ensure jump sequence is physically reachable."""
2025-11-18T07:14:11.2403908Z    |
2025-11-18T07:14:11.2404083Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2404090Z 
2025-11-18T07:14:11.2404205Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2404339Z   --> app/services/checkers/game_engine.py:93:1
2025-11-18T07:14:11.2404464Z    |
2025-11-18T07:14:11.2404557Z 91 |         if not move.jumps:
2025-11-18T07:14:11.2404719Z 92 |             return False
2025-11-18T07:14:11.2404861Z 93 |         
2025-11-18T07:14:11.2404993Z    | ^^^^^^^^
2025-11-18T07:14:11.2405167Z 94 |         if not self._is_valid_position(move.from_row, move.from_col):
2025-11-18T07:14:11.2405269Z 95 |             return False
2025-11-18T07:14:11.2405385Z    |
2025-11-18T07:14:11.2405557Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2405563Z 
2025-11-18T07:14:11.2405691Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2405860Z   --> app/services/checkers/game_engine.py:96:1
2025-11-18T07:14:11.2405952Z    |
2025-11-18T07:14:11.2406121Z 94 |         if not self._is_valid_position(move.from_row, move.from_col):
2025-11-18T07:14:11.2406224Z 95 |             return False
2025-11-18T07:14:11.2406418Z 96 |         
2025-11-18T07:14:11.2406523Z    | ^^^^^^^^
2025-11-18T07:14:11.2406673Z 97 |         piece = self.board[move.from_row][move.from_col]
2025-11-18T07:14:11.2406848Z 98 |         if not self._is_player_piece(piece, player):
2025-11-18T07:14:11.2407069Z    |
2025-11-18T07:14:11.2407196Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2407202Z 
2025-11-18T07:14:11.2407400Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2407555Z    --> app/services/checkers/game_engine.py:100:1
2025-11-18T07:14:11.2407653Z     |
2025-11-18T07:14:11.2407796Z  98 |         if not self._is_player_piece(piece, player):
2025-11-18T07:14:11.2407938Z  99 |             return False
2025-11-18T07:14:11.2408032Z 100 |         
2025-11-18T07:14:11.2408108Z     | ^^^^^^^^
2025-11-18T07:14:11.2408367Z 101 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2408507Z 102 |         temp_board = [row[:] for row in self.board]
2025-11-18T07:14:11.2408599Z     |
2025-11-18T07:14:11.2408751Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2408756Z 
2025-11-18T07:14:11.2408869Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2408986Z    --> app/services/checkers/game_engine.py:105:1
2025-11-18T07:14:11.2409185Z     |
2025-11-18T07:14:11.2409355Z 103 |         current_row, current_col = move.from_row, move.from_col
2025-11-18T07:14:11.2409492Z 104 |         temp_board[current_row][current_col] = 0
2025-11-18T07:14:11.2409588Z 105 |         
2025-11-18T07:14:11.2409717Z     | ^^^^^^^^
2025-11-18T07:14:11.2409867Z 106 |         for jump_row, jump_col in move.jumps:
2025-11-18T07:14:11.2410045Z 107 |             dr = jump_row - current_row
2025-11-18T07:14:11.2410187Z     |
2025-11-18T07:14:11.2410307Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2410313Z 
2025-11-18T07:14:11.2410422Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2410594Z    --> app/services/checkers/game_engine.py:109:1
2025-11-18T07:14:11.2410670Z     |
2025-11-18T07:14:11.2410838Z 107 |             dr = jump_row - current_row
2025-11-18T07:14:11.2410974Z 108 |             dc = jump_col - current_col
2025-11-18T07:14:11.2411109Z 109 |             
2025-11-18T07:14:11.2411204Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2411476Z 110 |             # Check if move is diagonal
2025-11-18T07:14:11.2411608Z 111 |             if abs(dr) != abs(dc):
2025-11-18T07:14:11.2411755Z     |
2025-11-18T07:14:11.2411889Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2411895Z 
2025-11-18T07:14:11.2412044Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2412286Z    --> app/services/checkers/game_engine.py:113:1
2025-11-18T07:14:11.2412377Z     |
2025-11-18T07:14:11.2412487Z 111 |             if abs(dr) != abs(dc):
2025-11-18T07:14:11.2412669Z 112 |                 return False
2025-11-18T07:14:11.2412779Z 113 |             
2025-11-18T07:14:11.2412872Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2413103Z 114 |             if not self._is_valid_position(jump_row, jump_col):
2025-11-18T07:14:11.2413210Z 115 |                 return False
2025-11-18T07:14:11.2413302Z     |
2025-11-18T07:14:11.2413499Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2413505Z 
2025-11-18T07:14:11.2413635Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2413774Z    --> app/services/checkers/game_engine.py:116:1
2025-11-18T07:14:11.2413865Z     |
2025-11-18T07:14:11.2414057Z 114 |             if not self._is_valid_position(jump_row, jump_col):
2025-11-18T07:14:11.2414161Z 115 |                 return False
2025-11-18T07:14:11.2414243Z 116 |             
2025-11-18T07:14:11.2414441Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2414592Z 117 |             jumped_piece = temp_board[jump_row][jump_col]
2025-11-18T07:14:11.2414823Z 118 |             if jumped_piece == 0 or self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2414951Z     |
2025-11-18T07:14:11.2415071Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2415077Z 
2025-11-18T07:14:11.2415173Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2415365Z    --> app/services/checkers/game_engine.py:120:1
2025-11-18T07:14:11.2415509Z     |
2025-11-18T07:14:11.2415699Z 118 |             if jumped_piece == 0 or self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2415807Z 119 |                 return False
2025-11-18T07:14:11.2415938Z 120 |             
2025-11-18T07:14:11.2416016Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2416172Z 121 |             if is_king:
2025-11-18T07:14:11.2416382Z 122 |                 # Ukrainian checkers: queen can jump any distance
2025-11-18T07:14:11.2416510Z     |
2025-11-18T07:14:11.2416626Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2416632Z 
2025-11-18T07:14:11.2416783Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2416896Z    --> app/services/checkers/game_engine.py:127:1
2025-11-18T07:14:11.2417241Z     |
2025-11-18T07:14:11.2417391Z 125 |                 row_dir = 1 if dr > 0 else -1
2025-11-18T07:14:11.2417546Z 126 |                 col_dir = 1 if dc > 0 else -1
2025-11-18T07:14:11.2417645Z 127 |                 
2025-11-18T07:14:11.2417740Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2417892Z 128 |                 for step in range(1, distance):
2025-11-18T07:14:11.2418096Z 129 |                     check_row = current_row + step * row_dir
2025-11-18T07:14:11.2418209Z     |
2025-11-18T07:14:11.2418407Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2418413Z 
2025-11-18T07:14:11.2418529Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2418671Z    --> app/services/checkers/game_engine.py:133:1
2025-11-18T07:14:11.2418767Z     |
2025-11-18T07:14:11.2418991Z 131 |                     if temp_board[check_row][check_col] != 0:
2025-11-18T07:14:11.2419124Z 132 |                         return False
2025-11-18T07:14:11.2419220Z 133 |                 
2025-11-18T07:14:11.2419351Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2419521Z 134 |                 # Landing square is one step beyond the jumped piece
2025-11-18T07:14:11.2419653Z 135 |                 landing_row = jump_row + row_dir
2025-11-18T07:14:11.2419833Z     |
2025-11-18T07:14:11.2419969Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2419975Z 
2025-11-18T07:14:11.2420256Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2420393Z    --> app/services/checkers/game_engine.py:141:1
2025-11-18T07:14:11.2420526Z     |
2025-11-18T07:14:11.2420652Z 139 |                 if abs(dr) != 1 or abs(dc) != 1:
2025-11-18T07:14:11.2420744Z 140 |                     return False
2025-11-18T07:14:11.2421054Z 141 |                 
2025-11-18T07:14:11.2421153Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2421286Z 142 |                 landing_row = current_row + 2 * dr
2025-11-18T07:14:11.2421446Z 143 |                 landing_col = current_col + 2 * dc
2025-11-18T07:14:11.2421536Z     |
2025-11-18T07:14:11.2421640Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2421646Z 
2025-11-18T07:14:11.2421895Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2422031Z    --> app/services/checkers/game_engine.py:144:1
2025-11-18T07:14:11.2422123Z     |
2025-11-18T07:14:11.2422246Z 142 |                 landing_row = current_row + 2 * dr
2025-11-18T07:14:11.2422406Z 143 |                 landing_col = current_col + 2 * dc
2025-11-18T07:14:11.2422490Z 144 |             
2025-11-18T07:14:11.2422636Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2422865Z 145 |             if not self._is_valid_position(landing_row, landing_col):
2025-11-18T07:14:11.2422971Z 146 |                 return False
2025-11-18T07:14:11.2423066Z     |
2025-11-18T07:14:11.2423184Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2423226Z 
2025-11-18T07:14:11.2423355Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2423540Z    --> app/services/checkers/game_engine.py:151:1
2025-11-18T07:14:11.2423648Z     |
2025-11-18T07:14:11.2423830Z 149 |             if temp_board[landing_row][landing_col] != 0:
2025-11-18T07:14:11.2423934Z 150 |                 return False
2025-11-18T07:14:11.2424026Z 151 |             
2025-11-18T07:14:11.2424138Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2424317Z 152 |             temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2424489Z 153 |             current_row, current_col = landing_row, landing_col
2025-11-18T07:14:11.2424621Z     |
2025-11-18T07:14:11.2424739Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2424745Z 
2025-11-18T07:14:11.2424857Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2425018Z    --> app/services/checkers/game_engine.py:154:1
2025-11-18T07:14:11.2425185Z     |
2025-11-18T07:14:11.2425329Z 152 |             temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2425480Z 153 |             current_row, current_col = landing_row, landing_col
2025-11-18T07:14:11.2425618Z 154 |         
2025-11-18T07:14:11.2425710Z     | ^^^^^^^^
2025-11-18T07:14:11.2425898Z 155 |         return (current_row, current_col) == (move.to_row, move.to_col)
2025-11-18T07:14:11.2426059Z     |
2025-11-18T07:14:11.2426194Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2426200Z 
2025-11-18T07:14:11.2426312Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2426474Z    --> app/services/checkers/game_engine.py:156:1
2025-11-18T07:14:11.2426570Z     |
2025-11-18T07:14:11.2426777Z 155 |         return (current_row, current_col) == (move.to_row, move.to_col)
2025-11-18T07:14:11.2426858Z 156 |     
2025-11-18T07:14:11.2427182Z     | ^^^^
2025-11-18T07:14:11.2427388Z 157 |     def _validate_move_path(self, move: Move, player: Player) -> bool:
2025-11-18T07:14:11.2427568Z 158 |         """Validate that move structure matches board geometry."""
2025-11-18T07:14:11.2427708Z     |
2025-11-18T07:14:11.2427826Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2427832Z 
2025-11-18T07:14:11.2427929Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2428176Z    --> app/services/checkers/game_engine.py:162:1
2025-11-18T07:14:11.2428268Z     |
2025-11-18T07:14:11.2428426Z 160 |             return self._validate_jump_sequence(move, player)
2025-11-18T07:14:11.2428577Z 161 |         return self._validate_simple_move(move, player)
2025-11-18T07:14:11.2428737Z 162 |     
2025-11-18T07:14:11.2428813Z     | ^^^^
2025-11-18T07:14:11.2429167Z 163 |     def __init__(self, board: list[list[int]] | None = None):
2025-11-18T07:14:11.2429375Z 164 |         """Initialize game with optional board state."""
2025-11-18T07:14:11.2429465Z     |
2025-11-18T07:14:11.2429583Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2429590Z 
2025-11-18T07:14:11.2429845Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2429963Z    --> app/services/checkers/game_engine.py:169:1
2025-11-18T07:14:11.2430114Z     |
2025-11-18T07:14:11.2430226Z 167 |         else:
2025-11-18T07:14:11.2430451Z 168 |             self.board = [row[:] for row in board]  # Deep copy
2025-11-18T07:14:11.2430544Z 169 |     
2025-11-18T07:14:11.2430635Z     | ^^^^
2025-11-18T07:14:11.2430760Z 170 |     @staticmethod
2025-11-18T07:14:11.2430958Z 171 |     def _create_initial_board() -> list[list[int]]:
2025-11-18T07:14:11.2431065Z     |
2025-11-18T07:14:11.2431223Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2431229Z 
2025-11-18T07:14:11.2431342Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2431480Z    --> app/services/checkers/game_engine.py:185:1
2025-11-18T07:14:11.2431572Z     |
2025-11-18T07:14:11.2431767Z 183 |                     board[row][col] = 2
2025-11-18T07:14:11.2431887Z 184 |         return board
2025-11-18T07:14:11.2432013Z 185 |     
2025-11-18T07:14:11.2432147Z     | ^^^^
2025-11-18T07:14:11.2432279Z 186 |     def get_board(self) -> list[list[int]]:
2025-11-18T07:14:11.2432424Z 187 |         """Get current board state (deep copy)."""
2025-11-18T07:14:11.2432590Z     |
2025-11-18T07:14:11.2432732Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2432738Z 
2025-11-18T07:14:11.2432851Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2432984Z    --> app/services/checkers/game_engine.py:189:1
2025-11-18T07:14:11.2433113Z     |
2025-11-18T07:14:11.2433247Z 187 |         """Get current board state (deep copy)."""
2025-11-18T07:14:11.2433360Z 188 |         return [row[:] for row in self.board]
2025-11-18T07:14:11.2433570Z 189 |     
2025-11-18T07:14:11.2433697Z     | ^^^^
2025-11-18T07:14:11.2433846Z 190 |     def get_piece(self, row: int, col: int) -> int:
2025-11-18T07:14:11.2434010Z 191 |         """Get piece at given position."""
2025-11-18T07:14:11.2434102Z     |
2025-11-18T07:14:11.2434204Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2434214Z 
2025-11-18T07:14:11.2434433Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2434565Z    --> app/services/checkers/game_engine.py:195:1
2025-11-18T07:14:11.2434657Z     |
2025-11-18T07:14:11.2434760Z 193 |             return 0
2025-11-18T07:14:11.2434919Z 194 |         return self.board[row][col]
2025-11-18T07:14:11.2434996Z 195 |     
2025-11-18T07:14:11.2435144Z     | ^^^^
2025-11-18T07:14:11.2435391Z 196 |     def _is_valid_position(self, row: int, col: int) -> bool:
2025-11-18T07:14:11.2435539Z 197 |         """Check if position is within board bounds."""
2025-11-18T07:14:11.2435631Z     |
2025-11-18T07:14:11.2435750Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2435797Z 
2025-11-18T07:14:11.2435894Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2436081Z    --> app/services/checkers/game_engine.py:199:1
2025-11-18T07:14:11.2436190Z     |
2025-11-18T07:14:11.2436370Z 197 |         """Check if position is within board bounds."""
2025-11-18T07:14:11.2436554Z 198 |         return 0 <= row < self.BOARD_SIZE and 0 <= col < self.BOARD_SIZE
2025-11-18T07:14:11.2436650Z 199 |     
2025-11-18T07:14:11.2436767Z     | ^^^^
2025-11-18T07:14:11.2437104Z 200 |     def _is_playable_square(self, row: int, col: int) -> bool:
2025-11-18T07:14:11.2437351Z 201 |         """Check if square is playable (dark squares only in checkers)."""
2025-11-18T07:14:11.2437481Z     |
2025-11-18T07:14:11.2437604Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2437611Z 
2025-11-18T07:14:11.2437726Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2437864Z    --> app/services/checkers/game_engine.py:203:1
2025-11-18T07:14:11.2438156Z     |
2025-11-18T07:14:11.2438362Z 201 |         """Check if square is playable (dark squares only in checkers)."""
2025-11-18T07:14:11.2438479Z 202 |         return (row + col) % 2 == 1
2025-11-18T07:14:11.2438612Z 203 |     
2025-11-18T07:14:11.2438704Z     | ^^^^
2025-11-18T07:14:11.2438879Z 204 |     def get_valid_moves(self, player: Player) -> list[Move]:
2025-11-18T07:14:11.2439234Z 205 |         """Get all valid moves for a player."""
2025-11-18T07:14:11.2439342Z     |
2025-11-18T07:14:11.2439465Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2439470Z 
2025-11-18T07:14:11.2439620Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2439755Z    --> app/services/checkers/game_engine.py:207:1
2025-11-18T07:14:11.2439847Z     |
2025-11-18T07:14:11.2439964Z 205 |         """Get all valid moves for a player."""
2025-11-18T07:14:11.2440172Z 206 |         moves = []
2025-11-18T07:14:11.2440268Z 207 |         
2025-11-18T07:14:11.2440362Z     | ^^^^^^^^
2025-11-18T07:14:11.2440528Z 208 |         # First, check for mandatory jumps
2025-11-18T07:14:11.2440670Z 209 |         jump_moves = []
2025-11-18T07:14:11.2440747Z     |
2025-11-18T07:14:11.2440927Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2440991Z 
2025-11-18T07:14:11.2441104Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2441241Z    --> app/services/checkers/game_engine.py:216:1
2025-11-18T07:14:11.2441333Z     |
2025-11-18T07:14:11.2441526Z 214 |                     jumps = self._get_jumps_from(row, col, player)
2025-11-18T07:14:11.2441638Z 215 |                     jump_moves.extend(jumps)
2025-11-18T07:14:11.2441782Z 216 |         
2025-11-18T07:14:11.2441924Z     | ^^^^^^^^
2025-11-18T07:14:11.2442030Z 217 |         if jump_moves:
2025-11-18T07:14:11.2442139Z 218 |             return jump_moves
2025-11-18T07:14:11.2442263Z     |
2025-11-18T07:14:11.2442404Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2442411Z 
2025-11-18T07:14:11.2442575Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2442726Z    --> app/services/checkers/game_engine.py:219:1
2025-11-18T07:14:11.2442853Z     |
2025-11-18T07:14:11.2442958Z 217 |         if jump_moves:
2025-11-18T07:14:11.2443066Z 218 |             return jump_moves
2025-11-18T07:14:11.2443180Z 219 |         
2025-11-18T07:14:11.2443322Z     | ^^^^^^^^
2025-11-18T07:14:11.2443467Z 220 |         # If no jumps, return regular moves
2025-11-18T07:14:11.2443590Z 221 |         for row in range(self.BOARD_SIZE):
2025-11-18T07:14:11.2443718Z     |
2025-11-18T07:14:11.2443867Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2443873Z 
2025-11-18T07:14:11.2443988Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2444190Z    --> app/services/checkers/game_engine.py:226:1
2025-11-18T07:14:11.2444302Z     |
2025-11-18T07:14:11.2444448Z 224 |                 if self._is_player_piece(piece, player):
2025-11-18T07:14:11.2444654Z 225 |                     moves.extend(self._get_moves_from(row, col, player))
2025-11-18T07:14:11.2444753Z 226 |         
2025-11-18T07:14:11.2444844Z     | ^^^^^^^^
2025-11-18T07:14:11.2445020Z 227 |         return moves
2025-11-18T07:14:11.2445127Z     |
2025-11-18T07:14:11.2445244Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2445250Z 
2025-11-18T07:14:11.2445363Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2445563Z    --> app/services/checkers/game_engine.py:228:1
2025-11-18T07:14:11.2445656Z     |
2025-11-18T07:14:11.2445742Z 227 |         return moves
2025-11-18T07:14:11.2445936Z 228 |     
2025-11-18T07:14:11.2446027Z     | ^^^^
2025-11-18T07:14:11.2446212Z 229 |     def _is_player_piece(self, piece: int, player: Player) -> bool:
2025-11-18T07:14:11.2446344Z 230 |         """Check if piece belongs to player."""
2025-11-18T07:14:11.2446468Z     |
2025-11-18T07:14:11.2446569Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2446575Z 
2025-11-18T07:14:11.2446744Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2446921Z    --> app/services/checkers/game_engine.py:235:1
2025-11-18T07:14:11.2447262Z     |
2025-11-18T07:14:11.2447361Z 233 |         else:
2025-11-18T07:14:11.2447560Z 234 |             return piece in (2, 4)  # White piece or white king
2025-11-18T07:14:11.2447640Z 235 |     
2025-11-18T07:14:11.2447793Z     | ^^^^
2025-11-18T07:14:11.2448059Z 236 |     def _get_moves_from(self, row: int, col: int, player: Player) -> list[Move]:
2025-11-18T07:14:11.2448330Z 237 |         """Get regular moves (non-jumps) from a position."""
2025-11-18T07:14:11.2448425Z     |
2025-11-18T07:14:11.2448545Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2448551Z 
2025-11-18T07:14:11.2448666Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2451884Z    --> app/services/checkers/game_engine.py:241:1
2025-11-18T07:14:11.2451969Z     |
2025-11-18T07:14:11.2452075Z 239 |         piece = self.board[row][col]
2025-11-18T07:14:11.2452160Z 240 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2452225Z 241 |         
2025-11-18T07:14:11.2452285Z     | ^^^^^^^^
2025-11-18T07:14:11.2452391Z 242 |         if player == 1:  # Black moves down
2025-11-18T07:14:11.2452595Z 243 |             directions = [(1, -1), (1, 1)] if not is_king else [(1, -1), (1, 1), (-1, -1), (-1, 1)]
2025-11-18T07:14:11.2452705Z     |
2025-11-18T07:14:11.2452797Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2452808Z 
2025-11-18T07:14:11.2452896Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2453003Z    --> app/services/checkers/game_engine.py:246:1
2025-11-18T07:14:11.2453063Z     |
2025-11-18T07:14:11.2453139Z 244 |         else:  # White moves up
2025-11-18T07:14:11.2453329Z 245 |             directions = [(-1, -1), (-1, 1)] if not is_king else [(1, -1), (1, 1), (-1, -1), (-1, 1)]
2025-11-18T07:14:11.2453389Z 246 |         
2025-11-18T07:14:11.2453450Z     | ^^^^^^^^
2025-11-18T07:14:11.2453534Z 247 |         for dr, dc in directions:
2025-11-18T07:14:11.2453605Z 248 |             if is_king:
2025-11-18T07:14:11.2453662Z     |
2025-11-18T07:14:11.2453750Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2453761Z 
2025-11-18T07:14:11.2453839Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2453941Z    --> app/services/checkers/game_engine.py:266:1
2025-11-18T07:14:11.2453998Z     |
2025-11-18T07:14:11.2454113Z 264 |                     if self.board[new_row][new_col] == 0:
2025-11-18T07:14:11.2454250Z 265 |                         moves.append(Move(row, col, new_row, new_col, []))
2025-11-18T07:14:11.2454310Z 266 |         
2025-11-18T07:14:11.2454369Z     | ^^^^^^^^
2025-11-18T07:14:11.2454437Z 267 |         return moves
2025-11-18T07:14:11.2454493Z     |
2025-11-18T07:14:11.2454578Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2454584Z 
2025-11-18T07:14:11.2454665Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2454763Z    --> app/services/checkers/game_engine.py:268:1
2025-11-18T07:14:11.2454819Z     |
2025-11-18T07:14:11.2454891Z 267 |         return moves
2025-11-18T07:14:11.2454950Z 268 |     
2025-11-18T07:14:11.2455011Z     | ^^^^
2025-11-18T07:14:11.2455189Z 269 |     def _get_jump_directions(self, player: Player) -> list[tuple[int, int]]:
2025-11-18T07:14:11.2455321Z 270 |         """Return directions for evaluating capture moves."""
2025-11-18T07:14:11.2455379Z     |
2025-11-18T07:14:11.2455461Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2455469Z 
2025-11-18T07:14:11.2455552Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2455647Z    --> app/services/checkers/game_engine.py:274:1
2025-11-18T07:14:11.2455704Z     |
2025-11-18T07:14:11.2455806Z 272 |             return [(1, -1), (1, 1), (-1, -1), (-1, 1)]
2025-11-18T07:14:11.2455902Z 273 |         return [(-1, -1), (-1, 1), (1, -1), (1, 1)]
2025-11-18T07:14:11.2455960Z 274 |     
2025-11-18T07:14:11.2456022Z     | ^^^^
2025-11-18T07:14:11.2456203Z 275 |     def _get_jumps_from(self, row: int, col: int, player: Player) -> list[Move]:
2025-11-18T07:14:11.2456365Z 276 |         """Get jump moves from a position (recursive for multi-jumps)."""
2025-11-18T07:14:11.2456570Z     |
2025-11-18T07:14:11.2456663Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2456668Z 
2025-11-18T07:14:11.2456750Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2456851Z    --> app/services/checkers/game_engine.py:281:1
2025-11-18T07:14:11.2457205Z     |
2025-11-18T07:14:11.2457297Z 279 |         piece = self.board[row][col]
2025-11-18T07:14:11.2457373Z 280 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2457438Z 281 |         
2025-11-18T07:14:11.2457495Z     | ^^^^^^^^
2025-11-18T07:14:11.2457570Z 282 |         for dr, dc in directions:
2025-11-18T07:14:11.2457639Z 283 |             if is_king:
2025-11-18T07:14:11.2457699Z     |
2025-11-18T07:14:11.2457782Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2457787Z 
2025-11-18T07:14:11.2457865Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2457966Z    --> app/services/checkers/game_engine.py:288:1
2025-11-18T07:14:11.2458024Z     |
2025-11-18T07:14:11.2458140Z 286 |                 for distance in range(1, self.BOARD_SIZE):
2025-11-18T07:14:11.2458290Z 287 |                     jump_row, jump_col = row + distance * dr, col + distance * dc
2025-11-18T07:14:11.2458359Z 288 |                     
2025-11-18T07:14:11.2458421Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2458551Z 289 |                     if not self._is_valid_position(jump_row, jump_col):
2025-11-18T07:14:11.2458627Z 290 |                         break
2025-11-18T07:14:11.2458686Z     |
2025-11-18T07:14:11.2458774Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2458780Z 
2025-11-18T07:14:11.2458863Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2458965Z    --> app/services/checkers/game_engine.py:293:1
2025-11-18T07:14:11.2459022Z     |
2025-11-18T07:14:11.2459151Z 291 |                     if not self._is_playable_square(jump_row, jump_col):
2025-11-18T07:14:11.2459225Z 292 |                         continue
2025-11-18T07:14:11.2459288Z 293 |                     
2025-11-18T07:14:11.2459355Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2459476Z 294 |                     jumped_piece = self.board[jump_row][jump_col]
2025-11-18T07:14:11.2459565Z 295 |                     if jumped_piece == 0:
2025-11-18T07:14:11.2459623Z     |
2025-11-18T07:14:11.2459712Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2459722Z 
2025-11-18T07:14:11.2459800Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2459897Z    --> app/services/checkers/game_engine.py:298:1
2025-11-18T07:14:11.2459957Z     |
2025-11-18T07:14:11.2460067Z 296 |                         # Empty cell, continue scanning
2025-11-18T07:14:11.2460136Z 297 |                         continue
2025-11-18T07:14:11.2460199Z 298 |                     
2025-11-18T07:14:11.2460263Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2460384Z 299 |                     if self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2460494Z 300 |                         # Own piece, stop scanning in this direction
2025-11-18T07:14:11.2460558Z     |
2025-11-18T07:14:11.2460641Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2460647Z 
2025-11-18T07:14:11.2460725Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2460819Z    --> app/services/checkers/game_engine.py:302:1
2025-11-18T07:14:11.2460882Z     |
2025-11-18T07:14:11.2460989Z 300 |                         # Own piece, stop scanning in this direction
2025-11-18T07:14:11.2461057Z 301 |                         break
2025-11-18T07:14:11.2461125Z 302 |                     
2025-11-18T07:14:11.2461187Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2461328Z 303 |                     # Found opponent piece, check if landing square is empty
2025-11-18T07:14:11.2461448Z 304 |                     land_row, land_col = jump_row + dr, jump_col + dc
2025-11-18T07:14:11.2461505Z     |
2025-11-18T07:14:11.2461589Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2461595Z 
2025-11-18T07:14:11.2461671Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2461926Z    --> app/services/checkers/game_engine.py:305:1
2025-11-18T07:14:11.2461984Z     |
2025-11-18T07:14:11.2462118Z 303 |                     # Found opponent piece, check if landing square is empty
2025-11-18T07:14:11.2462240Z 304 |                     land_row, land_col = jump_row + dr, jump_col + dc
2025-11-18T07:14:11.2462406Z 305 |                     
2025-11-18T07:14:11.2462468Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2462594Z 306 |                     if not self._is_valid_position(land_row, land_col):
2025-11-18T07:14:11.2462663Z 307 |                         break
2025-11-18T07:14:11.2462721Z     |
2025-11-18T07:14:11.2462806Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2462815Z 
2025-11-18T07:14:11.2462893Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2462986Z    --> app/services/checkers/game_engine.py:313:1
2025-11-18T07:14:11.2463043Z     |
2025-11-18T07:14:11.2463159Z 311 |                         # Landing square is occupied, stop scanning
2025-11-18T07:14:11.2463230Z 312 |                         break
2025-11-18T07:14:11.2463294Z 313 |                     
2025-11-18T07:14:11.2463363Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2463478Z 314 |                     # Check that path to jumped piece is clear
2025-11-18T07:14:11.2463564Z 315 |                     path_clear = True
2025-11-18T07:14:11.2463625Z     |
2025-11-18T07:14:11.2463714Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2463721Z 
2025-11-18T07:14:11.2463799Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2463897Z    --> app/services/checkers/game_engine.py:322:1
2025-11-18T07:14:11.2463958Z     |
2025-11-18T07:14:11.2464047Z 320 |                             path_clear = False
2025-11-18T07:14:11.2464116Z 321 |                             break
2025-11-18T07:14:11.2464181Z 322 |                     
2025-11-18T07:14:11.2464243Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2464329Z 323 |                     if not path_clear:
2025-11-18T07:14:11.2464399Z 324 |                         break
2025-11-18T07:14:11.2464460Z     |
2025-11-18T07:14:11.2464546Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2464551Z 
2025-11-18T07:14:11.2464629Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2464730Z    --> app/services/checkers/game_engine.py:325:1
2025-11-18T07:14:11.2464790Z     |
2025-11-18T07:14:11.2464870Z 323 |                     if not path_clear:
2025-11-18T07:14:11.2464934Z 324 |                         break
2025-11-18T07:14:11.2464999Z 325 |                     
2025-11-18T07:14:11.2465064Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2465173Z 326 |                     # Valid jump found, check for multi-jumps
2025-11-18T07:14:11.2465278Z 327 |                     jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2465336Z     |
2025-11-18T07:14:11.2465420Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2465425Z 
2025-11-18T07:14:11.2465507Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2465606Z    --> app/services/checkers/game_engine.py:329:1
2025-11-18T07:14:11.2465664Z     |
2025-11-18T07:14:11.2465757Z 327 |                     jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2465891Z 328 |                     move = Move(row, col, land_row, land_col, [jump_pos])
2025-11-18T07:14:11.2465959Z 329 |                     
2025-11-18T07:14:11.2466022Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2466147Z 330 |                     # Try to find additional jumps from landing position
2025-11-18T07:14:11.2466270Z 331 |                     # Temporarily make the jump to check for multi-jumps
2025-11-18T07:14:11.2466327Z     |
2025-11-18T07:14:11.2466415Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2466421Z 
2025-11-18T07:14:11.2466499Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2466594Z    --> app/services/checkers/game_engine.py:336:1
2025-11-18T07:14:11.2466651Z     |
2025-11-18T07:14:11.2466741Z 334 |                     temp_board[row][col] = 0
2025-11-18T07:14:11.2466928Z 335 |                     temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2467098Z 336 |                     
2025-11-18T07:14:11.2467165Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2467259Z 337 |                     # Check for additional jumps
2025-11-18T07:14:11.2467386Z 338 |                     additional_jumps = self._get_jumps_from_recursive(
2025-11-18T07:14:11.2467558Z     |
2025-11-18T07:14:11.2467641Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2467646Z 
2025-11-18T07:14:11.2467724Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2467818Z    --> app/services/checkers/game_engine.py:341:1
2025-11-18T07:14:11.2467880Z     |
2025-11-18T07:14:11.2467986Z 339 |                         land_row, land_col, player, temp_board
2025-11-18T07:14:11.2468054Z 340 |                     )
2025-11-18T07:14:11.2468118Z 341 |                     
2025-11-18T07:14:11.2468180Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2468266Z 342 |                     if additional_jumps:
2025-11-18T07:14:11.2468368Z 343 |                         # Combine with multi-jumps
2025-11-18T07:14:11.2468425Z     |
2025-11-18T07:14:11.2468509Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2468515Z 
2025-11-18T07:14:11.2468595Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2468697Z    --> app/services/checkers/game_engine.py:349:1
2025-11-18T07:14:11.2468754Z     |
2025-11-18T07:14:11.2468822Z 347 |                     else:
2025-11-18T07:14:11.2468916Z 348 |                         jumps.append(move)
2025-11-18T07:14:11.2468978Z 349 |                     
2025-11-18T07:14:11.2469040Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2469244Z 350 |                     # In Ukrainian checkers, queen can only jump one piece at a time per direction
2025-11-18T07:14:11.2469400Z 351 |                     # Continue scanning to find other jumps in the same direction
2025-11-18T07:14:11.2469457Z     |
2025-11-18T07:14:11.2469541Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2469550Z 
2025-11-18T07:14:11.2469635Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2469731Z    --> app/services/checkers/game_engine.py:356:1
2025-11-18T07:14:11.2469790Z     |
2025-11-18T07:14:11.2469894Z 354 |                 jump_row, jump_col = row + dr, col + dc
2025-11-18T07:14:11.2470008Z 355 |                 land_row, land_col = row + 2 * dr, col + 2 * dc
2025-11-18T07:14:11.2470071Z 356 |                 
2025-11-18T07:14:11.2470136Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2470254Z 357 |                 if (self._is_valid_position(jump_row, jump_col) and
2025-11-18T07:14:11.2470366Z 358 |                     self._is_valid_position(land_row, land_col) and
2025-11-18T07:14:11.2470423Z     |
2025-11-18T07:14:11.2470509Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2470515Z 
2025-11-18T07:14:11.2470591Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2470685Z    --> app/services/checkers/game_engine.py:361:1
2025-11-18T07:14:11.2470749Z     |
2025-11-18T07:14:11.2470865Z 359 |                     self._is_playable_square(land_row, land_col) and
2025-11-18T07:14:11.2470968Z 360 |                     self.board[land_row][land_col] == 0):
2025-11-18T07:14:11.2471035Z 361 |                     
2025-11-18T07:14:11.2471097Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2471215Z 362 |                     jumped_piece = self.board[jump_row][jump_col]
2025-11-18T07:14:11.2471400Z 363 |                     if jumped_piece != 0 and not self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2471461Z     |
2025-11-18T07:14:11.2471547Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2471553Z 
2025-11-18T07:14:11.2471632Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2471734Z    --> app/services/checkers/game_engine.py:367:1
2025-11-18T07:14:11.2471791Z     |
2025-11-18T07:14:11.2471891Z 365 |                         jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2472021Z 366 |                         move = Move(row, col, land_row, land_col, [jump_pos])
2025-11-18T07:14:11.2472205Z 367 |                         
2025-11-18T07:14:11.2472269Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2472396Z 368 |                         # Try to find additional jumps from landing position
2025-11-18T07:14:11.2472526Z 369 |                         # Temporarily make the jump to check for multi-jumps
2025-11-18T07:14:11.2472658Z     |
2025-11-18T07:14:11.2472742Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2472749Z 
2025-11-18T07:14:11.2472828Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2472924Z    --> app/services/checkers/game_engine.py:374:1
2025-11-18T07:14:11.2472981Z     |
2025-11-18T07:14:11.2473076Z 372 |                         temp_board[row][col] = 0
2025-11-18T07:14:11.2473176Z 373 |                         temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2473241Z 374 |                         
2025-11-18T07:14:11.2473307Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2473407Z 375 |                         # Check for additional jumps
2025-11-18T07:14:11.2473532Z 376 |                         additional_jumps = self._get_jumps_from_recursive(
2025-11-18T07:14:11.2473589Z     |
2025-11-18T07:14:11.2473676Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2473681Z 
2025-11-18T07:14:11.2473764Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2473859Z    --> app/services/checkers/game_engine.py:379:1
2025-11-18T07:14:11.2473918Z     |
2025-11-18T07:14:11.2474025Z 377 |                             land_row, land_col, player, temp_board
2025-11-18T07:14:11.2474091Z 378 |                         )
2025-11-18T07:14:11.2474156Z 379 |                         
2025-11-18T07:14:11.2474219Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2474309Z 380 |                         if additional_jumps:
2025-11-18T07:14:11.2474407Z 381 |                             # Combine with multi-jumps
2025-11-18T07:14:11.2474467Z     |
2025-11-18T07:14:11.2474552Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2474562Z 
2025-11-18T07:14:11.2474640Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2474740Z    --> app/services/checkers/game_engine.py:387:1
2025-11-18T07:14:11.2474797Z     |
2025-11-18T07:14:11.2474864Z 385 |                         else:
2025-11-18T07:14:11.2474959Z 386 |                             jumps.append(move)
2025-11-18T07:14:11.2475023Z 387 |         
2025-11-18T07:14:11.2475081Z     | ^^^^^^^^
2025-11-18T07:14:11.2475148Z 388 |         return jumps
2025-11-18T07:14:11.2475206Z     |
2025-11-18T07:14:11.2475289Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2475295Z 
2025-11-18T07:14:11.2475371Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2475468Z    --> app/services/checkers/game_engine.py:389:1
2025-11-18T07:14:11.2475524Z     |
2025-11-18T07:14:11.2475590Z 388 |         return jumps
2025-11-18T07:14:11.2475649Z 389 |     
2025-11-18T07:14:11.2475711Z     | ^^^^
2025-11-18T07:14:11.2475981Z 390 |     def _get_jumps_from_recursive(self, row: int, col: int, player: Player, board: list[list[int]]) -> list[Move]:
2025-11-18T07:14:11.2476100Z 391 |         """Recursive helper for finding multi-jumps."""
2025-11-18T07:14:11.2476161Z     |
2025-11-18T07:14:11.2476245Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2476254Z 
2025-11-18T07:14:11.2476333Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2476428Z    --> app/services/checkers/game_engine.py:393:1
2025-11-18T07:14:11.2476485Z     |
2025-11-18T07:14:11.2476591Z 391 |         """Recursive helper for finding multi-jumps."""
2025-11-18T07:14:11.2476659Z 392 |         jumps = []
2025-11-18T07:14:11.2476722Z 393 |         
2025-11-18T07:14:11.2476780Z     | ^^^^^^^^
2025-11-18T07:14:11.2476893Z 394 |         directions = self._get_jump_directions(player)
2025-11-18T07:14:11.2477069Z 395 |         piece = board[row][col]
2025-11-18T07:14:11.2477129Z     |
2025-11-18T07:14:11.2477212Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2477335Z 
2025-11-18T07:14:11.2477415Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2477514Z    --> app/services/checkers/game_engine.py:397:1
2025-11-18T07:14:11.2477570Z     |
2025-11-18T07:14:11.2477646Z 395 |         piece = board[row][col]
2025-11-18T07:14:11.2477726Z 396 |         is_king = piece in (3, 4)
2025-11-18T07:14:11.2477891Z 397 |         
2025-11-18T07:14:11.2477949Z     | ^^^^^^^^
2025-11-18T07:14:11.2478027Z 398 |         for dr, dc in directions:
2025-11-18T07:14:11.2478101Z 399 |             if is_king:
2025-11-18T07:14:11.2478158Z     |
2025-11-18T07:14:11.2478240Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2478245Z 
2025-11-18T07:14:11.2478325Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2478418Z    --> app/services/checkers/game_engine.py:404:1
2025-11-18T07:14:11.2478475Z     |
2025-11-18T07:14:11.2478588Z 402 |                 for distance in range(1, self.BOARD_SIZE):
2025-11-18T07:14:11.2478734Z 403 |                     jump_row, jump_col = row + distance * dr, col + distance * dc
2025-11-18T07:14:11.2478803Z 404 |                     
2025-11-18T07:14:11.2478868Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2478983Z 405 |                     if not (0 <= jump_row < 8 and 0 <= jump_col < 8):
2025-11-18T07:14:11.2479050Z 406 |                         break
2025-11-18T07:14:11.2479110Z     |
2025-11-18T07:14:11.2479195Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2479201Z 
2025-11-18T07:14:11.2479278Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2479372Z    --> app/services/checkers/game_engine.py:409:1
2025-11-18T07:14:11.2479433Z     |
2025-11-18T07:14:11.2479525Z 407 |                     if (jump_row + jump_col) % 2 != 1:
2025-11-18T07:14:11.2479597Z 408 |                         continue
2025-11-18T07:14:11.2479658Z 409 |                     
2025-11-18T07:14:11.2479724Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2479830Z 410 |                     jumped_piece = board[jump_row][jump_col]
2025-11-18T07:14:11.2479923Z 411 |                     if jumped_piece == 0:
2025-11-18T07:14:11.2479983Z     |
2025-11-18T07:14:11.2480063Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2480069Z 
2025-11-18T07:14:11.2480146Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2480243Z    --> app/services/checkers/game_engine.py:414:1
2025-11-18T07:14:11.2480303Z     |
2025-11-18T07:14:11.2480398Z 412 |                         # Empty cell, continue scanning
2025-11-18T07:14:11.2480466Z 413 |                         continue
2025-11-18T07:14:11.2480531Z 414 |                     
2025-11-18T07:14:11.2480593Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2480709Z 415 |                     if self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2480820Z 416 |                         # Own piece, stop scanning in this direction
2025-11-18T07:14:11.2480876Z     |
2025-11-18T07:14:11.2480958Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2480964Z 
2025-11-18T07:14:11.2481047Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2481142Z    --> app/services/checkers/game_engine.py:418:1
2025-11-18T07:14:11.2481199Z     |
2025-11-18T07:14:11.2481303Z 416 |                         # Own piece, stop scanning in this direction
2025-11-18T07:14:11.2481371Z 417 |                         break
2025-11-18T07:14:11.2481435Z 418 |                     
2025-11-18T07:14:11.2481495Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2481637Z 419 |                     # Found opponent piece, check if landing square is empty
2025-11-18T07:14:11.2481753Z 420 |                     land_row, land_col = jump_row + dr, jump_col + dc
2025-11-18T07:14:11.2481810Z     |
2025-11-18T07:14:11.2481894Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2481900Z 
2025-11-18T07:14:11.2481977Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2482071Z    --> app/services/checkers/game_engine.py:421:1
2025-11-18T07:14:11.2482128Z     |
2025-11-18T07:14:11.2482261Z 419 |                     # Found opponent piece, check if landing square is empty
2025-11-18T07:14:11.2482459Z 420 |                     land_row, land_col = jump_row + dr, jump_col + dc
2025-11-18T07:14:11.2482522Z 421 |                     
2025-11-18T07:14:11.2482586Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2482689Z 422 |                     if not (0 <= land_row < 8 and 0 <= land_col < 8):
2025-11-18T07:14:11.2482826Z 423 |                         break
2025-11-18T07:14:11.2482885Z     |
2025-11-18T07:14:11.2482968Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2482974Z 
2025-11-18T07:14:11.2483051Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2483145Z    --> app/services/checkers/game_engine.py:429:1
2025-11-18T07:14:11.2483201Z     |
2025-11-18T07:14:11.2483305Z 427 |                         # Landing square is occupied, stop scanning
2025-11-18T07:14:11.2483369Z 428 |                         break
2025-11-18T07:14:11.2483434Z 429 |                     
2025-11-18T07:14:11.2483500Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2483608Z 430 |                     # Check that path to jumped piece is clear
2025-11-18T07:14:11.2483696Z 431 |                     path_clear = True
2025-11-18T07:14:11.2483754Z     |
2025-11-18T07:14:11.2483835Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2483854Z 
2025-11-18T07:14:11.2483951Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2484047Z    --> app/services/checkers/game_engine.py:438:1
2025-11-18T07:14:11.2484103Z     |
2025-11-18T07:14:11.2484192Z 436 |                             path_clear = False
2025-11-18T07:14:11.2484263Z 437 |                             break
2025-11-18T07:14:11.2484325Z 438 |                     
2025-11-18T07:14:11.2484388Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2484473Z 439 |                     if not path_clear:
2025-11-18T07:14:11.2484537Z 440 |                         break
2025-11-18T07:14:11.2484594Z     |
2025-11-18T07:14:11.2484675Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2484684Z 
2025-11-18T07:14:11.2484764Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2484859Z    --> app/services/checkers/game_engine.py:441:1
2025-11-18T07:14:11.2484915Z     |
2025-11-18T07:14:11.2484998Z 439 |                     if not path_clear:
2025-11-18T07:14:11.2485063Z 440 |                         break
2025-11-18T07:14:11.2485130Z 441 |                     
2025-11-18T07:14:11.2485191Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2485290Z 442 |                     jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2485415Z 443 |                     move = Move(row, col, land_row, land_col, [jump_pos])
2025-11-18T07:14:11.2485471Z     |
2025-11-18T07:14:11.2485556Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2485562Z 
2025-11-18T07:14:11.2485640Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2485735Z    --> app/services/checkers/game_engine.py:444:1
2025-11-18T07:14:11.2485794Z     |
2025-11-18T07:14:11.2485886Z 442 |                     jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2486008Z 443 |                     move = Move(row, col, land_row, land_col, [jump_pos])
2025-11-18T07:14:11.2486075Z 444 |                     
2025-11-18T07:14:11.2486137Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2486220Z 445 |                     # Continue multi-jump
2025-11-18T07:14:11.2486319Z 446 |                     temp_board = [r[:] for r in board]
2025-11-18T07:14:11.2486378Z     |
2025-11-18T07:14:11.2486461Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2486466Z 
2025-11-18T07:14:11.2486543Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2486643Z    --> app/services/checkers/game_engine.py:450:1
2025-11-18T07:14:11.2486699Z     |
2025-11-18T07:14:11.2486784Z 448 |                     temp_board[row][col] = 0
2025-11-18T07:14:11.2486879Z 449 |                     temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2487037Z 450 |                     
2025-11-18T07:14:11.2487102Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2487438Z 451 |                     additional = self._get_jumps_from_recursive(land_row, land_col, player, temp_board)
2025-11-18T07:14:11.2487520Z 452 |                     if additional:
2025-11-18T07:14:11.2487577Z     |
2025-11-18T07:14:11.2487658Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2487763Z 
2025-11-18T07:14:11.2487844Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2487939Z    --> app/services/checkers/game_engine.py:458:1
2025-11-18T07:14:11.2487995Z     |
2025-11-18T07:14:11.2488060Z 456 |                     else:
2025-11-18T07:14:11.2488150Z 457 |                         jumps.append(move)
2025-11-18T07:14:11.2488212Z 458 |                     
2025-11-18T07:14:11.2488272Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2488473Z 459 |                     # In Ukrainian checkers, queen can only jump one piece at a time per direction
2025-11-18T07:14:11.2488626Z 460 |                     # Continue scanning to find other jumps in the same direction
2025-11-18T07:14:11.2488687Z     |
2025-11-18T07:14:11.2488774Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2488779Z 
2025-11-18T07:14:11.2488856Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2488950Z    --> app/services/checkers/game_engine.py:465:1
2025-11-18T07:14:11.2489011Z     |
2025-11-18T07:14:11.2489113Z 463 |                 jump_row, jump_col = row + dr, col + dc
2025-11-18T07:14:11.2489225Z 464 |                 land_row, land_col = row + 2 * dr, col + 2 * dc
2025-11-18T07:14:11.2489288Z 465 |                 
2025-11-18T07:14:11.2489354Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2489458Z 466 |                 if (0 <= jump_row < 8 and 0 <= jump_col < 8 and
2025-11-18T07:14:11.2489552Z 467 |                     0 <= land_row < 8 and 0 <= land_col < 8 and
2025-11-18T07:14:11.2489615Z     |
2025-11-18T07:14:11.2489698Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2489704Z 
2025-11-18T07:14:11.2489782Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2489886Z    --> app/services/checkers/game_engine.py:470:1
2025-11-18T07:14:11.2489943Z     |
2025-11-18T07:14:11.2490034Z 468 |                     (land_row + land_col) % 2 == 1 and
2025-11-18T07:14:11.2490129Z 469 |                     board[land_row][land_col] == 0):
2025-11-18T07:14:11.2490195Z 470 |                     
2025-11-18T07:14:11.2490261Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2490368Z 471 |                     jumped_piece = board[jump_row][jump_col]
2025-11-18T07:14:11.2490551Z 472 |                     if jumped_piece != 0 and not self._is_player_piece(jumped_piece, player):
2025-11-18T07:14:11.2490609Z     |
2025-11-18T07:14:11.2490692Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2490698Z 
2025-11-18T07:14:11.2490777Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2490872Z    --> app/services/checkers/game_engine.py:475:1
2025-11-18T07:14:11.2490927Z     |
2025-11-18T07:14:11.2491021Z 473 |                         jump_pos = (jump_row, jump_col)
2025-11-18T07:14:11.2491154Z 474 |                         move = Move(row, col, land_row, land_col, [jump_pos])
2025-11-18T07:14:11.2491221Z 475 |                         
2025-11-18T07:14:11.2491285Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2491377Z 476 |                         # Continue multi-jump
2025-11-18T07:14:11.2491478Z 477 |                         temp_board = [r[:] for r in board]
2025-11-18T07:14:11.2491535Z     |
2025-11-18T07:14:11.2491620Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2491627Z 
2025-11-18T07:14:11.2491704Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2491796Z    --> app/services/checkers/game_engine.py:481:1
2025-11-18T07:14:11.2491851Z     |
2025-11-18T07:14:11.2491946Z 479 |                         temp_board[row][col] = 0
2025-11-18T07:14:11.2492044Z 480 |                         temp_board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2492109Z 481 |                         
2025-11-18T07:14:11.2492175Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2492473Z 482 |                         additional = self._get_jumps_from_recursive(land_row, land_col, player, temp_board)
2025-11-18T07:14:11.2492554Z 483 |                         if additional:
2025-11-18T07:14:11.2492614Z     |
2025-11-18T07:14:11.2492697Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2492774Z 
2025-11-18T07:14:11.2492853Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2492946Z    --> app/services/checkers/game_engine.py:489:1
2025-11-18T07:14:11.2493007Z     |
2025-11-18T07:14:11.2493072Z 487 |                         else:
2025-11-18T07:14:11.2493161Z 488 |                             jumps.append(move)
2025-11-18T07:14:11.2493221Z 489 |         
2025-11-18T07:14:11.2493279Z     | ^^^^^^^^
2025-11-18T07:14:11.2493346Z 490 |         return jumps
2025-11-18T07:14:11.2493403Z     |
2025-11-18T07:14:11.2493489Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2493494Z 
2025-11-18T07:14:11.2493572Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2493674Z    --> app/services/checkers/game_engine.py:491:1
2025-11-18T07:14:11.2493734Z     |
2025-11-18T07:14:11.2493799Z 490 |         return jumps
2025-11-18T07:14:11.2493858Z 491 |     
2025-11-18T07:14:11.2493918Z     | ^^^^
2025-11-18T07:14:11.2494059Z 492 |     def is_valid_move(self, move: Move, player: Player) -> bool:
2025-11-18T07:14:11.2494184Z 493 |         """Check if a move is valid for the current player."""
2025-11-18T07:14:11.2494243Z     |
2025-11-18T07:14:11.2494329Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2494335Z 
2025-11-18T07:14:11.2494411Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2494505Z    --> app/services/checkers/game_engine.py:497:1
2025-11-18T07:14:11.2494564Z     |
2025-11-18T07:14:11.2494639Z 495 |         if matching_move is None:
2025-11-18T07:14:11.2494706Z 496 |             return False
2025-11-18T07:14:11.2494767Z 497 |         
2025-11-18T07:14:11.2494825Z     | ^^^^^^^^
2025-11-18T07:14:11.2494923Z 498 |         if move.jumps != matching_move.jumps:
2025-11-18T07:14:11.2494989Z 499 |             return False
2025-11-18T07:14:11.2495049Z     |
2025-11-18T07:14:11.2495130Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2495135Z 
2025-11-18T07:14:11.2495211Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2495310Z    --> app/services/checkers/game_engine.py:500:1
2025-11-18T07:14:11.2495368Z     |
2025-11-18T07:14:11.2495458Z 498 |         if move.jumps != matching_move.jumps:
2025-11-18T07:14:11.2495524Z 499 |             return False
2025-11-18T07:14:11.2495584Z 500 |         
2025-11-18T07:14:11.2495641Z     | ^^^^^^^^
2025-11-18T07:14:11.2495773Z 501 |         return self._validate_move_path(matching_move, player)
2025-11-18T07:14:11.2495831Z     |
2025-11-18T07:14:11.2495914Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2495921Z 
2025-11-18T07:14:11.2495998Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2496094Z    --> app/services/checkers/game_engine.py:502:1
2025-11-18T07:14:11.2496155Z     |
2025-11-18T07:14:11.2496279Z 501 |         return self._validate_move_path(matching_move, player)
2025-11-18T07:14:11.2496336Z 502 |     
2025-11-18T07:14:11.2496396Z     | ^^^^
2025-11-18T07:14:11.2496526Z 503 |     def make_move(self, move: Move, player: Player) -> bool:
2025-11-18T07:14:11.2496667Z 504 |         """Execute a move. Returns True if move was successful."""
2025-11-18T07:14:11.2496726Z     |
2025-11-18T07:14:11.2496808Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2496813Z 
2025-11-18T07:14:11.2496890Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2497128Z    --> app/services/checkers/game_engine.py:508:1
2025-11-18T07:14:11.2497189Z     |
2025-11-18T07:14:11.2497264Z 506 |         if matching_move is None:
2025-11-18T07:14:11.2497332Z 507 |             return False
2025-11-18T07:14:11.2497393Z 508 |         
2025-11-18T07:14:11.2497451Z     | ^^^^^^^^
2025-11-18T07:14:11.2497541Z 509 |         if move.jumps != matching_move.jumps:
2025-11-18T07:14:11.2497729Z 510 |             return False
2025-11-18T07:14:11.2497785Z     |
2025-11-18T07:14:11.2497866Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2497871Z 
2025-11-18T07:14:11.2497947Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2498044Z    --> app/services/checkers/game_engine.py:511:1
2025-11-18T07:14:11.2498201Z     |
2025-11-18T07:14:11.2498290Z 509 |         if move.jumps != matching_move.jumps:
2025-11-18T07:14:11.2498359Z 510 |             return False
2025-11-18T07:14:11.2498418Z 511 |         
2025-11-18T07:14:11.2498475Z     | ^^^^^^^^
2025-11-18T07:14:11.2498602Z 512 |         if not self._validate_move_path(matching_move, player):
2025-11-18T07:14:11.2498668Z 513 |             return False
2025-11-18T07:14:11.2498724Z     |
2025-11-18T07:14:11.2498805Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2498811Z 
2025-11-18T07:14:11.2498891Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2498984Z    --> app/services/checkers/game_engine.py:514:1
2025-11-18T07:14:11.2499045Z     |
2025-11-18T07:14:11.2499172Z 512 |         if not self._validate_move_path(matching_move, player):
2025-11-18T07:14:11.2499238Z 513 |             return False
2025-11-18T07:14:11.2499295Z 514 |         
2025-11-18T07:14:11.2499352Z     | ^^^^^^^^
2025-11-18T07:14:11.2499521Z 515 |         piece = self.board[matching_move.from_row][matching_move.from_col]
2025-11-18T07:14:11.2499578Z     |
2025-11-18T07:14:11.2499659Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2499664Z 
2025-11-18T07:14:11.2499743Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2499835Z    --> app/services/checkers/game_engine.py:516:1
2025-11-18T07:14:11.2499890Z     |
2025-11-18T07:14:11.2500046Z 515 |         piece = self.board[matching_move.from_row][matching_move.from_col]
2025-11-18T07:14:11.2500104Z 516 |         
2025-11-18T07:14:11.2500163Z     | ^^^^^^^^
2025-11-18T07:14:11.2500231Z 517 |         # Move piece
2025-11-18T07:14:11.2500391Z 518 |         self.board[matching_move.to_row][matching_move.to_col] = piece
2025-11-18T07:14:11.2500448Z     |
2025-11-18T07:14:11.2500532Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2500537Z 
2025-11-18T07:14:11.2500617Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2500710Z    --> app/services/checkers/game_engine.py:520:1
2025-11-18T07:14:11.2500769Z     |
2025-11-18T07:14:11.2500918Z 518 |         self.board[matching_move.to_row][matching_move.to_col] = piece
2025-11-18T07:14:11.2501061Z 519 |         self.board[matching_move.from_row][matching_move.from_col] = 0
2025-11-18T07:14:11.2501119Z 520 |         
2025-11-18T07:14:11.2501179Z     | ^^^^^^^^
2025-11-18T07:14:11.2501259Z 521 |         # Remove jumped pieces
2025-11-18T07:14:11.2501372Z 522 |         for jump_row, jump_col in matching_move.jumps:
2025-11-18T07:14:11.2501428Z     |
2025-11-18T07:14:11.2501515Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2501520Z 
2025-11-18T07:14:11.2501600Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2501693Z    --> app/services/checkers/game_engine.py:524:1
2025-11-18T07:14:11.2501755Z     |
2025-11-18T07:14:11.2501865Z 522 |         for jump_row, jump_col in matching_move.jumps:
2025-11-18T07:14:11.2501962Z 523 |             self.board[jump_row][jump_col] = 0
2025-11-18T07:14:11.2502023Z 524 |         
2025-11-18T07:14:11.2502083Z     | ^^^^^^^^
2025-11-18T07:14:11.2502166Z 525 |         # Check for king promotion
2025-11-18T07:14:11.2502322Z 526 |         if player == 1 and matching_move.to_row == 7:  # Black reaches bottom
2025-11-18T07:14:11.2502385Z     |
2025-11-18T07:14:11.2502469Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2502475Z 
2025-11-18T07:14:11.2502551Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2502649Z    --> app/services/checkers/game_engine.py:532:1
2025-11-18T07:14:11.2502706Z     |
2025-11-18T07:14:11.2502778Z 530 |             if piece == 2:
2025-11-18T07:14:11.2502973Z 531 |                 self.board[matching_move.to_row][matching_move.to_col] = 4  # Promote to king
2025-11-18T07:14:11.2503161Z 532 |         
2025-11-18T07:14:11.2503221Z     | ^^^^^^^^
2025-11-18T07:14:11.2503290Z 533 |         return True
2025-11-18T07:14:11.2503349Z     |
2025-11-18T07:14:11.2503433Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2503509Z 
2025-11-18T07:14:11.2503589Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2503683Z    --> app/services/checkers/game_engine.py:534:1
2025-11-18T07:14:11.2503743Z     |
2025-11-18T07:14:11.2503810Z 533 |         return True
2025-11-18T07:14:11.2503868Z 534 |     
2025-11-18T07:14:11.2503928Z     | ^^^^
2025-11-18T07:14:11.2504060Z 535 |     def check_game_over(self) -> tuple[bool, Player | None]:
2025-11-18T07:14:11.2504180Z 536 |         """Check if game is over. Returns (is_over, winner)."""
2025-11-18T07:14:11.2504240Z     |
2025-11-18T07:14:11.2504323Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2504329Z 
2025-11-18T07:14:11.2504411Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2504505Z    --> app/services/checkers/game_engine.py:539:1
2025-11-18T07:14:11.2504565Z     |
2025-11-18T07:14:11.2504664Z 537 |         player1_moves = self.get_valid_moves(1)
2025-11-18T07:14:11.2504759Z 538 |         player2_moves = self.get_valid_moves(2)
2025-11-18T07:14:11.2504824Z 539 |         
2025-11-18T07:14:11.2504882Z     | ^^^^^^^^
2025-11-18T07:14:11.2504972Z 540 |         # Check if players have pieces
2025-11-18T07:14:11.2505172Z 541 |         player1_pieces = sum(1 for row in self.board for cell in row if cell in (1, 3))
2025-11-18T07:14:11.2505229Z     |
2025-11-18T07:14:11.2505313Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2505319Z 
2025-11-18T07:14:11.2505396Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2505495Z    --> app/services/checkers/game_engine.py:543:1
2025-11-18T07:14:11.2505553Z     |
2025-11-18T07:14:11.2505733Z 541 |         player1_pieces = sum(1 for row in self.board for cell in row if cell in (1, 3))
2025-11-18T07:14:11.2505916Z 542 |         player2_pieces = sum(1 for row in self.board for cell in row if cell in (2, 4))
2025-11-18T07:14:11.2505975Z 543 |         
2025-11-18T07:14:11.2506032Z     | ^^^^^^^^
2025-11-18T07:14:11.2506114Z 544 |         if player1_pieces == 0:
2025-11-18T07:14:11.2506208Z 545 |             return (True, 2)  # Player 2 wins
2025-11-18T07:14:11.2506265Z     |
2025-11-18T07:14:11.2506348Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2506354Z 
2025-11-18T07:14:11.2506433Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2506525Z    --> app/services/checkers/game_engine.py:548:1
2025-11-18T07:14:11.2506581Z     |
2025-11-18T07:14:11.2506660Z 546 |         if player2_pieces == 0:
2025-11-18T07:14:11.2506747Z 547 |             return (True, 1)  # Player 1 wins
2025-11-18T07:14:11.2506804Z 548 |         
2025-11-18T07:14:11.2506860Z     | ^^^^^^^^
2025-11-18T07:14:11.2506936Z 549 |         if not player1_moves:
2025-11-18T07:14:11.2507283Z 550 |             return (True, 2)  # Player 1 has no moves
2025-11-18T07:14:11.2507340Z     |
2025-11-18T07:14:11.2507427Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2507433Z 
2025-11-18T07:14:11.2507509Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2507602Z    --> app/services/checkers/game_engine.py:553:1
2025-11-18T07:14:11.2507667Z     |
2025-11-18T07:14:11.2507738Z 551 |         if not player2_moves:
2025-11-18T07:14:11.2507833Z 552 |             return (True, 1)  # Player 2 has no moves
2025-11-18T07:14:11.2507893Z 553 |         
2025-11-18T07:14:11.2507951Z     | ^^^^^^^^
2025-11-18T07:14:11.2508024Z 554 |         return (False, None)
2025-11-18T07:14:11.2508080Z     |
2025-11-18T07:14:11.2508165Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2508171Z 
2025-11-18T07:14:11.2508246Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2508339Z    --> app/services/checkers/game_engine.py:555:1
2025-11-18T07:14:11.2508399Z     |
2025-11-18T07:14:11.2508594Z 554 |         return (False, None)
2025-11-18T07:14:11.2508653Z 555 |     
2025-11-18T07:14:11.2508710Z     | ^^^^
2025-11-18T07:14:11.2508788Z 556 |     def to_dict(self) -> dict:
2025-11-18T07:14:11.2508897Z 557 |         """Serialize game state to dictionary."""
2025-11-18T07:14:11.2508952Z     |
2025-11-18T07:14:11.2509150Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2509156Z 
2025-11-18T07:14:11.2509233Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2509328Z    --> app/services/checkers/game_engine.py:561:1
2025-11-18T07:14:11.2509384Z     |
2025-11-18T07:14:11.2509460Z 559 |             "board": self.board
2025-11-18T07:14:11.2509519Z 560 |         }
2025-11-18T07:14:11.2509574Z 561 |     
2025-11-18T07:14:11.2509633Z     | ^^^^
2025-11-18T07:14:11.2509698Z 562 |     @classmethod
2025-11-18T07:14:11.2509812Z 563 |     def from_dict(cls, data: dict) -> CheckersGame:
2025-11-18T07:14:11.2509870Z     |
2025-11-18T07:14:11.2509958Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2509967Z 
2025-11-18T07:14:11.2510045Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2510147Z    --> app/services/checkers/game_engine.py:569:1
2025-11-18T07:14:11.2510208Z     |
2025-11-18T07:14:11.2510277Z 567 |             return cls()
2025-11-18T07:14:11.2510349Z 568 |         return cls(board)
2025-11-18T07:14:11.2510411Z 569 |     
2025-11-18T07:14:11.2510470Z     | ^^^^
2025-11-18T07:14:11.2510545Z 570 |     def to_json(self) -> str:
2025-11-18T07:14:11.2510649Z 571 |         """Serialize game state to JSON string."""
2025-11-18T07:14:11.2510709Z     |
2025-11-18T07:14:11.2510793Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2510798Z 
2025-11-18T07:14:11.2510879Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2510976Z    --> app/services/checkers/game_engine.py:573:1
2025-11-18T07:14:11.2511033Z     |
2025-11-18T07:14:11.2511131Z 571 |         """Serialize game state to JSON string."""
2025-11-18T07:14:11.2511225Z 572 |         return json.dumps(self.to_dict())
2025-11-18T07:14:11.2511286Z 573 |     
2025-11-18T07:14:11.2511343Z     | ^^^^
2025-11-18T07:14:11.2511407Z 574 |     @classmethod
2025-11-18T07:14:11.2511529Z 575 |     def from_json(cls, json_str: str) -> CheckersGame:
2025-11-18T07:14:11.2511586Z     |
2025-11-18T07:14:11.2511669Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2511677Z 
2025-11-18T07:14:11.2511784Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2511882Z   --> app/services/checkers/game_store.py:3:1
2025-11-18T07:14:11.2511940Z    |
2025-11-18T07:14:11.2512042Z  1 |   """Database operations for checkers games."""
2025-11-18T07:14:11.2512102Z  2 |
2025-11-18T07:14:11.2512187Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.2512247Z  4 | |
2025-11-18T07:14:11.2512319Z  5 | | import logging
2025-11-18T07:14:11.2512384Z  6 | | import time
2025-11-18T07:14:11.2512463Z  7 | | from typing import Literal
2025-11-18T07:14:11.2512527Z  8 | | import uuid
2025-11-18T07:14:11.2512591Z  9 | |
2025-11-18T07:14:11.2512734Z 10 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2512830Z    | |_________________________________________________________^
2025-11-18T07:14:11.2512892Z 11 |
2025-11-18T07:14:11.2512981Z 12 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2513042Z    |
2025-11-18T07:14:11.2513116Z help: Organize imports
2025-11-18T07:14:11.2513122Z 
2025-11-18T07:14:11.2513203Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2513302Z   --> app/services/checkers/game_store.py:19:1
2025-11-18T07:14:11.2513359Z    |
2025-11-18T07:14:11.2513440Z 17 | class CheckersGameStore:
2025-11-18T07:14:11.2513543Z 18 |     """Database operations for checkers games."""
2025-11-18T07:14:11.2513602Z 19 |     
2025-11-18T07:14:11.2513663Z    | ^^^^
2025-11-18T07:14:11.2513756Z 20 |     def __init__(self, database_url: str):
2025-11-18T07:14:11.2513860Z 21 |         """Initialize game store with database URL."""
2025-11-18T07:14:11.2514005Z    |
2025-11-18T07:14:11.2514096Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2514102Z 
2025-11-18T07:14:11.2514179Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2514276Z   --> app/services/checkers/game_store.py:23:1
2025-11-18T07:14:11.2514335Z    |
2025-11-18T07:14:11.2514434Z 21 |         """Initialize game store with database URL."""
2025-11-18T07:14:11.2514599Z 22 |         self.database_url = database_url
2025-11-18T07:14:11.2514662Z 23 |     
2025-11-18T07:14:11.2514718Z    | ^^^^
2025-11-18T07:14:11.2514797Z 24 |     async def create_challenge(
2025-11-18T07:14:11.2514858Z 25 |         self,
2025-11-18T07:14:11.2514917Z    |
2025-11-18T07:14:11.2515001Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2515007Z 
2025-11-18T07:14:11.2515079Z W291 Trailing whitespace
2025-11-18T07:14:11.2515177Z   --> app/services/checkers/game_store.py:37:43
2025-11-18T07:14:11.2515234Z    |
2025-11-18T07:14:11.2515306Z 35 |             await conn.execute(
2025-11-18T07:14:11.2515374Z 36 |                 """
2025-11-18T07:14:11.2515463Z 37 |                 INSERT INTO checkers_games 
2025-11-18T07:14:11.2515534Z    |                                           ^
2025-11-18T07:14:11.2515690Z 38 |                 (id, chat_id, thread_id, challenger_id, opponent_id, current_player,
2025-11-18T07:14:11.2515880Z 39 |                  game_state, game_status, winner_id, challenge_message_id, board_message_id,
2025-11-18T07:14:11.2515938Z    |
2025-11-18T07:14:11.2516020Z help: Remove trailing whitespace
2025-11-18T07:14:11.2516026Z 
2025-11-18T07:14:11.2516108Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2516201Z   --> app/services/checkers/game_store.py:53:1
2025-11-18T07:14:11.2516259Z    |
2025-11-18T07:14:11.2516459Z 51 |         logger.info(f"Created pending checkers challenge {game_id} in chat {chat_id}")
2025-11-18T07:14:11.2516533Z 52 |         return game_id
2025-11-18T07:14:11.2516591Z 53 |     
2025-11-18T07:14:11.2516648Z    | ^^^^
2025-11-18T07:14:11.2516841Z 54 |     async def set_challenge_message(self, game_id: str, message_id: int) -> None:
2025-11-18T07:14:11.2517087Z 55 |         """Store Telegram message ID for a challenge announcement."""
2025-11-18T07:14:11.2517145Z    |
2025-11-18T07:14:11.2517231Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2517241Z 
2025-11-18T07:14:11.2517320Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2517418Z    --> app/services/checkers/game_store.py:150:1
2025-11-18T07:14:11.2517476Z     |
2025-11-18T07:14:11.2517644Z 148 |         logger.info(f"Challenge {game_id} accepted by user {opponent_id}")
2025-11-18T07:14:11.2517713Z 149 |         return True
2025-11-18T07:14:11.2517771Z 150 |     
2025-11-18T07:14:11.2517833Z     | ^^^^
2025-11-18T07:14:11.2517960Z 151 |     async def get_game(self, game_id: str) -> dict | None:
2025-11-18T07:14:11.2518070Z 152 |         """Get game by ID. Returns None if not found."""
2025-11-18T07:14:11.2518129Z     |
2025-11-18T07:14:11.2518214Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2518224Z 
2025-11-18T07:14:11.2518302Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2518395Z    --> app/services/checkers/game_store.py:164:1
2025-11-18T07:14:11.2518454Z     |
2025-11-18T07:14:11.2518521Z 162 |                 game_id,
2025-11-18T07:14:11.2518580Z 163 |             )
2025-11-18T07:14:11.2518645Z 164 |             
2025-11-18T07:14:11.2518704Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2518771Z 165 |             if not row:
2025-11-18T07:14:11.2518842Z 166 |                 return None
2025-11-18T07:14:11.2518901Z     |
2025-11-18T07:14:11.2518983Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2518989Z 
2025-11-18T07:14:11.2519065Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2519161Z    --> app/services/checkers/game_store.py:167:1
2025-11-18T07:14:11.2519219Z     |
2025-11-18T07:14:11.2519285Z 165 |             if not row:
2025-11-18T07:14:11.2519357Z 166 |                 return None
2025-11-18T07:14:11.2519536Z 167 |             
2025-11-18T07:14:11.2519597Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2519662Z 168 |             return {
2025-11-18T07:14:11.2519739Z 169 |                 "id": row["id"],
2025-11-18T07:14:11.2519796Z     |
2025-11-18T07:14:11.2519879Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2519984Z 
2025-11-18T07:14:11.2520070Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2520166Z    --> app/services/checkers/game_store.py:183:1
2025-11-18T07:14:11.2520222Z     |
2025-11-18T07:14:11.2520319Z 181 |                 "updated_at": row["updated_at"],
2025-11-18T07:14:11.2520382Z 182 |             }
2025-11-18T07:14:11.2520440Z 183 |     
2025-11-18T07:14:11.2520498Z     | ^^^^
2025-11-18T07:14:11.2520576Z 184 |     async def get_open_game(
2025-11-18T07:14:11.2520704Z 185 |         self, chat_id: int, thread_id: int | None, user_id: int
2025-11-18T07:14:11.2520760Z     |
2025-11-18T07:14:11.2520845Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2520851Z 
2025-11-18T07:14:11.2520927Z W291 Trailing whitespace
2025-11-18T07:14:11.2521025Z    --> app/services/checkers/game_store.py:195:35
2025-11-18T07:14:11.2521085Z     |
2025-11-18T07:14:11.2521193Z 193 |                        board_message_id, created_at, updated_at
2025-11-18T07:14:11.2521273Z 194 |                 FROM checkers_games
2025-11-18T07:14:11.2521352Z 195 |                 WHERE chat_id = $1 
2025-11-18T07:14:11.2521424Z     |                                   ^
2025-11-18T07:14:11.2521559Z 196 |                   AND (thread_id = $2 OR (thread_id IS NULL AND $2 IS NULL))
2025-11-18T07:14:11.2521664Z 197 |                   AND game_status IN ('pending', 'active')
2025-11-18T07:14:11.2521723Z     |
2025-11-18T07:14:11.2521805Z help: Remove trailing whitespace
2025-11-18T07:14:11.2521811Z 
2025-11-18T07:14:11.2521890Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2521984Z    --> app/services/checkers/game_store.py:206:1
2025-11-18T07:14:11.2522044Z     |
2025-11-18T07:14:11.2522110Z 204 |                 user_id,
2025-11-18T07:14:11.2522174Z 205 |             )
2025-11-18T07:14:11.2522234Z 206 |             
2025-11-18T07:14:11.2522293Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2522361Z 207 |             if not row:
2025-11-18T07:14:11.2522430Z 208 |                 return None
2025-11-18T07:14:11.2522492Z     |
2025-11-18T07:14:11.2522576Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2522581Z 
2025-11-18T07:14:11.2522658Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2522754Z    --> app/services/checkers/game_store.py:209:1
2025-11-18T07:14:11.2522812Z     |
2025-11-18T07:14:11.2522877Z 207 |             if not row:
2025-11-18T07:14:11.2522947Z 208 |                 return None
2025-11-18T07:14:11.2523006Z 209 |             
2025-11-18T07:14:11.2523065Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2523129Z 210 |             return {
2025-11-18T07:14:11.2523203Z 211 |                 "id": row["id"],
2025-11-18T07:14:11.2523260Z     |
2025-11-18T07:14:11.2523341Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2523350Z 
2025-11-18T07:14:11.2523429Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2523519Z    --> app/services/checkers/game_store.py:225:1
2025-11-18T07:14:11.2523577Z     |
2025-11-18T07:14:11.2523674Z 223 |                 "updated_at": row["updated_at"],
2025-11-18T07:14:11.2523741Z 224 |             }
2025-11-18T07:14:11.2523798Z 225 |     
2025-11-18T07:14:11.2523855Z     | ^^^^
2025-11-18T07:14:11.2523933Z 226 |     async def update_game(
2025-11-18T07:14:11.2523994Z 227 |         self,
2025-11-18T07:14:11.2524051Z     |
2025-11-18T07:14:11.2524138Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2524143Z 
2025-11-18T07:14:11.2524221Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2524311Z    --> app/services/checkers/game_store.py:237:1
2025-11-18T07:14:11.2524367Z     |
2025-11-18T07:14:11.2524445Z 235 |         """Update game state."""
2025-11-18T07:14:11.2524534Z 236 |         current_time = int(time.time())
2025-11-18T07:14:11.2524682Z 237 |         
2025-11-18T07:14:11.2524751Z     | ^^^^^^^^
2025-11-18T07:14:11.2524916Z 238 |         updates = ["updated_at = $2", "game_state = $3", "current_player = $4"]
2025-11-18T07:14:11.2525070Z 239 |         params = [game_id, current_time, game_state_json, current_player]
2025-11-18T07:14:11.2525205Z     |
2025-11-18T07:14:11.2525288Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2525294Z 
2025-11-18T07:14:11.2525370Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2525463Z    --> app/services/checkers/game_store.py:241:1
2025-11-18T07:14:11.2525522Z     |
2025-11-18T07:14:11.2525666Z 239 |         params = [game_id, current_time, game_state_json, current_player]
2025-11-18T07:14:11.2525736Z 240 |         param_index = 5
2025-11-18T07:14:11.2525797Z 241 |         
2025-11-18T07:14:11.2525854Z     | ^^^^^^^^
2025-11-18T07:14:11.2525919Z 242 |         if game_status:
2025-11-18T07:14:11.2526041Z 243 |             updates.append(f"game_status = ${param_index}")
2025-11-18T07:14:11.2526106Z     |
2025-11-18T07:14:11.2526189Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2526194Z 
2025-11-18T07:14:11.2526271Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2526365Z    --> app/services/checkers/game_store.py:246:1
2025-11-18T07:14:11.2526425Z     |
2025-11-18T07:14:11.2526513Z 244 |             params.append(game_status)
2025-11-18T07:14:11.2526589Z 245 |             param_index += 1
2025-11-18T07:14:11.2526647Z 246 |         
2025-11-18T07:14:11.2526704Z     | ^^^^^^^^
2025-11-18T07:14:11.2526778Z 247 |         if winner_id is not None:
2025-11-18T07:14:11.2526898Z 248 |             updates.append(f"winner_id = ${param_index}")
2025-11-18T07:14:11.2527051Z     |
2025-11-18T07:14:11.2527136Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2527142Z 
2025-11-18T07:14:11.2527224Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2527318Z    --> app/services/checkers/game_store.py:251:1
2025-11-18T07:14:11.2527380Z     |
2025-11-18T07:14:11.2527468Z 249 |             params.append(winner_id)
2025-11-18T07:14:11.2527541Z 250 |             param_index += 1
2025-11-18T07:14:11.2527601Z 251 |         
2025-11-18T07:14:11.2527660Z     | ^^^^^^^^
2025-11-18T07:14:11.2527755Z 252 |         if board_message_id is not None:
2025-11-18T07:14:11.2527888Z 253 |             updates.append(f"board_message_id = ${param_index}")
2025-11-18T07:14:11.2527948Z     |
2025-11-18T07:14:11.2528035Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2528041Z 
2025-11-18T07:14:11.2528117Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2528209Z    --> app/services/checkers/game_store.py:256:1
2025-11-18T07:14:11.2528267Z     |
2025-11-18T07:14:11.2528362Z 254 |             params.append(board_message_id)
2025-11-18T07:14:11.2528431Z 255 |             param_index += 1
2025-11-18T07:14:11.2528488Z 256 |         
2025-11-18T07:14:11.2528547Z     | ^^^^^^^^
2025-11-18T07:14:11.2528680Z 257 |         async with get_db_connection(self.database_url) as conn:
2025-11-18T07:14:11.2528761Z 258 |             await conn.execute(
2025-11-18T07:14:11.2528820Z     |
2025-11-18T07:14:11.2528903Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2528908Z 
2025-11-18T07:14:11.2528985Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2529080Z    --> app/services/checkers/game_store.py:266:1
2025-11-18T07:14:11.2529141Z     |
2025-11-18T07:14:11.2529209Z 264 |                 *params,
2025-11-18T07:14:11.2529268Z 265 |             )
2025-11-18T07:14:11.2529330Z 266 |         
2025-11-18T07:14:11.2529387Z     | ^^^^^^^^
2025-11-18T07:14:11.2529508Z 267 |         logger.debug(f"Updated checkers game {game_id}")
2025-11-18T07:14:11.2529566Z     |
2025-11-18T07:14:11.2529652Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2529658Z 
2025-11-18T07:14:11.2529734Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2529824Z    --> app/services/checkers/game_store.py:268:1
2025-11-18T07:14:11.2529883Z     |
2025-11-18T07:14:11.2530121Z 267 |         logger.debug(f"Updated checkers game {game_id}")
2025-11-18T07:14:11.2530181Z 268 |     
2025-11-18T07:14:11.2530243Z     | ^^^^
2025-11-18T07:14:11.2530320Z 269 |     async def get_user_games(
2025-11-18T07:14:11.2530478Z 270 |         self, user_id: int, status: GameStatus | None = None, limit: int = 10
2025-11-18T07:14:11.2530637Z     |
2025-11-18T07:14:11.2530724Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2530729Z 
2025-11-18T07:14:11.2530804Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2530896Z    --> app/services/checkers/game_store.py:304:1
2025-11-18T07:14:11.2530955Z     |
2025-11-18T07:14:11.2531021Z 302 |                     limit,
2025-11-18T07:14:11.2531083Z 303 |                 )
2025-11-18T07:14:11.2531147Z 304 |             
2025-11-18T07:14:11.2531205Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2531271Z 305 |             return [
2025-11-18T07:14:11.2531331Z 306 |                 {
2025-11-18T07:14:11.2531392Z     |
2025-11-18T07:14:11.2531479Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2531484Z 
2025-11-18T07:14:11.2531584Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2531677Z   --> app/services/context/__init__.py:9:1
2025-11-18T07:14:11.2531733Z    |
2025-11-18T07:14:11.2531791Z  7 |   """
2025-11-18T07:14:11.2531849Z  8 |
2025-11-18T07:14:11.2531936Z  9 | / from __future__ import annotations
2025-11-18T07:14:11.2531993Z 10 | |
2025-11-18T07:14:11.2532071Z 11 | | # Import implemented classes
2025-11-18T07:14:11.2532286Z 12 | | from app.services.context.hybrid_search import HybridSearchEngine, SearchResult
2025-11-18T07:14:11.2532490Z 13 | | from app.services.context.episodic_memory import EpisodicMemoryStore, Episode
2025-11-18T07:14:11.2532621Z 14 | | from app.services.context.multi_level_context import (
2025-11-18T07:14:11.2532706Z 15 | |     MultiLevelContextManager,
2025-11-18T07:14:11.2532775Z 16 | |     LayeredContext,
2025-11-18T07:14:11.2532848Z 17 | |     ImmediateContext,
2025-11-18T07:14:11.2532919Z 18 | |     RecentContext,
2025-11-18T07:14:11.2532992Z 19 | |     RelevantContext,
2025-11-18T07:14:11.2533065Z 20 | |     BackgroundContext,
2025-11-18T07:14:11.2533137Z 21 | |     EpisodicContext,
2025-11-18T07:14:11.2533198Z 22 | | )
2025-11-18T07:14:11.2533255Z    | |_^
2025-11-18T07:14:11.2533315Z 23 |
2025-11-18T07:14:11.2533376Z 24 |   __all__ = [
2025-11-18T07:14:11.2533436Z    |
2025-11-18T07:14:11.2533508Z help: Organize imports
2025-11-18T07:14:11.2533514Z 
2025-11-18T07:14:11.2533615Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2533756Z   --> app/services/context/episode_boundary_detector.py:11:1
2025-11-18T07:14:11.2533812Z    |
2025-11-18T07:14:11.2533870Z  9 |   """
2025-11-18T07:14:11.2533925Z 10 |
2025-11-18T07:14:11.2534013Z 11 | / from __future__ import annotations
2025-11-18T07:14:11.2534070Z 12 | |
2025-11-18T07:14:11.2534136Z 13 | | import asyncio
2025-11-18T07:14:11.2534203Z 14 | | import json
2025-11-18T07:14:11.2534267Z 15 | | import logging
2025-11-18T07:14:11.2534333Z 16 | | import re
2025-11-18T07:14:11.2534396Z 17 | | import time
2025-11-18T07:14:11.2534484Z 18 | | from dataclasses import dataclass
2025-11-18T07:14:11.2534561Z 19 | | from pathlib import Path
2025-11-18T07:14:11.2534634Z 20 | | from typing import Any
2025-11-18T07:14:11.2534698Z 21 | |
2025-11-18T07:14:11.2534756Z 22 | |
2025-11-18T07:14:11.2534837Z 23 | | from app.config import Settings
2025-11-18T07:14:11.2534904Z    | |_______________________________^
2025-11-18T07:14:11.2535006Z 24 |
2025-11-18T07:14:11.2535163Z 25 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2535266Z    |
2025-11-18T07:14:11.2535392Z help: Organize imports
2025-11-18T07:14:11.2535598Z 
2025-11-18T07:14:11.2535728Z F401 [*] `time` imported but unused
2025-11-18T07:14:11.2536180Z   --> app/services/context/episode_boundary_detector.py:17:8
2025-11-18T07:14:11.2536634Z    |
2025-11-18T07:14:11.2536864Z 15 | import logging
2025-11-18T07:14:11.2537306Z 16 | import re
2025-11-18T07:14:11.2537774Z 17 | import time
2025-11-18T07:14:11.2538021Z    |        ^^^^
2025-11-18T07:14:11.2538312Z 18 | from dataclasses import dataclass
2025-11-18T07:14:11.2538747Z 19 | from pathlib import Path
2025-11-18T07:14:11.2539093Z    |
2025-11-18T07:14:11.2539384Z help: Remove unused import: `time`
2025-11-18T07:14:11.2539869Z 
2025-11-18T07:14:11.2540038Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2540590Z   --> app/services/context/episode_boundary_detector.py:19:21
2025-11-18T07:14:11.2541092Z    |
2025-11-18T07:14:11.2541360Z 17 | import time
2025-11-18T07:14:11.2541686Z 18 | from dataclasses import dataclass
2025-11-18T07:14:11.2542120Z 19 | from pathlib import Path
2025-11-18T07:14:11.2542584Z    |                     ^^^^
2025-11-18T07:14:11.2542935Z 20 | from typing import Any
2025-11-18T07:14:11.2543242Z    |
2025-11-18T07:14:11.2543538Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2543833Z 
2025-11-18T07:14:11.2544030Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2544438Z    --> app/services/context/episode_boundary_detector.py:438:37
2025-11-18T07:14:11.2544729Z     |
2025-11-18T07:14:11.2544888Z 436 |         import math
2025-11-18T07:14:11.2545065Z 437 |
2025-11-18T07:14:11.2545248Z 438 |         dot = sum(x * y for x, y in zip(a, b))
2025-11-18T07:14:11.2545505Z     |                                     ^^^^^^^^^
2025-11-18T07:14:11.2545767Z 439 |         norm_a = math.sqrt(sum(x * x for x in a))
2025-11-18T07:14:11.2546039Z 440 |         norm_b = math.sqrt(sum(y * y for y in b))
2025-11-18T07:14:11.2546263Z     |
2025-11-18T07:14:11.2546452Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2546640Z 
2025-11-18T07:14:11.2546745Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2547285Z   --> app/services/context/episode_monitor.py:8:1
2025-11-18T07:14:11.2547532Z    |
2025-11-18T07:14:11.2547673Z  6 |   """
2025-11-18T07:14:11.2547819Z  7 |
2025-11-18T07:14:11.2547983Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2548208Z  9 | |
2025-11-18T07:14:11.2548356Z 10 | | import asyncio
2025-11-18T07:14:11.2548535Z 11 | | import logging
2025-11-18T07:14:11.2548705Z 12 | | import time
2025-11-18T07:14:11.2548912Z 13 | | from dataclasses import dataclass, field
2025-11-18T07:14:11.2549163Z 14 | | from pathlib import Path
2025-11-18T07:14:11.2549382Z 15 | | from typing import Any
2025-11-18T07:14:11.2549568Z 16 | |
2025-11-18T07:14:11.2549735Z 17 | | from app.config import Settings
2025-11-18T07:14:11.2550041Z 18 | | from app.services.context.episode_boundary_detector import (
2025-11-18T07:14:11.2550346Z 19 | |     BoundarySignal,
2025-11-18T07:14:11.2550557Z 20 | |     EpisodeBoundaryDetector,
2025-11-18T07:14:11.2550779Z 21 | |     MessageSequence,
2025-11-18T07:14:11.2550964Z 22 | | )
2025-11-18T07:14:11.2551221Z 23 | | from app.services.context.episodic_memory import EpisodicMemoryStore
2025-11-18T07:14:11.2551655Z 24 | | from app.services.context.episode_summarizer import EpisodeSummarizer
2025-11-18T07:14:11.2552041Z    | |_____________________________________________________________________^
2025-11-18T07:14:11.2552298Z 25 |
2025-11-18T07:14:11.2552468Z 26 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2552734Z    |
2025-11-18T07:14:11.2552886Z help: Organize imports
2025-11-18T07:14:11.2553011Z 
2025-11-18T07:14:11.2553107Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2553385Z   --> app/services/context/episode_monitor.py:14:21
2025-11-18T07:14:11.2553629Z    |
2025-11-18T07:14:11.2553769Z 12 | import time
2025-11-18T07:14:11.2553964Z 13 | from dataclasses import dataclass, field
2025-11-18T07:14:11.2554222Z 14 | from pathlib import Path
2025-11-18T07:14:11.2554426Z    |                     ^^^^
2025-11-18T07:14:11.2554624Z 15 | from typing import Any
2025-11-18T07:14:11.2554810Z    |
2025-11-18T07:14:11.2554983Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2555154Z 
2025-11-18T07:14:11.2555395Z F401 [*] `app.services.context.episode_boundary_detector.BoundarySignal` imported but unused
2025-11-18T07:14:11.2555971Z   --> app/services/context/episode_monitor.py:19:5
2025-11-18T07:14:11.2556216Z    |
2025-11-18T07:14:11.2556369Z 17 | from app.config import Settings
2025-11-18T07:14:11.2556676Z 18 | from app.services.context.episode_boundary_detector import (
2025-11-18T07:14:11.2557510Z 19 |     BoundarySignal,
2025-11-18T07:14:11.2557704Z    |     ^^^^^^^^^^^^^^
2025-11-18T07:14:11.2557896Z 20 |     EpisodeBoundaryDetector,
2025-11-18T07:14:11.2558112Z 21 |     MessageSequence,
2025-11-18T07:14:11.2558291Z    |
2025-11-18T07:14:11.2558610Z help: Remove unused import: `app.services.context.episode_boundary_detector.BoundarySignal`
2025-11-18T07:14:11.2558943Z 
2025-11-18T07:14:11.2559031Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2559302Z    --> app/services/context/episode_monitor.py:205:1
2025-11-18T07:14:11.2559554Z     |
2025-11-18T07:14:11.2559695Z 203 |         )
2025-11-18T07:14:11.2559935Z 204 |         batch_delay = batch_delay_ms / 1000.0  # Convert to seconds
2025-11-18T07:14:11.2560229Z 205 |         
2025-11-18T07:14:11.2560381Z     | ^^^^^^^^
2025-11-18T07:14:11.2560550Z 206 |         async with self._lock:
2025-11-18T07:14:11.2560785Z 207 |             keys_to_remove = []
2025-11-18T07:14:11.2560996Z     |
2025-11-18T07:14:11.2561162Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2561329Z 
2025-11-18T07:14:11.2561482Z F841 Local variable `keys_to_remove` is assigned to but never used
2025-11-18T07:14:11.2561827Z    --> app/services/context/episode_monitor.py:207:13
2025-11-18T07:14:11.2562088Z     |
2025-11-18T07:14:11.2562242Z 206 |         async with self._lock:
2025-11-18T07:14:11.2562461Z 207 |             keys_to_remove = []
2025-11-18T07:14:11.2562672Z     |             ^^^^^^^^^^^^^^
2025-11-18T07:14:11.2562922Z 208 |             windows_to_check = list(self.windows.items())
2025-11-18T07:14:11.2563181Z     |
2025-11-18T07:14:11.2563399Z help: Remove assignment to unused variable `keys_to_remove`
2025-11-18T07:14:11.2563623Z 
2025-11-18T07:14:11.2563706Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2563972Z    --> app/services/context/episode_monitor.py:223:1
2025-11-18T07:14:11.2564220Z     |
2025-11-18T07:14:11.2564365Z 221 |                     )
2025-11-18T07:14:11.2564628Z 222 |                     await self._create_episode_from_window(window, "timeout")
2025-11-18T07:14:11.2564934Z 223 |                     
2025-11-18T07:14:11.2565116Z     | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2565317Z 224 |                     async with self._lock:
2025-11-18T07:14:11.2565574Z 225 |                         if key in self.windows:
2025-11-18T07:14:11.2565805Z     |
2025-11-18T07:14:11.2565967Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2566132Z 
2025-11-18T07:14:11.2566227Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2566504Z    --> app/services/context/episode_monitor.py:289:34
2025-11-18T07:14:11.2566749Z     |
2025-11-18T07:14:11.2566900Z 287 |                 else:
2025-11-18T07:14:11.2567229Z 288 |                     # Just log detection (will be handled later)
2025-11-18T07:14:11.2567565Z 289 |                     LOGGER.debug(f"Boundary detected but auto_close=False")
2025-11-18T07:14:11.2567870Z     |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2568107Z 290 |
2025-11-18T07:14:11.2568261Z 291 |         except Exception as e:
2025-11-18T07:14:11.2568465Z     |
2025-11-18T07:14:11.2568628Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2568780Z 
2025-11-18T07:14:11.2568862Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2569129Z    --> app/services/context/episode_monitor.py:354:1
2025-11-18T07:14:11.2569369Z     |
2025-11-18T07:14:11.2569601Z 352 |                         gemini_valence = result.get("emotional_valence", "neutral")
2025-11-18T07:14:11.2569934Z 353 |                         gemini_tags = result.get("tags", [])
2025-11-18T07:14:11.2570186Z 354 |                         
2025-11-18T07:14:11.2570510Z     | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2570715Z 355 |                         if gemini_topic:
2025-11-18T07:14:11.2570967Z 356 |                             topic = gemini_topic
2025-11-18T07:14:11.2571193Z     |
2025-11-18T07:14:11.2571360Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2571626Z 
2025-11-18T07:14:11.2571707Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2571966Z    --> app/services/context/episode_monitor.py:363:1
2025-11-18T07:14:11.2572208Z     |
2025-11-18T07:14:11.2572366Z 361 |                         if gemini_tags:
2025-11-18T07:14:11.2572642Z 362 |                             tags = [reason] + gemini_tags[:4]  # Limit tags
2025-11-18T07:14:11.2572908Z 363 |                             
2025-11-18T07:14:11.2573112Z     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2573322Z 364 |                         LOGGER.debug(
2025-11-18T07:14:11.2573638Z 365 |                             f"Enhanced episode with Gemini summary (topic: {topic[:50]})"
2025-11-18T07:14:11.2573942Z     |
2025-11-18T07:14:11.2574105Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2574266Z 
2025-11-18T07:14:11.2574354Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2574617Z   --> app/services/context/episode_summarizer.py:32:1
2025-11-18T07:14:11.2574874Z    |
2025-11-18T07:14:11.2575032Z 30 |         self.settings = settings
2025-11-18T07:14:11.2575264Z 31 |         self.gemini = gemini_client
2025-11-18T07:14:11.2575479Z 32 |         
2025-11-18T07:14:11.2575629Z    | ^^^^^^^^
2025-11-18T07:14:11.2575839Z 33 |         # Rate limiting: track timestamps of recent API calls
2025-11-18T07:14:11.2576225Z 34 |         self.rate_limit = getattr(settings, "episode_summarization_rate_limit", 1)
2025-11-18T07:14:11.2576552Z    |
2025-11-18T07:14:11.2576716Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2576876Z 
2025-11-18T07:14:11.2577058Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2577326Z   --> app/services/context/episode_summarizer.py:42:1
2025-11-18T07:14:11.2577576Z    |
2025-11-18T07:14:11.2577713Z 40 |         """
2025-11-18T07:14:11.2577945Z 41 |         Check if we can make a Gemini API call based on rate limit.
2025-11-18T07:14:11.2578218Z 42 |         
2025-11-18T07:14:11.2578365Z    | ^^^^^^^^
2025-11-18T07:14:11.2578520Z 43 |         Returns:
2025-11-18T07:14:11.2578737Z 44 |             True if call is allowed, False if rate limited
2025-11-18T07:14:11.2578991Z    |
2025-11-18T07:14:11.2579157Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2579330Z 
2025-11-18T07:14:11.2579413Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2579685Z   --> app/services/context/episode_summarizer.py:51:1
2025-11-18T07:14:11.2579940Z    |
2025-11-18T07:14:11.2580224Z 49 |             while self._recent_calls and (now - self._recent_calls[0]) > self._rate_limit_window:
2025-11-18T07:14:11.2580608Z 50 |                 self._recent_calls.popleft()
2025-11-18T07:14:11.2580848Z 51 |             
2025-11-18T07:14:11.2581004Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2581185Z 52 |             # Check if we're at the limit
2025-11-18T07:14:11.2581454Z 53 |             if len(self._recent_calls) >= self.rate_limit:
2025-11-18T07:14:11.2581706Z    |
2025-11-18T07:14:11.2581866Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2582035Z 
2025-11-18T07:14:11.2582116Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2582381Z   --> app/services/context/episode_summarizer.py:55:1
2025-11-18T07:14:11.2582632Z    |
2025-11-18T07:14:11.2582813Z 53 |             if len(self._recent_calls) >= self.rate_limit:
2025-11-18T07:14:11.2583066Z 54 |                 return False
2025-11-18T07:14:11.2583264Z 55 |             
2025-11-18T07:14:11.2583417Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2583583Z 56 |             # Record this call
2025-11-18T07:14:11.2583813Z 57 |             self._recent_calls.append(now)
2025-11-18T07:14:11.2584038Z    |
2025-11-18T07:14:11.2584197Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2584484Z 
2025-11-18T07:14:11.2584565Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2584831Z   --> app/services/context/episode_summarizer.py:59:1
2025-11-18T07:14:11.2585079Z    |
2025-11-18T07:14:11.2585245Z 57 |             self._recent_calls.append(now)
2025-11-18T07:14:11.2585585Z 58 |             return True
2025-11-18T07:14:11.2585776Z 59 |     
2025-11-18T07:14:11.2585919Z    | ^^^^
2025-11-18T07:14:11.2586113Z 60 |     async def _wait_for_rate_limit(self) -> None:
2025-11-18T07:14:11.2586407Z 61 |         """Wait until rate limit allows another call."""
2025-11-18T07:14:11.2586656Z    |
2025-11-18T07:14:11.2586821Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2587078Z 
2025-11-18T07:14:11.2587162Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2587431Z   --> app/services/context/episode_summarizer.py:65:1
2025-11-18T07:14:11.2587676Z    |
2025-11-18T07:14:11.2587835Z 63 |             if not self._recent_calls:
2025-11-18T07:14:11.2588065Z 64 |                 return
2025-11-18T07:14:11.2588247Z 65 |             
2025-11-18T07:14:11.2588401Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2588574Z 66 |             now = time.time()
2025-11-18T07:14:11.2588788Z 67 |             # Remove old calls
2025-11-18T07:14:11.2588983Z    |
2025-11-18T07:14:11.2589150Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2589310Z 
2025-11-18T07:14:11.2589390Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2589653Z   --> app/services/context/episode_summarizer.py:70:1
2025-11-18T07:14:11.2589896Z    |
2025-11-18T07:14:11.2590174Z 68 |             while self._recent_calls and (now - self._recent_calls[0]) > self._rate_limit_window:
2025-11-18T07:14:11.2590553Z 69 |                 self._recent_calls.popleft()
2025-11-18T07:14:11.2590788Z 70 |             
2025-11-18T07:14:11.2590946Z    | ^^^^^^^^^^^^
2025-11-18T07:14:11.2591159Z 71 |             # If still at limit, wait for oldest call to expire
2025-11-18T07:14:11.2591470Z 72 |             if len(self._recent_calls) >= self.rate_limit:
2025-11-18T07:14:11.2591713Z    |
2025-11-18T07:14:11.2591879Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2592043Z 
2025-11-18T07:14:11.2592128Z F401 [*] `asyncpg` imported but unused
2025-11-18T07:14:11.2592388Z   --> app/services/context/episodic_memory.py:17:8
2025-11-18T07:14:11.2592631Z    |
2025-11-18T07:14:11.2592783Z 15 | from typing import Any
2025-11-18T07:14:11.2592966Z 16 |
2025-11-18T07:14:11.2593107Z 17 | import asyncpg
2025-11-18T07:14:11.2593277Z    |        ^^^^^^^
2025-11-18T07:14:11.2593428Z 18 |
2025-11-18T07:14:11.2593588Z 19 | from app.config import Settings
2025-11-18T07:14:11.2593799Z    |
2025-11-18T07:14:11.2593961Z help: Remove unused import: `asyncpg`
2025-11-18T07:14:11.2594119Z 
2025-11-18T07:14:11.2594194Z W291 Trailing whitespace
2025-11-18T07:14:11.2594431Z    --> app/services/context/episodic_memory.py:126:33
2025-11-18T07:14:11.2594682Z     |
2025-11-18T07:14:11.2594831Z 125 |         query = """
2025-11-18T07:14:11.2595034Z 126 |             INSERT INTO episodes 
2025-11-18T07:14:11.2595256Z     |                                 ^
2025-11-18T07:14:11.2595565Z 127 |             (chat_id, thread_id, topic, summary, summary_embedding, importance, 
2025-11-18T07:14:11.2596030Z 128 |              emotional_valence, message_ids, participant_ids, tags, created_at, access_count)
2025-11-18T07:14:11.2596399Z     |
2025-11-18T07:14:11.2596559Z help: Remove trailing whitespace
2025-11-18T07:14:11.2596711Z 
2025-11-18T07:14:11.2596785Z W291 Trailing whitespace
2025-11-18T07:14:11.2597119Z    --> app/services/context/episodic_memory.py:127:80
2025-11-18T07:14:11.2597369Z     |
2025-11-18T07:14:11.2597523Z 125 |         query = """
2025-11-18T07:14:11.2597719Z 126 |             INSERT INTO episodes 
2025-11-18T07:14:11.2598031Z 127 |             (chat_id, thread_id, topic, summary, summary_embedding, importance, 
2025-11-18T07:14:11.2598363Z     |                                                                                ^
2025-11-18T07:14:11.2598878Z 128 |              emotional_valence, message_ids, participant_ids, tags, created_at, access_count)
2025-11-18T07:14:11.2599295Z 129 |             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, 0)
2025-11-18T07:14:11.2599546Z     |
2025-11-18T07:14:11.2599707Z help: Remove trailing whitespace
2025-11-18T07:14:11.2599960Z 
2025-11-18T07:14:11.2600033Z W291 Trailing whitespace
2025-11-18T07:14:11.2600266Z    --> app/services/context/episodic_memory.py:191:35
2025-11-18T07:14:11.2600513Z     |
2025-11-18T07:14:11.2600820Z 189 |         # PostgreSQL: participant_ids is TEXT (JSON), need to cast to jsonb for array operations
2025-11-18T07:14:11.2601191Z 190 |         query = """
2025-11-18T07:14:11.2601394Z 191 |             SELECT * FROM episodes 
2025-11-18T07:14:11.2601622Z     |                                   ^
2025-11-18T07:14:11.2602528Z make: *** [Makefile:86: ci] Error 1
2025-11-18T07:14:11.2602760Z 192 |             WHERE chat_id = $1 
2025-11-18T07:14:11.2602994Z 193 |               AND importance >= $2
2025-11-18T07:14:11.2603208Z     |
2025-11-18T07:14:11.2603368Z help: Remove trailing whitespace
2025-11-18T07:14:11.2603517Z 
2025-11-18T07:14:11.2603590Z W291 Trailing whitespace
2025-11-18T07:14:11.2603825Z    --> app/services/context/episodic_memory.py:192:31
2025-11-18T07:14:11.2604076Z     |
2025-11-18T07:14:11.2604227Z 190 |         query = """
2025-11-18T07:14:11.2604424Z 191 |             SELECT * FROM episodes 
2025-11-18T07:14:11.2604656Z 192 |             WHERE chat_id = $1 
2025-11-18T07:14:11.2604866Z     |                               ^
2025-11-18T07:14:11.2605084Z 193 |               AND importance >= $2
2025-11-18T07:14:11.2605307Z 194 |               AND EXISTS (
2025-11-18T07:14:11.2605497Z     |
2025-11-18T07:14:11.2605654Z help: Remove trailing whitespace
2025-11-18T07:14:11.2605801Z 
2025-11-18T07:14:11.2605873Z W291 Trailing whitespace
2025-11-18T07:14:11.2606106Z    --> app/services/context/episodic_memory.py:363:32
2025-11-18T07:14:11.2606358Z     |
2025-11-18T07:14:11.2606599Z 361 |             placeholders = ",".join(f"${i+1}" for i in range(len(episode_ids)))
2025-11-18T07:14:11.2606923Z 362 |             query = f"""
2025-11-18T07:14:11.2607234Z 363 |                 UPDATE episodes 
2025-11-18T07:14:11.2607451Z     |                                ^
2025-11-18T07:14:11.2607709Z 364 |                 SET last_accessed = ${len(episode_ids) + 1}, 
2025-11-18T07:14:11.2608001Z 365 |                     access_count = access_count + 1
2025-11-18T07:14:11.2608238Z     |
2025-11-18T07:14:11.2608397Z help: Remove trailing whitespace
2025-11-18T07:14:11.2608541Z 
2025-11-18T07:14:11.2608614Z W291 Trailing whitespace
2025-11-18T07:14:11.2608848Z    --> app/services/context/episodic_memory.py:364:61
2025-11-18T07:14:11.2609093Z     |
2025-11-18T07:14:11.2609246Z 362 |             query = f"""
2025-11-18T07:14:11.2609451Z 363 |                 UPDATE episodes 
2025-11-18T07:14:11.2614059Z 364 |                 SET last_accessed = ${len(episode_ids) + 1}, 
2025-11-18T07:14:11.2614378Z     |                                                             ^
2025-11-18T07:14:11.2614651Z 365 |                     access_count = access_count + 1
2025-11-18T07:14:11.2614940Z 366 |                 WHERE id IN ({placeholders})
2025-11-18T07:14:11.2615183Z     |
2025-11-18T07:14:11.2615357Z help: Remove trailing whitespace
2025-11-18T07:14:11.2615508Z 
2025-11-18T07:14:11.2615582Z W291 Trailing whitespace
2025-11-18T07:14:11.2615827Z    --> app/services/context/episodic_memory.py:374:84
2025-11-18T07:14:11.2616082Z     |
2025-11-18T07:14:11.2616337Z 372 |             access_records = [(ep_id, ts, "retrieval") for ep_id in episode_ids]
2025-11-18T07:14:11.2616668Z 373 |             query = """
2025-11-18T07:14:11.2617125Z 374 |                 INSERT INTO episode_accesses (episode_id, accessed_at, access_type) 
2025-11-18T07:14:11.2617481Z     |                                                                                    ^
2025-11-18T07:14:11.2617897Z 375 |                 VALUES ($1, $2, $3)
2025-11-18T07:14:11.2618117Z 376 |             """
2025-11-18T07:14:11.2618279Z     |
2025-11-18T07:14:11.2618443Z help: Remove trailing whitespace
2025-11-18T07:14:11.2618590Z 
2025-11-18T07:14:11.2618695Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2619088Z   --> app/services/context/hybrid_search.py:11:1
2025-11-18T07:14:11.2619324Z    |
2025-11-18T07:14:11.2619459Z  9 |   """
2025-11-18T07:14:11.2619600Z 10 |
2025-11-18T07:14:11.2619757Z 11 | / from __future__ import annotations
2025-11-18T07:14:11.2619976Z 12 | |
2025-11-18T07:14:11.2620121Z 13 | | import asyncio
2025-11-18T07:14:11.2620292Z 14 | | import json
2025-11-18T07:14:11.2620453Z 15 | | import logging
2025-11-18T07:14:11.2620619Z 16 | | import math
2025-11-18T07:14:11.2620774Z 17 | | import re
2025-11-18T07:14:11.2620931Z 18 | | import time
2025-11-18T07:14:11.2621110Z 19 | | from dataclasses import dataclass
2025-11-18T07:14:11.2621349Z 20 | | from pathlib import Path
2025-11-18T07:14:11.2621566Z 21 | | from typing import Any
2025-11-18T07:14:11.2621753Z 22 | |
2025-11-18T07:14:11.2621899Z 23 | | import asyncpg
2025-11-18T07:14:11.2622188Z 24 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2622521Z 25 | |
2025-11-18T07:14:11.2622682Z 26 | | from app.config import Settings
2025-11-18T07:14:11.2622983Z 27 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2623310Z 28 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2623580Z    | |______________________________________________^
2025-11-18T07:14:11.2623794Z 29 |
2025-11-18T07:14:11.2623962Z 30 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2624185Z    |
2025-11-18T07:14:11.2624332Z help: Organize imports
2025-11-18T07:14:11.2624449Z 
2025-11-18T07:14:11.2624531Z F401 [*] `asyncpg` imported but unused
2025-11-18T07:14:11.2624784Z   --> app/services/context/hybrid_search.py:23:8
2025-11-18T07:14:11.2625018Z    |
2025-11-18T07:14:11.2625169Z 21 | from typing import Any
2025-11-18T07:14:11.2625358Z 22 |
2025-11-18T07:14:11.2625498Z 23 | import asyncpg
2025-11-18T07:14:11.2625656Z    |        ^^^^^^^
2025-11-18T07:14:11.2625937Z 24 | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2626260Z    |
2025-11-18T07:14:11.2626427Z help: Remove unused import: `asyncpg`
2025-11-18T07:14:11.2626581Z 
2025-11-18T07:14:11.2626810Z F401 [*] `app.infrastructure.query_converter.convert_query_to_postgres` imported but unused
2025-11-18T07:14:11.2627344Z   --> app/services/context/hybrid_search.py:24:48
2025-11-18T07:14:11.2627581Z    |
2025-11-18T07:14:11.2627718Z 23 | import asyncpg
2025-11-18T07:14:11.2628004Z 24 | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2628352Z    |                                                ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2628574Z 25 |
2025-11-18T07:14:11.2628725Z 26 | from app.config import Settings
2025-11-18T07:14:11.2628934Z    |
2025-11-18T07:14:11.2629233Z help: Remove unused import: `app.infrastructure.query_converter.convert_query_to_postgres`
2025-11-18T07:14:11.2629550Z 
2025-11-18T07:14:11.2629662Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2629959Z    --> app/services/context/hybrid_search.py:170:16
2025-11-18T07:14:11.2630200Z     |
2025-11-18T07:14:11.2630368Z 168 |                 timeout=timeout_seconds
2025-11-18T07:14:11.2630583Z 169 |             )
2025-11-18T07:14:11.2630773Z 170 |         except asyncio.TimeoutError:
2025-11-18T07:14:11.2631021Z     |                ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2631238Z 171 |             LOGGER.warning(
2025-11-18T07:14:11.2631630Z 172 |                 f"Hybrid search timeout ({timeout_seconds}s) for chat {chat_id}, using semantic-only fallback",
2025-11-18T07:14:11.2632020Z     |
2025-11-18T07:14:11.2632252Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2632492Z 
2025-11-18T07:14:11.2632687Z W291 Trailing whitespace
2025-11-18T07:14:11.2632921Z    --> app/services/context/hybrid_search.py:262:72
2025-11-18T07:14:11.2633160Z     |
2025-11-18T07:14:11.2633313Z 261 |             query_sql = f"""
2025-11-18T07:14:11.2633589Z 262 |                 SELECT m.id, m.chat_id, m.thread_id, m.user_id, m.role, 
2025-11-18T07:14:11.2633994Z     |                                                                        ^
2025-11-18T07:14:11.2634265Z 263 |                        m.text, m.media, m.embedding, m.ts
2025-11-18T07:14:11.2634518Z 264 |                 FROM messages m
2025-11-18T07:14:11.2634719Z     |
2025-11-18T07:14:11.2634875Z help: Remove trailing whitespace
2025-11-18T07:14:11.2635022Z 
2025-11-18T07:14:11.2635105Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2635364Z    --> app/services/context/hybrid_search.py:280:1
2025-11-18T07:14:11.2635599Z     |
2025-11-18T07:14:11.2635744Z 278 |                 else:
2025-11-18T07:14:11.2635945Z 279 |                     query_pg += char
2025-11-18T07:14:11.2636163Z 280 |             
2025-11-18T07:14:11.2636317Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2636544Z 281 |             async with get_db_connection(self.database_url) as conn:
2025-11-18T07:14:11.2636873Z 282 |                 rows = await conn.fetch(query_pg, *params)
2025-11-18T07:14:11.2637226Z     |
2025-11-18T07:14:11.2637387Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2637550Z 
2025-11-18T07:14:11.2637649Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2637938Z   --> app/services/context/multi_level_context.py:14:1
2025-11-18T07:14:11.2638188Z    |
2025-11-18T07:14:11.2638325Z 12 |   """
2025-11-18T07:14:11.2638463Z 13 |
2025-11-18T07:14:11.2638621Z 14 | / from __future__ import annotations
2025-11-18T07:14:11.2638834Z 15 | |
2025-11-18T07:14:11.2638980Z 16 | | import asyncio
2025-11-18T07:14:11.2639150Z 17 | | import logging
2025-11-18T07:14:11.2639315Z 18 | | import time
2025-11-18T07:14:11.2639493Z 19 | | from dataclasses import dataclass
2025-11-18T07:14:11.2639737Z 20 | | from pathlib import Path
2025-11-18T07:14:11.2639945Z 21 | | from typing import Any
2025-11-18T07:14:11.2640133Z 22 | |
2025-11-18T07:14:11.2640267Z 23 | |
2025-11-18T07:14:11.2640422Z 24 | | from app.config import Settings
2025-11-18T07:14:11.2640660Z 25 | | from app.services import telemetry
2025-11-18T07:14:11.2640888Z    | |__________________________________^
2025-11-18T07:14:11.2641084Z 26 |
2025-11-18T07:14:11.2641243Z 27 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2641461Z    |
2025-11-18T07:14:11.2641603Z help: Organize imports
2025-11-18T07:14:11.2641723Z 
2025-11-18T07:14:11.2641804Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2642082Z    --> app/services/context/multi_level_context.py:244:1
2025-11-18T07:14:11.2642337Z     |
2025-11-18T07:14:11.2642535Z 242 |         query_type = self._detect_query_type(query_text)
2025-11-18T07:14:11.2642819Z 243 |         is_news_query = query_type == "news"
2025-11-18T07:14:11.2643053Z 244 |         
2025-11-18T07:14:11.2643201Z     | ^^^^^^^^
2025-11-18T07:14:11.2643469Z 245 |         # For news queries, reduce or skip relevant context (past conversations)
2025-11-18T07:14:11.2643853Z 246 |         # to prevent pulling in irrelevant old conversations
2025-11-18T07:14:11.2644118Z     |
2025-11-18T07:14:11.2644286Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2644454Z 
2025-11-18T07:14:11.2644536Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2644804Z    --> app/services/context/multi_level_context.py:583:1
2025-11-18T07:14:11.2645055Z     |
2025-11-18T07:14:11.2645194Z 581 |         """
2025-11-18T07:14:11.2645441Z 582 |         Detect query type based on patterns, keywords, and structure.
2025-11-18T07:14:11.2645738Z 583 |         
2025-11-18T07:14:11.2645886Z     | ^^^^^^^^
2025-11-18T07:14:11.2646129Z 584 |         Returns: "news", "factual", "conversational", "command", "general"
2025-11-18T07:14:11.2646422Z 585 |         """
2025-11-18T07:14:11.2646700Z     |
2025-11-18T07:14:11.2646864Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2647120Z 
2025-11-18T07:14:11.2647201Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2647469Z    --> app/services/context/multi_level_context.py:588:1
2025-11-18T07:14:11.2647717Z     |
2025-11-18T07:14:11.2647975Z 586 |         if not query:
2025-11-18T07:14:11.2648166Z 587 |             return "general"
2025-11-18T07:14:11.2648364Z 588 |         
2025-11-18T07:14:11.2648508Z     | ^^^^^^^^
2025-11-18T07:14:11.2648686Z 589 |         query_lower = query.lower().strip()
2025-11-18T07:14:11.2648949Z 590 |         query_words = query_lower.split()
2025-11-18T07:14:11.2649171Z     |
2025-11-18T07:14:11.2649332Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2649489Z 
2025-11-18T07:14:11.2649568Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2649840Z    --> app/services/context/multi_level_context.py:592:1
2025-11-18T07:14:11.2650094Z     |
2025-11-18T07:14:11.2650271Z 590 |         query_words = query_lower.split()
2025-11-18T07:14:11.2650535Z 591 |         query_length = len(query_words)
2025-11-18T07:14:11.2650764Z 592 |         
2025-11-18T07:14:11.2650918Z     | ^^^^^^^^
2025-11-18T07:14:11.2651124Z 593 |         # News-related keywords (Ukrainian and English)
2025-11-18T07:14:11.2651400Z 594 |         news_keywords = [
2025-11-18T07:14:11.2651588Z     |
2025-11-18T07:14:11.2651758Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2651923Z 
2025-11-18T07:14:11.2652006Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2652278Z    --> app/services/context/multi_level_context.py:604:1
2025-11-18T07:14:11.2652526Z     |
2025-11-18T07:14:11.2652760Z 602 |             "events", "happened", "breaking", "breaking news"
2025-11-18T07:14:11.2653020Z 603 |         ]
2025-11-18T07:14:11.2653167Z 604 |         
2025-11-18T07:14:11.2653315Z     | ^^^^^^^^
2025-11-18T07:14:11.2653533Z 605 |         # Factual/lookup question words (Ukrainian and English)
2025-11-18T07:14:11.2653830Z 606 |         factual_indicators = [
2025-11-18T07:14:11.2654028Z     |
2025-11-18T07:14:11.2654194Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2654355Z 
2025-11-18T07:14:11.2654437Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2654706Z    --> app/services/context/multi_level_context.py:612:1
2025-11-18T07:14:11.2654963Z     |
2025-11-18T07:14:11.2655113Z 610 |             "which", "whose"
2025-11-18T07:14:11.2655308Z 611 |         ]
2025-11-18T07:14:11.2655458Z 612 |         
2025-11-18T07:14:11.2655605Z     | ^^^^^^^^
2025-11-18T07:14:11.2655764Z 613 |         # Command indicators
2025-11-18T07:14:11.2655976Z 614 |         command_indicators = [
2025-11-18T07:14:11.2656176Z     |
2025-11-18T07:14:11.2656341Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2656500Z 
2025-11-18T07:14:11.2656583Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2656844Z    --> app/services/context/multi_level_context.py:619:1
2025-11-18T07:14:11.2657193Z     |
2025-11-18T07:14:11.2657478Z 617 |             "згенеруй", "зроби", "створи", "намалюй"
2025-11-18T07:14:11.2657712Z 618 |         ]
2025-11-18T07:14:11.2657863Z 619 |         
2025-11-18T07:14:11.2658013Z     | ^^^^^^^^
2025-11-18T07:14:11.2658221Z 620 |         # Conversational indicators (greetings, casual)
2025-11-18T07:14:11.2658517Z 621 |         conversational_indicators = [
2025-11-18T07:14:11.2658745Z     |
2025-11-18T07:14:11.2658908Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2659071Z 
2025-11-18T07:14:11.2659159Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2659430Z    --> app/services/context/multi_level_context.py:626:1
2025-11-18T07:14:11.2659682Z     |
2025-11-18T07:14:11.2659928Z 624 |             "як справи", "що нового", "how are you", "what's up"
2025-11-18T07:14:11.2660184Z 625 |         ]
2025-11-18T07:14:11.2660334Z 626 |         
2025-11-18T07:14:11.2660483Z     | ^^^^^^^^
2025-11-18T07:14:11.2660643Z 627 |         # Check for news keywords
2025-11-18T07:14:11.2661020Z 628 |         for keyword in news_keywords:
2025-11-18T07:14:11.2661242Z     |
2025-11-18T07:14:11.2661408Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2661568Z 
2025-11-18T07:14:11.2661655Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2661927Z    --> app/services/context/multi_level_context.py:631:1
2025-11-18T07:14:11.2662097Z     |
2025-11-18T07:14:11.2662187Z 629 |             if keyword in query_lower:
2025-11-18T07:14:11.2662264Z 630 |                 return "news"
2025-11-18T07:14:11.2662324Z 631 |         
2025-11-18T07:14:11.2662386Z     | ^^^^^^^^
2025-11-18T07:14:11.2662518Z 632 |         # Check for factual questions (question words at start)
2025-11-18T07:14:11.2662652Z 633 |         if query_words and query_words[0] in factual_indicators:
2025-11-18T07:14:11.2662715Z     |
2025-11-18T07:14:11.2662800Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2662805Z 
2025-11-18T07:14:11.2662884Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2663008Z    --> app/services/context/multi_level_context.py:635:1
2025-11-18T07:14:11.2663065Z     |
2025-11-18T07:14:11.2663190Z 633 |         if query_words and query_words[0] in factual_indicators:
2025-11-18T07:14:11.2663264Z 634 |             return "factual"
2025-11-18T07:14:11.2663325Z 635 |         
2025-11-18T07:14:11.2663387Z     | ^^^^^^^^
2025-11-18T07:14:11.2663491Z 636 |         # Check for any factual indicators in query
2025-11-18T07:14:11.2663664Z 637 |         if any(indicator in query_lower for indicator in factual_indicators):
2025-11-18T07:14:11.2663723Z     |
2025-11-18T07:14:11.2663807Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2663812Z 
2025-11-18T07:14:11.2663896Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2664011Z    --> app/services/context/multi_level_context.py:639:1
2025-11-18T07:14:11.2664069Z     |
2025-11-18T07:14:11.2664229Z 637 |         if any(indicator in query_lower for indicator in factual_indicators):
2025-11-18T07:14:11.2664308Z 638 |             return "factual"
2025-11-18T07:14:11.2664366Z 639 |         
2025-11-18T07:14:11.2664426Z     | ^^^^^^^^
2025-11-18T07:14:11.2664532Z 640 |         # Check for commands (imperative verbs)
2025-11-18T07:14:11.2664689Z 641 |         if any(indicator in query_lower for indicator in command_indicators):
2025-11-18T07:14:11.2664750Z     |
2025-11-18T07:14:11.2664833Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2664842Z 
2025-11-18T07:14:11.2664923Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2665036Z    --> app/services/context/multi_level_context.py:643:1
2025-11-18T07:14:11.2665092Z     |
2025-11-18T07:14:11.2665251Z 641 |         if any(indicator in query_lower for indicator in command_indicators):
2025-11-18T07:14:11.2665325Z 642 |             return "command"
2025-11-18T07:14:11.2665383Z 643 |         
2025-11-18T07:14:11.2665445Z     | ^^^^^^^^
2025-11-18T07:14:11.2665542Z 644 |         # Check for conversational patterns
2025-11-18T07:14:11.2665732Z 645 |         if any(indicator in query_lower for indicator in conversational_indicators):
2025-11-18T07:14:11.2665794Z     |
2025-11-18T07:14:11.2665878Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2665884Z 
2025-11-18T07:14:11.2665961Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2666073Z    --> app/services/context/multi_level_context.py:647:1
2025-11-18T07:14:11.2666137Z     |
2025-11-18T07:14:11.2666320Z 645 |         if any(indicator in query_lower for indicator in conversational_indicators):
2025-11-18T07:14:11.2666408Z 646 |             return "conversational"
2025-11-18T07:14:11.2666471Z 647 |         
2025-11-18T07:14:11.2666530Z     | ^^^^^^^^
2025-11-18T07:14:11.2666704Z 648 |         # Very short queries (< 3 words) are likely conversational or follow-ups
2025-11-18T07:14:11.2666776Z 649 |         if query_length < 3:
2025-11-18T07:14:11.2666836Z     |
2025-11-18T07:14:11.2666919Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2666924Z 
2025-11-18T07:14:11.2667264Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2667392Z    --> app/services/context/multi_level_context.py:651:1
2025-11-18T07:14:11.2667452Z     |
2025-11-18T07:14:11.2667527Z 649 |         if query_length < 3:
2025-11-18T07:14:11.2667614Z 650 |             return "conversational"
2025-11-18T07:14:11.2667776Z 651 |         
2025-11-18T07:14:11.2667834Z     | ^^^^^^^^
2025-11-18T07:14:11.2667907Z 652 |         return "general"
2025-11-18T07:14:11.2667969Z     |
2025-11-18T07:14:11.2668057Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2668062Z 
2025-11-18T07:14:11.2668142Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2668265Z    --> app/services/context/multi_level_context.py:678:1
2025-11-18T07:14:11.2668322Z     |
2025-11-18T07:14:11.2668433Z 676 |         query_type = self._detect_query_type(query)
2025-11-18T07:14:11.2668529Z 677 |         is_news_query = query_type == "news"
2025-11-18T07:14:11.2668588Z 678 |         
2025-11-18T07:14:11.2668645Z     | ^^^^^^^^
2025-11-18T07:14:11.2668745Z 679 |         # For news queries, exclude old context
2025-11-18T07:14:11.2668824Z 680 |         time_range_days = None
2025-11-18T07:14:11.2668881Z     |
2025-11-18T07:14:11.2668966Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2668971Z 
2025-11-18T07:14:11.2669088Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2669207Z    --> app/services/context/multi_level_context.py:711:20
2025-11-18T07:14:11.2669264Z     |
2025-11-18T07:14:11.2669350Z 709 |                 last_error = None  # Success
2025-11-18T07:14:11.2669448Z 710 |                 break  # Success, exit retry loop
2025-11-18T07:14:11.2669542Z 711 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2669616Z     |                    ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2669721Z 712 |                 # Timeout errors shouldn't be retried
2025-11-18T07:14:11.2669797Z 713 |                 LOGGER.warning(
2025-11-18T07:14:11.2669853Z     |
2025-11-18T07:14:11.2670014Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2670020Z 
2025-11-18T07:14:11.2670158Z B007 Loop control variable `msg_idx` not used within loop body
2025-11-18T07:14:11.2670277Z     --> app/services/context/multi_level_context.py:1278:17
2025-11-18T07:14:11.2670337Z      |
2025-11-18T07:14:11.2670416Z 1276 |         filtered_by_type = 0
2025-11-18T07:14:11.2670492Z 1277 |         if self.gemini_client:
2025-11-18T07:14:11.2670614Z 1278 |             for msg_idx, msg in enumerate(modified_history):
2025-11-18T07:14:11.2670684Z      |                 ^^^^^^^
2025-11-18T07:14:11.2670777Z 1279 |                 parts = msg.get("parts", [])
2025-11-18T07:14:11.2670848Z 1280 |                 new_parts = []
2025-11-18T07:14:11.2670908Z      |
2025-11-18T07:14:11.2670997Z help: Rename unused `msg_idx` to `_msg_idx`
2025-11-18T07:14:11.2671002Z 
2025-11-18T07:14:11.2671099Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2671219Z     --> app/services/context/multi_level_context.py:1444:9
2025-11-18T07:14:11.2671280Z      |
2025-11-18T07:14:11.2671373Z 1442 |           - token_count: Estimated tokens
2025-11-18T07:14:11.2671436Z 1443 |           """
2025-11-18T07:14:11.2671573Z 1444 | /         from app.services.conversation_formatter import (
2025-11-18T07:14:11.2671661Z 1445 | |             format_history_compact,
2025-11-18T07:14:11.2671732Z 1446 | |             estimate_tokens,
2025-11-18T07:14:11.2671794Z 1447 | |         )
2025-11-18T07:14:11.2671852Z      | |_________^
2025-11-18T07:14:11.2671909Z 1448 |
2025-11-18T07:14:11.2672019Z 1449 |           # Combine immediate + recent into single list
2025-11-18T07:14:11.2672080Z      |
2025-11-18T07:14:11.2672150Z help: Organize imports
2025-11-18T07:14:11.2672156Z 
2025-11-18T07:14:11.2672231Z F401 [*] `re` imported but unused
2025-11-18T07:14:11.2672338Z   --> app/services/context/token_optimizer.py:15:8
2025-11-18T07:14:11.2672395Z    |
2025-11-18T07:14:11.2672459Z 14 | import logging
2025-11-18T07:14:11.2672629Z 15 | import re
2025-11-18T07:14:11.2672689Z    |        ^^
2025-11-18T07:14:11.2672759Z 16 | from typing import Any
2025-11-18T07:14:11.2672815Z    |
2025-11-18T07:14:11.2672897Z help: Remove unused import: `re`
2025-11-18T07:14:11.2672903Z 
2025-11-18T07:14:11.2672983Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2673143Z   --> app/services/context_cache.py:41:1
2025-11-18T07:14:11.2673203Z    |
2025-11-18T07:14:11.2673284Z 39 |         self._base_ttl = ttl_seconds
2025-11-18T07:14:11.2673390Z 40 |         self._max_in_memory_size = max_in_memory_size
2025-11-18T07:14:11.2673449Z 41 |         
2025-11-18T07:14:11.2673509Z    | ^^^^^^^^
2025-11-18T07:14:11.2673682Z 42 |         # In-memory LRU cache for frequently accessed entries (acts as L1 cache)
2025-11-18T07:14:11.2673941Z 43 |         self._lru_cache: OrderedDict[tuple[int, int | None], tuple[list[dict[str, Any]], float]] = OrderedDict()
2025-11-18T07:14:11.2674001Z    |
2025-11-18T07:14:11.2674086Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2674096Z 
2025-11-18T07:14:11.2674174Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2674261Z   --> app/services/context_cache.py:44:1
2025-11-18T07:14:11.2674318Z    |
2025-11-18T07:14:11.2674484Z 42 |         # In-memory LRU cache for frequently accessed entries (acts as L1 cache)
2025-11-18T07:14:11.2674733Z 43 |         self._lru_cache: OrderedDict[tuple[int, int | None], tuple[list[dict[str, Any]], float]] = OrderedDict()
2025-11-18T07:14:11.2674795Z 44 |         
2025-11-18T07:14:11.2674852Z    | ^^^^^^^^
2025-11-18T07:14:11.2674922Z 45 |         # Cache metrics
2025-11-18T07:14:11.2674996Z 46 |         self._hit_count = 0
2025-11-18T07:14:11.2675052Z    |
2025-11-18T07:14:11.2675135Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2675141Z 
2025-11-18T07:14:11.2675220Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2675303Z   --> app/services/context_cache.py:75:1
2025-11-18T07:14:11.2675360Z    |
2025-11-18T07:14:11.2675449Z 73 |         cache_key = (chat_id, thread_id)
2025-11-18T07:14:11.2675522Z 74 |         now = time.time()
2025-11-18T07:14:11.2675580Z 75 |         
2025-11-18T07:14:11.2675637Z    | ^^^^^^^^
2025-11-18T07:14:11.2675731Z 76 |         # Check in-memory LRU cache first (L1)
2025-11-18T07:14:11.2675814Z 77 |         if cache_key in self._lru_cache:
2025-11-18T07:14:11.2675874Z    |
2025-11-18T07:14:11.2675956Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2675965Z 
2025-11-18T07:14:11.2676042Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2676124Z   --> app/services/context_cache.py:85:1
2025-11-18T07:14:11.2676180Z    |
2025-11-18T07:14:11.2676282Z 83 |                 self._last_access_times[cache_key] = now
2025-11-18T07:14:11.2676350Z 84 |                 return data
2025-11-18T07:14:11.2676407Z 85 |         
2025-11-18T07:14:11.2676466Z    | ^^^^^^^^
2025-11-18T07:14:11.2676539Z 86 |         # Check Redis cache (L2)
2025-11-18T07:14:11.2676614Z 87 |         if self._redis is None:
2025-11-18T07:14:11.2676673Z    |
2025-11-18T07:14:11.2676759Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2676764Z 
2025-11-18T07:14:11.2676842Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2676932Z    --> app/services/context_cache.py:137:1
2025-11-18T07:14:11.2677090Z     |
2025-11-18T07:14:11.2677186Z 135 |         cache_key = (chat_id, thread_id)
2025-11-18T07:14:11.2677257Z 136 |         now = time.time()
2025-11-18T07:14:11.2677315Z 137 |         
2025-11-18T07:14:11.2677376Z     | ^^^^^^^^
2025-11-18T07:14:11.2677497Z 138 |         # Calculate adaptive TTL based on access frequency
2025-11-18T07:14:11.2677605Z 139 |         ttl = self._calculate_adaptive_ttl(cache_key)
2025-11-18T07:14:11.2677665Z     |
2025-11-18T07:14:11.2677750Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2677755Z 
2025-11-18T07:14:11.2677833Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2677926Z    --> app/services/context_cache.py:140:1
2025-11-18T07:14:11.2678104Z     |
2025-11-18T07:14:11.2678221Z 138 |         # Calculate adaptive TTL based on access frequency
2025-11-18T07:14:11.2678322Z 139 |         ttl = self._calculate_adaptive_ttl(cache_key)
2025-11-18T07:14:11.2678385Z 140 |         
2025-11-18T07:14:11.2678444Z     | ^^^^^^^^
2025-11-18T07:14:11.2678518Z 141 |         # Store in LRU cache
2025-11-18T07:14:11.2678737Z 142 |         self._update_lru_cache(cache_key, context, now)
2025-11-18T07:14:11.2678794Z     |
2025-11-18T07:14:11.2678877Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2678883Z 
2025-11-18T07:14:11.2678962Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2679049Z    --> app/services/context_cache.py:144:1
2025-11-18T07:14:11.2679105Z     |
2025-11-18T07:14:11.2679213Z 142 |         self._update_lru_cache(cache_key, context, now)
2025-11-18T07:14:11.2679316Z 143 |         self._last_access_times[cache_key] = now
2025-11-18T07:14:11.2679374Z 144 |         
2025-11-18T07:14:11.2679431Z     | ^^^^^^^^
2025-11-18T07:14:11.2679507Z 145 |         # Store in Redis
2025-11-18T07:14:11.2679583Z 146 |         if self._redis is None:
2025-11-18T07:14:11.2679640Z     |
2025-11-18T07:14:11.2679724Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2679732Z 
2025-11-18T07:14:11.2679810Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2679901Z    --> app/services/context_cache.py:156:1
2025-11-18T07:14:11.2679959Z     |
2025-11-18T07:14:11.2680040Z 154 |         except Exception as exc:
2025-11-18T07:14:11.2680185Z 155 |             logger.warning(f"Redis context cache set failed: {exc}")
2025-11-18T07:14:11.2680244Z 156 |     
2025-11-18T07:14:11.2680304Z     | ^^^^
2025-11-18T07:14:11.2680379Z 157 |     def _update_lru_cache(
2025-11-18T07:14:11.2680439Z 158 |         self,
2025-11-18T07:14:11.2680497Z     |
2025-11-18T07:14:11.2680582Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2680588Z 
2025-11-18T07:14:11.2680666Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2680751Z    --> app/services/context_cache.py:171:1
2025-11-18T07:14:11.2680814Z     |
2025-11-18T07:14:11.2680937Z 169 |             if len(self._lru_cache) >= self._max_in_memory_size:
2025-11-18T07:14:11.2681065Z 170 |                 self._lru_cache.popitem(last=False)  # Remove oldest
2025-11-18T07:14:11.2681126Z 171 |         
2025-11-18T07:14:11.2681188Z     | ^^^^^^^^
2025-11-18T07:14:11.2681260Z 172 |         # Add/update entry
2025-11-18T07:14:11.2681357Z 173 |         self._lru_cache[cache_key] = (data, now)
2025-11-18T07:14:11.2681417Z     |
2025-11-18T07:14:11.2681500Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2681506Z 
2025-11-18T07:14:11.2681584Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2681674Z    --> app/services/context_cache.py:174:1
2025-11-18T07:14:11.2681731Z     |
2025-11-18T07:14:11.2681800Z 172 |         # Add/update entry
2025-11-18T07:14:11.2681894Z 173 |         self._lru_cache[cache_key] = (data, now)
2025-11-18T07:14:11.2681954Z 174 |     
2025-11-18T07:14:11.2682013Z     | ^^^^
2025-11-18T07:14:11.2682201Z 175 |     def _calculate_adaptive_ttl(self, cache_key: tuple[int, int | None]) -> int:
2025-11-18T07:14:11.2682262Z 176 |         """
2025-11-18T07:14:11.2682318Z     |
2025-11-18T07:14:11.2682402Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2682408Z 
2025-11-18T07:14:11.2682495Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2682581Z    --> app/services/context_cache.py:178:1
2025-11-18T07:14:11.2682639Z     |
2025-11-18T07:14:11.2682697Z 176 |         """
2025-11-18T07:14:11.2682820Z 177 |         Calculate adaptive TTL based on access frequency.
2025-11-18T07:14:11.2682881Z 178 |         
2025-11-18T07:14:11.2682943Z     | ^^^^^^^^
2025-11-18T07:14:11.2683048Z 179 |         Frequently accessed chats get longer TTL.
2025-11-18T07:14:11.2683108Z 180 |         """
2025-11-18T07:14:11.2683164Z     |
2025-11-18T07:14:11.2683246Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2683254Z 
2025-11-18T07:14:11.2683333Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2683510Z    --> app/services/context_cache.py:182:1
2025-11-18T07:14:11.2683568Z     |
2025-11-18T07:14:11.2683629Z 180 |         """
2025-11-18T07:14:11.2683703Z 181 |         base_ttl = self._base_ttl
2025-11-18T07:14:11.2683761Z 182 |         
2025-11-18T07:14:11.2683822Z     | ^^^^^^^^
2025-11-18T07:14:11.2683973Z 183 |         # Check access frequency
2025-11-18T07:14:11.2684069Z 184 |         if cache_key in self._last_access_times:
2025-11-18T07:14:11.2684125Z     |
2025-11-18T07:14:11.2684209Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2684214Z 
2025-11-18T07:14:11.2684291Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2684375Z    --> app/services/context_cache.py:187:1
2025-11-18T07:14:11.2684435Z     |
2025-11-18T07:14:11.2684527Z 185 |             # Recently accessed - extend TTL
2025-11-18T07:14:11.2684661Z 186 |             return int(base_ttl * 1.5)  # 50% longer for active chats
2025-11-18T07:14:11.2684721Z 187 |         
2025-11-18T07:14:11.2684783Z     | ^^^^^^^^
2025-11-18T07:14:11.2684853Z 188 |         return base_ttl
2025-11-18T07:14:11.2684911Z     |
2025-11-18T07:14:11.2684998Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2685004Z 
2025-11-18T07:14:11.2685081Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2685170Z    --> app/services/context_cache.py:189:1
2025-11-18T07:14:11.2685232Z     |
2025-11-18T07:14:11.2685300Z 188 |         return base_ttl
2025-11-18T07:14:11.2685359Z 189 |     
2025-11-18T07:14:11.2685415Z     | ^^^^
2025-11-18T07:14:11.2685517Z 190 |     def get_cache_stats(self) -> dict[str, Any]:
2025-11-18T07:14:11.2685576Z 191 |         """
2025-11-18T07:14:11.2685632Z     |
2025-11-18T07:14:11.2685718Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2685723Z 
2025-11-18T07:14:11.2685800Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2685886Z    --> app/services/context_cache.py:193:1
2025-11-18T07:14:11.2685942Z     |
2025-11-18T07:14:11.2686003Z 191 |         """
2025-11-18T07:14:11.2686099Z 192 |         Get cache performance statistics.
2025-11-18T07:14:11.2686159Z 193 |         
2025-11-18T07:14:11.2686219Z     | ^^^^^^^^
2025-11-18T07:14:11.2686284Z 194 |         Returns:
2025-11-18T07:14:11.2686392Z 195 |             Dictionary with hit/miss counts and hit rate
2025-11-18T07:14:11.2686455Z     |
2025-11-18T07:14:11.2686536Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2686542Z 
2025-11-18T07:14:11.2686619Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2686706Z    --> app/services/context_cache.py:199:1
2025-11-18T07:14:11.2686766Z     |
2025-11-18T07:14:11.2686869Z 197 |         total = self._hit_count + self._miss_count
2025-11-18T07:14:11.2687111Z 198 |         hit_rate = (self._hit_count / total * 100) if total > 0 else 0.0
2025-11-18T07:14:11.2687174Z 199 |         
2025-11-18T07:14:11.2687231Z     | ^^^^^^^^
2025-11-18T07:14:11.2687294Z 200 |         return {
2025-11-18T07:14:11.2687372Z 201 |             "hits": self._hit_count,
2025-11-18T07:14:11.2687435Z     |
2025-11-18T07:14:11.2687520Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2687525Z 
2025-11-18T07:14:11.2687624Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2687710Z   --> app/services/context_store.py:1:1
2025-11-18T07:14:11.2687770Z    |
2025-11-18T07:14:11.2687854Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.2687916Z  2 | |
2025-11-18T07:14:11.2687982Z  3 | | import asyncio
2025-11-18T07:14:11.2688044Z  4 | | import json
2025-11-18T07:14:11.2688109Z  5 | | import logging
2025-11-18T07:14:11.2688174Z  6 | | import time
2025-11-18T07:14:11.2688257Z  7 | | from dataclasses import dataclass
2025-11-18T07:14:11.2688336Z  8 | | from pathlib import Path
2025-11-18T07:14:11.2688418Z  9 | | from typing import Any, Iterable
2025-11-18T07:14:11.2688481Z 10 | | import math
2025-11-18T07:14:11.2688537Z 11 | |
2025-11-18T07:14:11.2688603Z 12 | | import asyncpg
2025-11-18T07:14:11.2688792Z 13 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2688976Z 14 | |
2025-11-18T07:14:11.2689113Z 15 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2689233Z 16 | | from app.services.context_cache import ContextCache
2025-11-18T07:14:11.2689342Z 17 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2689540Z    | |______________________________________________^
2025-11-18T07:14:11.2689599Z 18 |
2025-11-18T07:14:11.2689688Z 19 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2689744Z    |
2025-11-18T07:14:11.2689814Z help: Organize imports
2025-11-18T07:14:11.2689820Z 
2025-11-18T07:14:11.2689952Z UP035 [*] Import from `collections.abc` instead: `Iterable`
2025-11-18T07:14:11.2690038Z   --> app/services/context_store.py:9:1
2025-11-18T07:14:11.2690094Z    |
2025-11-18T07:14:11.2690179Z  7 | from dataclasses import dataclass
2025-11-18T07:14:11.2690259Z  8 | from pathlib import Path
2025-11-18T07:14:11.2690340Z  9 | from typing import Any, Iterable
2025-11-18T07:14:11.2690410Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2690475Z 10 | import math
2025-11-18T07:14:11.2690531Z    |
2025-11-18T07:14:11.2690615Z help: Import from `collections.abc`
2025-11-18T07:14:11.2690621Z 
2025-11-18T07:14:11.2690723Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2690814Z    --> app/services/context_store.py:302:9
2025-11-18T07:14:11.2690872Z     |
2025-11-18T07:14:11.2690978Z 300 |                 sender_is_bot = 1 if sender.is_bot else 0
2025-11-18T07:14:11.2691036Z 301 |
2025-11-18T07:14:11.2691237Z 302 |         from app.infrastructure.db_utils import get_db_connection, execute_with_retry
2025-11-18T07:14:11.2691324Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2691383Z 303 |
2025-11-18T07:14:11.2691456Z 304 |         message_id = 0
2025-11-18T07:14:11.2691513Z     |
2025-11-18T07:14:11.2691585Z help: Organize imports
2025-11-18T07:14:11.2691594Z 
2025-11-18T07:14:11.2691665Z W291 [*] Trailing whitespace
2025-11-18T07:14:11.2691757Z    --> app/services/context_store.py:340:28
2025-11-18T07:14:11.2691817Z     |
2025-11-18T07:14:11.2691896Z 339 |         await execute_with_retry(
2025-11-18T07:14:11.2691968Z 340 |             insert_message, 
2025-11-18T07:14:11.2692038Z     |                            ^
2025-11-18T07:14:11.2692112Z 341 |             max_retries=5,
2025-11-18T07:14:11.2692224Z 342 |             operation_name="add_message (insert_message)"
2025-11-18T07:14:11.2692281Z     |
2025-11-18T07:14:11.2692364Z help: Remove trailing whitespace
2025-11-18T07:14:11.2692369Z 
2025-11-18T07:14:11.2692441Z W291 Trailing whitespace
2025-11-18T07:14:11.2692529Z    --> app/services/context_store.py:460:39
2025-11-18T07:14:11.2692587Z     |
2025-11-18T07:14:11.2692654Z 458 |                     """
2025-11-18T07:14:11.2692743Z 459 |                     SELECT id FROM messages
2025-11-18T07:14:11.2692826Z 460 |                     WHERE chat_id = $1 
2025-11-18T07:14:11.2692904Z     |                                       ^
2025-11-18T07:14:11.2692988Z 461 |                       AND media IS NOT NULL 
2025-11-18T07:14:11.2693063Z 462 |                       AND media != ''
2025-11-18T07:14:11.2693122Z     |
2025-11-18T07:14:11.2693198Z help: Remove trailing whitespace
2025-11-18T07:14:11.2693206Z 
2025-11-18T07:14:11.2693277Z W291 Trailing whitespace
2025-11-18T07:14:11.2693365Z    --> app/services/context_store.py:461:44
2025-11-18T07:14:11.2693425Z     |
2025-11-18T07:14:11.2693507Z 459 |                     SELECT id FROM messages
2025-11-18T07:14:11.2693586Z 460 |                     WHERE chat_id = $1 
2025-11-18T07:14:11.2693670Z 461 |                       AND media IS NOT NULL 
2025-11-18T07:14:11.2693742Z     |                                            ^
2025-11-18T07:14:11.2693815Z 462 |                       AND media != ''
2025-11-18T07:14:11.2694022Z 463 |                       AND (media::jsonb->'meta'->>'message_id') = $2 
2025-11-18T07:14:11.2694164Z     |
2025-11-18T07:14:11.2694242Z help: Remove trailing whitespace
2025-11-18T07:14:11.2694247Z 
2025-11-18T07:14:11.2694317Z W291 Trailing whitespace
2025-11-18T07:14:11.2694407Z    --> app/services/context_store.py:463:69
2025-11-18T07:14:11.2694464Z     |
2025-11-18T07:14:11.2694546Z 461 |                       AND media IS NOT NULL 
2025-11-18T07:14:11.2694699Z 462 |                       AND media != ''
2025-11-18T07:14:11.2694812Z 463 |                       AND (media::jsonb->'meta'->>'message_id') = $2 
2025-11-18T07:14:11.2694890Z     |                                                                     ^
2025-11-18T07:14:11.2694961Z 464 |                     LIMIT 1
2025-11-18T07:14:11.2695028Z 465 |                     """,
2025-11-18T07:14:11.2695085Z     |
2025-11-18T07:14:11.2695161Z help: Remove trailing whitespace
2025-11-18T07:14:11.2695166Z 
2025-11-18T07:14:11.2695310Z F841 Local variable `stored_media` is assigned to but never used
2025-11-18T07:14:11.2695398Z    --> app/services/context_store.py:663:25
2025-11-18T07:14:11.2695460Z     |
2025-11-18T07:14:11.2695550Z 661 |                             stored_meta = meta
2025-11-18T07:14:11.2695652Z 662 |                     elif isinstance(payload, list):
2025-11-18T07:14:11.2695734Z 663 |                         stored_media = [
2025-11-18T07:14:11.2695810Z     |                         ^^^^^^^^^^^^
2025-11-18T07:14:11.2695942Z 664 |                             part for part in payload if isinstance(part, dict)
2025-11-18T07:14:11.2696007Z 665 |                         ]
2025-11-18T07:14:11.2696064Z     |
2025-11-18T07:14:11.2696194Z help: Remove assignment to unused variable `stored_media`
2025-11-18T07:14:11.2696200Z 
2025-11-18T07:14:11.2696306Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2696393Z    --> app/services/context_store.py:736:37
2025-11-18T07:14:11.2696453Z     |
2025-11-18T07:14:11.2696542Z 734 |         if not a or not b or len(a) != len(b):
2025-11-18T07:14:11.2696608Z 735 |             return 0.0
2025-11-18T07:14:11.2696702Z 736 |         dot = sum(x * y for x, y in zip(a, b))
2025-11-18T07:14:11.2696775Z     |                                     ^^^^^^^^^
2025-11-18T07:14:11.2696873Z 737 |         norm_a = math.sqrt(sum(x * x for x in a))
2025-11-18T07:14:11.2697065Z 738 |         norm_b = math.sqrt(sum(y * y for y in b))
2025-11-18T07:14:11.2697133Z     |
2025-11-18T07:14:11.2697239Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2697244Z 
2025-11-18T07:14:11.2697345Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2697436Z   --> app/services/currency.py:21:5
2025-11-18T07:14:11.2697494Z    |
2025-11-18T07:14:11.2697572Z 19 | # Import logging framework
2025-11-18T07:14:11.2697636Z 20 | try:
2025-11-18T07:14:11.2697806Z 21 |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2697886Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2697958Z 22 | except ImportError:
2025-11-18T07:14:11.2698061Z 23 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2698118Z    |
2025-11-18T07:14:11.2698189Z help: Organize imports
2025-11-18T07:14:11.2698195Z 
2025-11-18T07:14:11.2698305Z E731 Do not assign a `lambda` expression, use a `def`
2025-11-18T07:14:11.2698388Z   --> app/services/currency.py:24:5
2025-11-18T07:14:11.2698443Z    |
2025-11-18T07:14:11.2698513Z 22 | except ImportError:
2025-11-18T07:14:11.2698611Z 23 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2698757Z 24 |     log_tool_execution = lambda name: lambda f: f  # No-op decorator
2025-11-18T07:14:11.2698830Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2698905Z 25 |     ToolLogger = None
2025-11-18T07:14:11.2698961Z    |
2025-11-18T07:14:11.2699059Z help: Rewrite `log_tool_execution` as a `def`
2025-11-18T07:14:11.2699065Z 
2025-11-18T07:14:11.2699443Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2699650Z    --> app/services/currency.py:165:13
2025-11-18T07:14:11.2699707Z     |
2025-11-18T07:14:11.2699804Z 163 |         except aiohttp.ClientError as e:
2025-11-18T07:14:11.2699966Z 164 |             self.logger.error(f"Network error fetching exchange rates: {e}")
2025-11-18T07:14:11.2700275Z 165 |             raise ValueError("Помилка з'єднання з сервісом курсу валют")
2025-11-18T07:14:11.2700356Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2700417Z 166 |
2025-11-18T07:14:11.2700496Z 167 |     async def convert_currency(
2025-11-18T07:14:11.2700554Z     |
2025-11-18T07:14:11.2700559Z 
2025-11-18T07:14:11.2700920Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2701005Z    --> app/services/currency.py:225:13
2025-11-18T07:14:11.2701073Z     |
2025-11-18T07:14:11.2701264Z 223 |             if "валюта" in str(e).lower() or "currency" in str(e).lower():
2025-11-18T07:14:11.2701377Z 224 |                 raise  # Re-raise currency-specific errors
2025-11-18T07:14:11.2701554Z 225 |             raise ValueError(f"Помилка конвертації валют: {e}")
2025-11-18T07:14:11.2701648Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2701707Z 226 |
2025-11-18T07:14:11.2701817Z 227 |     def get_popular_currencies(self) -> list[str]:
2025-11-18T07:14:11.2701874Z     |
2025-11-18T07:14:11.2701879Z 
2025-11-18T07:14:11.2701980Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2702074Z   --> app/services/donation_scheduler.py:12:1
2025-11-18T07:14:11.2702129Z    |
2025-11-18T07:14:11.2702191Z 10 |   """
2025-11-18T07:14:11.2702246Z 11 |
2025-11-18T07:14:11.2702331Z 12 | / from __future__ import annotations
2025-11-18T07:14:11.2702388Z 13 | |
2025-11-18T07:14:11.2702456Z 14 | | import asyncio
2025-11-18T07:14:11.2702528Z 15 | | import logging
2025-11-18T07:14:11.2702594Z 16 | | import time
2025-11-18T07:14:11.2702674Z 17 | | from pathlib import Path
2025-11-18T07:14:11.2702758Z 18 | | from typing import TYPE_CHECKING
2025-11-18T07:14:11.2702815Z 19 | |
2025-11-18T07:14:11.2702881Z 20 | | import asyncpg
2025-11-18T07:14:11.2703074Z 21 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2703225Z 22 | | from apscheduler.schedulers.asyncio import AsyncIOScheduler
2025-11-18T07:14:11.2703344Z 23 | | from apscheduler.triggers.cron import CronTrigger
2025-11-18T07:14:11.2703404Z 24 | |
2025-11-18T07:14:11.2703537Z 25 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2703629Z    | |_________________________________________________________^
2025-11-18T07:14:11.2703689Z 26 |
2025-11-18T07:14:11.2703757Z 27 |   if TYPE_CHECKING:
2025-11-18T07:14:11.2703814Z    |
2025-11-18T07:14:11.2703883Z help: Organize imports
2025-11-18T07:14:11.2703891Z 
2025-11-18T07:14:11.2703974Z F401 [*] `asyncpg` imported but unused
2025-11-18T07:14:11.2704069Z   --> app/services/donation_scheduler.py:20:8
2025-11-18T07:14:11.2704124Z    |
2025-11-18T07:14:11.2704209Z 18 | from typing import TYPE_CHECKING
2025-11-18T07:14:11.2704266Z 19 |
2025-11-18T07:14:11.2704331Z 20 | import asyncpg
2025-11-18T07:14:11.2704394Z    |        ^^^^^^^
2025-11-18T07:14:11.2704579Z 21 | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2704722Z 22 | from apscheduler.schedulers.asyncio import AsyncIOScheduler
2025-11-18T07:14:11.2704780Z    |
2025-11-18T07:14:11.2704867Z help: Remove unused import: `asyncpg`
2025-11-18T07:14:11.2704872Z 
2025-11-18T07:14:11.2704971Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2705063Z   --> app/services/donation_scheduler.py:28:5
2025-11-18T07:14:11.2705122Z    |
2025-11-18T07:14:11.2705191Z 27 |   if TYPE_CHECKING:
2025-11-18T07:14:11.2705268Z 28 | /     from aiogram import Bot
2025-11-18T07:14:11.2705475Z 29 | |     from app.services.context_store import ContextStore
2025-11-18T07:14:11.2705569Z    | |_______________________________________________________^
2025-11-18T07:14:11.2705625Z 30 |
2025-11-18T07:14:11.2705711Z 31 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2705962Z    |
2025-11-18T07:14:11.2706032Z help: Organize imports
2025-11-18T07:14:11.2706037Z 
2025-11-18T07:14:11.2706120Z F401 [*] `aiosqlite` imported but unused
2025-11-18T07:14:11.2706211Z   --> app/services/embedding_cache.py:18:8
2025-11-18T07:14:11.2706267Z    |
2025-11-18T07:14:11.2706339Z 16 | from typing import Any
2025-11-18T07:14:11.2706395Z 17 |
2025-11-18T07:14:11.2706462Z 18 | import aiosqlite
2025-11-18T07:14:11.2706523Z    |        ^^^^^^^^^
2025-11-18T07:14:11.2706578Z 19 |
2025-11-18T07:14:11.2706710Z 20 | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2706766Z    |
2025-11-18T07:14:11.2706848Z help: Remove unused import: `aiosqlite`
2025-11-18T07:14:11.2706857Z 
2025-11-18T07:14:11.2707046Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2707144Z    --> app/services/embedding_cache.py:127:21
2025-11-18T07:14:11.2707202Z     |
2025-11-18T07:14:11.2707274Z 126 |                 LOGGER.debug(
2025-11-18T07:14:11.2707377Z 127 |                     f"Embedding cache hit (in-memory)",
2025-11-18T07:14:11.2707460Z     |                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2707580Z 128 |                     extra={"text_preview": text[:50], "model": model},
2025-11-18T07:14:11.2707644Z 129 |                 )
2025-11-18T07:14:11.2707701Z     |
2025-11-18T07:14:11.2707783Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2707789Z 
2025-11-18T07:14:11.2707874Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2707967Z    --> app/services/embedding_cache.py:165:37
2025-11-18T07:14:11.2708023Z     |
2025-11-18T07:14:11.2708150Z 164 | …                     LOGGER.debug(
2025-11-18T07:14:11.2708313Z 165 | …                         f"Embedding cache hit (persistent)",
2025-11-18T07:14:11.2708402Z     |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2708582Z 166 | …                         extra={"text_preview": text[:50], "model": model},
2025-11-18T07:14:11.2708683Z 167 | …                     )
2025-11-18T07:14:11.2708749Z     |
2025-11-18T07:14:11.2708829Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2708835Z 
2025-11-18T07:14:11.2708920Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2709014Z    --> app/services/embedding_cache.py:171:37
2025-11-18T07:14:11.2709070Z     |
2025-11-18T07:14:11.2709215Z 169 | …                     except json.JSONDecodeError:
2025-11-18T07:14:11.2709344Z 170 | …                         LOGGER.warning(
2025-11-18T07:14:11.2709501Z 171 | …                             f"Failed to decode cached embedding",
2025-11-18T07:14:11.2709587Z     |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2709748Z 172 | …                             extra={"text_hash": text_hash},
2025-11-18T07:14:11.2709848Z 173 | …                         )
2025-11-18T07:14:11.2709905Z     |
2025-11-18T07:14:11.2709984Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2709992Z 
2025-11-18T07:14:11.2710100Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2710199Z    --> app/services/embedding_cache.py:174:20
2025-11-18T07:14:11.2710256Z     |
2025-11-18T07:14:11.2710406Z 172 | …                             extra={"text_hash": text_hash},
2025-11-18T07:14:11.2710504Z 173 | …                         )
2025-11-18T07:14:11.2710626Z 174 | …     except asyncio.TimeoutError:
2025-11-18T07:14:11.2710697Z     |              ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2711145Z 175 | …         LOGGER.warning(f"Timeout accessing persistent embedding cache (10s timeout)", extra={"text_hash": text_hash, "model": model…
2025-11-18T07:14:11.2711334Z 176 | …         # Fall through to cache miss - don't block the request
2025-11-18T07:14:11.2711517Z     |
2025-11-18T07:14:11.2711674Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2711680Z 
2025-11-18T07:14:11.2711767Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2711859Z    --> app/services/embedding_cache.py:175:32
2025-11-18T07:14:11.2712026Z     |
2025-11-18T07:14:11.2712130Z 173 | …                         )
2025-11-18T07:14:11.2712256Z 174 | …     except asyncio.TimeoutError:
2025-11-18T07:14:11.2712688Z 175 | …         LOGGER.warning(f"Timeout accessing persistent embedding cache (10s timeout)", extra={"text_hash": text_hash, "model": model…
2025-11-18T07:14:11.2712784Z     |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2712964Z 176 | …         # Fall through to cache miss - don't block the request
2025-11-18T07:14:11.2713024Z     |
2025-11-18T07:14:11.2713107Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2713113Z 
2025-11-18T07:14:11.2713231Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2713324Z    --> app/services/embedding_cache.py:226:20
2025-11-18T07:14:11.2713384Z     |
2025-11-18T07:14:11.2713449Z 224 |                         )
2025-11-18T07:14:11.2713533Z 225 |                         await db.commit()
2025-11-18T07:14:11.2713635Z 226 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2713704Z     |                    ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2714013Z 227 |                 LOGGER.warning(f"Timeout persisting embedding to cache (10s timeout)", extra={"text_hash": text_hash, "model": model})
2025-11-18T07:14:11.2714211Z 228 |                 # Don't block the request if persistence fails - in-memory cache is sufficient
2025-11-18T07:14:11.2714270Z     |
2025-11-18T07:14:11.2714419Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2714425Z 
2025-11-18T07:14:11.2714514Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2714604Z    --> app/services/embedding_cache.py:227:32
2025-11-18T07:14:11.2714665Z     |
2025-11-18T07:14:11.2714749Z 225 |                         await db.commit()
2025-11-18T07:14:11.2714844Z 226 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2715151Z 227 |                 LOGGER.warning(f"Timeout persisting embedding to cache (10s timeout)", extra={"text_hash": text_hash, "model": model})
2025-11-18T07:14:11.2715245Z     |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2715434Z 228 |                 # Don't block the request if persistence fails - in-memory cache is sufficient
2025-11-18T07:14:11.2715515Z 229 |             except Exception as e:
2025-11-18T07:14:11.2715572Z     |
2025-11-18T07:14:11.2715659Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2715665Z 
2025-11-18T07:14:11.2715771Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2715865Z    --> app/services/embedding_cache.py:292:16
2025-11-18T07:14:11.2715930Z     |
2025-11-18T07:14:11.2716003Z 291 |                 return deleted
2025-11-18T07:14:11.2716090Z 292 |         except asyncio.TimeoutError:
2025-11-18T07:14:11.2716159Z     |                ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2716447Z 293 |             LOGGER.warning(f"Timeout pruning embedding cache (30s timeout)", extra={"retention_days": retention_days})
2025-11-18T07:14:11.2716519Z 294 |             return 0
2025-11-18T07:14:11.2716576Z     |
2025-11-18T07:14:11.2716725Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2716731Z 
2025-11-18T07:14:11.2716816Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2716907Z    --> app/services/embedding_cache.py:293:28
2025-11-18T07:14:11.2717068Z     |
2025-11-18T07:14:11.2717142Z 291 |                 return deleted
2025-11-18T07:14:11.2717226Z 292 |         except asyncio.TimeoutError:
2025-11-18T07:14:11.2717500Z 293 |             LOGGER.warning(f"Timeout pruning embedding cache (30s timeout)", extra={"retention_days": retention_days})
2025-11-18T07:14:11.2717711Z     |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2717777Z 294 |             return 0
2025-11-18T07:14:11.2717851Z 295 |         except Exception as e:
2025-11-18T07:14:11.2717910Z     |
2025-11-18T07:14:11.2718091Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2718097Z 
2025-11-18T07:14:11.2718215Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.2718359Z   --> app/services/fact_extractors/chat_fact_extractor.py:11:1
2025-11-18T07:14:11.2718416Z    |
2025-11-18T07:14:11.2718480Z  9 | import logging
2025-11-18T07:14:11.2718542Z 10 | import re
2025-11-18T07:14:11.2718643Z 11 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2718714Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2718771Z 12 |
2025-11-18T07:14:11.2718858Z 13 | from aiogram.types import Message
2025-11-18T07:14:11.2718915Z    |
2025-11-18T07:14:11.2718924Z 
2025-11-18T07:14:11.2719038Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2719174Z   --> app/services/fact_extractors/chat_fact_extractor.py:11:1
2025-11-18T07:14:11.2719230Z    |
2025-11-18T07:14:11.2719293Z  9 | import logging
2025-11-18T07:14:11.2719354Z 10 | import re
2025-11-18T07:14:11.2719454Z 11 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.2719523Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2719578Z 12 |
2025-11-18T07:14:11.2719664Z 13 | from aiogram.types import Message
2025-11-18T07:14:11.2719721Z    |
2025-11-18T07:14:11.2719726Z 
2025-11-18T07:14:11.2719842Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2719984Z   --> app/services/fact_extractors/chat_fact_extractor.py:48:19
2025-11-18T07:14:11.2720043Z    |
2025-11-18T07:14:11.2720121Z 46 |     async def extract_chat_facts(
2025-11-18T07:14:11.2720182Z 47 |         self,
2025-11-18T07:14:11.2720262Z 48 |         messages: List[Message],
2025-11-18T07:14:11.2720331Z    |                   ^^^^
2025-11-18T07:14:11.2720397Z 49 |         chat_id: int,
2025-11-18T07:14:11.2720468Z 50 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2720529Z    |
2025-11-18T07:14:11.2720604Z help: Replace with `list`
2025-11-18T07:14:11.2720610Z 
2025-11-18T07:14:11.2720728Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2720871Z   --> app/services/fact_extractors/chat_fact_extractor.py:50:10
2025-11-18T07:14:11.2720927Z    |
2025-11-18T07:14:11.2721002Z 48 |         messages: List[Message],
2025-11-18T07:14:11.2721071Z 49 |         chat_id: int,
2025-11-18T07:14:11.2721141Z 50 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2721200Z    |          ^^^^
2025-11-18T07:14:11.2721330Z 51 |         """Extract facts about the chat/group from conversation.
2025-11-18T07:14:11.2721391Z    |
2025-11-18T07:14:11.2721464Z help: Replace with `list`
2025-11-18T07:14:11.2721469Z 
2025-11-18T07:14:11.2721581Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2721721Z   --> app/services/fact_extractors/chat_fact_extractor.py:67:20
2025-11-18T07:14:11.2721780Z    |
2025-11-18T07:14:11.2721859Z 65 |             List of ChatFact objects
2025-11-18T07:14:11.2721923Z 66 |         """
2025-11-18T07:14:11.2722008Z 67 |         all_facts: List[ChatFact] = []
2025-11-18T07:14:11.2722076Z    |                    ^^^^
2025-11-18T07:14:11.2722132Z 68 |
2025-11-18T07:14:11.2722268Z 69 |         # Method 1: Pattern-based extraction (fast, 70% coverage)
2025-11-18T07:14:11.2722325Z    |
2025-11-18T07:14:11.2722397Z help: Replace with `list`
2025-11-18T07:14:11.2722403Z 
2025-11-18T07:14:11.2722517Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2722665Z    --> app/services/fact_extractors/chat_fact_extractor.py:118:25
2025-11-18T07:14:11.2722723Z     |
2025-11-18T07:14:11.2722810Z 117 |     async def _extract_via_patterns(
2025-11-18T07:14:11.2722915Z 118 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2723071Z     |                         ^^^^
2025-11-18T07:14:11.2723143Z 119 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2723273Z 120 |         """Pattern-based extraction for common chat facts."""
2025-11-18T07:14:11.2723330Z     |
2025-11-18T07:14:11.2723403Z help: Replace with `list`
2025-11-18T07:14:11.2723481Z 
2025-11-18T07:14:11.2723601Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2723745Z    --> app/services/fact_extractors/chat_fact_extractor.py:119:10
2025-11-18T07:14:11.2723802Z     |
2025-11-18T07:14:11.2723887Z 117 |     async def _extract_via_patterns(
2025-11-18T07:14:11.2723990Z 118 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2724060Z 119 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2724119Z     |          ^^^^
2025-11-18T07:14:11.2724246Z 120 |         """Pattern-based extraction for common chat facts."""
2025-11-18T07:14:11.2724311Z 121 |         facts = []
2025-11-18T07:14:11.2724370Z     |
2025-11-18T07:14:11.2724450Z help: Replace with `list`
2025-11-18T07:14:11.2724455Z 
2025-11-18T07:14:11.2724548Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2724690Z    --> app/services/fact_extractors/chat_fact_extractor.py:210:49
2025-11-18T07:14:11.2724747Z     |
2025-11-18T07:14:11.2724823Z 208 |         return facts
2025-11-18T07:14:11.2724883Z 209 |
2025-11-18T07:14:11.2725054Z 210 |     def _extract_preference(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2725143Z     |                                                 ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2725237Z 211 |         """Extract preference from text."""
2025-11-18T07:14:11.2725320Z 212 |         # Simple keyword extraction
2025-11-18T07:14:11.2725379Z     |
2025-11-18T07:14:11.2725453Z help: Convert to `X | None`
2025-11-18T07:14:11.2725458Z 
2025-11-18T07:14:11.2725571Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2725708Z    --> app/services/fact_extractors/chat_fact_extractor.py:210:58
2025-11-18T07:14:11.2725772Z     |
2025-11-18T07:14:11.2725839Z 208 |         return facts
2025-11-18T07:14:11.2725896Z 209 |
2025-11-18T07:14:11.2726063Z 210 |     def _extract_preference(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2726142Z     |                                                          ^^^^
2025-11-18T07:14:11.2726237Z 211 |         """Extract preference from text."""
2025-11-18T07:14:11.2726320Z 212 |         # Simple keyword extraction
2025-11-18T07:14:11.2726378Z     |
2025-11-18T07:14:11.2726450Z help: Replace with `dict`
2025-11-18T07:14:11.2726456Z 
2025-11-18T07:14:11.2726545Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2726685Z    --> app/services/fact_extractors/chat_fact_extractor.py:228:48
2025-11-18T07:14:11.2726742Z     |
2025-11-18T07:14:11.2726807Z 226 |         return None
2025-11-18T07:14:11.2726867Z 227 |
2025-11-18T07:14:11.2727128Z 228 |     def _extract_tradition(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2727215Z     |                                                ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2727308Z 229 |         """Extract tradition from text."""
2025-11-18T07:14:11.2727384Z 230 |         # Look for day patterns
2025-11-18T07:14:11.2727441Z     |
2025-11-18T07:14:11.2727517Z help: Convert to `X | None`
2025-11-18T07:14:11.2727522Z 
2025-11-18T07:14:11.2727638Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2727775Z    --> app/services/fact_extractors/chat_fact_extractor.py:228:57
2025-11-18T07:14:11.2727832Z     |
2025-11-18T07:14:11.2727899Z 226 |         return None
2025-11-18T07:14:11.2727955Z 227 |
2025-11-18T07:14:11.2728112Z 228 |     def _extract_tradition(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2728198Z     |                                                         ^^^^
2025-11-18T07:14:11.2728287Z 229 |         """Extract tradition from text."""
2025-11-18T07:14:11.2728361Z 230 |         # Look for day patterns
2025-11-18T07:14:11.2728538Z     |
2025-11-18T07:14:11.2728616Z help: Replace with `dict`
2025-11-18T07:14:11.2728621Z 
2025-11-18T07:14:11.2728712Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2728858Z    --> app/services/fact_extractors/chat_fact_extractor.py:243:43
2025-11-18T07:14:11.2729024Z     |
2025-11-18T07:14:11.2729093Z 241 |         return None
2025-11-18T07:14:11.2729151Z 242 |
2025-11-18T07:14:11.2729306Z 243 |     def _extract_rule(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2729390Z     |                                           ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2729476Z 244 |         """Extract rule from text."""
2025-11-18T07:14:11.2729561Z 245 |         # Look for forbidden topics
2025-11-18T07:14:11.2729623Z     |
2025-11-18T07:14:11.2729699Z help: Convert to `X | None`
2025-11-18T07:14:11.2729704Z 
2025-11-18T07:14:11.2729822Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2729976Z    --> app/services/fact_extractors/chat_fact_extractor.py:243:52
2025-11-18T07:14:11.2730038Z     |
2025-11-18T07:14:11.2730107Z 241 |         return None
2025-11-18T07:14:11.2730165Z 242 |
2025-11-18T07:14:11.2730316Z 243 |     def _extract_rule(self, text: str) -> Optional[Dict[str, str]]:
2025-11-18T07:14:11.2730396Z     |                                                    ^^^^
2025-11-18T07:14:11.2730482Z 244 |         """Extract rule from text."""
2025-11-18T07:14:11.2730568Z 245 |         # Look for forbidden topics
2025-11-18T07:14:11.2730625Z     |
2025-11-18T07:14:11.2730699Z help: Replace with `dict`
2025-11-18T07:14:11.2730704Z 
2025-11-18T07:14:11.2730800Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2730942Z    --> app/services/fact_extractors/chat_fact_extractor.py:258:44
2025-11-18T07:14:11.2731001Z     |
2025-11-18T07:14:11.2731068Z 256 |         return None
2025-11-18T07:14:11.2731126Z 257 |
2025-11-18T07:14:11.2731251Z 258 |     def _extract_topic(self, text: str) -> Optional[str]:
2025-11-18T07:14:11.2731337Z     |                                            ^^^^^^^^^^^^^
2025-11-18T07:14:11.2731438Z 259 |         """Extract discussed topic from text."""
2025-11-18T07:14:11.2731602Z 260 |         # Simple extraction - look for quoted text or keywords after verbs
2025-11-18T07:14:11.2731659Z     |
2025-11-18T07:14:11.2731741Z help: Convert to `X | None`
2025-11-18T07:14:11.2731746Z 
2025-11-18T07:14:11.2731866Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2732006Z    --> app/services/fact_extractors/chat_fact_extractor.py:272:25
2025-11-18T07:14:11.2732066Z     |
2025-11-18T07:14:11.2732163Z 271 |     async def _extract_statistical_facts(
2025-11-18T07:14:11.2732268Z 272 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2732338Z     |                         ^^^^
2025-11-18T07:14:11.2732415Z 273 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2732553Z 274 |         """Extract facts from message patterns and statistics."""
2025-11-18T07:14:11.2732615Z     |
2025-11-18T07:14:11.2732691Z help: Replace with `list`
2025-11-18T07:14:11.2732697Z 
2025-11-18T07:14:11.2732809Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2732950Z    --> app/services/fact_extractors/chat_fact_extractor.py:273:10
2025-11-18T07:14:11.2733014Z     |
2025-11-18T07:14:11.2733109Z 271 |     async def _extract_statistical_facts(
2025-11-18T07:14:11.2733207Z 272 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2733278Z 273 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2733342Z     |          ^^^^
2025-11-18T07:14:11.2733471Z 274 |         """Extract facts from message patterns and statistics."""
2025-11-18T07:14:11.2733538Z 275 |         facts = []
2025-11-18T07:14:11.2733599Z     |
2025-11-18T07:14:11.2733676Z help: Replace with `list`
2025-11-18T07:14:11.2733681Z 
2025-11-18T07:14:11.2733799Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2733949Z    --> app/services/fact_extractors/chat_fact_extractor.py:359:25
2025-11-18T07:14:11.2734092Z     |
2025-11-18T07:14:11.2734173Z 358 |     async def _extract_via_llm(
2025-11-18T07:14:11.2734277Z 359 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2734350Z     |                         ^^^^
2025-11-18T07:14:11.2734496Z 360 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2734631Z 361 |         """LLM-based extraction for complex chat dynamics."""
2025-11-18T07:14:11.2734692Z     |
2025-11-18T07:14:11.2734767Z help: Replace with `list`
2025-11-18T07:14:11.2734773Z 
2025-11-18T07:14:11.2734888Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2735031Z    --> app/services/fact_extractors/chat_fact_extractor.py:360:10
2025-11-18T07:14:11.2735089Z     |
2025-11-18T07:14:11.2735165Z 358 |     async def _extract_via_llm(
2025-11-18T07:14:11.2735264Z 359 |         self, messages: List[Message], chat_id: int
2025-11-18T07:14:11.2735341Z 360 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2735407Z     |          ^^^^
2025-11-18T07:14:11.2735531Z 361 |         """LLM-based extraction for complex chat dynamics."""
2025-11-18T07:14:11.2735617Z 362 |         if not self.gemini_client:
2025-11-18T07:14:11.2735675Z     |
2025-11-18T07:14:11.2735750Z help: Replace with `list`
2025-11-18T07:14:11.2735756Z 
2025-11-18T07:14:11.2735872Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2736020Z    --> app/services/fact_extractors/chat_fact_extractor.py:469:22
2025-11-18T07:14:11.2736077Z     |
2025-11-18T07:14:11.2736171Z 468 |     async def _deduplicate_chat_facts(
2025-11-18T07:14:11.2736276Z 469 |         self, facts: List[ChatFact], chat_id: int
2025-11-18T07:14:11.2736343Z     |                      ^^^^
2025-11-18T07:14:11.2736414Z 470 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2736533Z 471 |         """Deduplicate chat facts by key and similarity.
2025-11-18T07:14:11.2736590Z     |
2025-11-18T07:14:11.2736663Z help: Replace with `list`
2025-11-18T07:14:11.2736672Z 
2025-11-18T07:14:11.2736782Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2736925Z    --> app/services/fact_extractors/chat_fact_extractor.py:470:10
2025-11-18T07:14:11.2737076Z     |
2025-11-18T07:14:11.2737169Z 468 |     async def _deduplicate_chat_facts(
2025-11-18T07:14:11.2737273Z 469 |         self, facts: List[ChatFact], chat_id: int
2025-11-18T07:14:11.2737345Z 470 |     ) -> List[ChatFact]:
2025-11-18T07:14:11.2737404Z     |          ^^^^
2025-11-18T07:14:11.2737519Z 471 |         """Deduplicate chat facts by key and similarity.
2025-11-18T07:14:11.2737575Z     |
2025-11-18T07:14:11.2737651Z help: Replace with `list`
2025-11-18T07:14:11.2737656Z 
2025-11-18T07:14:11.2737765Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.2737904Z    --> app/services/fact_extractors/chat_fact_extractor.py:484:17
2025-11-18T07:14:11.2737963Z     |
2025-11-18T07:14:11.2738033Z 483 |         # Group by key
2025-11-18T07:14:11.2738131Z 484 |         by_key: Dict[str, List[ChatFact]] = {}
2025-11-18T07:14:11.2738201Z     |                 ^^^^
2025-11-18T07:14:11.2738276Z 485 |         for fact in facts:
2025-11-18T07:14:11.2738387Z 486 |             key = f"{fact.fact_category}:{fact.fact_key}"
2025-11-18T07:14:11.2738445Z     |
2025-11-18T07:14:11.2738518Z help: Replace with `dict`
2025-11-18T07:14:11.2738526Z 
2025-11-18T07:14:11.2738636Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2738778Z    --> app/services/fact_extractors/chat_fact_extractor.py:484:27
2025-11-18T07:14:11.2738835Z     |
2025-11-18T07:14:11.2738903Z 483 |         # Group by key
2025-11-18T07:14:11.2738998Z 484 |         by_key: Dict[str, List[ChatFact]] = {}
2025-11-18T07:14:11.2739066Z     |                           ^^^^
2025-11-18T07:14:11.2739139Z 485 |         for fact in facts:
2025-11-18T07:14:11.2739247Z 486 |             key = f"{fact.fact_category}:{fact.fact_key}"
2025-11-18T07:14:11.2739303Z     |
2025-11-18T07:14:11.2739376Z help: Replace with `list`
2025-11-18T07:14:11.2739499Z 
2025-11-18T07:14:11.2739627Z B007 Loop control variable `key` not used within loop body
2025-11-18T07:14:11.2739769Z    --> app/services/fact_extractors/chat_fact_extractor.py:491:13
2025-11-18T07:14:11.2739827Z     |
2025-11-18T07:14:11.2739929Z 489 |         # For each key, keep highest confidence
2025-11-18T07:14:11.2740109Z 490 |         deduplicated = []
2025-11-18T07:14:11.2740207Z 491 |         for key, key_facts in by_key.items():
2025-11-18T07:14:11.2740271Z     |             ^^^
2025-11-18T07:14:11.2740347Z 492 |             # Sort by confidence
2025-11-18T07:14:11.2740488Z 493 |             key_facts.sort(key=lambda f: f.confidence, reverse=True)
2025-11-18T07:14:11.2740547Z     |
2025-11-18T07:14:11.2740633Z help: Rename unused `key` to `_key`
2025-11-18T07:14:11.2740638Z 
2025-11-18T07:14:11.2740745Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2740861Z   --> app/services/fact_extractors/normalizers.py:8:1
2025-11-18T07:14:11.2740922Z    |
2025-11-18T07:14:11.2740984Z  6 |   """
2025-11-18T07:14:11.2741041Z  7 |
2025-11-18T07:14:11.2741126Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2741184Z  9 | |
2025-11-18T07:14:11.2741251Z 10 | | import re
2025-11-18T07:14:11.2741324Z 11 | | import unicodedata
2025-11-18T07:14:11.2741399Z 12 | | from typing import Any
2025-11-18T07:14:11.2741471Z    | |______________________^
2025-11-18T07:14:11.2741527Z    |
2025-11-18T07:14:11.2741597Z help: Organize imports
2025-11-18T07:14:11.2741602Z 
2025-11-18T07:14:11.2741693Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2741796Z   --> app/services/feature_rate_limiter.py:33:21
2025-11-18T07:14:11.2741855Z    |
2025-11-18T07:14:11.2741920Z 31 | import asyncio
2025-11-18T07:14:11.2741987Z 32 | import time
2025-11-18T07:14:11.2742065Z 33 | from pathlib import Path
2025-11-18T07:14:11.2742128Z    |                     ^^^^
2025-11-18T07:14:11.2742203Z 34 | from typing import Tuple
2025-11-18T07:14:11.2742261Z    |
2025-11-18T07:14:11.2742361Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2742366Z 
2025-11-18T07:14:11.2742492Z UP035 `typing.Tuple` is deprecated, use `tuple` instead
2025-11-18T07:14:11.2742594Z   --> app/services/feature_rate_limiter.py:34:1
2025-11-18T07:14:11.2742652Z    |
2025-11-18T07:14:11.2742717Z 32 | import time
2025-11-18T07:14:11.2742799Z 33 | from pathlib import Path
2025-11-18T07:14:11.2742874Z 34 | from typing import Tuple
2025-11-18T07:14:11.2742937Z    | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2742994Z 35 |
2025-11-18T07:14:11.2743136Z 36 | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2743192Z    |
2025-11-18T07:14:11.2743197Z 
2025-11-18T07:14:11.2743322Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2743426Z    --> app/services/feature_rate_limiter.py:150:10
2025-11-18T07:14:11.2743486Z     |
2025-11-18T07:14:11.2743576Z 148 |         limit_per_hour: int | None = None,
2025-11-18T07:14:11.2743667Z 149 |         window_seconds: int | None = None,
2025-11-18T07:14:11.2743753Z 150 |     ) -> Tuple[bool, int, bool]:
2025-11-18T07:14:11.2743816Z     |          ^^^^^
2025-11-18T07:14:11.2743876Z 151 |         """
2025-11-18T07:14:11.2743998Z 152 |         Check if user is within rate limit for a feature.
2025-11-18T07:14:11.2744059Z     |
2025-11-18T07:14:11.2744136Z help: Replace with `tuple`
2025-11-18T07:14:11.2744142Z 
2025-11-18T07:14:11.2744263Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2744363Z    --> app/services/feature_rate_limiter.py:302:10
2025-11-18T07:14:11.2744420Z     |
2025-11-18T07:14:11.2744492Z 300 |         feature: str,
2025-11-18T07:14:11.2744582Z 301 |         cooldown_seconds: int | None = None,
2025-11-18T07:14:11.2744660Z 302 |     ) -> Tuple[bool, int, bool]:
2025-11-18T07:14:11.2744721Z     |          ^^^^^
2025-11-18T07:14:11.2744785Z 303 |         """
2025-11-18T07:14:11.2744947Z 304 |         Check if user has waited long enough since last request (cooldown).
2025-11-18T07:14:11.2745094Z     |
2025-11-18T07:14:11.2745173Z help: Replace with `tuple`
2025-11-18T07:14:11.2745179Z 
2025-11-18T07:14:11.2745277Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2745362Z   --> app/services/gemini.py:1:1
2025-11-18T07:14:11.2745419Z    |
2025-11-18T07:14:11.2745580Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.2745637Z  2 | |
2025-11-18T07:14:11.2745704Z  3 | | import base64
2025-11-18T07:14:11.2745776Z  4 | | import asyncio
2025-11-18T07:14:11.2745841Z  5 | | import inspect
2025-11-18T07:14:11.2745906Z  6 | | import json
2025-11-18T07:14:11.2745972Z  7 | | import logging
2025-11-18T07:14:11.2746040Z  8 | | import random
2025-11-18T07:14:11.2746105Z  9 | | import time
2025-11-18T07:14:11.2746249Z 10 | | from typing import Any, Awaitable, Callable, Iterable, cast
2025-11-18T07:14:11.2746310Z 11 | |
2025-11-18T07:14:11.2746387Z 12 | | from google import genai
2025-11-18T07:14:11.2746470Z 13 | | from google.genai import types
2025-11-18T07:14:11.2746577Z 14 | | from google.genai.errors import ServerError
2025-11-18T07:14:11.2746635Z 15 | |
2025-11-18T07:14:11.2746721Z 16 | | from app.services import telemetry
2025-11-18T07:14:11.2746857Z 17 | | from app.services.embedding_cache import EmbeddingCache
2025-11-18T07:14:11.2747061Z 18 | | from app.services.media import MAX_INLINE_SIZE
2025-11-18T07:14:11.2747148Z    | |______________________________________________^
2025-11-18T07:14:11.2747206Z    |
2025-11-18T07:14:11.2747281Z help: Organize imports
2025-11-18T07:14:11.2747287Z 
2025-11-18T07:14:11.2747370Z F401 [*] `inspect` imported but unused
2025-11-18T07:14:11.2747453Z  --> app/services/gemini.py:5:8
2025-11-18T07:14:11.2747512Z   |
2025-11-18T07:14:11.2747580Z 3 | import base64
2025-11-18T07:14:11.2747644Z 4 | import asyncio
2025-11-18T07:14:11.2747707Z 5 | import inspect
2025-11-18T07:14:11.2747768Z   |        ^^^^^^^
2025-11-18T07:14:11.2747830Z 6 | import json
2025-11-18T07:14:11.2747892Z 7 | import logging
2025-11-18T07:14:11.2747954Z   |
2025-11-18T07:14:11.2748042Z help: Remove unused import: `inspect`
2025-11-18T07:14:11.2748047Z 
2025-11-18T07:14:11.2748246Z UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`, `Iterable`
2025-11-18T07:14:11.2748330Z   --> app/services/gemini.py:10:1
2025-11-18T07:14:11.2748390Z    |
2025-11-18T07:14:11.2748457Z  8 | import random
2025-11-18T07:14:11.2748521Z  9 | import time
2025-11-18T07:14:11.2748665Z 10 | from typing import Any, Awaitable, Callable, Iterable, cast
2025-11-18T07:14:11.2748745Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2748803Z 11 |
2025-11-18T07:14:11.2748879Z 12 | from google import genai
2025-11-18T07:14:11.2748941Z    |
2025-11-18T07:14:11.2749026Z help: Import from `collections.abc`
2025-11-18T07:14:11.2749031Z 
2025-11-18T07:14:11.2749109Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2749192Z    --> app/services/gemini.py:388:1
2025-11-18T07:14:11.2749250Z     |
2025-11-18T07:14:11.2749314Z 386 |         """
2025-11-18T07:14:11.2749541Z 387 |         Remove internal metadata fields (mime, kind) from media parts before sending to API.
2025-11-18T07:14:11.2749602Z 388 |         
2025-11-18T07:14:11.2749660Z     | ^^^^^^^^
2025-11-18T07:14:11.2749866Z 389 |         The build_media_parts method adds mime and kind fields for internal use, but these
2025-11-18T07:14:11.2750053Z 390 |         are not part of the Gemini API schema and cause Pydantic validation errors.
2025-11-18T07:14:11.2750111Z     |
2025-11-18T07:14:11.2750198Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2750203Z 
2025-11-18T07:14:11.2750285Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2750362Z    --> app/services/gemini.py:391:1
2025-11-18T07:14:11.2750419Z     |
2025-11-18T07:14:11.2750618Z 389 |         The build_media_parts method adds mime and kind fields for internal use, but these
2025-11-18T07:14:11.2750793Z 390 |         are not part of the Gemini API schema and cause Pydantic validation errors.
2025-11-18T07:14:11.2750970Z 391 |         
2025-11-18T07:14:11.2751029Z     | ^^^^^^^^
2025-11-18T07:14:11.2751094Z 392 |         Args:
2025-11-18T07:14:11.2751262Z 393 |             contents: List of Content objects with parts that may contain media
2025-11-18T07:14:11.2751319Z     |
2025-11-18T07:14:11.2751409Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2751552Z 
2025-11-18T07:14:11.2751633Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2751714Z    --> app/services/gemini.py:394:1
2025-11-18T07:14:11.2751774Z     |
2025-11-18T07:14:11.2751836Z 392 |         Args:
2025-11-18T07:14:11.2752002Z 393 |             contents: List of Content objects with parts that may contain media
2025-11-18T07:14:11.2752063Z 394 |             
2025-11-18T07:14:11.2752125Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2752190Z 395 |         Returns:
2025-11-18T07:14:11.2752346Z 396 |             Contents with mime and kind fields removed from all media parts
2025-11-18T07:14:11.2752407Z     |
2025-11-18T07:14:11.2752507Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2752512Z 
2025-11-18T07:14:11.2752591Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2752674Z    --> app/services/gemini.py:403:1
2025-11-18T07:14:11.2752762Z     |
2025-11-18T07:14:11.2752863Z 401 |                 cleaned_contents.append(content)
2025-11-18T07:14:11.2752936Z 402 |                 continue
2025-11-18T07:14:11.2753001Z 403 |                 
2025-11-18T07:14:11.2753063Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2753138Z 404 |             cleaned_content = {}
2025-11-18T07:14:11.2753238Z 405 |             for key, value in content.items():
2025-11-18T07:14:11.2753295Z     |
2025-11-18T07:14:11.2753378Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2753384Z 
2025-11-18T07:14:11.2753461Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2753544Z    --> app/services/gemini.py:431:1
2025-11-18T07:14:11.2753602Z     |
2025-11-18T07:14:11.2753693Z 429 |                     cleaned_content[key] = value
2025-11-18T07:14:11.2753809Z 430 |             cleaned_contents.append(cleaned_content)
2025-11-18T07:14:11.2753869Z 431 |         
2025-11-18T07:14:11.2753929Z     | ^^^^^^^^
2025-11-18T07:14:11.2754006Z 432 |         return cleaned_contents
2025-11-18T07:14:11.2754066Z     |
2025-11-18T07:14:11.2754149Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2754157Z 
2025-11-18T07:14:11.2754295Z B007 Loop control variable `attempt` not used within loop body
2025-11-18T07:14:11.2754381Z    --> app/services/gemini.py:477:13
2025-11-18T07:14:11.2754438Z     |
2025-11-18T07:14:11.2754585Z 475 |         server_error_retries = 3  # Retry server errors up to 3 times
2025-11-18T07:14:11.2754648Z 476 |
2025-11-18T07:14:11.2754745Z 477 |         for attempt in range(max(1, attempts)):
2025-11-18T07:14:11.2754811Z     |             ^^^^^^^
2025-11-18T07:14:11.2754916Z 478 |             client, key = await self._acquire_client()
2025-11-18T07:14:11.2754977Z     |
2025-11-18T07:14:11.2755069Z help: Rename unused `attempt` to `_attempt`
2025-11-18T07:14:11.2755077Z 
2025-11-18T07:14:11.2755186Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2755271Z    --> app/services/gemini.py:496:24
2025-11-18T07:14:11.2755327Z     |
2025-11-18T07:14:11.2755391Z 494 |                     )
2025-11-18T07:14:11.2755473Z 495 |                     return response
2025-11-18T07:14:11.2755581Z 496 |                 except asyncio.TimeoutError as exc:
2025-11-18T07:14:11.2755657Z     |                        ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2755793Z 497 |                     raise GeminiError("Gemini request timed out") from exc
2025-11-18T07:14:11.2755885Z 498 |                 except Exception as exc:
2025-11-18T07:14:11.2755943Z     |
2025-11-18T07:14:11.2756093Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2756099Z 
2025-11-18T07:14:11.2756182Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2756268Z     --> app/services/gemini.py:1001:1
2025-11-18T07:14:11.2756412Z      |
2025-11-18T07:14:11.2756494Z  999 |                 if finish_reason:
2025-11-18T07:14:11.2756659Z 1000 |                     self._logger.info(f"Candidate finish_reason: {finish_reason}")
2025-11-18T07:14:11.2756725Z 1001 |                     
2025-11-18T07:14:11.2756789Z      | ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2757100Z 1002 |                     # Check if content was blocked due to safety filters
2025-11-18T07:14:11.2757222Z 1003 |                     if "PROHIBITED_CONTENT" in str(finish_reason):
2025-11-18T07:14:11.2757281Z      |
2025-11-18T07:14:11.2757369Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2757376Z 
2025-11-18T07:14:11.2757505Z F841 Local variable `err_text` is assigned to but never used
2025-11-18T07:14:11.2757590Z     --> app/services/gemini.py:1167:17
2025-11-18T07:14:11.2757649Z      |
2025-11-18T07:14:11.2757715Z 1165 |                 )
2025-11-18T07:14:11.2757827Z 1166 |             except Exception as exc:  # pragma: no cover
2025-11-18T07:14:11.2757909Z 1167 |                 err_text = str(exc)
2025-11-18T07:14:11.2757979Z      |                 ^^^^^^^^
2025-11-18T07:14:11.2758070Z 1168 |                 self._logger.exception(
2025-11-18T07:14:11.2758205Z 1169 |                     "Gemini tool-followup failed; retrying without tools"
2025-11-18T07:14:11.2758270Z      |
2025-11-18T07:14:11.2758383Z help: Remove assignment to unused variable `err_text`
2025-11-18T07:14:11.2758389Z 
2025-11-18T07:14:11.2758507Z F841 [*] Local variable `exc` is assigned to but never used
2025-11-18T07:14:11.2758591Z     --> app/services/gemini.py:1225:37
2025-11-18T07:14:11.2758649Z      |
2025-11-18T07:14:11.2758736Z 1223 |                         system_instruction,
2025-11-18T07:14:11.2758802Z 1224 |                     )
2025-11-18T07:14:11.2758897Z 1225 |                 except Exception as exc:
2025-11-18T07:14:11.2758971Z      |                                     ^^^
2025-11-18T07:14:11.2759151Z 1226 |                     self._logger.exception("Failed to force text response after tools")
2025-11-18T07:14:11.2759313Z 1227 |                     # Continue with current_response - handler will use fallback
2025-11-18T07:14:11.2759371Z      |
2025-11-18T07:14:11.2759475Z help: Remove assignment to unused variable `exc`
2025-11-18T07:14:11.2759480Z 
2025-11-18T07:14:11.2759585Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2759680Z   --> app/services/image_generation.py:8:1
2025-11-18T07:14:11.2759738Z    |
2025-11-18T07:14:11.2759800Z  6 |   """
2025-11-18T07:14:11.2759857Z  7 |
2025-11-18T07:14:11.2759940Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2759997Z  9 | |
2025-11-18T07:14:11.2760069Z 10 | | import asyncio
2025-11-18T07:14:11.2760135Z 11 | | import base64
2025-11-18T07:14:11.2760202Z 12 | | import logging
2025-11-18T07:14:11.2760267Z 13 | | import time
2025-11-18T07:14:11.2760365Z 14 | | from datetime import datetime, timezone
2025-11-18T07:14:11.2760438Z 15 | | from io import BytesIO
2025-11-18T07:14:11.2760520Z 16 | | from pathlib import Path
2025-11-18T07:14:11.2760597Z 17 | | from typing import Any
2025-11-18T07:14:11.2760653Z 18 | |
2025-11-18T07:14:11.2760719Z 19 | | import asyncpg
2025-11-18T07:14:11.2760910Z 20 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2761053Z 21 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2761130Z 22 | | from google import genai
2025-11-18T07:14:11.2761213Z 23 | | from google.genai import types
2025-11-18T07:14:11.2761291Z 24 | | from PIL import Image
2025-11-18T07:14:11.2761355Z    | |_____________________^
2025-11-18T07:14:11.2761412Z 25 |
2025-11-18T07:14:11.2761475Z 26 |   try:
2025-11-18T07:14:11.2761531Z    |
2025-11-18T07:14:11.2761601Z help: Organize imports
2025-11-18T07:14:11.2761607Z 
2025-11-18T07:14:11.2761684Z F401 [*] `base64` imported but unused
2025-11-18T07:14:11.2761787Z   --> app/services/image_generation.py:11:8
2025-11-18T07:14:11.2761844Z    |
2025-11-18T07:14:11.2762029Z 10 | import asyncio
2025-11-18T07:14:11.2762098Z 11 | import base64
2025-11-18T07:14:11.2762157Z    |        ^^^^^^
2025-11-18T07:14:11.2762220Z 12 | import logging
2025-11-18T07:14:11.2762283Z 13 | import time
2025-11-18T07:14:11.2762343Z    |
2025-11-18T07:14:11.2762426Z help: Remove unused import: `base64`
2025-11-18T07:14:11.2762532Z 
2025-11-18T07:14:11.2762632Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2762730Z   --> app/services/image_generation.py:16:21
2025-11-18T07:14:11.2762787Z    |
2025-11-18T07:14:11.2762877Z 14 | from datetime import datetime, timezone
2025-11-18T07:14:11.2762951Z 15 | from io import BytesIO
2025-11-18T07:14:11.2763029Z 16 | from pathlib import Path
2025-11-18T07:14:11.2763091Z    |                     ^^^^
2025-11-18T07:14:11.2763163Z 17 | from typing import Any
2025-11-18T07:14:11.2763225Z    |
2025-11-18T07:14:11.2763318Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2763324Z 
2025-11-18T07:14:11.2763422Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2763520Z   --> app/services/image_generation.py:27:5
2025-11-18T07:14:11.2763576Z    |
2025-11-18T07:14:11.2763636Z 26 | try:
2025-11-18T07:14:11.2763804Z 27 |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2763889Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2763965Z 28 | except ImportError:
2025-11-18T07:14:11.2764068Z 29 |     log_tool_execution = lambda name: lambda f: f
2025-11-18T07:14:11.2764127Z    |
2025-11-18T07:14:11.2764198Z help: Organize imports
2025-11-18T07:14:11.2764204Z 
2025-11-18T07:14:11.2764312Z E731 Do not assign a `lambda` expression, use a `def`
2025-11-18T07:14:11.2764405Z   --> app/services/image_generation.py:29:5
2025-11-18T07:14:11.2764464Z    |
2025-11-18T07:14:11.2764624Z 27 |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2764696Z 28 | except ImportError:
2025-11-18T07:14:11.2764801Z 29 |     log_tool_execution = lambda name: lambda f: f
2025-11-18T07:14:11.2764875Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2764947Z 30 |     ToolLogger = None
2025-11-18T07:14:11.2765008Z    |
2025-11-18T07:14:11.2765104Z help: Rewrite `log_tool_execution` as a `def`
2025-11-18T07:14:11.2765113Z 
2025-11-18T07:14:11.2765192Z UP017 [*] Use `datetime.UTC` alias
2025-11-18T07:14:11.2765289Z   --> app/services/image_generation.py:84:29
2025-11-18T07:14:11.2765346Z    |
2025-11-18T07:14:11.2765431Z 82 |     def _get_today_date(self) -> str:
2025-11-18T07:14:11.2765543Z 83 |         """Get today's date in YYYY-MM-DD format (UTC)."""
2025-11-18T07:14:11.2765683Z 84 |         return datetime.now(timezone.utc).strftime("%Y-%m-%d")
2025-11-18T07:14:11.2765754Z    |                             ^^^^^^^^^^^^
2025-11-18T07:14:11.2765811Z 85 |
2025-11-18T07:14:11.2765910Z 86 |     def _is_admin(self, user_id: int) -> bool:
2025-11-18T07:14:11.2765967Z    |
2025-11-18T07:14:11.2766056Z help: Convert to `datetime.UTC` alias
2025-11-18T07:14:11.2766061Z 
2025-11-18T07:14:11.2766171Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2766268Z    --> app/services/image_generation.py:227:20
2025-11-18T07:14:11.2766326Z     |
2025-11-18T07:14:11.2766399Z 225 |                     timeout=90.0,
2025-11-18T07:14:11.2766467Z 226 |                 )
2025-11-18T07:14:11.2766560Z 227 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2766632Z     |                    ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2766801Z 228 |                 self.logger.error("Image generation timed out after 90 seconds")
2025-11-18T07:14:11.2766895Z 229 |                 raise ImageGenerationError(
2025-11-18T07:14:11.2767047Z     |
2025-11-18T07:14:11.2767206Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2767212Z 
2025-11-18T07:14:11.2767586Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2767799Z    --> app/services/image_generation.py:229:17
2025-11-18T07:14:11.2767859Z     |
2025-11-18T07:14:11.2767953Z 227 |               except asyncio.TimeoutError:
2025-11-18T07:14:11.2768119Z 228 |                   self.logger.error("Image generation timed out after 90 seconds")
2025-11-18T07:14:11.2768314Z 229 | /                 raise ImageGenerationError(
2025-11-18T07:14:11.2768545Z 230 | |                     "Генерація зображення зайняла забагато часу. Спробуй ще раз або спрости запит."
2025-11-18T07:14:11.2768613Z 231 | |                 )
2025-11-18T07:14:11.2768677Z     | |_________________^
2025-11-18T07:14:11.2768737Z 232 |
2025-11-18T07:14:11.2768838Z 233 |               # Extract image from response safely
2025-11-18T07:14:11.2768896Z     |
2025-11-18T07:14:11.2768900Z 
2025-11-18T07:14:11.2768984Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2769078Z    --> app/services/image_generation.py:326:1
2025-11-18T07:14:11.2769144Z     |
2025-11-18T07:14:11.2769229Z 325 |         today = self._get_today_date()
2025-11-18T07:14:11.2769292Z 326 |         
2025-11-18T07:14:11.2769352Z     | ^^^^^^^^
2025-11-18T07:14:11.2769459Z 327 |         query, params = convert_query_to_postgres(
2025-11-18T07:14:11.2769526Z 328 |             """
2025-11-18T07:14:11.2769590Z     |
2025-11-18T07:14:11.2769679Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2769684Z 
2025-11-18T07:14:11.2769762Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2772970Z    --> app/services/image_generation.py:362:1
2025-11-18T07:14:11.2773056Z     |
2025-11-18T07:14:11.2773164Z 361 |         today = self._get_today_date()
2025-11-18T07:14:11.2773230Z 362 |         
2025-11-18T07:14:11.2773289Z     | ^^^^^^^^
2025-11-18T07:14:11.2773410Z 363 |         query, params = convert_query_to_postgres(
2025-11-18T07:14:11.2773474Z 364 |             """
2025-11-18T07:14:11.2773536Z     |
2025-11-18T07:14:11.2773629Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2773643Z 
2025-11-18T07:14:11.2773750Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2773838Z   --> app/services/media.py:1:1
2025-11-18T07:14:11.2773895Z    |
2025-11-18T07:14:11.2773982Z  1 | / from __future__ import annotations
2025-11-18T07:14:11.2774047Z  2 | |
2025-11-18T07:14:11.2774110Z  3 | | import re
2025-11-18T07:14:11.2774177Z  4 | | import time
2025-11-18T07:14:11.2774266Z  5 | | from collections import defaultdict
2025-11-18T07:14:11.2774345Z  6 | | from typing import Any
2025-11-18T07:14:11.2774431Z  7 | | from urllib.parse import quote
2025-11-18T07:14:11.2774488Z  8 | |
2025-11-18T07:14:11.2774558Z  9 | | import aiohttp
2025-11-18T07:14:11.2774633Z 10 | | from aiogram import Bot
2025-11-18T07:14:11.2774721Z 11 | | from aiogram.types import Message
2025-11-18T07:14:11.2774788Z 12 | | import asyncio
2025-11-18T07:14:11.2774855Z 13 | | import logging
2025-11-18T07:14:11.2774916Z    | |______________^
2025-11-18T07:14:11.2774973Z    |
2025-11-18T07:14:11.2775049Z help: Organize imports
2025-11-18T07:14:11.2775055Z 
2025-11-18T07:14:11.2775170Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2775259Z   --> app/services/media.py:53:12
2025-11-18T07:14:11.2775315Z    |
2025-11-18T07:14:11.2775469Z 51 |         # Add timeout to bot.get_file() call (15 seconds for metadata)
2025-11-18T07:14:11.2775744Z 52 |         file = await asyncio.wait_for(bot.get_file(file_id), timeout=15.0)
2025-11-18T07:14:11.2775830Z 53 |     except asyncio.TimeoutError:
2025-11-18T07:14:11.2775901Z    |            ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2775974Z 54 |         LOGGER.warning(
2025-11-18T07:14:11.2776128Z 55 |             "Timed out fetching file metadata for %s (timeout: 15s)", file_id
2025-11-18T07:14:11.2776187Z    |
2025-11-18T07:14:11.2776344Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2776350Z 
2025-11-18T07:14:11.2776456Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2776619Z    --> app/services/media.py:123:16
2025-11-18T07:14:11.2776679Z     |
2025-11-18T07:14:11.2776749Z 121 |                     return data
2025-11-18T07:14:11.2776805Z 122 |
2025-11-18T07:14:11.2776904Z 123 |         except asyncio.TimeoutError as exc:
2025-11-18T07:14:11.2777121Z     |                ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2777207Z 124 |             last_exception = exc
2025-11-18T07:14:11.2777284Z 125 |             LOGGER.warning(
2025-11-18T07:14:11.2777341Z     |
2025-11-18T07:14:11.2777488Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2777494Z 
2025-11-18T07:14:11.2777596Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2777680Z    --> app/services/media.py:273:9
2025-11-18T07:14:11.2777738Z     |
2025-11-18T07:14:11.2777797Z 271 |       """
2025-11-18T07:14:11.2777858Z 272 |       try:
2025-11-18T07:14:11.2777937Z 273 | /         from PIL import Image
2025-11-18T07:14:11.2778005Z 274 | |         import io
2025-11-18T07:14:11.2778074Z     | |_________________^
2025-11-18T07:14:11.2778131Z 275 |
2025-11-18T07:14:11.2778244Z 276 |           # Quick size check to avoid work on small files
2025-11-18T07:14:11.2778300Z     |
2025-11-18T07:14:11.2778374Z help: Organize imports
2025-11-18T07:14:11.2778379Z 
2025-11-18T07:14:11.2778486Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2778620Z   --> app/services/monitoring/continuous_monitor.py:12:1
2025-11-18T07:14:11.2778679Z    |
2025-11-18T07:14:11.2778738Z 10 |   """
2025-11-18T07:14:11.2778794Z 11 |
2025-11-18T07:14:11.2778882Z 12 | / from __future__ import annotations
2025-11-18T07:14:11.2778943Z 13 | |
2025-11-18T07:14:11.2779009Z 14 | | import logging
2025-11-18T07:14:11.2779127Z 15 | | from typing import TYPE_CHECKING, Any, List, Tuple
2025-11-18T07:14:11.2779188Z 16 | |
2025-11-18T07:14:11.2779274Z 17 | | from aiogram.types import Message
2025-11-18T07:14:11.2779331Z 18 | |
2025-11-18T07:14:11.2779414Z 19 | | from app.config import Settings
2025-11-18T07:14:11.2779541Z 20 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.2779644Z 21 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2779882Z 22 | | from app.services.monitoring.message_classifier import MessageClassifier, MessageValue
2025-11-18T07:14:11.2780041Z 23 | | from app.services.monitoring.conversation_analyzer import (
2025-11-18T07:14:11.2780122Z 24 | |     ConversationAnalyzer,
2025-11-18T07:14:11.2780198Z 25 | |     ConversationWindow,
2025-11-18T07:14:11.2780260Z 26 | | )
2025-11-18T07:14:11.2780458Z 27 | | from app.services.monitoring.fact_quality_manager import FactQualityManager
2025-11-18T07:14:11.2780641Z 28 | | from app.services.monitoring.proactive_trigger import ProactiveTrigger
2025-11-18T07:14:11.2780859Z 29 | | from app.services.monitoring.event_system import EventQueue, Event, EventPriority
2025-11-18T07:14:11.2780988Z    | |_________________________________________________________________________________^
2025-11-18T07:14:11.2781048Z 30 |
2025-11-18T07:14:11.2781119Z 31 |   if TYPE_CHECKING:
2025-11-18T07:14:11.2781179Z    |
2025-11-18T07:14:11.2781251Z help: Organize imports
2025-11-18T07:14:11.2781256Z 
2025-11-18T07:14:11.2781374Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.2781503Z   --> app/services/monitoring/continuous_monitor.py:15:1
2025-11-18T07:14:11.2781691Z    |
2025-11-18T07:14:11.2781757Z 14 | import logging
2025-11-18T07:14:11.2781874Z 15 | from typing import TYPE_CHECKING, Any, List, Tuple
2025-11-18T07:14:11.2781953Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2782009Z 16 |
2025-11-18T07:14:11.2782093Z 17 | from aiogram.types import Message
2025-11-18T07:14:11.2782152Z    |
2025-11-18T07:14:11.2782157Z 
2025-11-18T07:14:11.2782273Z UP035 `typing.Tuple` is deprecated, use `tuple` instead
2025-11-18T07:14:11.2782394Z   --> app/services/monitoring/continuous_monitor.py:15:1
2025-11-18T07:14:11.2782453Z    |
2025-11-18T07:14:11.2782517Z 14 | import logging
2025-11-18T07:14:11.2782731Z 15 | from typing import TYPE_CHECKING, Any, List, Tuple
2025-11-18T07:14:11.2782803Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2782864Z 16 |
2025-11-18T07:14:11.2782946Z 17 | from aiogram.types import Message
2025-11-18T07:14:11.2783003Z    |
2025-11-18T07:14:11.2783011Z 
2025-11-18T07:14:11.2783231Z F401 [*] `app.services.monitoring.message_classifier.MessageValue` imported but unused
2025-11-18T07:14:11.2783355Z   --> app/services/monitoring/continuous_monitor.py:22:75
2025-11-18T07:14:11.2783411Z    |
2025-11-18T07:14:11.2783534Z 20 | from app.services.context_store import ContextStore
2025-11-18T07:14:11.2783638Z 21 | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2783871Z 22 | from app.services.monitoring.message_classifier import MessageClassifier, MessageValue
2025-11-18T07:14:11.2783958Z    |                                                                           ^^^^^^^^^^^^
2025-11-18T07:14:11.2784112Z 23 | from app.services.monitoring.conversation_analyzer import (
2025-11-18T07:14:11.2784194Z 24 |     ConversationAnalyzer,
2025-11-18T07:14:11.2784250Z    |
2025-11-18T07:14:11.2784467Z help: Remove unused import: `app.services.monitoring.message_classifier.MessageValue`
2025-11-18T07:14:11.2784473Z 
2025-11-18T07:14:11.2784578Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2784697Z   --> app/services/monitoring/continuous_monitor.py:39:1
2025-11-18T07:14:11.2784756Z    |
2025-11-18T07:14:11.2784836Z 37 |       ProfileStoreType = Any
2025-11-18T07:14:11.2784893Z 38 |
2025-11-18T07:14:11.2785023Z 39 | / from app.services.fact_extractors import FactExtractor
2025-11-18T07:14:11.2785222Z 40 | | from app.services.fact_extractors.chat_fact_extractor import ChatFactExtractor
2025-11-18T07:14:11.2785411Z 41 | | from app.repositories.chat_profile import ChatProfileRepository, ChatFact
2025-11-18T07:14:11.2785522Z    | |_________________________________________________________________________^
2025-11-18T07:14:11.2785584Z 42 |
2025-11-18T07:14:11.2785673Z 43 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2785728Z    |
2025-11-18T07:14:11.2785800Z help: Organize imports
2025-11-18T07:14:11.2785806Z 
2025-11-18T07:14:11.2785932Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2786068Z    --> app/services/monitoring/continuous_monitor.py:442:10
2025-11-18T07:14:11.2786126Z     |
2025-11-18T07:14:11.2786224Z 440 |     async def _extract_facts_from_window(
2025-11-18T07:14:11.2786319Z 441 |         self, window: ConversationWindow
2025-11-18T07:14:11.2786430Z 442 |     ) -> Tuple[List[dict[str, Any]], List[ChatFact]]:
2025-11-18T07:14:11.2786497Z     |          ^^^^^
2025-11-18T07:14:11.2786556Z 443 |         """
2025-11-18T07:14:11.2786713Z 444 |         Extract both user facts and chat facts from a conversation window.
2025-11-18T07:14:11.2786772Z     |
2025-11-18T07:14:11.2786848Z help: Replace with `tuple`
2025-11-18T07:14:11.2786854Z 
2025-11-18T07:14:11.2787075Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2787203Z    --> app/services/monitoring/continuous_monitor.py:442:16
2025-11-18T07:14:11.2787263Z     |
2025-11-18T07:14:11.2787353Z 440 |     async def _extract_facts_from_window(
2025-11-18T07:14:11.2787444Z 441 |         self, window: ConversationWindow
2025-11-18T07:14:11.2787671Z 442 |     ) -> Tuple[List[dict[str, Any]], List[ChatFact]]:
2025-11-18T07:14:11.2787737Z     |                ^^^^
2025-11-18T07:14:11.2787796Z 443 |         """
2025-11-18T07:14:11.2787954Z 444 |         Extract both user facts and chat facts from a conversation window.
2025-11-18T07:14:11.2788011Z     |
2025-11-18T07:14:11.2788086Z help: Replace with `list`
2025-11-18T07:14:11.2788092Z 
2025-11-18T07:14:11.2788203Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2788330Z    --> app/services/monitoring/continuous_monitor.py:442:38
2025-11-18T07:14:11.2788387Z     |
2025-11-18T07:14:11.2788477Z 440 |     async def _extract_facts_from_window(
2025-11-18T07:14:11.2788676Z 441 |         self, window: ConversationWindow
2025-11-18T07:14:11.2788779Z 442 |     ) -> Tuple[List[dict[str, Any]], List[ChatFact]]:
2025-11-18T07:14:11.2788849Z     |                                      ^^^^
2025-11-18T07:14:11.2788909Z 443 |         """
2025-11-18T07:14:11.2789068Z 444 |         Extract both user facts and chat facts from a conversation window.
2025-11-18T07:14:11.2789124Z     |
2025-11-18T07:14:11.2789197Z help: Replace with `list`
2025-11-18T07:14:11.2789202Z 
2025-11-18T07:14:11.2789326Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2789446Z    --> app/services/monitoring/continuous_monitor.py:567:16
2025-11-18T07:14:11.2789504Z     |
2025-11-18T07:14:11.2789581Z 565 |     async def _store_facts(
2025-11-18T07:14:11.2789643Z 566 |         self,
2025-11-18T07:14:11.2789763Z 567 |         facts: Tuple[List[dict[str, Any]], List[ChatFact]],
2025-11-18T07:14:11.2789831Z     |                ^^^^^
2025-11-18T07:14:11.2789921Z 568 |         window: ConversationWindow,
2025-11-18T07:14:11.2789984Z 569 |     ) -> None:
2025-11-18T07:14:11.2790041Z     |
2025-11-18T07:14:11.2790118Z help: Replace with `tuple`
2025-11-18T07:14:11.2790123Z 
2025-11-18T07:14:11.2790236Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2790364Z    --> app/services/monitoring/continuous_monitor.py:567:22
2025-11-18T07:14:11.2790424Z     |
2025-11-18T07:14:11.2790501Z 565 |     async def _store_facts(
2025-11-18T07:14:11.2790562Z 566 |         self,
2025-11-18T07:14:11.2790678Z 567 |         facts: Tuple[List[dict[str, Any]], List[ChatFact]],
2025-11-18T07:14:11.2790747Z     |                      ^^^^
2025-11-18T07:14:11.2790832Z 568 |         window: ConversationWindow,
2025-11-18T07:14:11.2790895Z 569 |     ) -> None:
2025-11-18T07:14:11.2790955Z     |
2025-11-18T07:14:11.2791027Z help: Replace with `list`
2025-11-18T07:14:11.2791033Z 
2025-11-18T07:14:11.2791144Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2791271Z    --> app/services/monitoring/continuous_monitor.py:567:44
2025-11-18T07:14:11.2791329Z     |
2025-11-18T07:14:11.2791402Z 565 |     async def _store_facts(
2025-11-18T07:14:11.2791461Z 566 |         self,
2025-11-18T07:14:11.2791579Z 567 |         facts: Tuple[List[dict[str, Any]], List[ChatFact]],
2025-11-18T07:14:11.2791661Z     |                                            ^^^^
2025-11-18T07:14:11.2791742Z 568 |         window: ConversationWindow,
2025-11-18T07:14:11.2791806Z 569 |     ) -> None:
2025-11-18T07:14:11.2791864Z     |
2025-11-18T07:14:11.2791937Z help: Replace with `list`
2025-11-18T07:14:11.2791942Z 
2025-11-18T07:14:11.2792055Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.2792175Z    --> app/services/monitoring/continuous_monitor.py:592:22
2025-11-18T07:14:11.2792231Z     |
2025-11-18T07:14:11.2792310Z 591 |     async def _store_user_facts(
2025-11-18T07:14:11.2792459Z 592 |         self, facts: List[dict[str, Any]], window: ConversationWindow
2025-11-18T07:14:11.2792527Z     |                      ^^^^
2025-11-18T07:14:11.2792590Z 593 |     ) -> None:
2025-11-18T07:14:11.2792651Z 594 |         """
2025-11-18T07:14:11.2792708Z     |
2025-11-18T07:14:11.2792779Z help: Replace with `list`
2025-11-18T07:14:11.2792868Z 
2025-11-18T07:14:11.2792977Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2793105Z   --> app/services/monitoring/conversation_analyzer.py:15:1
2025-11-18T07:14:11.2793162Z    |
2025-11-18T07:14:11.2793220Z 13 |   """
2025-11-18T07:14:11.2793280Z 14 |
2025-11-18T07:14:11.2793362Z 15 | / from __future__ import annotations
2025-11-18T07:14:11.2793420Z 16 | |
2025-11-18T07:14:11.2793488Z 17 | | import logging
2025-11-18T07:14:11.2793552Z 18 | | import time
2025-11-18T07:14:11.2793631Z 19 | | from collections import deque
2025-11-18T07:14:11.2793725Z 20 | | from dataclasses import dataclass, field
2025-11-18T07:14:11.2793806Z 21 | | from typing import Any
2025-11-18T07:14:11.2793942Z 22 | |
2025-11-18T07:14:11.2794029Z 23 | | from aiogram.types import Message
2025-11-18T07:14:11.2794089Z 24 | |
2025-11-18T07:14:11.2794232Z 25 | | from app.services.monitoring.message_classifier import (
2025-11-18T07:14:11.2794301Z 26 | |     MessageValue,
2025-11-18T07:14:11.2794377Z 27 | |     ClassificationResult,
2025-11-18T07:14:11.2794442Z 28 | | )
2025-11-18T07:14:11.2794499Z    | |_^
2025-11-18T07:14:11.2794555Z 29 |
2025-11-18T07:14:11.2794645Z 30 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2794701Z    |
2025-11-18T07:14:11.2794770Z help: Organize imports
2025-11-18T07:14:11.2794776Z 
2025-11-18T07:14:11.2794880Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2794985Z   --> app/services/monitoring/event_system.py:11:1
2025-11-18T07:14:11.2795042Z    |
2025-11-18T07:14:11.2795098Z  9 |   """
2025-11-18T07:14:11.2795158Z 10 |
2025-11-18T07:14:11.2795238Z 11 | / from __future__ import annotations
2025-11-18T07:14:11.2795295Z 12 | |
2025-11-18T07:14:11.2795363Z 13 | | import asyncio
2025-11-18T07:14:11.2795430Z 14 | | import logging
2025-11-18T07:14:11.2795492Z 15 | | import time
2025-11-18T07:14:11.2795583Z 16 | | from dataclasses import dataclass, field
2025-11-18T07:14:11.2795660Z 17 | | from enum import Enum
2025-11-18T07:14:11.2795753Z 18 | | from typing import Any, Callable, Awaitable
2025-11-18T07:14:11.2795832Z    | |___________________________________________^
2025-11-18T07:14:11.2795892Z 19 |
2025-11-18T07:14:11.2795976Z 20 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2796033Z    |
2025-11-18T07:14:11.2796102Z help: Organize imports
2025-11-18T07:14:11.2796107Z 
2025-11-18T07:14:11.2796271Z UP035 [*] Import from `collections.abc` instead: `Callable`, `Awaitable`
2025-11-18T07:14:11.2796371Z   --> app/services/monitoring/event_system.py:18:1
2025-11-18T07:14:11.2796427Z    |
2025-11-18T07:14:11.2796525Z 16 | from dataclasses import dataclass, field
2025-11-18T07:14:11.2796597Z 17 | from enum import Enum
2025-11-18T07:14:11.2796695Z 18 | from typing import Any, Callable, Awaitable
2025-11-18T07:14:11.2796767Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2796826Z 19 |
2025-11-18T07:14:11.2796909Z 20 | LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2797060Z    |
2025-11-18T07:14:11.2797152Z help: Import from `collections.abc`
2025-11-18T07:14:11.2797162Z 
2025-11-18T07:14:11.2797272Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2797382Z    --> app/services/monitoring/event_system.py:258:20
2025-11-18T07:14:11.2797441Z     |
2025-11-18T07:14:11.2797539Z 256 |                 self._stats["events_queued"] += 1
2025-11-18T07:14:11.2797609Z 257 |                 return True
2025-11-18T07:14:11.2797703Z 258 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2797777Z     |                    ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2797877Z 259 |                 self._stats["events_dropped"] += 1
2025-11-18T07:14:11.2797948Z 260 |                 return False
2025-11-18T07:14:11.2798011Z     |
2025-11-18T07:14:11.2798160Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2798166Z 
2025-11-18T07:14:11.2798269Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2798377Z    --> app/services/monitoring/event_system.py:300:20
2025-11-18T07:14:11.2798591Z     |
2025-11-18T07:14:11.2798716Z 298 |                 # Get event with timeout to allow graceful shutdown
2025-11-18T07:14:11.2798870Z 299 |                 event = await asyncio.wait_for(self._queue.get(), timeout=1.0)
2025-11-18T07:14:11.2798963Z 300 |             except asyncio.TimeoutError:
2025-11-18T07:14:11.2799035Z     |                    ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2799102Z 301 |                 continue
2025-11-18T07:14:11.2799161Z     |
2025-11-18T07:14:11.2799311Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2799316Z 
2025-11-18T07:14:11.2799393Z F401 [*] `json` imported but unused
2025-11-18T07:14:11.2799626Z   --> app/services/monitoring/fact_quality_manager.py:16:8
2025-11-18T07:14:11.2799685Z    |
2025-11-18T07:14:11.2799749Z 15 | import asyncio
2025-11-18T07:14:11.2799812Z 16 | import json
2025-11-18T07:14:11.2799874Z    |        ^^^^
2025-11-18T07:14:11.2799937Z 17 | import logging
2025-11-18T07:14:11.2800003Z 18 | import math
2025-11-18T07:14:11.2800063Z    |
2025-11-18T07:14:11.2800145Z help: Remove unused import: `json`
2025-11-18T07:14:11.2800150Z 
2025-11-18T07:14:11.2800259Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2800390Z    --> app/services/monitoring/fact_quality_manager.py:408:45
2025-11-18T07:14:11.2800447Z     |
2025-11-18T07:14:11.2800515Z 406 |             return 0.0
2025-11-18T07:14:11.2800572Z 407 |
2025-11-18T07:14:11.2800697Z 408 |         dot_product = sum(a * b for a, b in zip(vec1, vec2))
2025-11-18T07:14:11.2800777Z     |                                             ^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2800891Z 409 |         magnitude1 = math.sqrt(sum(a * a for a in vec1))
2025-11-18T07:14:11.2801005Z 410 |         magnitude2 = math.sqrt(sum(b * b for b in vec2))
2025-11-18T07:14:11.2801064Z     |
2025-11-18T07:14:11.2801167Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2801173Z 
2025-11-18T07:14:11.2801314Z C401 Unnecessary generator (rewrite as a set comprehension)
2025-11-18T07:14:11.2801449Z    --> app/services/monitoring/fact_quality_manager.py:511:22
2025-11-18T07:14:11.2801505Z     |
2025-11-18T07:14:11.2801608Z 510 |             # Check if values are different (conflict)
2025-11-18T07:14:11.2801731Z 511 |             values = set(f["fact_value"] for f in group_facts)
2025-11-18T07:14:11.2801811Z     |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2801868Z 512 |
2025-11-18T07:14:11.2801947Z 513 |             if len(values) == 1:
2025-11-18T07:14:11.2802004Z     |
2025-11-18T07:14:11.2802088Z help: Rewrite as a set comprehension
2025-11-18T07:14:11.2802094Z 
2025-11-18T07:14:11.2802201Z F401 [*] `datetime.timedelta` imported but unused
2025-11-18T07:14:11.2802325Z   --> app/services/monitoring/proactive_trigger.py:18:32
2025-11-18T07:14:11.2802382Z    |
2025-11-18T07:14:11.2802468Z 16 | from collections import defaultdict
2025-11-18T07:14:11.2802554Z 17 | from dataclasses import dataclass
2025-11-18T07:14:11.2802651Z 18 | from datetime import datetime, timedelta
2025-11-18T07:14:11.2802722Z    |                                ^^^^^^^^^
2025-11-18T07:14:11.2802797Z 19 | from enum import Enum
2025-11-18T07:14:11.2802880Z 20 | from typing import Any, Optional
2025-11-18T07:14:11.2802937Z    |
2025-11-18T07:14:11.2803040Z help: Remove unused import: `datetime.timedelta`
2025-11-18T07:14:11.2803048Z 
2025-11-18T07:14:11.2803140Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2803262Z   --> app/services/monitoring/proactive_trigger.py:54:25
2025-11-18T07:14:11.2803319Z    |
2025-11-18T07:14:11.2803466Z 52 |     trigger_message: str  # The message that triggered detection
2025-11-18T07:14:11.2803595Z 53 |     context_summary: str  # What the conversation is about
2025-11-18T07:14:11.2803759Z 54 |     suggested_response: Optional[str] = None  # Optional AI suggestion
2025-11-18T07:14:11.2803832Z    |                         ^^^^^^^^^^^^^
2025-11-18T07:14:11.2803887Z    |
2025-11-18T07:14:11.2804047Z help: Convert to `X | None`
2025-11-18T07:14:11.2804053Z 
2025-11-18T07:14:11.2804141Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2804262Z   --> app/services/monitoring/proactive_trigger.py:63:30
2025-11-18T07:14:11.2804318Z    |
2025-11-18T07:14:11.2804383Z 61 |     user_id: int
2025-11-18T07:14:11.2804507Z 62 |     proactivity_multiplier: float  # 0.0-2.0, default 1.0
2025-11-18T07:14:11.2804608Z 63 |     last_proactive_response: Optional[datetime]
2025-11-18T07:14:11.2804681Z    |                              ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2804760Z 64 |     total_proactive_sent: int
2025-11-18T07:14:11.2804854Z 65 |     reaction_counts: dict[UserReaction, int]
2025-11-18T07:14:11.2804989Z    |
2025-11-18T07:14:11.2805064Z help: Convert to `X | None`
2025-11-18T07:14:11.2805069Z 
2025-11-18T07:14:11.2805161Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2805277Z   --> app/services/monitoring/proactive_trigger.py:67:29
2025-11-18T07:14:11.2805333Z    |
2025-11-18T07:14:11.2805432Z 65 |     reaction_counts: dict[UserReaction, int]
2025-11-18T07:14:11.2805508Z 66 |     consecutive_ignores: int
2025-11-18T07:14:11.2805604Z 67 |     last_negative_feedback: Optional[datetime]
2025-11-18T07:14:11.2805678Z    |                             ^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2805735Z    |
2025-11-18T07:14:11.2805807Z help: Convert to `X | None`
2025-11-18T07:14:11.2805811Z 
2025-11-18T07:14:11.2805899Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2806016Z   --> app/services/monitoring/proactive_trigger.py:76:13
2025-11-18T07:14:11.2806071Z    |
2025-11-18T07:14:11.2806145Z 74 |     should_respond: bool
2025-11-18T07:14:11.2806222Z 75 |     confidence: float
2025-11-18T07:14:11.2806313Z 76 |     intent: Optional[ConversationIntent]
2025-11-18T07:14:11.2806381Z    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2806489Z 77 |     reason: str  # Why we should/shouldn't respond
2025-11-18T07:14:11.2806579Z 78 |     suggested_response: Optional[str] = None
2025-11-18T07:14:11.2806638Z    |
2025-11-18T07:14:11.2806710Z help: Convert to `X | None`
2025-11-18T07:14:11.2806715Z 
2025-11-18T07:14:11.2806804Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2806920Z   --> app/services/monitoring/proactive_trigger.py:78:25
2025-11-18T07:14:11.2807075Z    |
2025-11-18T07:14:11.2807169Z 76 |     intent: Optional[ConversationIntent]
2025-11-18T07:14:11.2807271Z 77 |     reason: str  # Why we should/shouldn't respond
2025-11-18T07:14:11.2807363Z 78 |     suggested_response: Optional[str] = None
2025-11-18T07:14:11.2807435Z    |                         ^^^^^^^^^^^^^
2025-11-18T07:14:11.2807490Z    |
2025-11-18T07:14:11.2807564Z help: Convert to `X | None`
2025-11-18T07:14:11.2807569Z 
2025-11-18T07:14:11.2807653Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2807769Z   --> app/services/monitoring/proactive_trigger.py:93:10
2025-11-18T07:14:11.2807825Z    |
2025-11-18T07:14:11.2807902Z 91 |     async def classify_window(
2025-11-18T07:14:11.2808061Z 92 |         self, window: ConversationWindow, bot_capabilities: list[str]
2025-11-18T07:14:11.2808152Z 93 |     ) -> Optional[ConversationIntent]:
2025-11-18T07:14:11.2808220Z    |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2808280Z 94 |         """
2025-11-18T07:14:11.2808440Z 95 |         Analyze window to detect if proactive response would be helpful.
2025-11-18T07:14:11.2808496Z    |
2025-11-18T07:14:11.2808569Z help: Convert to `X | None`
2025-11-18T07:14:11.2808574Z 
2025-11-18T07:14:11.2808662Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2808784Z    --> app/services/monitoring/proactive_trigger.py:187:10
2025-11-18T07:14:11.2808844Z     |
2025-11-18T07:14:11.2808927Z 185 |     def _parse_intent_response(
2025-11-18T07:14:11.2809044Z 186 |         self, response: str, window: ConversationWindow
2025-11-18T07:14:11.2809136Z 187 |     ) -> Optional[ConversationIntent]:
2025-11-18T07:14:11.2809206Z     |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2809467Z 188 |         """Parse Gemini's intent classification response."""
2025-11-18T07:14:11.2809530Z 189 |         try:
2025-11-18T07:14:11.2809587Z     |
2025-11-18T07:14:11.2809665Z help: Convert to `X | None`
2025-11-18T07:14:11.2809671Z 
2025-11-18T07:14:11.2809742Z W291 Trailing whitespace
2025-11-18T07:14:11.2809864Z    --> app/services/monitoring/proactive_trigger.py:230:19
2025-11-18T07:14:11.2809924Z     |
2025-11-18T07:14:11.2810008Z 228 |         cursor = await conn.execute(
2025-11-18T07:14:11.2810071Z 229 |             """
2025-11-18T07:14:11.2810136Z 230 |             SELECT 
2025-11-18T07:14:11.2810203Z     |                   ^
2025-11-18T07:14:11.2810385Z 231 |                 COUNT(*) as total,
2025-11-18T07:14:11.2810474Z 232 |                 MAX(created_at) as last_sent,
2025-11-18T07:14:11.2810533Z     |
2025-11-18T07:14:11.2810616Z help: Remove trailing whitespace
2025-11-18T07:14:11.2810621Z 
2025-11-18T07:14:11.2810708Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2810831Z    --> app/services/monitoring/proactive_trigger.py:339:69
2025-11-18T07:14:11.2810888Z     |
2025-11-18T07:14:11.2810970Z 338 |     async def record_reaction(
2025-11-18T07:14:11.2811174Z 339 |         self, event_id: int, reaction: UserReaction, reaction_time: Optional[int] = None
2025-11-18T07:14:11.2811266Z     |                                                                     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2811327Z 340 |     ):
2025-11-18T07:14:11.2811454Z 341 |         """Record user's reaction to proactive response."""
2025-11-18T07:14:11.2811515Z     |
2025-11-18T07:14:11.2811588Z help: Convert to `X | None`
2025-11-18T07:14:11.2811597Z 
2025-11-18T07:14:11.2811689Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2811815Z    --> app/services/monitoring/proactive_trigger.py:369:18
2025-11-18T07:14:11.2811872Z     |
2025-11-18T07:14:11.2811935Z 367 |         self,
2025-11-18T07:14:11.2812002Z 368 |         chat_id: int,
2025-11-18T07:14:11.2812096Z 369 |         user_id: Optional[int] = None,
2025-11-18T07:14:11.2812163Z     |                  ^^^^^^^^^^^^^
2025-11-18T07:14:11.2812267Z 370 |         intent_type: Optional[IntentType] = None,
2025-11-18T07:14:11.2812359Z 371 |     ) -> tuple[bool, Optional[str]]:
2025-11-18T07:14:11.2812416Z     |
2025-11-18T07:14:11.2812488Z help: Convert to `X | None`
2025-11-18T07:14:11.2812494Z 
2025-11-18T07:14:11.2812585Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2812704Z    --> app/services/monitoring/proactive_trigger.py:370:22
2025-11-18T07:14:11.2812761Z     |
2025-11-18T07:14:11.2812826Z 368 |         chat_id: int,
2025-11-18T07:14:11.2812912Z 369 |         user_id: Optional[int] = None,
2025-11-18T07:14:11.2813015Z 370 |         intent_type: Optional[IntentType] = None,
2025-11-18T07:14:11.2813090Z     |                      ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2813177Z 371 |     ) -> tuple[bool, Optional[str]]:
2025-11-18T07:14:11.2813236Z 372 |         """
2025-11-18T07:14:11.2813295Z     |
2025-11-18T07:14:11.2813366Z help: Convert to `X | None`
2025-11-18T07:14:11.2813371Z 
2025-11-18T07:14:11.2813461Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2813578Z    --> app/services/monitoring/proactive_trigger.py:371:22
2025-11-18T07:14:11.2813635Z     |
2025-11-18T07:14:11.2813721Z 369 |         user_id: Optional[int] = None,
2025-11-18T07:14:11.2813815Z 370 |         intent_type: Optional[IntentType] = None,
2025-11-18T07:14:11.2813898Z 371 |     ) -> tuple[bool, Optional[str]]:
2025-11-18T07:14:11.2813967Z     |                      ^^^^^^^^^^^^^
2025-11-18T07:14:11.2814027Z 372 |         """
2025-11-18T07:14:11.2814123Z 373 |         Check if cooldown period has passed.
2025-11-18T07:14:11.2814182Z     |
2025-11-18T07:14:11.2814255Z help: Convert to `X | None`
2025-11-18T07:14:11.2814260Z 
2025-11-18T07:14:11.2814331Z W291 Trailing whitespace
2025-11-18T07:14:11.2814449Z    --> app/services/monitoring/proactive_trigger.py:430:34
2025-11-18T07:14:11.2814595Z     |
2025-11-18T07:14:11.2814661Z 428 |                 """
2025-11-18T07:14:11.2814764Z 429 |                 SELECT created_at FROM proactive_events
2025-11-18T07:14:11.2814842Z 430 |                 WHERE chat_id = ? 
2025-11-18T07:14:11.2814909Z     |                                  ^
2025-11-18T07:14:11.2815061Z 431 |                 AND json_extract(intent_classification, '$.intent_type') = ?
2025-11-18T07:14:11.2815141Z 432 |                 AND response_sent = 1
2025-11-18T07:14:11.2815200Z     |
2025-11-18T07:14:11.2815279Z help: Remove trailing whitespace
2025-11-18T07:14:11.2815285Z 
2025-11-18T07:14:11.2815372Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2815569Z    --> app/services/monitoring/proactive_trigger.py:627:10
2025-11-18T07:14:11.2815626Z     |
2025-11-18T07:14:11.2815710Z 625 |     def _get_primary_participant(
2025-11-18T07:14:11.2815835Z 626 |         self, window: ConversationWindow, bot_user_id: int
2025-11-18T07:14:11.2815910Z 627 |     ) -> Optional[int]:
2025-11-18T07:14:11.2815979Z     |          ^^^^^^^^^^^^^
2025-11-18T07:14:11.2816143Z 628 |         """Get most active participant in window (for preference lookup)."""
2025-11-18T07:14:11.2816228Z 629 |         if not window.messages:
2025-11-18T07:14:11.2816285Z     |
2025-11-18T07:14:11.2816361Z help: Convert to `X | None`
2025-11-18T07:14:11.2816366Z 
2025-11-18T07:14:11.2816462Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2816590Z    --> app/services/monitoring/proactive_trigger.py:650:30
2025-11-18T07:14:11.2816647Z     |
2025-11-18T07:14:11.2816733Z 648 |         intent: ConversationIntent,
2025-11-18T07:14:11.2816811Z 649 |         response_text: str,
2025-11-18T07:14:11.2816919Z 650 |         response_message_id: Optional[int] = None,
2025-11-18T07:14:11.2817091Z     |                              ^^^^^^^^^^^^^
2025-11-18T07:14:11.2817160Z 651 |     ) -> int:
2025-11-18T07:14:11.2817220Z 652 |         """
2025-11-18T07:14:11.2817275Z     |
2025-11-18T07:14:11.2817348Z help: Convert to `X | None`
2025-11-18T07:14:11.2817357Z 
2025-11-18T07:14:11.2817437Z UP015 [*] Unnecessary mode argument
2025-11-18T07:14:11.2817528Z   --> app/services/persona/loader.py:69:29
2025-11-18T07:14:11.2817584Z    |
2025-11-18T07:14:11.2817680Z 67 |                 return self._get_default_persona()
2025-11-18T07:14:11.2817736Z 68 |
2025-11-18T07:14:11.2817843Z 69 |             with open(path, "r", encoding="utf-8") as f:
2025-11-18T07:14:11.2817913Z    |                             ^^^
2025-11-18T07:14:11.2817994Z 70 |                 data = yaml.safe_load(f)
2025-11-18T07:14:11.2818049Z    |
2025-11-18T07:14:11.2818122Z help: Remove mode argument
2025-11-18T07:14:11.2818130Z 
2025-11-18T07:14:11.2818210Z UP015 [*] Unnecessary mode argument
2025-11-18T07:14:11.2818299Z   --> app/services/persona/loader.py:83:46
2025-11-18T07:14:11.2818355Z    |
2025-11-18T07:14:11.2818487Z 81 |                 template_path = Path(data["system_prompt_template"])
2025-11-18T07:14:11.2818575Z 82 |                 if template_path.exists():
2025-11-18T07:14:11.2818703Z 83 |                     with open(template_path, "r", encoding="utf-8") as f:
2025-11-18T07:14:11.2818783Z    |                                              ^^^
2025-11-18T07:14:11.2818869Z 84 |                         system_prompt = f.read()
2025-11-18T07:14:11.2818934Z 85 |                 else:
2025-11-18T07:14:11.2818995Z    |
2025-11-18T07:14:11.2819067Z help: Remove mode argument
2025-11-18T07:14:11.2819072Z 
2025-11-18T07:14:11.2819149Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2819241Z    --> app/services/persona/loader.py:115:1
2025-11-18T07:14:11.2819301Z     |
2025-11-18T07:14:11.2819432Z 113 |     def _ensure_plain_system_prompt(prompt: str) -> None:
2025-11-18T07:14:11.2819627Z 114 |         """Validate system prompt template for well-formed variable placeholders.
2025-11-18T07:14:11.2819690Z 115 |         
2025-11-18T07:14:11.2819750Z     | ^^^^^^^^
2025-11-18T07:14:11.2819924Z 116 |         Allows variable placeholders like {timestamp}, {current_year}, etc.
2025-11-18T07:14:11.2820191Z 117 |         Only warns about unclosed braces or malformed placeholders.
2025-11-18T07:14:11.2820252Z     |
2025-11-18T07:14:11.2820338Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2820344Z 
2025-11-18T07:14:11.2820423Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2820515Z    --> app/services/persona/loader.py:125:1
2025-11-18T07:14:11.2820573Z     |
2025-11-18T07:14:11.2820663Z 123 |         open_braces = prompt.count("{")
2025-11-18T07:14:11.2820756Z 124 |         close_braces = prompt.count("}")
2025-11-18T07:14:11.2820814Z 125 |         
2025-11-18T07:14:11.2820872Z     | ^^^^^^^^
2025-11-18T07:14:11.2821061Z 126 |         if open_braces != close_braces:
2025-11-18T07:14:11.2821139Z 127 |             LOGGER.warning(
2025-11-18T07:14:11.2821196Z     |
2025-11-18T07:14:11.2821279Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2821284Z 
2025-11-18T07:14:11.2821366Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2821456Z    --> app/services/persona/loader.py:130:1
2025-11-18T07:14:11.2821513Z     |
2025-11-18T07:14:11.2821726Z 128 |                 f"System prompt has mismatched braces: {open_braces} open, {close_braces} close"
2025-11-18T07:14:11.2821786Z 129 |             )
2025-11-18T07:14:11.2821844Z 130 |         
2025-11-18T07:14:11.2821900Z     | ^^^^^^^^
2025-11-18T07:14:11.2822096Z 131 |         # Check for malformed placeholders (e.g., {{ or }} without proper escaping)
2025-11-18T07:14:11.2822172Z 132 |         # Allow {variable} format
2025-11-18T07:14:11.2822227Z     |
2025-11-18T07:14:11.2822313Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2822322Z 
2025-11-18T07:14:11.2822399Z UP015 [*] Unnecessary mode argument
2025-11-18T07:14:11.2822490Z    --> app/services/persona/loader.py:152:29
2025-11-18T07:14:11.2822551Z     |
2025-11-18T07:14:11.2822652Z 150 |                 return self._get_default_responses()
2025-11-18T07:14:11.2822709Z 151 |
2025-11-18T07:14:11.2822821Z 152 |             with open(path, "r", encoding="utf-8") as f:
2025-11-18T07:14:11.2822892Z     |                             ^^^
2025-11-18T07:14:11.2822978Z 153 |                 templates = json.load(f)
2025-11-18T07:14:11.2823034Z     |
2025-11-18T07:14:11.2823111Z help: Remove mode argument
2025-11-18T07:14:11.2823116Z 
2025-11-18T07:14:11.2823192Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2823279Z    --> app/services/persona/loader.py:191:1
2025-11-18T07:14:11.2823338Z     |
2025-11-18T07:14:11.2823455Z 189 |     def get_system_prompt(self, **kwargs: Any) -> str:
2025-11-18T07:14:11.2823616Z 190 |         """Return the configured system prompt with variable substitution.
2025-11-18T07:14:11.2823678Z 191 |         
2025-11-18T07:14:11.2823739Z     | ^^^^^^^^
2025-11-18T07:14:11.2823830Z 192 |         Supports the following variables:
2025-11-18T07:14:11.2824046Z 193 |         - {timestamp} - Full formatted timestamp (e.g., "Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.2824109Z     |
2025-11-18T07:14:11.2824194Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2824200Z 
2025-11-18T07:14:11.2824278Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2824368Z    --> app/services/persona/loader.py:197:1
2025-11-18T07:14:11.2824425Z     |
2025-11-18T07:14:11.2824591Z 195 |         - {current_date} - Date portion only (e.g., "Monday, January 15, 2025")
2025-11-18T07:14:11.2824692Z 196 |         - Any other variables passed via kwargs
2025-11-18T07:14:11.2824753Z 197 |         
2025-11-18T07:14:11.2824811Z     | ^^^^^^^^
2025-11-18T07:14:11.2824872Z 198 |         Args:
2025-11-18T07:14:11.2825087Z 199 |             **kwargs: Variables for template substitution. Special handling for 'current_time'.
2025-11-18T07:14:11.2825148Z     |
2025-11-18T07:14:11.2825233Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2825238Z 
2025-11-18T07:14:11.2825315Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2825407Z    --> app/services/persona/loader.py:200:1
2025-11-18T07:14:11.2825549Z     |
2025-11-18T07:14:11.2825608Z 198 |         Args:
2025-11-18T07:14:11.2825817Z 199 |             **kwargs: Variables for template substitution. Special handling for 'current_time'.
2025-11-18T07:14:11.2825875Z 200 |         
2025-11-18T07:14:11.2825933Z     | ^^^^^^^^
2025-11-18T07:14:11.2826001Z 201 |         Returns:
2025-11-18T07:14:11.2826105Z 202 |             System prompt with variables substituted
2025-11-18T07:14:11.2826162Z     |
2025-11-18T07:14:11.2826244Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2826250Z 
2025-11-18T07:14:11.2826332Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2826419Z    --> app/services/persona/loader.py:205:1
2025-11-18T07:14:11.2826551Z     |
2025-11-18T07:14:11.2826613Z 203 |         """
2025-11-18T07:14:11.2826712Z 204 |         prompt = self.persona.system_prompt
2025-11-18T07:14:11.2826770Z 205 |         
2025-11-18T07:14:11.2826827Z     | ^^^^^^^^
2025-11-18T07:14:11.2826934Z 206 |         # If no variables in prompt, return as-is
2025-11-18T07:14:11.2827107Z 207 |         if "{" not in prompt:
2025-11-18T07:14:11.2827164Z     |
2025-11-18T07:14:11.2827251Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2827257Z 
2025-11-18T07:14:11.2827336Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2827424Z    --> app/services/persona/loader.py:209:1
2025-11-18T07:14:11.2827484Z     |
2025-11-18T07:14:11.2827553Z 207 |         if "{" not in prompt:
2025-11-18T07:14:11.2827625Z 208 |             return prompt
2025-11-18T07:14:11.2827684Z 209 |         
2025-11-18T07:14:11.2827745Z     | ^^^^^^^^
2025-11-18T07:14:11.2827834Z 210 |         # Prepare substitution variables
2025-11-18T07:14:11.2827935Z 211 |         substitution_vars: dict[str, Any] = {}
2025-11-18T07:14:11.2827995Z     |
2025-11-18T07:14:11.2828076Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2828081Z 
2025-11-18T07:14:11.2828159Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2828248Z    --> app/services/persona/loader.py:212:1
2025-11-18T07:14:11.2828309Z     |
2025-11-18T07:14:11.2828395Z 210 |         # Prepare substitution variables
2025-11-18T07:14:11.2828489Z 211 |         substitution_vars: dict[str, Any] = {}
2025-11-18T07:14:11.2828549Z 212 |         
2025-11-18T07:14:11.2828606Z     | ^^^^^^^^
2025-11-18T07:14:11.2828780Z 213 |         # Extract timestamp-related variables from current_time if provided
2025-11-18T07:14:11.2828884Z 214 |         current_time = kwargs.get("current_time")
2025-11-18T07:14:11.2828941Z     |
2025-11-18T07:14:11.2829023Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2829029Z 
2025-11-18T07:14:11.2829106Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2829198Z    --> app/services/persona/loader.py:217:1
2025-11-18T07:14:11.2829255Z     |
2025-11-18T07:14:11.2829325Z 215 |         if current_time:
2025-11-18T07:14:11.2829442Z 216 |             substitution_vars["timestamp"] = current_time
2025-11-18T07:14:11.2829502Z 217 |             
2025-11-18T07:14:11.2829563Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2829756Z 218 |             # Extract year from timestamp (format: "Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.2829888Z 219 |             year_match = re.search(r"\b(19|20)\d{2}\b", current_time)
2025-11-18T07:14:11.2829945Z     |
2025-11-18T07:14:11.2830028Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2830036Z 
2025-11-18T07:14:11.2830113Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2830199Z    --> app/services/persona/loader.py:231:1
2025-11-18T07:14:11.2830255Z     |
2025-11-18T07:14:11.2830373Z 229 |                     # If parsing fails, use current year as fallback
2025-11-18T07:14:11.2830530Z 230 |                     substitution_vars["current_year"] = str(datetime.now().year)
2025-11-18T07:14:11.2830588Z 231 |             
2025-11-18T07:14:11.2830648Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2830769Z 232 |             # Extract date portion (everything before " at ")
2025-11-18T07:14:11.2830971Z 233 |             if " at " in current_time:
2025-11-18T07:14:11.2831029Z     |
2025-11-18T07:14:11.2831114Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2831120Z 
2025-11-18T07:14:11.2831196Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2831282Z    --> app/services/persona/loader.py:251:1
2025-11-18T07:14:11.2831340Z     |
2025-11-18T07:14:11.2831435Z 249 |                 # If timezone fails, use local time
2025-11-18T07:14:11.2831502Z 250 |                 pass
2025-11-18T07:14:11.2831563Z 251 |             
2025-11-18T07:14:11.2831621Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2831756Z 252 |             timestamp_str = now.strftime("%A, %B %d, %Y at %H:%M:%S")
2025-11-18T07:14:11.2831981Z 253 |             substitution_vars["timestamp"] = timestamp_str
2025-11-18T07:14:11.2832041Z     |
2025-11-18T07:14:11.2832127Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2832133Z 
2025-11-18T07:14:11.2832211Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2832307Z    --> app/services/persona/loader.py:256:1
2025-11-18T07:14:11.2832365Z     |
2025-11-18T07:14:11.2832483Z 254 |             substitution_vars["current_year"] = str(now.year)
2025-11-18T07:14:11.2832649Z 255 |             substitution_vars["current_date"] = now.strftime("%A, %B %d, %Y")
2025-11-18T07:14:11.2832707Z 256 |         
2025-11-18T07:14:11.2832766Z     | ^^^^^^^^
2025-11-18T07:14:11.2832857Z 257 |         # Add any other kwargs as variables
2025-11-18T07:14:11.2833061Z 258 |         substitution_vars.update({k: v for k, v in kwargs.items() if k != "current_time"})
2025-11-18T07:14:11.2833117Z     |
2025-11-18T07:14:11.2833200Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2833210Z 
2025-11-18T07:14:11.2833292Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2833378Z    --> app/services/persona/loader.py:259:1
2025-11-18T07:14:11.2833437Z     |
2025-11-18T07:14:11.2833527Z 257 |         # Add any other kwargs as variables
2025-11-18T07:14:11.2833719Z 258 |         substitution_vars.update({k: v for k, v in kwargs.items() if k != "current_time"})
2025-11-18T07:14:11.2833782Z 259 |         
2025-11-18T07:14:11.2833840Z     | ^^^^^^^^
2025-11-18T07:14:11.2833919Z 260 |         # Perform substitution
2025-11-18T07:14:11.2833979Z 261 |         try:
2025-11-18T07:14:11.2834035Z     |
2025-11-18T07:14:11.2834121Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2834126Z 
2025-11-18T07:14:11.2834204Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2834291Z    --> app/services/persona/loader.py:272:1
2025-11-18T07:14:11.2834350Z     |
2025-11-18T07:14:11.2834492Z 270 |             LOGGER.warning(f"Error formatting system prompt: {e}")
2025-11-18T07:14:11.2834592Z 271 |             # Return original if formatting fails
2025-11-18T07:14:11.2834650Z 272 |         
2025-11-18T07:14:11.2834713Z     | ^^^^^^^^
2025-11-18T07:14:11.2834783Z 273 |         return prompt
2025-11-18T07:14:11.2834840Z     |
2025-11-18T07:14:11.2834925Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2834933Z 
2025-11-18T07:14:11.2835034Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2835116Z   --> app/services/polls.py:8:1
2025-11-18T07:14:11.2835173Z    |
2025-11-18T07:14:11.2835235Z  6 |   """
2025-11-18T07:14:11.2835291Z  7 |
2025-11-18T07:14:11.2835378Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2835438Z  9 | |
2025-11-18T07:14:11.2835504Z 10 | | import json
2025-11-18T07:14:11.2835570Z 11 | | import logging
2025-11-18T07:14:11.2835632Z 12 | | import time
2025-11-18T07:14:11.2835732Z 13 | | from datetime import datetime, timedelta
2025-11-18T07:14:11.2835812Z 14 | | from typing import Any, Optional
2025-11-18T07:14:11.2835899Z 15 | | from dataclasses import dataclass
2025-11-18T07:14:11.2835977Z 16 | | from enum import Enum
2025-11-18T07:14:11.2836044Z    | |_____________________^
2025-11-18T07:14:11.2836102Z 17 |
2025-11-18T07:14:11.2836179Z 18 |   # Import logging framework
2025-11-18T07:14:11.2836238Z    |
2025-11-18T07:14:11.2836396Z help: Organize imports
2025-11-18T07:14:11.2836402Z 
2025-11-18T07:14:11.2836513Z F401 [*] `dataclasses.dataclass` imported but unused
2025-11-18T07:14:11.2836598Z   --> app/services/polls.py:15:25
2025-11-18T07:14:11.2836653Z    |
2025-11-18T07:14:11.2836745Z 13 | from datetime import datetime, timedelta
2025-11-18T07:14:11.2836829Z 14 | from typing import Any, Optional
2025-11-18T07:14:11.2836911Z 15 | from dataclasses import dataclass
2025-11-18T07:14:11.2837072Z    |                         ^^^^^^^^^
2025-11-18T07:14:11.2837147Z 16 | from enum import Enum
2025-11-18T07:14:11.2837206Z    |
2025-11-18T07:14:11.2837322Z help: Remove unused import: `dataclasses.dataclass`
2025-11-18T07:14:11.2837435Z 
2025-11-18T07:14:11.2837523Z F401 [*] `enum.Enum` imported but unused
2025-11-18T07:14:11.2837609Z   --> app/services/polls.py:16:18
2025-11-18T07:14:11.2837665Z    |
2025-11-18T07:14:11.2837744Z 14 | from typing import Any, Optional
2025-11-18T07:14:11.2837825Z 15 | from dataclasses import dataclass
2025-11-18T07:14:11.2837903Z 16 | from enum import Enum
2025-11-18T07:14:11.2837966Z    |                  ^^^^
2025-11-18T07:14:11.2838022Z 17 |
2025-11-18T07:14:11.2838099Z 18 | # Import logging framework
2025-11-18T07:14:11.2838155Z    |
2025-11-18T07:14:11.2838237Z help: Remove unused import: `enum.Enum`
2025-11-18T07:14:11.2838243Z 
2025-11-18T07:14:11.2838345Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2838426Z   --> app/services/polls.py:20:5
2025-11-18T07:14:11.2838482Z    |
2025-11-18T07:14:11.2838555Z 18 | # Import logging framework
2025-11-18T07:14:11.2838619Z 19 | try:
2025-11-18T07:14:11.2838790Z 20 |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2838879Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2838953Z 21 | except ImportError:
2025-11-18T07:14:11.2839053Z 22 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2839110Z    |
2025-11-18T07:14:11.2839179Z help: Organize imports
2025-11-18T07:14:11.2839191Z 
2025-11-18T07:14:11.2839303Z E731 Do not assign a `lambda` expression, use a `def`
2025-11-18T07:14:11.2839384Z   --> app/services/polls.py:23:5
2025-11-18T07:14:11.2839440Z    |
2025-11-18T07:14:11.2839515Z 21 | except ImportError:
2025-11-18T07:14:11.2839619Z 22 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2839777Z 23 |     log_tool_execution = lambda name: lambda f: f  # No-op decorator
2025-11-18T07:14:11.2839890Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2839964Z 24 |     ToolLogger = None
2025-11-18T07:14:11.2840022Z    |
2025-11-18T07:14:11.2840119Z help: Rewrite `log_tool_execution` as a `def`
2025-11-18T07:14:11.2840131Z 
2025-11-18T07:14:11.2840223Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2840304Z   --> app/services/polls.py:36:48
2025-11-18T07:14:11.2840362Z    |
2025-11-18T07:14:11.2840525Z 36 | def _generate_poll_id(chat_id: int, thread_id: Optional[int]) -> str:
2025-11-18T07:14:11.2840611Z    |                                                ^^^^^^^^^^^^^
2025-11-18T07:14:11.2840695Z 37 |     """Generate a unique poll ID."""
2025-11-18T07:14:11.2840847Z 38 |     return f"poll_{chat_id}_{thread_id or 0}_{int(time.time())}"
2025-11-18T07:14:11.2840919Z    |
2025-11-18T07:14:11.2840992Z help: Convert to `X | None`
2025-11-18T07:14:11.2840997Z 
2025-11-18T07:14:11.2841087Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2841169Z   --> app/services/polls.py:43:17
2025-11-18T07:14:11.2841225Z    |
2025-11-18T07:14:11.2841356Z 41 | def _format_poll_display(poll_data: dict[str, Any]) -> str:
2025-11-18T07:14:11.2841438Z 42 |     """Format poll for display."""
2025-11-18T07:14:11.2841608Z 43 |     poll_text = f"📋 Опитування\n\n"
2025-11-18T07:14:11.2841678Z    |                 ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2841829Z 44 |     poll_text += f"❓ {poll_data['question']}\n\n"
2025-11-18T07:14:11.2841887Z    |
2025-11-18T07:14:11.2841969Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2842137Z 
2025-11-18T07:14:11.2842226Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2842307Z   --> app/services/polls.py:74:18
2025-11-18T07:14:11.2842363Z    |
2025-11-18T07:14:11.2842543Z 72 |             poll_text += f"⏰ Залишилось: {hours}г {minutes}хв\n"
2025-11-18T07:14:11.2842603Z 73 |
2025-11-18T07:14:11.2842788Z 74 |     poll_text += f"\n💬 Для голосування напишіть номер варіанту"
2025-11-18T07:14:11.2842867Z    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2842925Z 75 |
2025-11-18T07:14:11.2842999Z 76 |     return poll_text
2025-11-18T07:14:11.2843055Z    |
2025-11-18T07:14:11.2843231Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2843237Z 
2025-11-18T07:14:11.2843334Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2843416Z   --> app/services/polls.py:81:16
2025-11-18T07:14:11.2843473Z    |
2025-11-18T07:14:11.2843550Z 79 | def _create_poll_data(
2025-11-18T07:14:11.2843624Z 80 |     chat_id: int,
2025-11-18T07:14:11.2843701Z 81 |     thread_id: Optional[int],
2025-11-18T07:14:11.2843767Z    |                ^^^^^^^^^^^^^
2025-11-18T07:14:11.2843837Z 82 |     creator_id: int,
2025-11-18T07:14:11.2843903Z 83 |     question: str,
2025-11-18T07:14:11.2843958Z    |
2025-11-18T07:14:11.2844034Z help: Convert to `X | None`
2025-11-18T07:14:11.2844039Z 
2025-11-18T07:14:11.2844130Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2844209Z   --> app/services/polls.py:86:21
2025-11-18T07:14:11.2844267Z    |
2025-11-18T07:14:11.2844341Z 84 |     options: list[str],
2025-11-18T07:14:11.2844418Z 85 |     poll_type: str = "regular",
2025-11-18T07:14:11.2844514Z 86 |     duration_hours: Optional[int] = None,
2025-11-18T07:14:11.2844585Z    |                     ^^^^^^^^^^^^^
2025-11-18T07:14:11.2844654Z 87 | ) -> dict[str, Any]:
2025-11-18T07:14:11.2844743Z 88 |     """Create poll data structure."""
2025-11-18T07:14:11.2844802Z    |
2025-11-18T07:14:11.2844874Z help: Convert to `X | None`
2025-11-18T07:14:11.2844883Z 
2025-11-18T07:14:11.2844970Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2845056Z    --> app/services/polls.py:424:20
2025-11-18T07:14:11.2845113Z     |
2025-11-18T07:14:11.2845266Z 422 |     total_votes = sum(opt["votes"] for opt in poll_data["options"])
2025-11-18T07:14:11.2845323Z 423 |
2025-11-18T07:14:11.2845487Z 424 |     results_text = f"📊 Результати опитування:\n\n"
2025-11-18T07:14:11.2845564Z     |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2845725Z 425 |     results_text += f"❓ {poll_data['question']}\n\n"
2025-11-18T07:14:11.2845787Z     |
2025-11-18T07:14:11.2845869Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2845881Z 
2025-11-18T07:14:11.2845981Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2846078Z   --> app/services/profile_photo_tool.py:8:1
2025-11-18T07:14:11.2846136Z    |
2025-11-18T07:14:11.2846194Z  6 |   """
2025-11-18T07:14:11.2846250Z  7 |
2025-11-18T07:14:11.2846343Z  8 | / from __future__ import annotations
2025-11-18T07:14:11.2846401Z  9 | |
2025-11-18T07:14:11.2846467Z 10 | | import logging
2025-11-18T07:14:11.2846542Z 11 | | from typing import Any
2025-11-18T07:14:11.2846602Z 12 | |
2025-11-18T07:14:11.2846676Z 13 | | from aiogram import Bot
2025-11-18T07:14:11.2846893Z 14 | | from app.services.media import _download, _maybe_downscale_image, DEFAULT_PHOTO_MIME
2025-11-18T07:14:11.2847124Z    | |____________________________________________________________________________________^
2025-11-18T07:14:11.2847182Z 15 |
2025-11-18T07:14:11.2847270Z 16 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2847328Z    |
2025-11-18T07:14:11.2847404Z help: Organize imports
2025-11-18T07:14:11.2847410Z 
2025-11-18T07:14:11.2847500Z F401 [*] `datetime.time` imported but unused
2025-11-18T07:14:11.2847605Z   --> app/services/profile_summarization.py:16:32
2025-11-18T07:14:11.2847665Z    |
2025-11-18T07:14:11.2847730Z 14 | import asyncio
2025-11-18T07:14:11.2847917Z 15 | import logging
2025-11-18T07:14:11.2848010Z 16 | from datetime import datetime, time
2025-11-18T07:14:11.2848081Z    |                                ^^^^
2025-11-18T07:14:11.2848169Z 17 | from typing import TYPE_CHECKING, Any
2025-11-18T07:14:11.2848230Z    |
2025-11-18T07:14:11.2848324Z help: Remove unused import: `datetime.time`
2025-11-18T07:14:11.2848329Z 
2025-11-18T07:14:11.2848454Z UP035 `typing.Tuple` is deprecated, use `tuple` instead
2025-11-18T07:14:11.2848544Z  --> app/services/rate_limiter.py:5:1
2025-11-18T07:14:11.2848604Z   |
2025-11-18T07:14:11.2848670Z 3 | import asyncio
2025-11-18T07:14:11.2848732Z 4 | import time
2025-11-18T07:14:11.2848814Z 5 | from typing import Tuple
2025-11-18T07:14:11.2848986Z   | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2849043Z 6 |
2025-11-18T07:14:11.2849186Z 7 | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2849246Z   |
2025-11-18T07:14:11.2849251Z 
2025-11-18T07:14:11.2849379Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2849473Z   --> app/services/rate_limiter.py:77:10
2025-11-18T07:14:11.2849532Z    |
2025-11-18T07:14:11.2849616Z 75 |     async def check_and_increment(
2025-11-18T07:14:11.2849715Z 76 |         self, user_id: int, now: int | None = None
2025-11-18T07:14:11.2849797Z 77 |     ) -> Tuple[bool, int, int]:
2025-11-18T07:14:11.2849858Z    |          ^^^^^
2025-11-18T07:14:11.2849918Z 78 |         """
2025-11-18T07:14:11.2850083Z 79 |         Check if the user is within the allowed rate and increment on success.
2025-11-18T07:14:11.2850142Z    |
2025-11-18T07:14:11.2850220Z help: Replace with `tuple`
2025-11-18T07:14:11.2850226Z 
2025-11-18T07:14:11.2850349Z UP035 `typing.Tuple` is deprecated, use `tuple` instead
2025-11-18T07:14:11.2850451Z   --> app/services/redis_rate_limiter.py:12:1
2025-11-18T07:14:11.2850510Z    |
2025-11-18T07:14:11.2850574Z 10 | import logging
2025-11-18T07:14:11.2850636Z 11 | import time
2025-11-18T07:14:11.2850717Z 12 | from typing import Tuple
2025-11-18T07:14:11.2850785Z    | ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2850843Z 13 |
2025-11-18T07:14:11.2850956Z 14 | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2851012Z    |
2025-11-18T07:14:11.2851018Z 
2025-11-18T07:14:11.2851141Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2851243Z   --> app/services/redis_rate_limiter.py:48:10
2025-11-18T07:14:11.2851299Z    |
2025-11-18T07:14:11.2851380Z 46 |     async def check_and_increment(
2025-11-18T07:14:11.2851476Z 47 |         self, user_id: int, now: int | None = None
2025-11-18T07:14:11.2851563Z 48 |     ) -> Tuple[bool, int, int] | None:
2025-11-18T07:14:11.2851622Z    |          ^^^^^
2025-11-18T07:14:11.2851685Z 49 |         """
2025-11-18T07:14:11.2851847Z 50 |         Check if the user is within the allowed rate and increment on success.
2025-11-18T07:14:11.2851906Z    |
2025-11-18T07:14:11.2851983Z help: Replace with `tuple`
2025-11-18T07:14:11.2851989Z 
2025-11-18T07:14:11.2852111Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2852217Z    --> app/services/redis_rate_limiter.py:186:10
2025-11-18T07:14:11.2852276Z     |
2025-11-18T07:14:11.2852369Z 184 |         window_seconds: int | None = None,
2025-11-18T07:14:11.2852448Z 185 |         now: int | None = None,
2025-11-18T07:14:11.2852526Z 186 |     ) -> Tuple[bool, int] | None:
2025-11-18T07:14:11.2852590Z     |          ^^^^^
2025-11-18T07:14:11.2852654Z 187 |         """
2025-11-18T07:14:11.2852880Z 188 |         Check if user is within rate limit for a feature and increment.
2025-11-18T07:14:11.2852938Z     |
2025-11-18T07:14:11.2853013Z help: Replace with `tuple`
2025-11-18T07:14:11.2853024Z 
2025-11-18T07:14:11.2853151Z UP035 [*] Import from `collections.abc` instead: `Mapping`
2025-11-18T07:14:11.2853238Z  --> app/services/redis_types.py:3:1
2025-11-18T07:14:11.2853295Z   |
2025-11-18T07:14:11.2853383Z 1 | from __future__ import annotations
2025-11-18T07:14:11.2853439Z 2 |
2025-11-18T07:14:11.2853536Z 3 | from typing import Any, Mapping, Protocol
2025-11-18T07:14:11.2853704Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2853762Z   |
2025-11-18T07:14:11.2853847Z help: Import from `collections.abc`
2025-11-18T07:14:11.2853853Z 
2025-11-18T07:14:11.2853928Z F401 [*] `os` imported but unused
2025-11-18T07:14:11.2854023Z   --> app/services/resource_monitor.py:11:8
2025-11-18T07:14:11.2854082Z    |
2025-11-18T07:14:11.2854146Z  9 | import asyncio
2025-11-18T07:14:11.2854213Z 10 | import logging
2025-11-18T07:14:11.2854275Z 11 | import os
2025-11-18T07:14:11.2854332Z    |        ^^
2025-11-18T07:14:11.2854394Z 12 | import time
2025-11-18T07:14:11.2854479Z 13 | from dataclasses import dataclass
2025-11-18T07:14:11.2854614Z    |
2025-11-18T07:14:11.2854695Z help: Remove unused import: `os`
2025-11-18T07:14:11.2854700Z 
2025-11-18T07:14:11.2854846Z F401 [*] `app.services.telemetry.telemetry` imported but unused
2025-11-18T07:14:11.2854941Z   --> app/services/resource_monitor.py:16:36
2025-11-18T07:14:11.2855001Z    |
2025-11-18T07:14:11.2855084Z 14 | from typing import TYPE_CHECKING
2025-11-18T07:14:11.2855142Z 15 |
2025-11-18T07:14:11.2855247Z 16 | from app.services.telemetry import telemetry
2025-11-18T07:14:11.2855318Z    |                                    ^^^^^^^^^
2025-11-18T07:14:11.2855377Z 17 |
2025-11-18T07:14:11.2855445Z 18 | if TYPE_CHECKING:
2025-11-18T07:14:11.2855500Z    |
2025-11-18T07:14:11.2855653Z help: Remove unused import: `app.services.telemetry.telemetry`
2025-11-18T07:14:11.2855659Z 
2025-11-18T07:14:11.2855760Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2855856Z   --> app/services/resource_optimizer.py:6:1
2025-11-18T07:14:11.2855917Z    |
2025-11-18T07:14:11.2855981Z  4 |   """
2025-11-18T07:14:11.2856038Z  5 |
2025-11-18T07:14:11.2856123Z  6 | / from __future__ import annotations
2025-11-18T07:14:11.2856184Z  7 | |
2025-11-18T07:14:11.2856251Z  8 | | import asyncio
2025-11-18T07:14:11.2856316Z  9 | | import logging
2025-11-18T07:14:11.2856390Z 10 | | from typing import Any
2025-11-18T07:14:11.2856456Z 11 | |
2025-11-18T07:14:11.2856659Z 12 | | from app.services.resource_monitor import get_resource_monitor, ResourceStats
2025-11-18T07:14:11.2856766Z 13 | | from app.services.telemetry import telemetry
2025-11-18T07:14:11.2856849Z    | |____________________________________________^
2025-11-18T07:14:11.2856905Z 14 |
2025-11-18T07:14:11.2857089Z 15 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2857149Z    |
2025-11-18T07:14:11.2857219Z help: Organize imports
2025-11-18T07:14:11.2857225Z 
2025-11-18T07:14:11.2857304Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2857393Z    --> app/services/search_tool.py:223:1
2025-11-18T07:14:11.2857457Z     |
2025-11-18T07:14:11.2857515Z 221 |     """
2025-11-18T07:14:11.2857623Z 222 |     Fetch detailed content from a web page URL.
2025-11-18T07:14:11.2857683Z 223 |     
2025-11-18T07:14:11.2857741Z     | ^^^^
2025-11-18T07:14:11.2857925Z 224 |     Can be used after search_web to get full page content from specific results.
2025-11-18T07:14:11.2858130Z 225 |     Requires a URL to fetch from. Optional parameters (result_index, search_query) are
2025-11-18T07:14:11.2858191Z     |
2025-11-18T07:14:11.2858279Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2858284Z 
2025-11-18T07:14:11.2858362Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2858452Z    --> app/services/search_tool.py:227:1
2025-11-18T07:14:11.2858513Z     |
2025-11-18T07:14:11.2858705Z 225 |     Requires a URL to fetch from. Optional parameters (result_index, search_query) are
2025-11-18T07:14:11.2858858Z 226 |     included in the response for context/tracking purposes only.
2025-11-18T07:14:11.2858922Z 227 |     
2025-11-18T07:14:11.2858978Z     | ^^^^
2025-11-18T07:14:11.2859039Z 228 |     Args:
2025-11-18T07:14:11.2859138Z 229 |         params: Tool parameters containing:
2025-11-18T07:14:11.2859197Z     |
2025-11-18T07:14:11.2859281Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2859286Z 
2025-11-18T07:14:11.2859487Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2859571Z    --> app/services/search_tool.py:233:1
2025-11-18T07:14:11.2859628Z     |
2025-11-18T07:14:11.2859835Z 231 |             - 'result_index' (optional): Index from previous search_web results (for context)
2025-11-18T07:14:11.2859989Z 232 |             - 'search_query' (optional): Original search query (for context)
2025-11-18T07:14:11.2860046Z 233 |     
2025-11-18T07:14:11.2860103Z     | ^^^^
2025-11-18T07:14:11.2860167Z 234 |     Returns:
2025-11-18T07:14:11.2860287Z 235 |         JSON string with fetched content or error message
2025-11-18T07:14:11.2860344Z     |
2025-11-18T07:14:11.2860432Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2860545Z 
2025-11-18T07:14:11.2860627Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2860711Z    --> app/services/search_tool.py:240:1
2025-11-18T07:14:11.2860771Z     |
2025-11-18T07:14:11.2860869Z 238 |     result_index = params.get("result_index")
2025-11-18T07:14:11.2860982Z 239 |     search_query = params.get("search_query", "")
2025-11-18T07:14:11.2861040Z 240 |     
2025-11-18T07:14:11.2861100Z     | ^^^^
2025-11-18T07:14:11.2861170Z 241 |     # Validate URL
2025-11-18T07:14:11.2861265Z 242 |     if not url or not isinstance(url, str):
2025-11-18T07:14:11.2861325Z     |
2025-11-18T07:14:11.2861408Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2861414Z 
2025-11-18T07:14:11.2861492Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2861573Z    --> app/services/search_tool.py:247:1
2025-11-18T07:14:11.2861633Z     |
2025-11-18T07:14:11.2861701Z 245 |             "url": url,
2025-11-18T07:14:11.2861761Z 246 |         })
2025-11-18T07:14:11.2861826Z 247 |     
2025-11-18T07:14:11.2861883Z     | ^^^^
2025-11-18T07:14:11.2861957Z 248 |     # Basic URL validation
2025-11-18T07:14:11.2862033Z 249 |     parsed = urlparse(url)
2025-11-18T07:14:11.2862095Z     |
2025-11-18T07:14:11.2862179Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2862188Z 
2025-11-18T07:14:11.2862265Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2862351Z    --> app/services/search_tool.py:255:1
2025-11-18T07:14:11.2862409Z     |
2025-11-18T07:14:11.2862476Z 253 |             "url": url,
2025-11-18T07:14:11.2862537Z 254 |         })
2025-11-18T07:14:11.2862594Z 255 |     
2025-11-18T07:14:11.2862652Z     | ^^^^
2025-11-18T07:14:11.2862726Z 256 |     # Ensure URL has a scheme
2025-11-18T07:14:11.2862847Z 257 |     if not url.startswith(("http://", "https://")):
2025-11-18T07:14:11.2862905Z     |
2025-11-18T07:14:11.2862987Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2862993Z 
2025-11-18T07:14:11.2863073Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2863158Z    --> app/services/search_tool.py:259:1
2025-11-18T07:14:11.2863215Z     |
2025-11-18T07:14:11.2863323Z 257 |     if not url.startswith(("http://", "https://")):
2025-11-18T07:14:11.2863400Z 258 |         url = "https://" + url
2025-11-18T07:14:11.2863458Z 259 |     
2025-11-18T07:14:11.2863519Z     | ^^^^
2025-11-18T07:14:11.2863583Z 260 |     try:
2025-11-18T07:14:11.2863676Z 261 |         # Fetch page content with timeout
2025-11-18T07:14:11.2863733Z     |
2025-11-18T07:14:11.2863815Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2863823Z 
2025-11-18T07:14:11.2863901Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2863983Z    --> app/services/search_tool.py:268:1
2025-11-18T07:14:11.2864041Z     |
2025-11-18T07:14:11.2864479Z 266 | …         "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari…
2025-11-18T07:14:11.2864567Z 267 | …     }
2025-11-18T07:14:11.2864655Z 268 | …     
2025-11-18T07:14:11.2864715Z ^^^^^^^^^^^^
2025-11-18T07:14:11.2864983Z 269 | …     async with session.get(url, headers=headers, allow_redirects=True) as response:
2025-11-18T07:14:11.2865111Z 270 | …         if response.status != 200:
2025-11-18T07:14:11.2865172Z     |
2025-11-18T07:14:11.2865348Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2865354Z 
2025-11-18T07:14:11.2865434Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2865517Z    --> app/services/search_tool.py:276:1
2025-11-18T07:14:11.2865577Z     |
2025-11-18T07:14:11.2865676Z 274 |                         "status": response.status,
2025-11-18T07:14:11.2865743Z 275 |                     })
2025-11-18T07:14:11.2865806Z 276 |                 
2025-11-18T07:14:11.2865866Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2865946Z 277 |                 # Check content type
2025-11-18T07:14:11.2866111Z 278 |                 content_type = response.headers.get("Content-Type", "").lower()
2025-11-18T07:14:11.2866258Z     |
2025-11-18T07:14:11.2866342Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2866348Z 
2025-11-18T07:14:11.2866425Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2866510Z    --> app/services/search_tool.py:285:1
2025-11-18T07:14:11.2866566Z     |
2025-11-18T07:14:11.2866664Z 283 |                         "content_type": content_type,
2025-11-18T07:14:11.2866736Z 284 |                     })
2025-11-18T07:14:11.2866797Z 285 |                 
2025-11-18T07:14:11.2866858Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2867146Z 286 |                 # Read content with size limit (1MB max)
2025-11-18T07:14:11.2867323Z 287 |                 content = await response.read()
2025-11-18T07:14:11.2867381Z     |
2025-11-18T07:14:11.2867473Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2867479Z 
2025-11-18T07:14:11.2867568Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2867659Z    --> app/services/search_tool.py:294:1
2025-11-18T07:14:11.2867718Z     |
2025-11-18T07:14:11.2867820Z 292 |                         "size_bytes": len(content),
2025-11-18T07:14:11.2867887Z 293 |                     })
2025-11-18T07:14:11.2867948Z 294 |                 
2025-11-18T07:14:11.2868009Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2868083Z 295 |                 # Decode HTML
2025-11-18T07:14:11.2868151Z 296 |                 try:
2025-11-18T07:14:11.2868207Z     |
2025-11-18T07:14:11.2868295Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2868300Z 
2025-11-18T07:14:11.2868381Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2868468Z    --> app/services/search_tool.py:307:1
2025-11-18T07:14:11.2868526Z     |
2025-11-18T07:14:11.2868609Z 305 |                             "url": url,
2025-11-18T07:14:11.2868675Z 306 |                         })
2025-11-18T07:14:11.2868735Z 307 |                 
2025-11-18T07:14:11.2868797Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2868881Z 308 |                 # Extract text from HTML
2025-11-18T07:14:11.2868972Z 309 |                 parser = TextExtractor()
2025-11-18T07:14:11.2869036Z     |
2025-11-18T07:14:11.2869122Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2869127Z 
2025-11-18T07:14:11.2869206Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2869288Z    --> app/services/search_tool.py:312:1
2025-11-18T07:14:11.2869351Z     |
2025-11-18T07:14:11.2869443Z 310 |                 parser.feed(html_content)
2025-11-18T07:14:11.2869570Z 311 |                 extracted_text = parser.get_text(max_length=5000)
2025-11-18T07:14:11.2869637Z 312 |                 
2025-11-18T07:14:11.2869698Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2869792Z 313 |                 # Try to extract title from HTML
2025-11-18T07:14:11.2870007Z 314 |                 title_match = re.search(r"<title[^>]*>(.*?)</title>", html_content, re.IGNORECASE | re.DOTALL)
2025-11-18T07:14:11.2870070Z     |
2025-11-18T07:14:11.2870154Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2870159Z 
2025-11-18T07:14:11.2870242Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2870327Z    --> app/services/search_tool.py:319:1
2025-11-18T07:14:11.2870385Z     |
2025-11-18T07:14:11.2870480Z 317 |                 title = re.sub(r"<[^>]+>", "", title)
2025-11-18T07:14:11.2870597Z 318 |                 title = title.replace("&nbsp;", " ").strip()
2025-11-18T07:14:11.2870795Z 319 |                 
2025-11-18T07:14:11.2870855Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2870938Z 320 |                 return json.dumps({
2025-11-18T07:14:11.2871009Z 321 |                     "url": url,
2025-11-18T07:14:11.2871066Z     |
2025-11-18T07:14:11.2871149Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2871154Z 
2025-11-18T07:14:11.2871236Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2871318Z    --> app/services/search_tool.py:329:1
2025-11-18T07:14:11.2871375Z     |
2025-11-18T07:14:11.2871473Z 327 |                     "search_query": search_query,
2025-11-18T07:14:11.2871557Z 328 |                 }, ensure_ascii=False)
2025-11-18T07:14:11.2871725Z 329 |     
2025-11-18T07:14:11.2871782Z     | ^^^^
2025-11-18T07:14:11.2871872Z 330 |     except asyncio.TimeoutError:
2025-11-18T07:14:11.2871947Z 331 |         return json.dumps({
2025-11-18T07:14:11.2872004Z     |
2025-11-18T07:14:11.2872090Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2872099Z 
2025-11-18T07:14:11.2872208Z UP041 [*] Replace aliased errors with `TimeoutError`
2025-11-18T07:14:11.2872296Z    --> app/services/search_tool.py:330:12
2025-11-18T07:14:11.2872356Z     |
2025-11-18T07:14:11.2872437Z 328 |                 }, ensure_ascii=False)
2025-11-18T07:14:11.2872494Z 329 |     
2025-11-18T07:14:11.2872578Z 330 |     except asyncio.TimeoutError:
2025-11-18T07:14:11.2872648Z     |            ^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2872720Z 331 |         return json.dumps({
2025-11-18T07:14:11.2872859Z 332 |             "error": "Request timeout: URL took too long to respond",
2025-11-18T07:14:11.2872921Z     |
2025-11-18T07:14:11.2873078Z help: Replace `asyncio.TimeoutError` with builtin `TimeoutError`
2025-11-18T07:14:11.2873084Z 
2025-11-18T07:14:11.2873163Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2873251Z    --> app/services/search_tool.py:356:1
2025-11-18T07:14:11.2873308Z     |
2025-11-18T07:14:11.2873367Z 354 |     """
2025-11-18T07:14:11.2873473Z 355 |     Analyze text/news search results using LLM.
2025-11-18T07:14:11.2873534Z 356 |     
2025-11-18T07:14:11.2873591Z     | ^^^^
2025-11-18T07:14:11.2873652Z 357 |     Args:
2025-11-18T07:14:11.2873737Z 358 |         query: Original search query
2025-11-18T07:14:11.2873793Z     |
2025-11-18T07:14:11.2873877Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2873883Z 
2025-11-18T07:14:11.2873959Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2874043Z    --> app/services/search_tool.py:362:1
2025-11-18T07:14:11.2874099Z     |
2025-11-18T07:14:11.2874292Z 360 |         fetched_content: List of fetched content dicts with 'url', 'title', 'content'
2025-11-18T07:14:11.2874400Z 361 |         gemini_client: Gemini client for analysis
2025-11-18T07:14:11.2874459Z 362 |     
2025-11-18T07:14:11.2874516Z     | ^^^^
2025-11-18T07:14:11.2874577Z 363 |     Returns:
2025-11-18T07:14:11.2874683Z 364 |         Dict with summary, key_points, and sources
2025-11-18T07:14:11.2874743Z     |
2025-11-18T07:14:11.2874826Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2874832Z 
2025-11-18T07:14:11.2874911Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2874991Z    --> app/services/search_tool.py:372:1
2025-11-18T07:14:11.2875048Z     |
2025-11-18T07:14:11.2875121Z 370 |             "sources": [],
2025-11-18T07:14:11.2875180Z 371 |         }
2025-11-18T07:14:11.2875237Z 372 |     
2025-11-18T07:14:11.2875294Z     | ^^^^
2025-11-18T07:14:11.2875371Z 373 |     # Build analysis prompt
2025-11-18T07:14:11.2875443Z 374 |     content_texts = []
2025-11-18T07:14:11.2875500Z     |
2025-11-18T07:14:11.2875586Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2875595Z 
2025-11-18T07:14:11.2875672Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2875754Z    --> app/services/search_tool.py:381:1
2025-11-18T07:14:11.2875811Z     |
2025-11-18T07:14:11.2875878Z 379 |         if text:
2025-11-18T07:14:11.2876100Z 380 |             content_texts.append(f"Source {idx + 1} ({url}):\nTitle: {title}\nContent: {text[:2000]}\n")
2025-11-18T07:14:11.2876247Z 381 |     
2025-11-18T07:14:11.2876306Z     | ^^^^
2025-11-18T07:14:11.2876380Z 382 |     if not content_texts:
2025-11-18T07:14:11.2876443Z 383 |         return {
2025-11-18T07:14:11.2876502Z     |
2025-11-18T07:14:11.2876585Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2876591Z 
2025-11-18T07:14:11.2876668Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2876751Z    --> app/services/search_tool.py:388:1
2025-11-18T07:14:11.2876812Z     |
2025-11-18T07:14:11.2876881Z 386 |             "sources": [],
2025-11-18T07:14:11.2876939Z 387 |         }
2025-11-18T07:14:11.2877226Z 388 |     
2025-11-18T07:14:11.2877286Z     | ^^^^
2025-11-18T07:14:11.2877466Z 389 |     prompt = f"""Analyze the following search results for the query: "{query}"
2025-11-18T07:14:11.2877525Z     |
2025-11-18T07:14:11.2877616Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2877622Z 
2025-11-18T07:14:11.2877707Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2877797Z    --> app/services/search_tool.py:404:1
2025-11-18T07:14:11.2877858Z     |
2025-11-18T07:14:11.2878015Z 402 |     "relevant_sources": [0, 1, ...]  // indices of most relevant sources
2025-11-18T07:14:11.2878074Z 403 | }}"""
2025-11-18T07:14:11.2878134Z 404 |     
2025-11-18T07:14:11.2878190Z     | ^^^^
2025-11-18T07:14:11.2878250Z 405 |     try:
2025-11-18T07:14:11.2878355Z 406 |         response = await gemini_client.generate(
2025-11-18T07:14:11.2878415Z     |
2025-11-18T07:14:11.2878498Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2878503Z 
2025-11-18T07:14:11.2878581Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2878669Z    --> app/services/search_tool.py:411:1
2025-11-18T07:14:11.2878726Z     |
2025-11-18T07:14:11.2878819Z 409 |             user_parts=[{"text": prompt}],
2025-11-18T07:14:11.2878878Z 410 |         )
2025-11-18T07:14:11.2878939Z 411 |         
2025-11-18T07:14:11.2878996Z     | ^^^^^^^^
2025-11-18T07:14:11.2879116Z 412 |         text_response = response.get("text", "").strip()
2025-11-18T07:14:11.2879176Z     |
2025-11-18T07:14:11.2879260Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2879265Z 
2025-11-18T07:14:11.2879343Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2879433Z    --> app/services/search_tool.py:413:1
2025-11-18T07:14:11.2879490Z     |
2025-11-18T07:14:11.2879601Z 412 |         text_response = response.get("text", "").strip()
2025-11-18T07:14:11.2879659Z 413 |         
2025-11-18T07:14:11.2879721Z     | ^^^^^^^^
2025-11-18T07:14:11.2879811Z 414 |         # Try to parse JSON from response
2025-11-18T07:14:11.2879871Z 415 |         try:
2025-11-18T07:14:11.2879935Z     |
2025-11-18T07:14:11.2880016Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2880022Z 
2025-11-18T07:14:11.2880100Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2880185Z    --> app/services/search_tool.py:429:1
2025-11-18T07:14:11.2880245Z     |
2025-11-18T07:14:11.2880380Z 427 |                 "relevant_sources": list(range(len(fetched_content))),
2025-11-18T07:14:11.2880440Z 428 |             }
2025-11-18T07:14:11.2880501Z 429 |         
2025-11-18T07:14:11.2880558Z     | ^^^^^^^^
2025-11-18T07:14:11.2880633Z 430 |         # Build sources list
2025-11-18T07:14:11.2880704Z 431 |         sources = []
2025-11-18T07:14:11.2880762Z     |
2025-11-18T07:14:11.2880845Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2880851Z 
2025-11-18T07:14:11.2880930Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2881013Z    --> app/services/search_tool.py:440:1
2025-11-18T07:14:11.2881071Z     |
2025-11-18T07:14:11.2881168Z 438 |                 "relevant": idx in relevant_indices,
2025-11-18T07:14:11.2881236Z 439 |             })
2025-11-18T07:14:11.2881296Z 440 |         
2025-11-18T07:14:11.2881355Z     | ^^^^^^^^
2025-11-18T07:14:11.2881418Z 441 |         return {
2025-11-18T07:14:11.2881521Z 442 |             "summary": analysis.get("summary", ""),
2025-11-18T07:14:11.2881701Z     |
2025-11-18T07:14:11.2881787Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2881792Z 
2025-11-18T07:14:11.2881875Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2881957Z    --> app/services/search_tool.py:463:1
2025-11-18T07:14:11.2882015Z     |
2025-11-18T07:14:11.2882076Z 461 |     """
2025-11-18T07:14:11.2882189Z 462 |     Analyze image search results using vision model.
2025-11-18T07:14:11.2882250Z 463 |     
2025-11-18T07:14:11.2882309Z     | ^^^^
2025-11-18T07:14:11.2882371Z 464 |     Args:
2025-11-18T07:14:11.2882455Z 465 |         query: Original search query
2025-11-18T07:14:11.2882512Z     |
2025-11-18T07:14:11.2882721Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2882728Z 
2025-11-18T07:14:11.2882805Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2882888Z    --> app/services/search_tool.py:469:1
2025-11-18T07:14:11.2882946Z     |
2025-11-18T07:14:11.2883090Z 467 |         downloaded_images: List of (image_data, filename) tuples
2025-11-18T07:14:11.2883208Z 468 |         gemini_client: Gemini client with vision support
2025-11-18T07:14:11.2883267Z 469 |     
2025-11-18T07:14:11.2883328Z     | ^^^^
2025-11-18T07:14:11.2883388Z 470 |     Returns:
2025-11-18T07:14:11.2883519Z 471 |         Dict with summary, descriptions, and selected indices
2025-11-18T07:14:11.2883578Z     |
2025-11-18T07:14:11.2883662Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2883668Z 
2025-11-18T07:14:11.2883746Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2883831Z    --> app/services/search_tool.py:479:1
2025-11-18T07:14:11.2883892Z     |
2025-11-18T07:14:11.2883973Z 477 |             "selected_indices": [],
2025-11-18T07:14:11.2884035Z 478 |         }
2025-11-18T07:14:11.2884095Z 479 |     
2025-11-18T07:14:11.2884152Z     | ^^^^
2025-11-18T07:14:11.2884225Z 480 |     # Analyze each image
2025-11-18T07:14:11.2884299Z 481 |     descriptions = []
2025-11-18T07:14:11.2884359Z     |
2025-11-18T07:14:11.2884443Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2884451Z 
2025-11-18T07:14:11.2884530Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2884617Z    --> app/services/search_tool.py:483:1
2025-11-18T07:14:11.2884675Z     |
2025-11-18T07:14:11.2884747Z 481 |     descriptions = []
2025-11-18T07:14:11.2884822Z 482 |     selected_indices = []
2025-11-18T07:14:11.2884881Z 483 |     
2025-11-18T07:14:11.2884939Z     | ^^^^
2025-11-18T07:14:11.2885088Z 484 |     for idx, (image_data, filename) in enumerate(downloaded_images):
2025-11-18T07:14:11.2885153Z 485 |         try:
2025-11-18T07:14:11.2885210Z     |
2025-11-18T07:14:11.2885294Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2885303Z 
2025-11-18T07:14:11.2885384Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2885467Z    --> app/services/search_tool.py:488:1
2025-11-18T07:14:11.2885526Z     |
2025-11-18T07:14:11.2885609Z 486 |             # Convert image to base64
2025-11-18T07:14:11.2885746Z 487 |             image_b64 = base64.b64encode(image_data).decode("utf-8")
2025-11-18T07:14:11.2885810Z 488 |             
2025-11-18T07:14:11.2885869Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2886003Z 489 |             # Determine MIME type from filename or default to jpeg
2025-11-18T07:14:11.2886085Z 490 |             mime_type = "image/jpeg"
2025-11-18T07:14:11.2886142Z     |
2025-11-18T07:14:11.2886229Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2886234Z 
2025-11-18T07:14:11.2886312Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2886396Z    --> app/services/search_tool.py:497:1
2025-11-18T07:14:11.2886454Z     |
2025-11-18T07:14:11.2886558Z 495 |             elif filename.lower().endswith(".webp"):
2025-11-18T07:14:11.2886648Z 496 |                 mime_type = "image/webp"
2025-11-18T07:14:11.2886707Z 497 |             
2025-11-18T07:14:11.2886769Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2886850Z 498 |             # Build analysis prompt
2025-11-18T07:14:11.2887138Z 499 |             prompt = f"""Analyze this image in the context of the search query: "{query}"
2025-11-18T07:14:11.2887320Z     |
2025-11-18T07:14:11.2887406Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2887412Z 
2025-11-18T07:14:11.2887492Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2887574Z    --> app/services/search_tool.py:502:1
2025-11-18T07:14:11.2887633Z     |
2025-11-18T07:14:11.2887844Z 501 | Describe what you see and how relevant it is to the query. Be concise (1-2 sentences)."""
2025-11-18T07:14:11.2887904Z 502 |             
2025-11-18T07:14:11.2887966Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2888053Z 503 |             # Use Gemini to analyze image
2025-11-18T07:14:11.2888156Z 504 |             response = await gemini_client.generate(
2025-11-18T07:14:11.2888322Z     |
2025-11-18T07:14:11.2888410Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2888415Z 
2025-11-18T07:14:11.2888494Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2888579Z    --> app/services/search_tool.py:517:1
2025-11-18T07:14:11.2888643Z     |
2025-11-18T07:14:11.2888708Z 515 |                 ],
2025-11-18T07:14:11.2888769Z 516 |             )
2025-11-18T07:14:11.2888830Z 517 |             
2025-11-18T07:14:11.2888889Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2889006Z 518 |             description = response.get("text", "").strip()
2025-11-18T07:14:11.2889087Z 519 |             descriptions.append({
2025-11-18T07:14:11.2889146Z     |
2025-11-18T07:14:11.2889229Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2889235Z 
2025-11-18T07:14:11.2889314Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2889398Z    --> app/services/search_tool.py:524:1
2025-11-18T07:14:11.2889458Z     |
2025-11-18T07:14:11.2889610Z 522 |                 "url": results[idx].get("url", "") if idx < len(results) else "",
2025-11-18T07:14:11.2889674Z 523 |             })
2025-11-18T07:14:11.2889733Z 524 |             
2025-11-18T07:14:11.2889791Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2889921Z 525 |             # Consider image relevant if description is not empty
2025-11-18T07:14:11.2890003Z 526 |             if description:
2025-11-18T07:14:11.2890061Z     |
2025-11-18T07:14:11.2890144Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2890149Z 
2025-11-18T07:14:11.2890230Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2890312Z    --> app/services/search_tool.py:528:1
2025-11-18T07:14:11.2890370Z     |
2025-11-18T07:14:11.2890442Z 526 |             if description:
2025-11-18T07:14:11.2890540Z 527 |                 selected_indices.append(idx)
2025-11-18T07:14:11.2890601Z 528 |                 
2025-11-18T07:14:11.2890662Z     | ^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2890743Z 529 |         except Exception as e:
2025-11-18T07:14:11.2890883Z 530 |             logger.warning(f"Failed to analyze image {idx}: {e}")
2025-11-18T07:14:11.2890942Z     |
2025-11-18T07:14:11.2891031Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2891037Z 
2025-11-18T07:14:11.2891115Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2891202Z    --> app/services/search_tool.py:536:1
2025-11-18T07:14:11.2891258Z     |
2025-11-18T07:14:11.2891407Z 534 |                 "url": results[idx].get("url", "") if idx < len(results) else "",
2025-11-18T07:14:11.2891468Z 535 |             })
2025-11-18T07:14:11.2891527Z 536 |     
2025-11-18T07:14:11.2891586Z     | ^^^^
2025-11-18T07:14:11.2891663Z 537 |     # Generate overall summary
2025-11-18T07:14:11.2891736Z 538 |     if descriptions:
2025-11-18T07:14:11.2891793Z     |
2025-11-18T07:14:11.2891879Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2891885Z 
2025-11-18T07:14:11.2891963Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2892048Z    --> app/services/search_tool.py:540:1
2025-11-18T07:14:11.2892106Z     |
2025-11-18T07:14:11.2892176Z 538 |     if descriptions:
2025-11-18T07:14:11.2892566Z 539 |         summary_prompt = f"""Based on the analyzed images for query "{query}", provide a brief summary (1-2 sentences) of what was fo…
2025-11-18T07:14:11.2892716Z 540 |         
2025-11-18T07:14:11.2892776Z     | ^^^^^^^^
2025-11-18T07:14:11.2892836Z 541 |         try:
2025-11-18T07:14:11.2893090Z 542 |             desc_text = "\n".join([f"Image {d['index']}: {d['description']}" for d in descriptions if d['description']])
2025-11-18T07:14:11.2893150Z     |
2025-11-18T07:14:11.2893235Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2893240Z 
2025-11-18T07:14:11.2893318Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2893403Z    --> app/services/search_tool.py:554:1
2025-11-18T07:14:11.2893460Z     |
2025-11-18T07:14:11.2893520Z 552 |     else:
2025-11-18T07:14:11.2893589Z 553 |         summary = ""
2025-11-18T07:14:11.2893727Z 554 |     
2025-11-18T07:14:11.2893784Z     | ^^^^
2025-11-18T07:14:11.2893844Z 555 |     return {
2025-11-18T07:14:11.2893918Z 556 |         "summary": summary,
2025-11-18T07:14:11.2893975Z     |
2025-11-18T07:14:11.2894057Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2894062Z 
2025-11-18T07:14:11.2894150Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2894232Z    --> app/services/search_tool.py:569:1
2025-11-18T07:14:11.2894292Z     |
2025-11-18T07:14:11.2894350Z 567 |     """
2025-11-18T07:14:11.2894449Z 568 |     Analyze video search results using LLM.
2025-11-18T07:14:11.2894506Z 569 |     
2025-11-18T07:14:11.2894563Z     | ^^^^
2025-11-18T07:14:11.2894624Z 570 |     Args:
2025-11-18T07:14:11.2894707Z 571 |         query: Original search query
2025-11-18T07:14:11.2894765Z     |
2025-11-18T07:14:11.2894847Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2894855Z 
2025-11-18T07:14:11.2894932Z W293 Blank line contains whitespace
2025-11-18T07:14:11.2895016Z    --> app/services/search_tool.py:574:1
2025-11-18T07:14:11.2895073Z     |
2025-11-18T07:14:11.2895183Z 572 |         results: Video search results with metadata
2025-11-18T07:14:11.2895285Z 573 |         gemini_client: Gemini client for analysis
2025-11-18T07:14:11.2895342Z 574 |     
2025-11-18T07:14:11.2895407Z     | ^^^^
2025-11-18T07:14:11.2895469Z 575 |     Returns:
2025-11-18T07:14:11.2895591Z 576 |         Dict with summary, key_points, and selected indices
2025-11-18T07:14:11.2895650Z     |
2025-11-18T07:14:11.2895737Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2895743Z 
2025-11-18T07:14:11.2895823Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2895907Z    --> app/services/search_tool.py:584:1
2025-11-18T07:14:11.2895968Z     |
2025-11-18T07:14:11.2896050Z 582 |             "selected_indices": [],
2025-11-18T07:14:11.2896109Z 583 |         }
2025-11-18T07:14:11.2896169Z 584 |     
2025-11-18T07:14:11.2896227Z     | ^^^^
2025-11-18T07:14:11.2896334Z 585 |     # Build analysis prompt from video metadata
2025-11-18T07:14:11.2896407Z 586 |     video_info = []
2025-11-18T07:14:11.2896468Z     |
2025-11-18T07:14:11.2896552Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2896558Z 
2025-11-18T07:14:11.2896636Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2896724Z    --> app/services/search_tool.py:593:1
2025-11-18T07:14:11.2896782Z     |
2025-11-18T07:14:11.2896877Z 591 |         duration = result.get("duration", "")
2025-11-18T07:14:11.2897083Z 592 |         url = result.get("url", "")
2025-11-18T07:14:11.2897149Z 593 |         
2025-11-18T07:14:11.2897207Z     | ^^^^^^^^
2025-11-18T07:14:11.2897287Z 594 |         info = f"Video {idx + 1}:\n"
2025-11-18T07:14:11.2897356Z 595 |         if title:
2025-11-18T07:14:11.2897413Z     |
2025-11-18T07:14:11.2897496Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2897502Z 
2025-11-18T07:14:11.2897582Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2897665Z    --> app/services/search_tool.py:606:1
2025-11-18T07:14:11.2897728Z     |
2025-11-18T07:14:11.2897802Z 604 |             info += f"URL: {url}\n"
2025-11-18T07:14:11.2897884Z 605 |         video_info.append(info)
2025-11-18T07:14:11.2897942Z 606 |     
2025-11-18T07:14:11.2897998Z     | ^^^^
2025-11-18T07:14:11.2898195Z 607 |     prompt = f"""Analyze the following video search results for the query: "{query}"
2025-11-18T07:14:11.2898373Z     |
2025-11-18T07:14:11.2898457Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2898462Z 
2025-11-18T07:14:11.2898539Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2898624Z    --> app/services/search_tool.py:622:1
2025-11-18T07:14:11.2898681Z     |
2025-11-18T07:14:11.2898835Z 620 |     "relevant_indices": [0, 1, ...]  // indices of most relevant videos
2025-11-18T07:14:11.2898897Z 621 | }}"""
2025-11-18T07:14:11.2898953Z 622 |     
2025-11-18T07:14:11.2899010Z     | ^^^^
2025-11-18T07:14:11.2899071Z 623 |     try:
2025-11-18T07:14:11.2899174Z 624 |         response = await gemini_client.generate(
2025-11-18T07:14:11.2899337Z     |
2025-11-18T07:14:11.2899421Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2899426Z 
2025-11-18T07:14:11.2899509Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2899593Z    --> app/services/search_tool.py:629:1
2025-11-18T07:14:11.2899654Z     |
2025-11-18T07:14:11.2899750Z 627 |             user_parts=[{"text": prompt}],
2025-11-18T07:14:11.2899809Z 628 |         )
2025-11-18T07:14:11.2899866Z 629 |         
2025-11-18T07:14:11.2899922Z     | ^^^^^^^^
2025-11-18T07:14:11.2900041Z 630 |         text_response = response.get("text", "").strip()
2025-11-18T07:14:11.2900097Z     |
2025-11-18T07:14:11.2900180Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2900185Z 
2025-11-18T07:14:11.2900264Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2900345Z    --> app/services/search_tool.py:631:1
2025-11-18T07:14:11.2900403Z     |
2025-11-18T07:14:11.2900515Z 630 |         text_response = response.get("text", "").strip()
2025-11-18T07:14:11.2900576Z 631 |         
2025-11-18T07:14:11.2900634Z     | ^^^^^^^^
2025-11-18T07:14:11.2900725Z 632 |         # Try to parse JSON from response
2025-11-18T07:14:11.2900788Z 633 |         try:
2025-11-18T07:14:11.2900845Z     |
2025-11-18T07:14:11.2900928Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2900937Z 
2025-11-18T07:14:11.2901017Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2901099Z    --> app/services/search_tool.py:646:1
2025-11-18T07:14:11.2901156Z     |
2025-11-18T07:14:11.2901272Z 644 |                 "relevant_indices": list(range(len(results))),
2025-11-18T07:14:11.2901335Z 645 |             }
2025-11-18T07:14:11.2901393Z 646 |         
2025-11-18T07:14:11.2901451Z     | ^^^^^^^^
2025-11-18T07:14:11.2901517Z 647 |         return {
2025-11-18T07:14:11.2901619Z 648 |             "summary": analysis.get("summary", ""),
2025-11-18T07:14:11.2901676Z     |
2025-11-18T07:14:11.2901759Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2901771Z 
2025-11-18T07:14:11.2901872Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2901973Z   --> app/services/system_prompt_manager.py:3:1
2025-11-18T07:14:11.2902031Z    |
2025-11-18T07:14:11.2902191Z  1 |   """System Prompt Manager for custom admin-configured prompts."""
2025-11-18T07:14:11.2902252Z  2 |
2025-11-18T07:14:11.2902337Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.2902396Z  4 | |
2025-11-18T07:14:11.2902462Z  5 | | import logging
2025-11-18T07:14:11.2902525Z  6 | | import time
2025-11-18T07:14:11.2902607Z  7 | | from dataclasses import dataclass
2025-11-18T07:14:11.2902688Z  8 | | from pathlib import Path
2025-11-18T07:14:11.2902764Z  9 | | from typing import Any
2025-11-18T07:14:11.2902821Z 10 | |
2025-11-18T07:14:11.2902890Z 11 | | import asyncpg
2025-11-18T07:14:11.2903084Z 12 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2903222Z 13 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2903324Z    | |_________________________________________________________^
2025-11-18T07:14:11.2903381Z 14 |
2025-11-18T07:14:11.2903471Z 15 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2903533Z    |
2025-11-18T07:14:11.2903610Z help: Organize imports
2025-11-18T07:14:11.2903701Z 
2025-11-18T07:14:11.2903794Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2903897Z  --> app/services/system_prompt_manager.py:8:21
2025-11-18T07:14:11.2903956Z   |
2025-11-18T07:14:11.2904019Z 6 | import time
2025-11-18T07:14:11.2904101Z 7 | from dataclasses import dataclass
2025-11-18T07:14:11.2904180Z 8 | from pathlib import Path
2025-11-18T07:14:11.2904248Z   |                     ^^^^
2025-11-18T07:14:11.2904322Z 9 | from typing import Any
2025-11-18T07:14:11.2904378Z   |
2025-11-18T07:14:11.2904475Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2904481Z 
2025-11-18T07:14:11.2904565Z F401 [*] `typing.Any` imported but unused
2025-11-18T07:14:11.2904744Z   --> app/services/system_prompt_manager.py:9:20
2025-11-18T07:14:11.2904804Z    |
2025-11-18T07:14:11.2904889Z  7 | from dataclasses import dataclass
2025-11-18T07:14:11.2904965Z  8 | from pathlib import Path
2025-11-18T07:14:11.2905038Z  9 | from typing import Any
2025-11-18T07:14:11.2905105Z    |                    ^^^
2025-11-18T07:14:11.2905165Z 10 |
2025-11-18T07:14:11.2905230Z 11 | import asyncpg
2025-11-18T07:14:11.2905288Z    |
2025-11-18T07:14:11.2905375Z help: Remove unused import: `typing.Any`
2025-11-18T07:14:11.2905381Z 
2025-11-18T07:14:11.2905469Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2905559Z  --> app/services/telegram_service.py:7:21
2025-11-18T07:14:11.2905620Z   |
2025-11-18T07:14:11.2905683Z 5 | import logging
2025-11-18T07:14:11.2905777Z 6 | from datetime import datetime, timedelta
2025-11-18T07:14:11.2905855Z 7 | from pathlib import Path
2025-11-18T07:14:11.2905919Z   |                     ^^^^
2025-11-18T07:14:11.2905974Z 8 |
2025-11-18T07:14:11.2906050Z 9 | from aiogram import Bot
2025-11-18T07:14:11.2906109Z   |
2025-11-18T07:14:11.2906200Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2906206Z 
2025-11-18T07:14:11.2906310Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2906399Z  --> app/services/telemetry.py:1:1
2025-11-18T07:14:11.2906458Z   |
2025-11-18T07:14:11.2906540Z 1 | / from __future__ import annotations
2025-11-18T07:14:11.2906601Z 2 | |
2025-11-18T07:14:11.2906667Z 3 | | import logging
2025-11-18T07:14:11.2906748Z 4 | | from collections import Counter
2025-11-18T07:14:11.2906825Z 5 | | from threading import Lock
2025-11-18T07:14:11.2906906Z 6 | | from typing import Any, Tuple
2025-11-18T07:14:11.2907068Z   | |_____________________________^
2025-11-18T07:14:11.2907127Z   |
2025-11-18T07:14:11.2907199Z help: Organize imports
2025-11-18T07:14:11.2907205Z 
2025-11-18T07:14:11.2907329Z UP035 `typing.Tuple` is deprecated, use `tuple` instead
2025-11-18T07:14:11.2907411Z  --> app/services/telemetry.py:6:1
2025-11-18T07:14:11.2907471Z   |
2025-11-18T07:14:11.2907551Z 4 | from collections import Counter
2025-11-18T07:14:11.2907627Z 5 | from threading import Lock
2025-11-18T07:14:11.2907704Z 6 | from typing import Any, Tuple
2025-11-18T07:14:11.2907772Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2907827Z   |
2025-11-18T07:14:11.2907836Z 
2025-11-18T07:14:11.2907961Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2908050Z   --> app/services/telemetry.py:9:30
2025-11-18T07:14:11.2908107Z    |
2025-11-18T07:14:11.2908272Z  9 | _METRICS: Counter[tuple[str, Tuple[tuple[str, Any], ...]]] = Counter()
2025-11-18T07:14:11.2908340Z    |                              ^^^^^
2025-11-18T07:14:11.2908407Z 10 | _LOCK = Lock()
2025-11-18T07:14:11.2908516Z 11 | _LOGGER = logging.getLogger("gryag.telemetry")
2025-11-18T07:14:11.2908573Z    |
2025-11-18T07:14:11.2908655Z help: Replace with `tuple`
2025-11-18T07:14:11.2908660Z 
2025-11-18T07:14:11.2908784Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2908874Z   --> app/services/telemetry.py:14:50
2025-11-18T07:14:11.2908934Z    |
2025-11-18T07:14:11.2909122Z 14 | def _normalize_labels(labels: dict[str, Any]) -> Tuple[tuple[str, Any], ...]:
2025-11-18T07:14:11.2909204Z    |                                                  ^^^^^
2025-11-18T07:14:11.2909390Z 15 |     if not labels:
2025-11-18T07:14:11.2909456Z 16 |         return ()
2025-11-18T07:14:11.2909511Z    |
2025-11-18T07:14:11.2909586Z help: Replace with `tuple`
2025-11-18T07:14:11.2909591Z 
2025-11-18T07:14:11.2909716Z UP006 [*] Use `tuple` instead of `Tuple` for type annotation
2025-11-18T07:14:11.2909801Z   --> app/services/telemetry.py:64:36
2025-11-18T07:14:11.2909859Z    |
2025-11-18T07:14:11.2910019Z 64 | def _render_key(name: str, labels: Tuple[tuple[str, Any], ...]) -> str:
2025-11-18T07:14:11.2910096Z    |                                    ^^^^^
2025-11-18T07:14:11.2910160Z 65 |     if not labels:
2025-11-18T07:14:11.2910227Z 66 |         return name
2025-11-18T07:14:11.2910391Z    |
2025-11-18T07:14:11.2910471Z help: Replace with `tuple`
2025-11-18T07:14:11.2910477Z 
2025-11-18T07:14:11.2910637Z UP035 [*] Import from `collections.abc` instead: `Awaitable`, `Callable`
2025-11-18T07:14:11.2910725Z   --> app/services/tool_logging.py:13:1
2025-11-18T07:14:11.2910786Z    |
2025-11-18T07:14:11.2910849Z 11 | import logging
2025-11-18T07:14:11.2910911Z 12 | import time
2025-11-18T07:14:11.2911010Z 13 | from typing import Any, Awaitable, Callable
2025-11-18T07:14:11.2911080Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2911136Z 14 |
2025-11-18T07:14:11.2911224Z 15 | # Import telemetry for usage tracking
2025-11-18T07:14:11.2911281Z    |
2025-11-18T07:14:11.2911364Z help: Import from `collections.abc`
2025-11-18T07:14:11.2911370Z 
2025-11-18T07:14:11.2911468Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2911556Z   --> app/services/tools/__init__.py:3:1
2025-11-18T07:14:11.2911613Z    |
2025-11-18T07:14:11.2911751Z  1 |   """Memory management tools for Gemini function calling."""
2025-11-18T07:14:11.2911810Z  2 |
2025-11-18T07:14:11.2911887Z  3 | / from .memory_tools import (
2025-11-18T07:14:11.2911961Z  4 | |     remember_memory_tool,
2025-11-18T07:14:11.2912035Z  5 | |     recall_memories_tool,
2025-11-18T07:14:11.2912110Z  6 | |     forget_memory_tool,
2025-11-18T07:14:11.2912189Z  7 | |     forget_all_memories_tool,
2025-11-18T07:14:11.2912261Z  8 | |     set_pronouns_tool,
2025-11-18T07:14:11.2912324Z  9 | | )
2025-11-18T07:14:11.2912382Z 10 | |
2025-11-18T07:14:11.2912468Z 11 | | from .memory_definitions import (
2025-11-18T07:14:11.2915215Z 12 | |     REMEMBER_MEMORY_DEFINITION,
2025-11-18T07:14:11.2915332Z 13 | |     RECALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2915416Z 14 | |     FORGET_MEMORY_DEFINITION,
2025-11-18T07:14:11.2915507Z 15 | |     FORGET_ALL_MEMORIES_DEFINITION,
2025-11-18T07:14:11.2915588Z 16 | |     SET_PRONOUNS_DEFINITION,
2025-11-18T07:14:11.2915647Z 17 | | )
2025-11-18T07:14:11.2915712Z    | |_^
2025-11-18T07:14:11.2915771Z 18 |
2025-11-18T07:14:11.2915834Z 19 |   __all__ = [
2025-11-18T07:14:11.2915891Z    |
2025-11-18T07:14:11.2915966Z help: Organize imports
2025-11-18T07:14:11.2915972Z 
2025-11-18T07:14:11.2916065Z F401 [*] `typing.Any` imported but unused
2025-11-18T07:14:11.2916174Z  --> app/services/tools/bot_self_tools.py:7:20
2025-11-18T07:14:11.2916235Z   |
2025-11-18T07:14:11.2916302Z 5 | import json
2025-11-18T07:14:11.2916366Z 6 | import logging
2025-11-18T07:14:11.2916440Z 7 | from typing import Any
2025-11-18T07:14:11.2916505Z   |                    ^^^
2025-11-18T07:14:11.2916565Z 8 |
2025-11-18T07:14:11.2916696Z 9 | from app.services.bot_profile import BotProfileStore
2025-11-18T07:14:11.2916754Z   |
2025-11-18T07:14:11.2916850Z help: Remove unused import: `typing.Any`
2025-11-18T07:14:11.2916856Z 
2025-11-18T07:14:11.2917087Z UP037 [*] Remove quotes from type annotation
2025-11-18T07:14:11.2917199Z    --> app/services/tools/memory_tools.py:304:20
2025-11-18T07:14:11.2917262Z     |
2025-11-18T07:14:11.2917338Z 302 |     # Injected by handler
2025-11-18T07:14:11.2917417Z 303 |     chat_id: int | None = None,
2025-11-18T07:14:11.2917620Z 304 |     profile_store: "UserProfileStore | UserProfileStoreAdapter | None" = None,
2025-11-18T07:14:11.2917713Z     |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2917933Z 305 | ) -> str:
2025-11-18T07:14:11.2918033Z 306 |     """Update or clear a user's pronouns."""
2025-11-18T07:14:11.2918095Z     |
2025-11-18T07:14:11.2918162Z help: Remove quotes
2025-11-18T07:14:11.2918168Z 
2025-11-18T07:14:11.2918266Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2918374Z  --> app/services/tools/moderation_tools.py:5:1
2025-11-18T07:14:11.2918430Z   |
2025-11-18T07:14:11.2918489Z 3 |   """
2025-11-18T07:14:11.2918546Z 4 |
2025-11-18T07:14:11.2918612Z 5 | / import json
2025-11-18T07:14:11.2918676Z 6 | | import logging
2025-11-18T07:14:11.2918820Z 7 | | from app.services.telegram_service import TelegramService
2025-11-18T07:14:11.2919024Z   | |_________________________________________________________^
2025-11-18T07:14:11.2919081Z 8 |
2025-11-18T07:14:11.2919169Z 9 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2919228Z   |
2025-11-18T07:14:11.2919300Z help: Organize imports
2025-11-18T07:14:11.2919310Z 
2025-11-18T07:14:11.2919391Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2919500Z    --> app/services/tools/moderation_tools.py:114:1
2025-11-18T07:14:11.2919560Z     |
2025-11-18T07:14:11.2919644Z 112 |             if not query_str.strip():
2025-11-18T07:14:11.2919780Z 113 |                 return json.dumps({"error": "Query cannot be empty"})
2025-11-18T07:14:11.2919843Z 114 |             
2025-11-18T07:14:11.2919903Z     | ^^^^^^^^^^^^
2025-11-18T07:14:11.2919967Z 115 |             try:
2025-11-18T07:14:11.2920055Z 116 |                 chat_id_int = int(chat_id)
2025-11-18T07:14:11.2920115Z     |
2025-11-18T07:14:11.2920201Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2920211Z 
2025-11-18T07:14:11.2920340Z UP035 [*] Import from `collections.abc` instead: `Iterable`
2025-11-18T07:14:11.2920428Z  --> app/services/triggers.py:4:1
2025-11-18T07:14:11.2920485Z   |
2025-11-18T07:14:11.2920547Z 3 | import re
2025-11-18T07:14:11.2920624Z 4 | from typing import Iterable
2025-11-18T07:14:11.2920694Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2920750Z 5 |
2025-11-18T07:14:11.2920863Z 6 | from aiogram.types import Message, MessageEntity
2025-11-18T07:14:11.2920925Z   |
2025-11-18T07:14:11.2921012Z help: Import from `collections.abc`
2025-11-18T07:14:11.2921018Z 
2025-11-18T07:14:11.2921109Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.2921195Z   --> app/services/typing.py:17:21
2025-11-18T07:14:11.2921252Z    |
2025-11-18T07:14:11.2921326Z 15 |         self._chat_id = chat_id
2025-11-18T07:14:11.2921416Z 16 |         self._interval = max(interval, 1.0)
2025-11-18T07:14:11.2921523Z 17 |         self._task: Optional[asyncio.Task] = None
2025-11-18T07:14:11.2921602Z    |                     ^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2921676Z 18 |         self._active = False
2025-11-18T07:14:11.2921735Z    |
2025-11-18T07:14:11.2921809Z help: Convert to `X | None`
2025-11-18T07:14:11.2921815Z 
2025-11-18T07:14:11.2921906Z UP037 [*] Remove quotes from type annotation
2025-11-18T07:14:11.2921989Z   --> app/services/typing.py:20:35
2025-11-18T07:14:11.2922050Z    |
2025-11-18T07:14:11.2922121Z 18 |         self._active = False
2025-11-18T07:14:11.2922178Z 19 |
2025-11-18T07:14:11.2922295Z 20 |     async def __aenter__(self) -> "TypingIndicator":
2025-11-18T07:14:11.2922374Z    |                                   ^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2922447Z 21 |         self._active = True
2025-11-18T07:14:11.2922519Z 22 |         await self._send()
2025-11-18T07:14:11.2922575Z    |
2025-11-18T07:14:11.2922641Z help: Remove quotes
2025-11-18T07:14:11.2922646Z 
2025-11-18T07:14:11.2922736Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2922839Z    --> app/services/user_profile.py:163:25
2025-11-18T07:14:11.2922897Z     |
2025-11-18T07:14:11.2923003Z 161 |                 except json.JSONDecodeError as e:
2025-11-18T07:14:11.2923087Z 162 |                     LOGGER.warning(
2025-11-18T07:14:11.2923225Z 163 |                         f"Failed to parse fact extraction JSON from Gemini",
2025-11-18T07:14:11.2923397Z     |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2923470Z 164 |                         extra={
2025-11-18T07:14:11.2923562Z 165 |                             "user_id": user_id,
2025-11-18T07:14:11.2923620Z     |
2025-11-18T07:14:11.2923704Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2923710Z 
2025-11-18T07:14:11.2923785Z W291 Trailing whitespace
2025-11-18T07:14:11.2923877Z    --> app/services/user_profile.py:347:42
2025-11-18T07:14:11.2923935Z     |
2025-11-18T07:14:11.2924010Z 345 |             await db.execute(
2025-11-18T07:14:11.2924075Z 346 |                 """
2025-11-18T07:14:11.2924244Z 347 |                 INSERT INTO user_profiles 
2025-11-18T07:14:11.2924314Z     |                                          ^
2025-11-18T07:14:11.2924562Z 348 |                 (user_id, chat_id, display_name, username, pronouns, membership_status, first_seen, last_seen, 
2025-11-18T07:14:11.2924765Z 349 |                  interaction_count, message_count, profile_version, created_at, updated_at)
2025-11-18T07:14:11.2924822Z     |
2025-11-18T07:14:11.2924907Z help: Remove trailing whitespace
2025-11-18T07:14:11.2924913Z 
2025-11-18T07:14:11.2924983Z W291 Trailing whitespace
2025-11-18T07:14:11.2925077Z    --> app/services/user_profile.py:348:111
2025-11-18T07:14:11.2925137Z     |
2025-11-18T07:14:11.2925203Z 346 |                 """
2025-11-18T07:14:11.2925291Z 347 |                 INSERT INTO user_profiles 
2025-11-18T07:14:11.2925520Z 348 |                 (user_id, chat_id, display_name, username, pronouns, membership_status, first_seen, last_seen, 
2025-11-18T07:14:11.2925616Z     |                                                                                                               ^
2025-11-18T07:14:11.2925804Z 349 |                  interaction_count, message_count, profile_version, created_at, updated_at)
2025-11-18T07:14:11.2925909Z 350 |                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, 0, 1, ?, ?)
2025-11-18T07:14:11.2925974Z     |
2025-11-18T07:14:11.2926053Z help: Remove trailing whitespace
2025-11-18T07:14:11.2926059Z 
2025-11-18T07:14:11.2926128Z W291 Trailing whitespace
2025-11-18T07:14:11.2926219Z    --> app/services/user_profile.py:404:48
2025-11-18T07:14:11.2926276Z     |
2025-11-18T07:14:11.2926359Z 402 |                 async with db.execute(
2025-11-18T07:14:11.2926427Z 403 |                     """
2025-11-18T07:14:11.2926523Z 404 |                     SELECT * FROM user_profiles 
2025-11-18T07:14:11.2926597Z     |                                                ^
2025-11-18T07:14:11.2926673Z 405 |                     WHERE user_id = ?
2025-11-18T07:14:11.2926764Z 406 |                     ORDER BY last_seen DESC
2025-11-18T07:14:11.2926821Z     |
2025-11-18T07:14:11.2926900Z help: Remove trailing whitespace
2025-11-18T07:14:11.2926905Z 
2025-11-18T07:14:11.2927079Z W291 Trailing whitespace
2025-11-18T07:14:11.2927171Z    --> app/services/user_profile.py:418:45
2025-11-18T07:14:11.2927231Z     |
2025-11-18T07:14:11.2927319Z 416 |                 # Get facts across all chats
2025-11-18T07:14:11.2927387Z 417 |                 query = """
2025-11-18T07:14:11.2927472Z 418 |                     SELECT * FROM user_facts 
2025-11-18T07:14:11.2927547Z     |                                             ^
2025-11-18T07:14:11.2927652Z 419 |                     WHERE user_id = ? AND is_active = 1
2025-11-18T07:14:11.2927760Z 420 |                     ORDER BY confidence DESC, created_at DESC
2025-11-18T07:14:11.2927818Z     |
2025-11-18T07:14:11.2927898Z help: Remove trailing whitespace
2025-11-18T07:14:11.2927904Z 
2025-11-18T07:14:11.2927976Z W291 Trailing whitespace
2025-11-18T07:14:11.2928064Z    --> app/services/user_profile.py:523:25
2025-11-18T07:14:11.2928123Z     |
2025-11-18T07:14:11.2928193Z 522 |             query += """
2025-11-18T07:14:11.2928260Z 523 |                 ORDER BY 
2025-11-18T07:14:11.2928324Z     |                         ^
2025-11-18T07:14:11.2928530Z 524 |                     CASE membership_status
2025-11-18T07:14:11.2928613Z 525 |                         WHEN 'member' THEN 0
2025-11-18T07:14:11.2928670Z     |
2025-11-18T07:14:11.2928748Z help: Remove trailing whitespace
2025-11-18T07:14:11.2928753Z 
2025-11-18T07:14:11.2928822Z W291 Trailing whitespace
2025-11-18T07:14:11.2928907Z    --> app/services/user_profile.py:566:61
2025-11-18T07:14:11.2928963Z     |
2025-11-18T07:14:11.2929044Z 564 |             async with db.execute(
2025-11-18T07:14:11.2929108Z 565 |                 """
2025-11-18T07:14:11.2929219Z 566 |                 SELECT id, confidence, is_active, fact_value 
2025-11-18T07:14:11.2929298Z     |                                                             ^
2025-11-18T07:14:11.2929517Z 567 |                 FROM user_facts 
2025-11-18T07:14:11.2929678Z 568 |                 WHERE user_id = ? AND chat_id = ? AND fact_type = ? AND fact_key = ? 
2025-11-18T07:14:11.2929738Z     |
2025-11-18T07:14:11.2929817Z help: Remove trailing whitespace
2025-11-18T07:14:11.2929826Z 
2025-11-18T07:14:11.2929895Z W291 Trailing whitespace
2025-11-18T07:14:11.2929979Z    --> app/services/user_profile.py:567:32
2025-11-18T07:14:11.2930038Z     |
2025-11-18T07:14:11.2930102Z 565 |                 """
2025-11-18T07:14:11.2930208Z 566 |                 SELECT id, confidence, is_active, fact_value 
2025-11-18T07:14:11.2930283Z 567 |                 FROM user_facts 
2025-11-18T07:14:11.2930350Z     |                                ^
2025-11-18T07:14:11.2930498Z 568 |                 WHERE user_id = ? AND chat_id = ? AND fact_type = ? AND fact_key = ? 
2025-11-18T07:14:11.2930592Z 569 |                 ORDER BY created_at DESC LIMIT 1
2025-11-18T07:14:11.2930652Z     |
2025-11-18T07:14:11.2930728Z help: Remove trailing whitespace
2025-11-18T07:14:11.2930734Z 
2025-11-18T07:14:11.2930801Z W291 Trailing whitespace
2025-11-18T07:14:11.2930889Z    --> app/services/user_profile.py:568:85
2025-11-18T07:14:11.2930947Z     |
2025-11-18T07:14:11.2931050Z 566 |                 SELECT id, confidence, is_active, fact_value 
2025-11-18T07:14:11.2931126Z 567 |                 FROM user_facts 
2025-11-18T07:14:11.2931269Z 568 |                 WHERE user_id = ? AND chat_id = ? AND fact_type = ? AND fact_key = ? 
2025-11-18T07:14:11.2931351Z     |                                                                                     ^
2025-11-18T07:14:11.2931443Z 569 |                 ORDER BY created_at DESC LIMIT 1
2025-11-18T07:14:11.2931508Z 570 |                 """,
2025-11-18T07:14:11.2931564Z     |
2025-11-18T07:14:11.2931641Z help: Remove trailing whitespace
2025-11-18T07:14:11.2931649Z 
2025-11-18T07:14:11.2931718Z W291 Trailing whitespace
2025-11-18T07:14:11.2931806Z    --> app/services/user_profile.py:609:42
2025-11-18T07:14:11.2931864Z     |
2025-11-18T07:14:11.2931944Z 607 |                     await db.execute(
2025-11-18T07:14:11.2932009Z 608 |                         """
2025-11-18T07:14:11.2932091Z 609 |                         UPDATE user_facts 
2025-11-18T07:14:11.2932167Z     |                                          ^
2025-11-18T07:14:11.2932290Z 610 |                         SET fact_value = ?, confidence = ?, is_active = 1, 
2025-11-18T07:14:11.2932394Z 611 |                             updated_at = ?, last_mentioned = ?,
2025-11-18T07:14:11.2932451Z     |
2025-11-18T07:14:11.2932532Z help: Remove trailing whitespace
2025-11-18T07:14:11.2932538Z 
2025-11-18T07:14:11.2932606Z W291 Trailing whitespace
2025-11-18T07:14:11.2932691Z    --> app/services/user_profile.py:610:75
2025-11-18T07:14:11.2932752Z     |
2025-11-18T07:14:11.2932816Z 608 |                         """
2025-11-18T07:14:11.2932896Z 609 |                         UPDATE user_facts 
2025-11-18T07:14:11.2933018Z 610 |                         SET fact_value = ?, confidence = ?, is_active = 1, 
2025-11-18T07:14:11.2933098Z     |                                                                           ^
2025-11-18T07:14:11.2933195Z 611 |                             updated_at = ?, last_mentioned = ?,
2025-11-18T07:14:11.2933394Z 612 |                             evidence_text = COALESCE(?, evidence_text)
2025-11-18T07:14:11.2933455Z     |
2025-11-18T07:14:11.2933531Z help: Remove trailing whitespace
2025-11-18T07:14:11.2933536Z 
2025-11-18T07:14:11.2933604Z W291 Trailing whitespace
2025-11-18T07:14:11.2933694Z    --> app/services/user_profile.py:621:50
2025-11-18T07:14:11.2933751Z     |
2025-11-18T07:14:11.2933829Z 619 |                     await db.execute(
2025-11-18T07:14:11.2933897Z 620 |                         """
2025-11-18T07:14:11.2933992Z 621 |                         INSERT INTO fact_versions 
2025-11-18T07:14:11.2934067Z     |                                                  ^
2025-11-18T07:14:11.2934320Z 622 |                         (fact_id, version_number, change_type, confidence_delta, created_at)
2025-11-18T07:14:11.2934409Z 623 |                         VALUES (?, ?, ?, ?, ?)
2025-11-18T07:14:11.2934466Z     |
2025-11-18T07:14:11.2934543Z help: Remove trailing whitespace
2025-11-18T07:14:11.2934553Z 
2025-11-18T07:14:11.2934624Z W291 Trailing whitespace
2025-11-18T07:14:11.2934711Z    --> app/services/user_profile.py:663:50
2025-11-18T07:14:11.2934767Z     |
2025-11-18T07:14:11.2934847Z 661 |                     await db.execute(
2025-11-18T07:14:11.2934912Z 662 |                         """
2025-11-18T07:14:11.2935002Z 663 |                         INSERT INTO fact_versions 
2025-11-18T07:14:11.2935073Z     |                                                  ^
2025-11-18T07:14:11.2935238Z 664 |                         (fact_id, version_number, change_type, confidence_delta, created_at)
2025-11-18T07:14:11.2935319Z 665 |                         VALUES (?, ?, ?, ?, ?)
2025-11-18T07:14:11.2935379Z     |
2025-11-18T07:14:11.2935458Z help: Remove trailing whitespace
2025-11-18T07:14:11.2935464Z 
2025-11-18T07:14:11.2935533Z W291 Trailing whitespace
2025-11-18T07:14:11.2935619Z    --> app/services/user_profile.py:676:39
2025-11-18T07:14:11.2935678Z     |
2025-11-18T07:14:11.2935762Z 674 |             cursor = await db.execute(
2025-11-18T07:14:11.2935831Z 675 |                 """
2025-11-18T07:14:11.2935915Z 676 |                 INSERT INTO user_facts 
2025-11-18T07:14:11.2935990Z     |                                       ^
2025-11-18T07:14:11.2936140Z 677 |                 (user_id, chat_id, fact_type, fact_key, fact_value, confidence, 
2025-11-18T07:14:11.2936359Z 678 |                  source_message_id, evidence_text, is_active, created_at, updated_at, last_mentioned)
2025-11-18T07:14:11.2936420Z     |
2025-11-18T07:14:11.2936499Z help: Remove trailing whitespace
2025-11-18T07:14:11.2936505Z 
2025-11-18T07:14:11.2936573Z W291 Trailing whitespace
2025-11-18T07:14:11.2936665Z    --> app/services/user_profile.py:677:80
2025-11-18T07:14:11.2936722Z     |
2025-11-18T07:14:11.2936786Z 675 |                 """
2025-11-18T07:14:11.2936867Z 676 |                 INSERT INTO user_facts 
2025-11-18T07:14:11.2937118Z 677 |                 (user_id, chat_id, fact_type, fact_key, fact_value, confidence, 
2025-11-18T07:14:11.2937207Z     |                                                                                ^
2025-11-18T07:14:11.2937413Z 678 |                  source_message_id, evidence_text, is_active, created_at, updated_at, last_mentioned)
2025-11-18T07:14:11.2937516Z 679 |                 VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, ?, ?, ?)
2025-11-18T07:14:11.2937574Z     |
2025-11-18T07:14:11.2937651Z help: Remove trailing whitespace
2025-11-18T07:14:11.2937656Z 
2025-11-18T07:14:11.2937728Z W291 Trailing whitespace
2025-11-18T07:14:11.2937814Z    --> app/services/user_profile.py:700:42
2025-11-18T07:14:11.2937871Z     |
2025-11-18T07:14:11.2937945Z 698 |             await db.execute(
2025-11-18T07:14:11.2938012Z 699 |                 """
2025-11-18T07:14:11.2938096Z 700 |                 INSERT INTO fact_versions 
2025-11-18T07:14:11.2938168Z     |                                          ^
2025-11-18T07:14:11.2938334Z 701 |                 (fact_id, version_number, change_type, confidence_delta, created_at)
2025-11-18T07:14:11.2938545Z 702 |                 VALUES (?, 1, 'creation', ?, ?)
2025-11-18T07:14:11.2938603Z     |
2025-11-18T07:14:11.2938683Z help: Remove trailing whitespace
2025-11-18T07:14:11.2938688Z 
2025-11-18T07:14:11.2938757Z W291 Trailing whitespace
2025-11-18T07:14:11.2938844Z    --> app/services/user_profile.py:871:69
2025-11-18T07:14:11.2938903Z     |
2025-11-18T07:14:11.2938981Z 869 |             async with db.execute(
2025-11-18T07:14:11.2939043Z 870 |                 """
2025-11-18T07:14:11.2939176Z 871 |                 SELECT id, interaction_count FROM user_relationships 
2025-11-18T07:14:11.2939259Z     |                                                                     ^
2025-11-18T07:14:11.2939496Z 872 |                 WHERE user_id = ? AND chat_id = ? AND related_user_id = ?
2025-11-18T07:14:11.2939563Z 873 |                 """,
2025-11-18T07:14:11.2939622Z     |
2025-11-18T07:14:11.2939700Z help: Remove trailing whitespace
2025-11-18T07:14:11.2939705Z 
2025-11-18T07:14:11.2939777Z W291 Trailing whitespace
2025-11-18T07:14:11.2939865Z    --> app/services/user_profile.py:882:46
2025-11-18T07:14:11.2939922Z     |
2025-11-18T07:14:11.2939996Z 880 |                 await db.execute(
2025-11-18T07:14:11.2940062Z 881 |                     """
2025-11-18T07:14:11.2940156Z 882 |                     UPDATE user_relationships 
2025-11-18T07:14:11.2940227Z     |                                              ^
2025-11-18T07:14:11.2940432Z 883 |                     SET relationship_type = ?, relationship_label = COALESCE(?, relationship_label),
2025-11-18T07:14:11.2940555Z 884 |                         strength = ?, sentiment = ?, interaction_count = ?,
2025-11-18T07:14:11.2940616Z     |
2025-11-18T07:14:11.2940697Z help: Remove trailing whitespace
2025-11-18T07:14:11.2940702Z 
2025-11-18T07:14:11.2940774Z W291 Trailing whitespace
2025-11-18T07:14:11.2940862Z    --> app/services/user_profile.py:902:51
2025-11-18T07:14:11.2940921Z     |
2025-11-18T07:14:11.2940995Z 900 |                 await db.execute(
2025-11-18T07:14:11.2941068Z 901 |                     """
2025-11-18T07:14:11.2941169Z 902 |                     INSERT INTO user_relationships 
2025-11-18T07:14:11.2941247Z     |                                                   ^
2025-11-18T07:14:11.2941435Z 903 |                     (user_id, chat_id, related_user_id, relationship_type, relationship_label,
2025-11-18T07:14:11.2941649Z 904 |                      strength, interaction_count, last_interaction, sentiment, created_at, updated_at)
2025-11-18T07:14:11.2941707Z     |
2025-11-18T07:14:11.2941789Z help: Remove trailing whitespace
2025-11-18T07:14:11.2941795Z 
2025-11-18T07:14:11.2941864Z W291 Trailing whitespace
2025-11-18T07:14:11.2941955Z    --> app/services/user_profile.py:933:49
2025-11-18T07:14:11.2942012Z     |
2025-11-18T07:14:11.2942094Z 931 |             async with db.execute(
2025-11-18T07:14:11.2942160Z 932 |                 """
2025-11-18T07:14:11.2942257Z 933 |                 SELECT * FROM user_relationships 
2025-11-18T07:14:11.2942338Z     |                                                 ^
2025-11-18T07:14:11.2942458Z 934 |                 WHERE user_id = ? AND chat_id = ? AND strength >= ?
2025-11-18T07:14:11.2942576Z 935 |                 ORDER BY strength DESC, interaction_count DESC
2025-11-18T07:14:11.2942636Z     |
2025-11-18T07:14:11.2942715Z help: Remove trailing whitespace
2025-11-18T07:14:11.2942720Z 
2025-11-18T07:14:11.2942791Z W291 Trailing whitespace
2025-11-18T07:14:11.2942889Z     --> app/services/user_profile.py:1103:34
2025-11-18T07:14:11.2942951Z      |
2025-11-18T07:14:11.2943042Z 1101 |             cursor = await db.execute(
2025-11-18T07:14:11.2943107Z 1102 |                 """
2025-11-18T07:14:11.2943194Z 1103 |                 UPDATE user_facts 
2025-11-18T07:14:11.2943261Z      |                                  ^
2025-11-18T07:14:11.2943361Z 1104 |                 SET is_active = 0, updated_at = ?
2025-11-18T07:14:11.2943484Z 1105 |                 WHERE user_id = ? AND chat_id = ? AND is_active = 1
2025-11-18T07:14:11.2943631Z      |
2025-11-18T07:14:11.2943710Z help: Remove trailing whitespace
2025-11-18T07:14:11.2943715Z 
2025-11-18T07:14:11.2943785Z W291 Trailing whitespace
2025-11-18T07:14:11.2943878Z     --> app/services/user_profile.py:1142:47
2025-11-18T07:14:11.2943934Z      |
2025-11-18T07:14:11.2944020Z 1140 |                 FROM user_profiles p
2025-11-18T07:14:11.2944098Z 1141 |                 WHERE EXISTS (
2025-11-18T07:14:11.2944195Z 1142 |                     SELECT 1 FROM user_facts f 
2025-11-18T07:14:11.2944269Z      |                                               ^
2025-11-18T07:14:11.2944396Z 1143 |                     WHERE f.user_id = p.user_id AND f.is_active = 1
2025-11-18T07:14:11.2944537Z 1144 |                 )
2025-11-18T07:14:11.2944594Z      |
2025-11-18T07:14:11.2944674Z help: Remove trailing whitespace
2025-11-18T07:14:11.2944680Z 
2025-11-18T07:14:11.2944753Z W291 Trailing whitespace
2025-11-18T07:14:11.2944843Z     --> app/services/user_profile.py:1146:38
2025-11-18T07:14:11.2944904Z      |
2025-11-18T07:14:11.2944967Z 1144 |                 )
2025-11-18T07:14:11.2945033Z 1145 |                 AND (
2025-11-18T07:14:11.2945117Z 1146 |                     p.summary IS NULL 
2025-11-18T07:14:11.2945187Z      |                                      ^
2025-11-18T07:14:11.2945316Z 1147 |                     OR p.last_seen > COALESCE(p.summary_updated_at, 0)
2025-11-18T07:14:11.2945379Z 1148 |                 )
2025-11-18T07:14:11.2945434Z      |
2025-11-18T07:14:11.2945515Z help: Remove trailing whitespace
2025-11-18T07:14:11.2945521Z 
2025-11-18T07:14:11.2945589Z W291 Trailing whitespace
2025-11-18T07:14:11.2945679Z     --> app/services/user_profile.py:1173:37
2025-11-18T07:14:11.2945742Z      |
2025-11-18T07:14:11.2945815Z 1171 |             await db.execute(
2025-11-18T07:14:11.2945880Z 1172 |                 """
2025-11-18T07:14:11.2945964Z 1173 |                 UPDATE user_profiles 
2025-11-18T07:14:11.2946036Z      |                                     ^
2025-11-18T07:14:11.2946145Z 1174 |                 SET summary = ?, summary_updated_at = ?
2025-11-18T07:14:11.2946222Z 1175 |                 WHERE user_id = ?
2025-11-18T07:14:11.2946281Z      |
2025-11-18T07:14:11.2946359Z help: Remove trailing whitespace
2025-11-18T07:14:11.2946364Z 
2025-11-18T07:14:11.2946465Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2946568Z   --> app/services/user_profile_adapter.py:9:1
2025-11-18T07:14:11.2946628Z    |
2025-11-18T07:14:11.2946686Z  7 |   """
2025-11-18T07:14:11.2946743Z  8 |
2025-11-18T07:14:11.2946829Z  9 | / from __future__ import annotations
2025-11-18T07:14:11.2946885Z 10 | |
2025-11-18T07:14:11.2947045Z 11 | | import asyncio
2025-11-18T07:14:11.2947118Z 12 | | import logging
2025-11-18T07:14:11.2947185Z 13 | | import time
2025-11-18T07:14:11.2947263Z 14 | | from pathlib import Path
2025-11-18T07:14:11.2947339Z 15 | | from typing import Any
2025-11-18T07:14:11.2947398Z 16 | |
2025-11-18T07:14:11.2947463Z 17 | | import asyncpg
2025-11-18T07:14:11.2947659Z 18 | | from app.infrastructure.query_converter import convert_query_to_postgres
2025-11-18T07:14:11.2947719Z 19 | |
2025-11-18T07:14:11.2947859Z 20 | | from app.infrastructure.db_utils import get_db_connection
2025-11-18T07:14:11.2947948Z 21 | | from app.services import telemetry
2025-11-18T07:14:11.2948117Z 22 | | from app.repositories.fact_repository import UnifiedFactRepository
2025-11-18T07:14:11.2948229Z 23 | | from app.services.redis_types import RedisLike
2025-11-18T07:14:11.2948309Z    | |______________________________________________^
2025-11-18T07:14:11.2948365Z 24 |
2025-11-18T07:14:11.2948453Z 25 |   logger = logging.getLogger(__name__)
2025-11-18T07:14:11.2948512Z    |
2025-11-18T07:14:11.2948583Z help: Organize imports
2025-11-18T07:14:11.2948588Z 
2025-11-18T07:14:11.2948679Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2948780Z   --> app/services/user_profile_adapter.py:14:21
2025-11-18T07:14:11.2948837Z    |
2025-11-18T07:14:11.2948901Z 12 | import logging
2025-11-18T07:14:11.2949088Z 13 | import time
2025-11-18T07:14:11.2949166Z 14 | from pathlib import Path
2025-11-18T07:14:11.2949230Z    |                     ^^^^
2025-11-18T07:14:11.2949304Z 15 | from typing import Any
2025-11-18T07:14:11.2949361Z    |
2025-11-18T07:14:11.2949454Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2949460Z 
2025-11-18T07:14:11.2949530Z W291 Trailing whitespace
2025-11-18T07:14:11.2949635Z    --> app/services/user_profile_adapter.py:208:52
2025-11-18T07:14:11.2949691Z     |
2025-11-18T07:14:11.2949773Z 206 |         if chat_context is not None:
2025-11-18T07:14:11.2949845Z 207 |             query = """
2025-11-18T07:14:11.2949944Z 208 |                 SELECT COUNT(*) as count FROM facts 
2025-11-18T07:14:11.2950126Z     |                                                    ^
2025-11-18T07:14:11.2950329Z 209 |                 WHERE entity_type = $1 AND entity_id = $3 AND chat_context = $2 AND is_active = 1
2025-11-18T07:14:11.2950392Z 210 |             """
2025-11-18T07:14:11.2950451Z     |
2025-11-18T07:14:11.2950531Z help: Remove trailing whitespace
2025-11-18T07:14:11.2950537Z 
2025-11-18T07:14:11.2950609Z W291 Trailing whitespace
2025-11-18T07:14:11.2950708Z    --> app/services/user_profile_adapter.py:214:52
2025-11-18T07:14:11.2950766Z     |
2025-11-18T07:14:11.2950829Z 212 |         else:
2025-11-18T07:14:11.2950896Z 213 |             query = """
2025-11-18T07:14:11.2950990Z 214 |                 SELECT COUNT(*) as count FROM facts 
2025-11-18T07:14:11.2951063Z     |                                                    ^
2025-11-18T07:14:11.2951208Z 215 |                 WHERE entity_type = $1 AND entity_id = $2 AND is_active = 1
2025-11-18T07:14:11.2951273Z 216 |             """
2025-11-18T07:14:11.2951330Z     |
2025-11-18T07:14:11.2951411Z help: Remove trailing whitespace
2025-11-18T07:14:11.2951416Z 
2025-11-18T07:14:11.2951486Z W291 Trailing whitespace
2025-11-18T07:14:11.2951584Z    --> app/services/user_profile_adapter.py:288:42
2025-11-18T07:14:11.2951648Z     |
2025-11-18T07:14:11.2951756Z 286 |             query, params = convert_query_to_postgres(
2025-11-18T07:14:11.2951821Z 287 |                 """
2025-11-18T07:14:11.2951907Z 288 |                 INSERT INTO user_profiles 
2025-11-18T07:14:11.2951981Z     |                                          ^
2025-11-18T07:14:11.2952154Z 289 |                 (user_id, chat_id, display_name, username, pronouns, membership_status,
2025-11-18T07:14:11.2952290Z 290 |                  first_seen, last_seen, interaction_count, message_count,
2025-11-18T07:14:11.2952352Z     |
2025-11-18T07:14:11.2952430Z help: Remove trailing whitespace
2025-11-18T07:14:11.2952435Z 
2025-11-18T07:14:11.2952507Z W291 Trailing whitespace
2025-11-18T07:14:11.2952605Z    --> app/services/user_profile_adapter.py:385:48
2025-11-18T07:14:11.2952661Z     |
2025-11-18T07:14:11.2952769Z 383 |                 query, params = convert_query_to_postgres(
2025-11-18T07:14:11.2952871Z 384 |                     """
2025-11-18T07:14:11.2952976Z 385 |                     SELECT * FROM user_profiles 
2025-11-18T07:14:11.2953054Z     |                                                ^
2025-11-18T07:14:11.2953137Z 386 |                     WHERE user_id = $1
2025-11-18T07:14:11.2953224Z 387 |                     ORDER BY last_seen DESC
2025-11-18T07:14:11.2953281Z     |
2025-11-18T07:14:11.2953358Z help: Remove trailing whitespace
2025-11-18T07:14:11.2953364Z 
2025-11-18T07:14:11.2953435Z W291 Trailing whitespace
2025-11-18T07:14:11.2953532Z    --> app/services/user_profile_adapter.py:485:21
2025-11-18T07:14:11.2953590Z     |
2025-11-18T07:14:11.2953657Z 484 |         query += """
2025-11-18T07:14:11.2953726Z 485 |             ORDER BY 
2025-11-18T07:14:11.2953793Z     |                     ^
2025-11-18T07:14:11.2953876Z 486 |                 CASE membership_status
2025-11-18T07:14:11.2953961Z 487 |                     WHEN 'member' THEN 0
2025-11-18T07:14:11.2954018Z     |
2025-11-18T07:14:11.2954094Z help: Remove trailing whitespace
2025-11-18T07:14:11.2954188Z 
2025-11-18T07:14:11.2954261Z W291 Trailing whitespace
2025-11-18T07:14:11.2954357Z    --> app/services/user_profile_adapter.py:509:45
2025-11-18T07:14:11.2954414Z     |
2025-11-18T07:14:11.2954521Z 507 |         query, params = convert_query_to_postgres(
2025-11-18T07:14:11.2954585Z 508 |             """
2025-11-18T07:14:11.2954678Z 509 |             SELECT * FROM user_relationships 
2025-11-18T07:14:11.2954748Z     |                                             ^
2025-11-18T07:14:11.2954878Z 510 |             WHERE user_id = $1 AND chat_id = $2 AND strength >= $3
2025-11-18T07:14:11.2954992Z 511 |             ORDER BY strength DESC, interaction_count DESC
2025-11-18T07:14:11.2955123Z     |
2025-11-18T07:14:11.2955201Z help: Remove trailing whitespace
2025-11-18T07:14:11.2955209Z 
2025-11-18T07:14:11.2955307Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2955390Z   --> app/services/weather.py:20:5
2025-11-18T07:14:11.2955446Z    |
2025-11-18T07:14:11.2955524Z 18 | # Import logging framework
2025-11-18T07:14:11.2955588Z 19 | try:
2025-11-18T07:14:11.2955757Z 20 |     from app.services.tool_logging import log_tool_execution, ToolLogger
2025-11-18T07:14:11.2955842Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2955915Z 21 | except ImportError:
2025-11-18T07:14:11.2956014Z 22 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2956071Z    |
2025-11-18T07:14:11.2956144Z help: Organize imports
2025-11-18T07:14:11.2956150Z 
2025-11-18T07:14:11.2956258Z E731 Do not assign a `lambda` expression, use a `def`
2025-11-18T07:14:11.2956337Z   --> app/services/weather.py:23:5
2025-11-18T07:14:11.2956397Z    |
2025-11-18T07:14:11.2956474Z 21 | except ImportError:
2025-11-18T07:14:11.2956570Z 22 |     # Fallback if logging framework not available
2025-11-18T07:14:11.2956718Z 23 |     log_tool_execution = lambda name: lambda f: f  # No-op decorator
2025-11-18T07:14:11.2956790Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2956864Z 24 |     ToolLogger = None
2025-11-18T07:14:11.2956920Z    |
2025-11-18T07:14:11.2957120Z help: Rewrite `log_tool_execution` as a `def`
2025-11-18T07:14:11.2957127Z 
2025-11-18T07:14:11.2957502Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2957591Z    --> app/services/weather.py:111:13
2025-11-18T07:14:11.2957655Z     |
2025-11-18T07:14:11.2957750Z 109 |         except aiohttp.ClientError as e:
2025-11-18T07:14:11.2957896Z 110 |             self.logger.error(f"Network error fetching weather: {e}")
2025-11-18T07:14:11.2958122Z 111 |             raise ValueError("Помилка з'єднання з сервісом погоди")
2025-11-18T07:14:11.2958207Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2958264Z 112 |
2025-11-18T07:14:11.2958459Z 113 |     async def get_forecast(self, location: str, days: int = 3) -> dict[str, Any]:
2025-11-18T07:14:11.2958526Z     |
2025-11-18T07:14:11.2958532Z 
2025-11-18T07:14:11.2958898Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2958985Z    --> app/services/weather.py:180:13
2025-11-18T07:14:11.2959044Z     |
2025-11-18T07:14:11.2959138Z 178 |         except aiohttp.ClientError as e:
2025-11-18T07:14:11.2959284Z 179 |             self.logger.error(f"Network error fetching forecast: {e}")
2025-11-18T07:14:11.2959464Z 180 |             raise ValueError("Помилка з'єднання з сервісом погоди")
2025-11-18T07:14:11.2959543Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2959726Z 181 |
2025-11-18T07:14:11.2959909Z 182 |     def _format_current_weather(self, data: dict[str, Any]) -> dict[str, Any]:
2025-11-18T07:14:11.2959966Z     |
2025-11-18T07:14:11.2959972Z 
2025-11-18T07:14:11.2960329Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.2960521Z    --> app/services/weather.py:277:13
2025-11-18T07:14:11.2960578Z     |
2025-11-18T07:14:11.2960637Z 275 |             )
2025-11-18T07:14:11.2960712Z 276 |         except ImportError:
2025-11-18T07:14:11.2960824Z 277 |             raise ValueError("Settings not available")
2025-11-18T07:14:11.2960901Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2960957Z 278 |
2025-11-18T07:14:11.2961034Z 279 |     return _weather_service
2025-11-18T07:14:11.2961091Z     |
2025-11-18T07:14:11.2961096Z 
2025-11-18T07:14:11.2961196Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2961290Z   --> app/utils/text_processing.py:9:1
2025-11-18T07:14:11.2961347Z    |
2025-11-18T07:14:11.2961405Z  7 |   """
2025-11-18T07:14:11.2961461Z  8 |
2025-11-18T07:14:11.2961548Z  9 | / from __future__ import annotations
2025-11-18T07:14:11.2961607Z 10 | |
2025-11-18T07:14:11.2961673Z 11 | | import math
2025-11-18T07:14:11.2961733Z    | |___________^
2025-11-18T07:14:11.2961790Z    |
2025-11-18T07:14:11.2961862Z help: Organize imports
2025-11-18T07:14:11.2961868Z 
2025-11-18T07:14:11.2961975Z B905 `zip()` without an explicit `strict=` parameter
2025-11-18T07:14:11.2962067Z    --> app/utils/text_processing.py:103:33
2025-11-18T07:14:11.2962124Z     |
2025-11-18T07:14:11.2962188Z 101 |         return 0.0
2025-11-18T07:14:11.2962249Z 102 |
2025-11-18T07:14:11.2962340Z 103 |     dot = sum(x * y for x, y in zip(a, b))
2025-11-18T07:14:11.2962414Z     |                                 ^^^^^^^^^
2025-11-18T07:14:11.2962507Z 104 |     norm_a = math.sqrt(sum(x * x for x in a))
2025-11-18T07:14:11.2962605Z 105 |     norm_b = math.sqrt(sum(y * y for y in b))
2025-11-18T07:14:11.2962662Z     |
2025-11-18T07:14:11.2962764Z help: Add explicit value for parameter `strict=`
2025-11-18T07:14:11.2962769Z 
2025-11-18T07:14:11.2962868Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2962949Z  --> tests/conftest.py:3:1
2025-11-18T07:14:11.2963005Z   |
2025-11-18T07:14:11.2963113Z 1 |   """Pytest configuration and shared fixtures."""
2025-11-18T07:14:11.2963170Z 2 |
2025-11-18T07:14:11.2963235Z 3 | / import asyncio
2025-11-18T07:14:11.2963300Z 4 | | import pytest
2025-11-18T07:14:11.2963375Z 5 | | import pytest_asyncio
2025-11-18T07:14:11.2963453Z 6 | | from pathlib import Path
2025-11-18T07:14:11.2963537Z 7 | | from typing import AsyncGenerator
2025-11-18T07:14:11.2963606Z 8 | | import aiosqlite
2025-11-18T07:14:11.2963668Z   | |________________^
2025-11-18T07:14:11.2963723Z   |
2025-11-18T07:14:11.2963792Z help: Organize imports
2025-11-18T07:14:11.2963800Z 
2025-11-18T07:14:11.2963947Z UP035 [*] Import from `collections.abc` instead: `AsyncGenerator`
2025-11-18T07:14:11.2964023Z  --> tests/conftest.py:7:1
2025-11-18T07:14:11.2964079Z   |
2025-11-18T07:14:11.2964153Z 5 | import pytest_asyncio
2025-11-18T07:14:11.2964228Z 6 | from pathlib import Path
2025-11-18T07:14:11.2964315Z 7 | from typing import AsyncGenerator
2025-11-18T07:14:11.2964386Z   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2964454Z 8 | import aiosqlite
2025-11-18T07:14:11.2964511Z   |
2025-11-18T07:14:11.2964595Z help: Import from `collections.abc`
2025-11-18T07:14:11.2964601Z 
2025-11-18T07:14:11.2964700Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2964777Z   --> tests/conftest.py:56:5
2025-11-18T07:14:11.2964834Z    |
2025-11-18T07:14:11.2964954Z 54 |           Mock Message object with common fields populated
2025-11-18T07:14:11.2965014Z 55 |       """
2025-11-18T07:14:11.2965099Z 56 | /     from unittest.mock import Mock
2025-11-18T07:14:11.2965293Z 57 | |     from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.2965381Z    | |_________________________________________________^
2025-11-18T07:14:11.2965437Z 58 |
2025-11-18T07:14:11.2965505Z 59 |       user = User(
2025-11-18T07:14:11.2965563Z    |
2025-11-18T07:14:11.2965633Z help: Organize imports
2025-11-18T07:14:11.2965723Z 
2025-11-18T07:14:11.2965820Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2965900Z    --> tests/conftest.py:108:5
2025-11-18T07:14:11.2965957Z     |
2025-11-18T07:14:11.2966038Z 106 |           AsyncMock of GeminiClient
2025-11-18T07:14:11.2966097Z 107 |       """
2025-11-18T07:14:11.2966191Z 108 | /     from unittest.mock import AsyncMock
2025-11-18T07:14:11.2966306Z 109 | |     from types import ModuleType, SimpleNamespace
2025-11-18T07:14:11.2966372Z 110 | |     import sys
2025-11-18T07:14:11.2966435Z     | |______________^
2025-11-18T07:14:11.2966492Z 111 |
2025-11-18T07:14:11.2966551Z 112 |       try:
2025-11-18T07:14:11.2966611Z     |
2025-11-18T07:14:11.2966683Z help: Organize imports
2025-11-18T07:14:11.2966689Z 
2025-11-18T07:14:11.2967047Z B010 [*] Do not call `setattr` with a constant attribute value. It is not any safer than normal property access.
2025-11-18T07:14:11.2967128Z    --> tests/conftest.py:134:9
2025-11-18T07:14:11.2967193Z     |
2025-11-18T07:14:11.2967347Z 133 |         google_entry = sys.modules.setdefault("google", google_module)
2025-11-18T07:14:11.2967457Z 134 |         setattr(google_entry, "genai", genai_module)
2025-11-18T07:14:11.2967536Z     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2967639Z 135 |         sys.modules["google.genai"] = genai_module
2025-11-18T07:14:11.2967757Z 136 |         sys.modules["google.genai.types"] = types_module
2025-11-18T07:14:11.2967815Z     |
2025-11-18T07:14:11.2967903Z help: Replace `setattr` with assignment
2025-11-18T07:14:11.2967908Z 
2025-11-18T07:14:11.2968003Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2968110Z   --> tests/integration/test_compact_format.py:7:1
2025-11-18T07:14:11.2968170Z    |
2025-11-18T07:14:11.2968227Z  5 |   """
2025-11-18T07:14:11.2968284Z  6 |
2025-11-18T07:14:11.2968352Z  7 | / import asyncio
2025-11-18T07:14:11.2968470Z  8 | | from app.services.conversation_formatter import (
2025-11-18T07:14:11.2968549Z  9 | |     format_history_compact,
2025-11-18T07:14:11.2968621Z 10 | |     format_message_compact,
2025-11-18T07:14:11.2968693Z 11 | |     estimate_tokens,
2025-11-18T07:14:11.2968753Z 12 | | )
2025-11-18T07:14:11.2968810Z    | |_^
2025-11-18T07:14:11.2968868Z    |
2025-11-18T07:14:11.2968937Z help: Organize imports
2025-11-18T07:14:11.2968942Z 
2025-11-18T07:14:11.2969023Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.2969128Z  --> tests/integration/test_compact_format.py:7:8
2025-11-18T07:14:11.2969187Z   |
2025-11-18T07:14:11.2969245Z 5 | """
2025-11-18T07:14:11.2969300Z 6 |
2025-11-18T07:14:11.2969367Z 7 | import asyncio
2025-11-18T07:14:11.2969427Z   |        ^^^^^^^
2025-11-18T07:14:11.2969546Z 8 | from app.services.conversation_formatter import (
2025-11-18T07:14:11.2969620Z 9 |     format_history_compact,
2025-11-18T07:14:11.2969679Z   |
2025-11-18T07:14:11.2969763Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.2969769Z 
2025-11-18T07:14:11.2969984Z F401 [*] `app.services.conversation_formatter.format_message_compact` imported but unused
2025-11-18T07:14:11.2970096Z   --> tests/integration/test_compact_format.py:10:5
2025-11-18T07:14:11.2970153Z    |
2025-11-18T07:14:11.2970270Z  8 | from app.services.conversation_formatter import (
2025-11-18T07:14:11.2970348Z  9 |     format_history_compact,
2025-11-18T07:14:11.2970423Z 10 |     format_message_compact,
2025-11-18T07:14:11.2970488Z    |     ^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2970556Z 11 |     estimate_tokens,
2025-11-18T07:14:11.2970614Z 12 | )
2025-11-18T07:14:11.2970671Z    |
2025-11-18T07:14:11.2970886Z help: Remove unused import: `app.services.conversation_formatter.format_message_compact`
2025-11-18T07:14:11.2971050Z 
2025-11-18T07:14:11.2971144Z F541 [*] f-string without any placeholders
2025-11-18T07:14:11.2971256Z    --> tests/integration/test_compact_format.py:110:34
2025-11-18T07:14:11.2971313Z     |
2025-11-18T07:14:11.2971390Z 108 |                     "role": "model",
2025-11-18T07:14:11.2971460Z 109 |                     "parts": [
2025-11-18T07:14:11.2971661Z 110 |                         {"text": f'[meta] name="gryag"'},
2025-11-18T07:14:11.2971743Z     |                                  ^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2971894Z 111 |                         {"text": f"Відповідь {i}"},
2025-11-18T07:14:11.2971961Z 112 |                     ],
2025-11-18T07:14:11.2972018Z     |
2025-11-18T07:14:11.2972101Z help: Remove extraneous `f` prefix
2025-11-18T07:14:11.2972107Z 
2025-11-18T07:14:11.2972204Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2972301Z  --> tests/integration/test_context_store.py:3:1
2025-11-18T07:14:11.2972360Z   |
2025-11-18T07:14:11.2972460Z 1 |   """Integration tests for context store."""
2025-11-18T07:14:11.2972515Z 2 |
2025-11-18T07:14:11.2972581Z 3 | / import pytest
2025-11-18T07:14:11.2972737Z 4 | | from app.services.context_store import ContextStore, TurnSender
2025-11-18T07:14:11.2972836Z   | |_______________________________________________________________^
2025-11-18T07:14:11.2972899Z   |
2025-11-18T07:14:11.2972972Z help: Organize imports
2025-11-18T07:14:11.2972978Z 
2025-11-18T07:14:11.2973073Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2973190Z   --> tests/integration/test_episode_integration.py:11:1
2025-11-18T07:14:11.2973249Z    |
2025-11-18T07:14:11.2973307Z  9 |   """
2025-11-18T07:14:11.2973363Z 10 |
2025-11-18T07:14:11.2973431Z 11 | / import asyncio
2025-11-18T07:14:11.2973500Z 12 | | import logging
2025-11-18T07:14:11.2973561Z 13 | | import time
2025-11-18T07:14:11.2973637Z 14 | | from pathlib import Path
2025-11-18T07:14:11.2973763Z 15 | | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.2973827Z 16 | |
2025-11-18T07:14:11.2973893Z 17 | | import pytest
2025-11-18T07:14:11.2973966Z 18 | | import pytest_asyncio
2025-11-18T07:14:11.2974027Z 19 | |
2025-11-18T07:14:11.2974113Z 20 | | from app.config import get_settings
2025-11-18T07:14:11.2974217Z 21 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.2974439Z 22 | | from app.services.context.episode_boundary_detector import EpisodeBoundaryDetector
2025-11-18T07:14:11.2974595Z 23 | | from app.services.context.episode_monitor import EpisodeMonitor
2025-11-18T07:14:11.2974768Z 24 | | from app.services.context.episodic_memory import EpisodicMemoryStore
2025-11-18T07:14:11.2974875Z    | |____________________________________________________________________^
2025-11-18T07:14:11.2974935Z 25 |
2025-11-18T07:14:11.2975023Z 26 |   LOGGER = logging.getLogger(__name__)
2025-11-18T07:14:11.2975080Z    |
2025-11-18T07:14:11.2975152Z help: Organize imports
2025-11-18T07:14:11.2975158Z 
2025-11-18T07:14:11.2975248Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.2975374Z   --> tests/integration/test_episode_integration.py:14:21
2025-11-18T07:14:11.2975434Z    |
2025-11-18T07:14:11.2975499Z 12 | import logging
2025-11-18T07:14:11.2975563Z 13 | import time
2025-11-18T07:14:11.2975639Z 14 | from pathlib import Path
2025-11-18T07:14:11.2975711Z    |                     ^^^^
2025-11-18T07:14:11.2975837Z 15 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.2975894Z    |
2025-11-18T07:14:11.2975991Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.2975997Z 
2025-11-18T07:14:11.2976096Z F401 [*] `unittest.mock.patch` imported but unused
2025-11-18T07:14:11.2976214Z   --> tests/integration/test_episode_integration.py:15:49
2025-11-18T07:14:11.2976275Z    |
2025-11-18T07:14:11.2976338Z 13 | import time
2025-11-18T07:14:11.2976413Z 14 | from pathlib import Path
2025-11-18T07:14:11.2976536Z 15 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.2976700Z    |                                                 ^^^^^
2025-11-18T07:14:11.2976758Z 16 |
2025-11-18T07:14:11.2976822Z 17 | import pytest
2025-11-18T07:14:11.2976881Z    |
2025-11-18T07:14:11.2977090Z help: Remove unused import: `unittest.mock.patch`
2025-11-18T07:14:11.2977097Z 
2025-11-18T07:14:11.2977178Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.2977388Z   --> tests/integration/test_token_budget.py:8:8
2025-11-18T07:14:11.2977449Z    |
2025-11-18T07:14:11.2977506Z  6 | """
2025-11-18T07:14:11.2977562Z  7 |
2025-11-18T07:14:11.2977628Z  8 | import asyncio
2025-11-18T07:14:11.2977688Z    |        ^^^^^^^
2025-11-18T07:14:11.2977750Z  9 | import sqlite3
2025-11-18T07:14:11.2977824Z 10 | from pathlib import Path
2025-11-18T07:14:11.2977883Z    |
2025-11-18T07:14:11.2977965Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.2977971Z 
2025-11-18T07:14:11.2978049Z F401 [*] `sqlite3` imported but unused
2025-11-18T07:14:11.2978149Z   --> tests/integration/test_token_budget.py:9:8
2025-11-18T07:14:11.2978210Z    |
2025-11-18T07:14:11.2978274Z  8 | import asyncio
2025-11-18T07:14:11.2978339Z  9 | import sqlite3
2025-11-18T07:14:11.2978398Z    |        ^^^^^^^
2025-11-18T07:14:11.2978472Z 10 | from pathlib import Path
2025-11-18T07:14:11.2978547Z 11 | from typing import Any
2025-11-18T07:14:11.2978607Z    |
2025-11-18T07:14:11.2978690Z help: Remove unused import: `sqlite3`
2025-11-18T07:14:11.2978697Z 
2025-11-18T07:14:11.2978785Z F401 [*] `typing.Any` imported but unused
2025-11-18T07:14:11.2978887Z   --> tests/integration/test_token_budget.py:11:20
2025-11-18T07:14:11.2978943Z    |
2025-11-18T07:14:11.2979006Z  9 | import sqlite3
2025-11-18T07:14:11.2979079Z 10 | from pathlib import Path
2025-11-18T07:14:11.2979155Z 11 | from typing import Any
2025-11-18T07:14:11.2979218Z    |                    ^^^
2025-11-18T07:14:11.2979274Z 12 |
2025-11-18T07:14:11.2979341Z 13 | import pytest
2025-11-18T07:14:11.2979398Z    |
2025-11-18T07:14:11.2979483Z help: Remove unused import: `typing.Any`
2025-11-18T07:14:11.2979492Z 
2025-11-18T07:14:11.2979664Z B007 Loop control variable `expected_min_tokens` not used within loop body
2025-11-18T07:14:11.2979775Z    --> tests/integration/test_token_budget.py:225:15
2025-11-18T07:14:11.2979833Z     |
2025-11-18T07:14:11.2979894Z 223 |     ]
2025-11-18T07:14:11.2979952Z 224 |
2025-11-18T07:14:11.2980060Z 225 |     for text, expected_min_tokens in test_cases:
2025-11-18T07:14:11.2980127Z     |               ^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.2980252Z 226 |         message = {"role": "user", "parts": [{"text": text}]}
2025-11-18T07:14:11.2980367Z 227 |         estimated = manager._estimate_tokens([message])
2025-11-18T07:14:11.2980424Z     |
2025-11-18T07:14:11.2980573Z help: Rename unused `expected_min_tokens` to `_expected_min_tokens`
2025-11-18T07:14:11.2980582Z 
2025-11-18T07:14:11.2980679Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2980759Z   --> tests/unit/test_chat_tools.py:9:1
2025-11-18T07:14:11.2980816Z    |
2025-11-18T07:14:11.2980880Z  7 |   """
2025-11-18T07:14:11.2980936Z  8 |
2025-11-18T07:14:11.2981002Z  9 | / import asyncio
2025-11-18T07:14:11.2981065Z 10 | | import json
2025-11-18T07:14:11.2981132Z 11 | | import pytest
2025-11-18T07:14:11.2981189Z 12 | |
2025-11-18T07:14:11.2981283Z 13 | | from app.handlers.chat_tools import (
2025-11-18T07:14:11.2981366Z 14 | |     build_tool_definitions,
2025-11-18T07:14:11.2981438Z 15 | |     build_tool_callbacks,
2025-11-18T07:14:11.2981496Z 16 | | )
2025-11-18T07:14:11.2981556Z    | |_^
2025-11-18T07:14:11.2981612Z    |
2025-11-18T07:14:11.2981681Z help: Organize imports
2025-11-18T07:14:11.2981687Z 
2025-11-18T07:14:11.2981765Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.2981848Z   --> tests/unit/test_chat_tools.py:9:8
2025-11-18T07:14:11.2981906Z    |
2025-11-18T07:14:11.2981964Z  7 | """
2025-11-18T07:14:11.2982024Z  8 |
2025-11-18T07:14:11.2982086Z  9 | import asyncio
2025-11-18T07:14:11.2982146Z    |        ^^^^^^^
2025-11-18T07:14:11.2982209Z 10 | import json
2025-11-18T07:14:11.2982394Z 11 | import pytest
2025-11-18T07:14:11.2982450Z    |
2025-11-18T07:14:11.2982532Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.2982537Z 
2025-11-18T07:14:11.2982636Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2982728Z   --> tests/unit/test_chat_tools_image.py:7:1
2025-11-18T07:14:11.2982861Z    |
2025-11-18T07:14:11.2982918Z  5 |   """
2025-11-18T07:14:11.2982985Z  6 |
2025-11-18T07:14:11.2983047Z  7 | / import json
2025-11-18T07:14:11.2983113Z  8 | | import pytest
2025-11-18T07:14:11.2983178Z  9 | | import types
2025-11-18T07:14:11.2983234Z 10 | |
2025-11-18T07:14:11.2983366Z 11 | | from app.handlers.chat_tools import build_tool_callbacks
2025-11-18T07:14:11.2983458Z    | |________________________________________________________^
2025-11-18T07:14:11.2983520Z    |
2025-11-18T07:14:11.2983589Z help: Organize imports
2025-11-18T07:14:11.2983595Z 
2025-11-18T07:14:11.2983690Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2983790Z    --> tests/unit/test_chat_tools_image.py:105:5
2025-11-18T07:14:11.2983846Z     |
2025-11-18T07:14:11.2983952Z 103 |           return [{"kind": "image", "bytes": b"IMG"}]
2025-11-18T07:14:11.2984012Z 104 |
2025-11-18T07:14:11.2984181Z 105 | /     from app import handlers as _h  # noqa: F401  # ensure package import
2025-11-18T07:14:11.2984304Z 106 | |     import app.handlers.chat_tools as chat_tools_mod
2025-11-18T07:14:11.2984391Z     | |____________________________________________________^
2025-11-18T07:14:11.2984617Z 107 |       monkeypatch.setattr(chat_tools_mod, "collect_media_parts", _fake_collect_media_parts)
2025-11-18T07:14:11.2984675Z     |
2025-11-18T07:14:11.2984745Z help: Organize imports
2025-11-18T07:14:11.2984751Z 
2025-11-18T07:14:11.2984853Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.2984952Z   --> tests/unit/test_chat_tools_validation.py:9:1
2025-11-18T07:14:11.2985010Z    |
2025-11-18T07:14:11.2985070Z  7 |   """
2025-11-18T07:14:11.2985126Z  8 |
2025-11-18T07:14:11.2985196Z  9 | / import pytest
2025-11-18T07:14:11.2985260Z 10 | | import types
2025-11-18T07:14:11.2985323Z 11 | |
2025-11-18T07:14:11.2985522Z 12 | | from app.handlers.chat_tools import build_tool_definitions, build_tool_callbacks
2025-11-18T07:14:11.2985642Z    | |________________________________________________________________________________^
2025-11-18T07:14:11.2985705Z    |
2025-11-18T07:14:11.2985773Z help: Organize imports
2025-11-18T07:14:11.2985779Z 
2025-11-18T07:14:11.2985863Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2985969Z   --> tests/unit/test_chat_tools_validation.py:55:1
2025-11-18T07:14:11.2986026Z    |
2025-11-18T07:14:11.2986095Z 53 |                 self.id = 1
2025-11-18T07:14:11.2986163Z 54 |         return Memory()
2025-11-18T07:14:11.2986224Z 55 |     
2025-11-18T07:14:11.2986281Z    | ^^^^
2025-11-18T07:14:11.2986429Z 56 |     async def get_memories_for_user(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2986495Z 57 |         return []
2025-11-18T07:14:11.2986553Z    |
2025-11-18T07:14:11.2986637Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2986643Z 
2025-11-18T07:14:11.2986722Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2986825Z   --> tests/unit/test_chat_tools_validation.py:58:1
2025-11-18T07:14:11.2986881Z    |
2025-11-18T07:14:11.2987132Z 56 |     async def get_memories_for_user(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2987200Z 57 |         return []
2025-11-18T07:14:11.2987257Z 58 |     
2025-11-18T07:14:11.2987313Z    | ^^^^
2025-11-18T07:14:11.2987422Z 59 |     async def get_memory_by_id(self, memory_id: int):
2025-11-18T07:14:11.2987491Z 60 |         return None
2025-11-18T07:14:11.2987547Z    |
2025-11-18T07:14:11.2987630Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2987636Z 
2025-11-18T07:14:11.2987716Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2987815Z   --> tests/unit/test_chat_tools_validation.py:61:1
2025-11-18T07:14:11.2987871Z    |
2025-11-18T07:14:11.2988095Z 59 |     async def get_memory_by_id(self, memory_id: int):
2025-11-18T07:14:11.2988162Z 60 |         return None
2025-11-18T07:14:11.2988221Z 61 |     
2025-11-18T07:14:11.2988278Z    | ^^^^
2025-11-18T07:14:11.2988388Z 62 |     async def delete_memory(self, memory_id: int):
2025-11-18T07:14:11.2988453Z 63 |         return True
2025-11-18T07:14:11.2988609Z    |
2025-11-18T07:14:11.2988697Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2988702Z 
2025-11-18T07:14:11.2988779Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2988880Z   --> tests/unit/test_chat_tools_validation.py:64:1
2025-11-18T07:14:11.2988939Z    |
2025-11-18T07:14:11.2989040Z 62 |     async def delete_memory(self, memory_id: int):
2025-11-18T07:14:11.2989105Z 63 |         return True
2025-11-18T07:14:11.2989161Z 64 |     
2025-11-18T07:14:11.2989222Z    | ^^^^
2025-11-18T07:14:11.2989369Z 65 |     async def delete_all_memories(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2989432Z 66 |         return 0
2025-11-18T07:14:11.2989496Z    |
2025-11-18T07:14:11.2989579Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2989585Z 
2025-11-18T07:14:11.2989662Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2989761Z   --> tests/unit/test_chat_tools_validation.py:72:1
2025-11-18T07:14:11.2989820Z    |
2025-11-18T07:14:11.2989937Z 70 |     async def find_user(self, query: str, chat_id: int):
2025-11-18T07:14:11.2990036Z 71 |         return {"user_id": 123, "username": "test"}
2025-11-18T07:14:11.2990095Z 72 |     
2025-11-18T07:14:11.2990151Z    | ^^^^
2025-11-18T07:14:11.2990268Z 73 |     async def kick_user(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2990344Z 74 |         return "User kicked"
2025-11-18T07:14:11.2990401Z    |
2025-11-18T07:14:11.2990484Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2990490Z 
2025-11-18T07:14:11.2990568Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2990669Z   --> tests/unit/test_chat_tools_validation.py:75:1
2025-11-18T07:14:11.2990729Z    |
2025-11-18T07:14:11.2990845Z 73 |     async def kick_user(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2990920Z 74 |         return "User kicked"
2025-11-18T07:14:11.2990978Z 75 |     
2025-11-18T07:14:11.2991035Z    | ^^^^
2025-11-18T07:14:11.2991239Z 76 |     async def mute_user(self, user_id: int, chat_id: int, duration_minutes: int | None = None):
2025-11-18T07:14:11.2991317Z 77 |         return "User muted"
2025-11-18T07:14:11.2991373Z    |
2025-11-18T07:14:11.2991455Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2991460Z 
2025-11-18T07:14:11.2991542Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2991643Z   --> tests/unit/test_chat_tools_validation.py:78:1
2025-11-18T07:14:11.2991699Z    |
2025-11-18T07:14:11.2991896Z 76 |     async def mute_user(self, user_id: int, chat_id: int, duration_minutes: int | None = None):
2025-11-18T07:14:11.2991968Z 77 |         return "User muted"
2025-11-18T07:14:11.2992025Z 78 |     
2025-11-18T07:14:11.2992087Z    | ^^^^
2025-11-18T07:14:11.2992218Z 79 |     async def unmute_user(self, user_id: int, chat_id: int):
2025-11-18T07:14:11.2992293Z 80 |         return "User unmuted"
2025-11-18T07:14:11.2992349Z    |
2025-11-18T07:14:11.2992438Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2992444Z 
2025-11-18T07:14:11.2992527Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2992636Z    --> tests/unit/test_checkers_game_engine.py:105:1
2025-11-18T07:14:11.2992695Z     |
2025-11-18T07:14:11.2992782Z 103 |     board = [[0] * 8 for _ in range(8)]
2025-11-18T07:14:11.2992936Z 104 |     board[3][2] = 3  # Black king (queen) at playable square (3+2=5, odd)
2025-11-18T07:14:11.2992995Z 105 |     
2025-11-18T07:14:11.2993055Z     | ^^^^
2025-11-18T07:14:11.2993133Z 106 |     game = CheckersGame(board)
2025-11-18T07:14:11.2993215Z 107 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.2993273Z     |
2025-11-18T07:14:11.2993357Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2993447Z 
2025-11-18T07:14:11.2993529Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2993635Z    --> tests/unit/test_checkers_game_engine.py:108:1
2025-11-18T07:14:11.2993692Z     |
2025-11-18T07:14:11.2993768Z 106 |     game = CheckersGame(board)
2025-11-18T07:14:11.2993850Z 107 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.2993984Z 108 |     
2025-11-18T07:14:11.2994042Z     | ^^^^
2025-11-18T07:14:11.2994195Z 109 |     # Queen should be able to move to multiple positions diagonally
2025-11-18T07:14:11.2994386Z 110 |     queen_moves = [move for move in moves if (move.from_row, move.from_col) == (3, 2)]
2025-11-18T07:14:11.2994446Z     |
2025-11-18T07:14:11.2994530Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2994536Z 
2025-11-18T07:14:11.2994613Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2994720Z    --> tests/unit/test_checkers_game_engine.py:111:1
2025-11-18T07:14:11.2994778Z     |
2025-11-18T07:14:11.2994923Z 109 |     # Queen should be able to move to multiple positions diagonally
2025-11-18T07:14:11.2995113Z 110 |     queen_moves = [move for move in moves if (move.from_row, move.from_col) == (3, 2)]
2025-11-18T07:14:11.2995172Z 111 |     
2025-11-18T07:14:11.2995229Z     | ^^^^
2025-11-18T07:14:11.2995393Z 112 |     # Should have moves in all 4 diagonal directions, multiple cells each
2025-11-18T07:14:11.2995540Z 113 |     assert len(queen_moves) > 4  # More than just adjacent cells
2025-11-18T07:14:11.2995598Z     |
2025-11-18T07:14:11.2995682Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2995690Z 
2025-11-18T07:14:11.2995769Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2995869Z    --> tests/unit/test_checkers_game_engine.py:114:1
2025-11-18T07:14:11.2995926Z     |
2025-11-18T07:14:11.2996084Z 112 |     # Should have moves in all 4 diagonal directions, multiple cells each
2025-11-18T07:14:11.2996220Z 113 |     assert len(queen_moves) > 4  # More than just adjacent cells
2025-11-18T07:14:11.2996279Z 114 |     
2025-11-18T07:14:11.2996344Z     | ^^^^
2025-11-18T07:14:11.2996534Z 115 |     # Check that queen can move to a distant playable cell (e.g., from (3,2) to (0,5))
2025-11-18T07:14:11.2996608Z 116 |     distant_move = next(
2025-11-18T07:14:11.2996667Z     |
2025-11-18T07:14:11.2996754Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2996763Z 
2025-11-18T07:14:11.2996841Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2997045Z    --> tests/unit/test_checkers_game_engine.py:129:1
2025-11-18T07:14:11.2997108Z     |
2025-11-18T07:14:11.2997244Z 127 |     board[0][1] = 3  # Black king (queen) at playable square (0+1=1, odd)
2025-11-18T07:14:11.2997378Z 128 |     board[3][4] = 2  # White piece 3 cells away diagonally (3+4=7, odd)
2025-11-18T07:14:11.2997438Z 129 |     
2025-11-18T07:14:11.2997496Z     | ^^^^
2025-11-18T07:14:11.2997573Z 130 |     game = CheckersGame(board)
2025-11-18T07:14:11.2997654Z 131 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.2997715Z     |
2025-11-18T07:14:11.2997800Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2997806Z 
2025-11-18T07:14:11.2997883Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2997985Z    --> tests/unit/test_checkers_game_engine.py:132:1
2025-11-18T07:14:11.2998043Z     |
2025-11-18T07:14:11.2998118Z 130 |     game = CheckersGame(board)
2025-11-18T07:14:11.2998204Z 131 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.2998260Z 132 |     
2025-11-18T07:14:11.2998317Z     | ^^^^
2025-11-18T07:14:11.2998437Z 133 |     # Queen should be able to jump over the white piece
2025-11-18T07:14:11.2998512Z 134 |     jump_moves = [
2025-11-18T07:14:11.2998569Z     |
2025-11-18T07:14:11.2998652Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2998657Z 
2025-11-18T07:14:11.2998739Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2998839Z    --> tests/unit/test_checkers_game_engine.py:139:1
2025-11-18T07:14:11.2998897Z     |
2025-11-18T07:14:11.2998978Z 137 |         and move.jumps == [(3, 4)]
2025-11-18T07:14:11.2999160Z 138 |     ]
2025-11-18T07:14:11.2999219Z 139 |     
2025-11-18T07:14:11.2999278Z     | ^^^^
2025-11-18T07:14:11.2999356Z 140 |     assert len(jump_moves) > 0
2025-11-18T07:14:11.2999480Z 141 |     # Landing should be one cell beyond the jumped piece
2025-11-18T07:14:11.2999537Z     |
2025-11-18T07:14:11.2999724Z help: Remove whitespace from blank line
2025-11-18T07:14:11.2999732Z 
2025-11-18T07:14:11.2999809Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.2999908Z    --> tests/unit/test_checkers_game_engine.py:153:1
2025-11-18T07:14:11.2999965Z     |
2025-11-18T07:14:11.3000076Z 151 |     board[2][3] = 2  # First white piece (2+3=5, odd)
2025-11-18T07:14:11.3000182Z 152 |     board[5][6] = 2  # Second white piece (5+6=11, odd)
2025-11-18T07:14:11.3000242Z 153 |     
2025-11-18T07:14:11.3000302Z     | ^^^^
2025-11-18T07:14:11.3000376Z 154 |     game = CheckersGame(board)
2025-11-18T07:14:11.3000456Z 155 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3000513Z     |
2025-11-18T07:14:11.3000601Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3000607Z 
2025-11-18T07:14:11.3000685Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3000787Z    --> tests/unit/test_checkers_game_engine.py:156:1
2025-11-18T07:14:11.3000847Z     |
2025-11-18T07:14:11.3000921Z 154 |     game = CheckersGame(board)
2025-11-18T07:14:11.3001004Z 155 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3001064Z 156 |     
2025-11-18T07:14:11.3001121Z     | ^^^^
2025-11-18T07:14:11.3001204Z 157 |     # Should find multi-jump moves
2025-11-18T07:14:11.3001277Z 158 |     multi_jump_moves = [
2025-11-18T07:14:11.3001336Z     |
2025-11-18T07:14:11.3001418Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3001424Z 
2025-11-18T07:14:11.3001501Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3001604Z    --> tests/unit/test_checkers_game_engine.py:163:1
2025-11-18T07:14:11.3001662Z     |
2025-11-18T07:14:11.3001742Z 161 |         and len(move.jumps) == 2
2025-11-18T07:14:11.3001804Z 162 |     ]
2025-11-18T07:14:11.3001864Z 163 |     
2025-11-18T07:14:11.3001921Z     | ^^^^
2025-11-18T07:14:11.3002007Z 164 |     assert len(multi_jump_moves) > 0
2025-11-18T07:14:11.3002093Z 165 |     multi_move = multi_jump_moves[0]
2025-11-18T07:14:11.3002152Z     |
2025-11-18T07:14:11.3002235Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3002243Z 
2025-11-18T07:14:11.3002323Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3002424Z    --> tests/unit/test_checkers_game_engine.py:174:1
2025-11-18T07:14:11.3002481Z     |
2025-11-18T07:14:11.3002564Z 172 |     board = [[0] * 8 for _ in range(8)]
2025-11-18T07:14:11.3002746Z 173 |     board[3][2] = 1  # Black regular piece (not a king) at playable square (3+2=5, odd)
2025-11-18T07:14:11.3002803Z 174 |     
2025-11-18T07:14:11.3002861Z     | ^^^^
2025-11-18T07:14:11.3002938Z 175 |     game = CheckersGame(board)
2025-11-18T07:14:11.3003019Z 176 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3003077Z     |
2025-11-18T07:14:11.3003162Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3003171Z 
2025-11-18T07:14:11.3003247Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3003346Z    --> tests/unit/test_checkers_game_engine.py:177:1
2025-11-18T07:14:11.3003404Z     |
2025-11-18T07:14:11.3003482Z 175 |     game = CheckersGame(board)
2025-11-18T07:14:11.3003565Z 176 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3003623Z 177 |     
2025-11-18T07:14:11.3003684Z     | ^^^^
2025-11-18T07:14:11.3003878Z 178 |     regular_moves = [move for move in moves if (move.from_row, move.from_col) == (3, 2)]
2025-11-18T07:14:11.3003935Z     |
2025-11-18T07:14:11.3004018Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3004027Z 
2025-11-18T07:14:11.3004106Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3004204Z    --> tests/unit/test_checkers_game_engine.py:179:1
2025-11-18T07:14:11.3004261Z     |
2025-11-18T07:14:11.3004450Z 178 |     regular_moves = [move for move in moves if (move.from_row, move.from_col) == (3, 2)]
2025-11-18T07:14:11.3004593Z 179 |     
2025-11-18T07:14:11.3004651Z     | ^^^^
2025-11-18T07:14:11.3004802Z 180 |     # Regular piece should only have 2 moves (forward diagonally)
2025-11-18T07:14:11.3004883Z 181 |     assert len(regular_moves) == 2
2025-11-18T07:14:11.3005016Z     |
2025-11-18T07:14:11.3005099Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3005104Z 
2025-11-18T07:14:11.3005185Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3005286Z    --> tests/unit/test_checkers_game_engine.py:182:1
2025-11-18T07:14:11.3005343Z     |
2025-11-18T07:14:11.3005484Z 180 |     # Regular piece should only have 2 moves (forward diagonally)
2025-11-18T07:14:11.3005565Z 181 |     assert len(regular_moves) == 2
2025-11-18T07:14:11.3005621Z 182 |     
2025-11-18T07:14:11.3005679Z     | ^^^^
2025-11-18T07:14:11.3005775Z 183 |     # All moves should be exactly 1 cell away
2025-11-18T07:14:11.3005849Z 184 |     for move in regular_moves:
2025-11-18T07:14:11.3005910Z     |
2025-11-18T07:14:11.3005997Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3006002Z 
2025-11-18T07:14:11.3006079Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3006177Z    --> tests/unit/test_checkers_game_engine.py:197:1
2025-11-18T07:14:11.3006236Z     |
2025-11-18T07:14:11.3006365Z 195 |     board[2][3] = 1  # Own piece blocking the path (2+3=5, odd)
2025-11-18T07:14:11.3006485Z 196 |     board[4][5] = 0  # Empty playable cell beyond (4+5=9, odd)
2025-11-18T07:14:11.3006546Z 197 |     
2025-11-18T07:14:11.3006602Z     | ^^^^
2025-11-18T07:14:11.3006679Z 198 |     game = CheckersGame(board)
2025-11-18T07:14:11.3006758Z 199 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3006817Z     |
2025-11-18T07:14:11.3006900Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3006906Z 
2025-11-18T07:14:11.3007078Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3007184Z    --> tests/unit/test_checkers_game_engine.py:200:1
2025-11-18T07:14:11.3007246Z     |
2025-11-18T07:14:11.3007321Z 198 |     game = CheckersGame(board)
2025-11-18T07:14:11.3007400Z 199 |     moves = game.get_valid_moves(1)
2025-11-18T07:14:11.3007461Z 200 |     
2025-11-18T07:14:11.3007519Z     | ^^^^
2025-11-18T07:14:11.3007700Z 201 |     queen_moves = [move for move in moves if (move.from_row, move.from_col) == (0, 1)]
2025-11-18T07:14:11.3007764Z     |
2025-11-18T07:14:11.3007847Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3007852Z 
2025-11-18T07:14:11.3007930Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3008031Z    --> tests/unit/test_checkers_game_engine.py:202:1
2025-11-18T07:14:11.3008089Z     |
2025-11-18T07:14:11.3008266Z 201 |     queen_moves = [move for move in moves if (move.from_row, move.from_col) == (0, 1)]
2025-11-18T07:14:11.3008325Z 202 |     
2025-11-18T07:14:11.3008386Z     | ^^^^
2025-11-18T07:14:11.3008523Z 203 |     # Should not be able to move to (4,5) because path is blocked
2025-11-18T07:14:11.3008595Z 204 |     blocked_move = next(
2025-11-18T07:14:11.3008658Z     |
2025-11-18T07:14:11.3008740Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3008746Z 
2025-11-18T07:14:11.3008824Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3008926Z    --> tests/unit/test_checkers_game_engine.py:209:1
2025-11-18T07:14:11.3008989Z     |
2025-11-18T07:14:11.3009047Z 207 |     )
2025-11-18T07:14:11.3009124Z 208 |     assert blocked_move is None
2025-11-18T07:14:11.3009184Z 209 |     
2025-11-18T07:14:11.3009242Z     | ^^^^
2025-11-18T07:14:11.3009399Z 210 |     # Should be able to move to (1,2) before the blocking piece (1+2=3, odd)
2025-11-18T07:14:11.3009472Z 211 |     valid_move = next(
2025-11-18T07:14:11.3009528Z     |
2025-11-18T07:14:11.3009611Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3009617Z 
2025-11-18T07:14:11.3009715Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3009815Z   --> tests/unit/test_checkers_game_store.py:3:1
2025-11-18T07:14:11.3009873Z    |
2025-11-18T07:14:11.3010125Z  1 |   """Unit tests for the CheckersGameStore challenge flow."""
2025-11-18T07:14:11.3010186Z  2 |
2025-11-18T07:14:11.3010269Z  3 | / from __future__ import annotations
2025-11-18T07:14:11.3010326Z  4 | |
2025-11-18T07:14:11.3010390Z  5 | | import time
2025-11-18T07:14:11.3010488Z  6 | | from collections.abc import AsyncIterator
2025-11-18T07:14:11.3010690Z  7 | | from contextlib import asynccontextmanager
2025-11-18T07:14:11.3010790Z  8 | | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.3010850Z  9 | |
2025-11-18T07:14:11.3010917Z 10 | | import pytest
2025-11-18T07:14:11.3010974Z 11 | |
2025-11-18T07:14:11.3011038Z 12 | | import sys
2025-11-18T07:14:11.3011125Z 13 | | from types import SimpleNamespace
2025-11-18T07:14:11.3011193Z    | |_________________________________^
2025-11-18T07:14:11.3011249Z 14 |
2025-11-18T07:14:11.3011332Z 15 |   if "asyncpg" not in sys.modules:
2025-11-18T07:14:11.3011389Z    |
2025-11-18T07:14:11.3011461Z help: Organize imports
2025-11-18T07:14:11.3011470Z 
2025-11-18T07:14:11.3011589Z UP035 `typing.Dict` is deprecated, use `dict` instead
2025-11-18T07:14:11.3011687Z   --> tests/unit/test_checkers_game_store.py:8:1
2025-11-18T07:14:11.3011745Z    |
2025-11-18T07:14:11.3011842Z  6 | from collections.abc import AsyncIterator
2025-11-18T07:14:11.3011942Z  7 | from contextlib import asynccontextmanager
2025-11-18T07:14:11.3012042Z  8 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.3012114Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3012174Z  9 |
2025-11-18T07:14:11.3012240Z 10 | import pytest
2025-11-18T07:14:11.3012298Z    |
2025-11-18T07:14:11.3012303Z 
2025-11-18T07:14:11.3012419Z UP035 `typing.List` is deprecated, use `list` instead
2025-11-18T07:14:11.3012513Z   --> tests/unit/test_checkers_game_store.py:8:1
2025-11-18T07:14:11.3012569Z    |
2025-11-18T07:14:11.3012663Z  6 | from collections.abc import AsyncIterator
2025-11-18T07:14:11.3012762Z  7 | from contextlib import asynccontextmanager
2025-11-18T07:14:11.3012858Z  8 | from typing import Any, Dict, List, Optional
2025-11-18T07:14:11.3012927Z    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3012985Z  9 |
2025-11-18T07:14:11.3013051Z 10 | import pytest
2025-11-18T07:14:11.3013108Z    |
2025-11-18T07:14:11.3013114Z 
2025-11-18T07:14:11.3013234Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.3013340Z   --> tests/unit/test_checkers_game_store.py:29:21
2025-11-18T07:14:11.3013396Z    |
2025-11-18T07:14:11.3013472Z 28 |     def __init__(self) -> None:
2025-11-18T07:14:11.3013576Z 29 |         self.games: Dict[str, Dict[str, Any]] = {}
2025-11-18T07:14:11.3013642Z    |                     ^^^^
2025-11-18T07:14:11.3013698Z 30 |
2025-11-18T07:14:11.3013832Z 31 |     async def execute(self, sql: str, *params: Any) -> None:
2025-11-18T07:14:11.3013890Z    |
2025-11-18T07:14:11.3013963Z help: Replace with `dict`
2025-11-18T07:14:11.3013969Z 
2025-11-18T07:14:11.3014082Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.3014189Z   --> tests/unit/test_checkers_game_store.py:29:31
2025-11-18T07:14:11.3014246Z    |
2025-11-18T07:14:11.3014317Z 28 |     def __init__(self) -> None:
2025-11-18T07:14:11.3014415Z 29 |         self.games: Dict[str, Dict[str, Any]] = {}
2025-11-18T07:14:11.3014481Z    |                               ^^^^
2025-11-18T07:14:11.3014540Z 30 |
2025-11-18T07:14:11.3014665Z 31 |     async def execute(self, sql: str, *params: Any) -> None:
2025-11-18T07:14:11.3014723Z    |
2025-11-18T07:14:11.3014796Z help: Replace with `dict`
2025-11-18T07:14:11.3014801Z 
2025-11-18T07:14:11.3014893Z UP045 [*] Use `X | None` for type annotations
2025-11-18T07:14:11.3014998Z    --> tests/unit/test_checkers_game_store.py:100:57
2025-11-18T07:14:11.3015056Z     |
2025-11-18T07:14:11.3015195Z  98 |         raise AssertionError(f"Unexpected execute call: {sql}")
2025-11-18T07:14:11.3015255Z  99 |
2025-11-18T07:14:11.3015441Z 100 |     async def fetchrow(self, sql: str, *params: Any) -> Optional[Dict[str, Any]]:
2025-11-18T07:14:11.3015653Z     |                                                         ^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3015766Z 101 |         if "SELECT challenger_id, game_status" in sql:
2025-11-18T07:14:11.3015843Z 102 |             game_id = params[0]
2025-11-18T07:14:11.3015977Z     |
2025-11-18T07:14:11.3016053Z help: Convert to `X | None`
2025-11-18T07:14:11.3016058Z 
2025-11-18T07:14:11.3016174Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.3016276Z    --> tests/unit/test_checkers_game_store.py:100:66
2025-11-18T07:14:11.3016334Z     |
2025-11-18T07:14:11.3016470Z  98 |         raise AssertionError(f"Unexpected execute call: {sql}")
2025-11-18T07:14:11.3016527Z  99 |
2025-11-18T07:14:11.3016705Z 100 |     async def fetchrow(self, sql: str, *params: Any) -> Optional[Dict[str, Any]]:
2025-11-18T07:14:11.3016792Z     |                                                                  ^^^^
2025-11-18T07:14:11.3016899Z 101 |         if "SELECT challenger_id, game_status" in sql:
2025-11-18T07:14:11.3017075Z 102 |             game_id = params[0]
2025-11-18T07:14:11.3017136Z     |
2025-11-18T07:14:11.3017213Z help: Replace with `dict`
2025-11-18T07:14:11.3017219Z 
2025-11-18T07:14:11.3017330Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.3017434Z    --> tests/unit/test_checkers_game_store.py:120:25
2025-11-18T07:14:11.3017493Z     |
2025-11-18T07:14:11.3017606Z 118 |         if "game_status IN ('pending', 'active')" in sql:
2025-11-18T07:14:11.3017703Z 119 |             chat_id, thread_id, user_id = params
2025-11-18T07:14:11.3017798Z 120 |             candidates: List[Dict[str, Any]] = []
2025-11-18T07:14:11.3017867Z     |                         ^^^^
2025-11-18T07:14:11.3017960Z 121 |             for record in self.games.values():
2025-11-18T07:14:11.3018052Z 122 |                 if record["chat_id"] != chat_id:
2025-11-18T07:14:11.3018112Z     |
2025-11-18T07:14:11.3018184Z help: Replace with `list`
2025-11-18T07:14:11.3018194Z 
2025-11-18T07:14:11.3018304Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.3018407Z    --> tests/unit/test_checkers_game_store.py:120:30
2025-11-18T07:14:11.3018464Z     |
2025-11-18T07:14:11.3018573Z 118 |         if "game_status IN ('pending', 'active')" in sql:
2025-11-18T07:14:11.3018670Z 119 |             chat_id, thread_id, user_id = params
2025-11-18T07:14:11.3018764Z 120 |             candidates: List[Dict[str, Any]] = []
2025-11-18T07:14:11.3018831Z     |                              ^^^^
2025-11-18T07:14:11.3018924Z 121 |             for record in self.games.values():
2025-11-18T07:14:11.3019016Z 122 |                 if record["chat_id"] != chat_id:
2025-11-18T07:14:11.3019075Z     |
2025-11-18T07:14:11.3019148Z help: Replace with `dict`
2025-11-18T07:14:11.3019153Z 
2025-11-18T07:14:11.3019266Z UP006 [*] Use `list` instead of `List` for type annotation
2025-11-18T07:14:11.3019364Z    --> tests/unit/test_checkers_game_store.py:139:54
2025-11-18T07:14:11.3019425Z     |
2025-11-18T07:14:11.3019567Z 137 |         raise AssertionError(f"Unexpected fetchrow call: {sql}")
2025-11-18T07:14:11.3019625Z 138 |
2025-11-18T07:14:11.3019786Z 139 |     async def fetch(self, sql: str, *params: Any) -> List[Dict[str, Any]]:
2025-11-18T07:14:11.3019863Z     |                                                      ^^^^
2025-11-18T07:14:11.3019943Z 140 |         user_id = params[0]
2025-11-18T07:14:11.3020031Z 141 |         if "AND game_status = $2" in sql:
2025-11-18T07:14:11.3020088Z     |
2025-11-18T07:14:11.3020163Z help: Replace with `list`
2025-11-18T07:14:11.3020168Z 
2025-11-18T07:14:11.3020278Z UP006 [*] Use `dict` instead of `Dict` for type annotation
2025-11-18T07:14:11.3020375Z    --> tests/unit/test_checkers_game_store.py:139:59
2025-11-18T07:14:11.3020439Z     |
2025-11-18T07:14:11.3020580Z 137 |         raise AssertionError(f"Unexpected fetchrow call: {sql}")
2025-11-18T07:14:11.3020637Z 138 |
2025-11-18T07:14:11.3020793Z 139 |     async def fetch(self, sql: str, *params: Any) -> List[Dict[str, Any]]:
2025-11-18T07:14:11.3020998Z     |                                                           ^^^^
2025-11-18T07:14:11.3021072Z 140 |         user_id = params[0]
2025-11-18T07:14:11.3021157Z 141 |         if "AND game_status = $2" in sql:
2025-11-18T07:14:11.3021319Z     |
2025-11-18T07:14:11.3021392Z help: Replace with `dict`
2025-11-18T07:14:11.3021396Z 
2025-11-18T07:14:11.3021495Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3021616Z  --> tests/unit/test_command_throttle_middleware.py:3:1
2025-11-18T07:14:11.3021673Z   |
2025-11-18T07:14:11.3021768Z 1 |   """Tests for command throttle middleware."""
2025-11-18T07:14:11.3021824Z 2 |
2025-11-18T07:14:11.3021892Z 3 | / import pytest
2025-11-18T07:14:11.3022022Z 4 | | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3022122Z 5 | | from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3022183Z 6 | |
2025-11-18T07:14:11.3022364Z 7 | | from app.middlewares.command_throttle import CommandThrottleMiddleware
2025-11-18T07:14:11.3022450Z 8 | | from app.config import Settings
2025-11-18T07:14:11.3022519Z   | |_______________________________^
2025-11-18T07:14:11.3022577Z   |
2025-11-18T07:14:11.3022648Z help: Organize imports
2025-11-18T07:14:11.3022653Z 
2025-11-18T07:14:11.3022753Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3022860Z   --> tests/unit/test_conversation_formatter.py:7:1
2025-11-18T07:14:11.3022918Z    |
2025-11-18T07:14:11.3022976Z  5 |   """
2025-11-18T07:14:11.3023033Z  6 |
2025-11-18T07:14:11.3023099Z  7 | / import pytest
2025-11-18T07:14:11.3023221Z  8 | | from app.services.conversation_formatter import (
2025-11-18T07:14:11.3023296Z  9 | |     build_collision_map,
2025-11-18T07:14:11.3023368Z 10 | |     describe_media,
2025-11-18T07:14:11.3023437Z 11 | |     estimate_tokens,
2025-11-18T07:14:11.3023519Z 12 | |     extract_metadata_from_parts,
2025-11-18T07:14:11.3023597Z 13 | |     extract_text_from_parts,
2025-11-18T07:14:11.3023676Z 14 | |     format_history_compact,
2025-11-18T07:14:11.3023749Z 15 | |     format_message_compact,
2025-11-18T07:14:11.3023821Z 16 | |     parse_user_id_short,
2025-11-18T07:14:11.3023895Z 17 | |     sanitize_username,
2025-11-18T07:14:11.3023955Z 18 | | )
2025-11-18T07:14:11.3024011Z    | |_^
2025-11-18T07:14:11.3024074Z    |
2025-11-18T07:14:11.3024143Z help: Organize imports
2025-11-18T07:14:11.3024148Z 
2025-11-18T07:14:11.3024227Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.3024342Z  --> tests/unit/test_episode_boundary_detector.py:7:8
2025-11-18T07:14:11.3024399Z   |
2025-11-18T07:14:11.3024457Z 5 | """
2025-11-18T07:14:11.3024514Z 6 |
2025-11-18T07:14:11.3024580Z 7 | import asyncio
2025-11-18T07:14:11.3024640Z   |        ^^^^^^^
2025-11-18T07:14:11.3024702Z 8 | import json
2025-11-18T07:14:11.3024782Z 9 | from pathlib import Path
2025-11-18T07:14:11.3024838Z   |
2025-11-18T07:14:11.3024921Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.3024926Z 
2025-11-18T07:14:11.3025019Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.3025136Z   --> tests/unit/test_episode_boundary_detector.py:9:21
2025-11-18T07:14:11.3025193Z    |
2025-11-18T07:14:11.3025260Z  7 | import asyncio
2025-11-18T07:14:11.3025325Z  8 | import json
2025-11-18T07:14:11.3025399Z  9 | from pathlib import Path
2025-11-18T07:14:11.3025467Z    |                     ^^^^
2025-11-18T07:14:11.3025593Z 10 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3025655Z    |
2025-11-18T07:14:11.3025752Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.3025758Z 
2025-11-18T07:14:11.3025858Z F401 [*] `unittest.mock.patch` imported but unused
2025-11-18T07:14:11.3025979Z   --> tests/unit/test_episode_boundary_detector.py:10:49
2025-11-18T07:14:11.3026036Z    |
2025-11-18T07:14:11.3026098Z  8 | import json
2025-11-18T07:14:11.3026176Z  9 | from pathlib import Path
2025-11-18T07:14:11.3026298Z 10 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3026457Z    |                                                 ^^^^^
2025-11-18T07:14:11.3026515Z 11 |
2025-11-18T07:14:11.3026584Z 12 | import pytest
2025-11-18T07:14:11.3026640Z    |
2025-11-18T07:14:11.3026749Z help: Remove unused import: `unittest.mock.patch`
2025-11-18T07:14:11.3026755Z 
2025-11-18T07:14:11.3026921Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.3027123Z   --> tests/unit/test_episode_monitor.py:9:21
2025-11-18T07:14:11.3027182Z    |
2025-11-18T07:14:11.3027246Z  7 | import asyncio
2025-11-18T07:14:11.3027311Z  8 | import time
2025-11-18T07:14:11.3027384Z  9 | from pathlib import Path
2025-11-18T07:14:11.3027448Z    |                     ^^^^
2025-11-18T07:14:11.3027572Z 10 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3027628Z    |
2025-11-18T07:14:11.3027721Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.3027727Z 
2025-11-18T07:14:11.3027826Z F401 [*] `unittest.mock.patch` imported but unused
2025-11-18T07:14:11.3027926Z   --> tests/unit/test_episode_monitor.py:10:49
2025-11-18T07:14:11.3027985Z    |
2025-11-18T07:14:11.3028046Z  8 | import time
2025-11-18T07:14:11.3028123Z  9 | from pathlib import Path
2025-11-18T07:14:11.3028241Z 10 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3028313Z    |                                                 ^^^^^
2025-11-18T07:14:11.3028376Z 11 |
2025-11-18T07:14:11.3028443Z 12 | import pytest
2025-11-18T07:14:11.3028500Z    |
2025-11-18T07:14:11.3028606Z help: Remove unused import: `unittest.mock.patch`
2025-11-18T07:14:11.3028615Z 
2025-11-18T07:14:11.3028710Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3028809Z   --> tests/unit/test_episode_summarizer.py:11:1
2025-11-18T07:14:11.3028867Z    |
2025-11-18T07:14:11.3028929Z  9 |   """
2025-11-18T07:14:11.3028986Z 10 |
2025-11-18T07:14:11.3029053Z 11 | / import pytest
2025-11-18T07:14:11.3029180Z 12 | | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3029240Z 13 | |
2025-11-18T07:14:11.3029419Z 14 | | from app.services.context.episode_summarizer import EpisodeSummarizer
2025-11-18T07:14:11.3029528Z    | |_____________________________________________________________________^
2025-11-18T07:14:11.3029586Z    |
2025-11-18T07:14:11.3029658Z help: Organize imports
2025-11-18T07:14:11.3029667Z 
2025-11-18T07:14:11.3029767Z F401 [*] `unittest.mock.patch` imported but unused
2025-11-18T07:14:11.3029868Z   --> tests/unit/test_episode_summarizer.py:12:49
2025-11-18T07:14:11.3029924Z    |
2025-11-18T07:14:11.3029989Z 11 | import pytest
2025-11-18T07:14:11.3030110Z 12 | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3030187Z    |                                                 ^^^^^
2025-11-18T07:14:11.3030244Z 13 |
2025-11-18T07:14:11.3030420Z 14 | from app.services.context.episode_summarizer import EpisodeSummarizer
2025-11-18T07:14:11.3030479Z    |
2025-11-18T07:14:11.3030583Z help: Remove unused import: `unittest.mock.patch`
2025-11-18T07:14:11.3030592Z 
2025-11-18T07:14:11.3030675Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3030776Z   --> tests/unit/test_episode_summarizer.py:88:1
2025-11-18T07:14:11.3030832Z    |
2025-11-18T07:14:11.3030907Z 86 |     gemini_response = """
2025-11-18T07:14:11.3030997Z 87 |     TOPIC: Python 3.13 Features Discussion
2025-11-18T07:14:11.3031064Z 88 |     
2025-11-18T07:14:11.3031122Z    | ^^^^
2025-11-18T07:14:11.3031331Z 89 |     SUMMARY: A technical discussion among developers about Python 3.13's new features,
2025-11-18T07:14:11.3031536Z 90 |     focusing on improved error messages, performance gains, and typing enhancements.
2025-11-18T07:14:11.3031593Z    |
2025-11-18T07:14:11.3031680Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3031686Z 
2025-11-18T07:14:11.3031765Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3031861Z   --> tests/unit/test_episode_summarizer.py:92:1
2025-11-18T07:14:11.3031918Z    |
2025-11-18T07:14:11.3032113Z 90 |     focusing on improved error messages, performance gains, and typing enhancements.
2025-11-18T07:14:11.3032343Z 91 |     The conversation was positive and informative.
2025-11-18T07:14:11.3032401Z 92 |     
2025-11-18T07:14:11.3032459Z    | ^^^^
2025-11-18T07:14:11.3032542Z 93 |     EMOTIONAL_VALENCE: positive
2025-11-18T07:14:11.3032599Z    |
2025-11-18T07:14:11.3032784Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3032790Z 
2025-11-18T07:14:11.3032869Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3032972Z   --> tests/unit/test_episode_summarizer.py:94:1
2025-11-18T07:14:11.3033030Z    |
2025-11-18T07:14:11.3033105Z 93 |     EMOTIONAL_VALENCE: positive
2025-11-18T07:14:11.3033165Z 94 |     
2025-11-18T07:14:11.3033222Z    | ^^^^
2025-11-18T07:14:11.3033363Z 95 |     TAGS: python, programming, python313, technical-discussion
2025-11-18T07:14:11.3033424Z    |
2025-11-18T07:14:11.3033508Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3033512Z 
2025-11-18T07:14:11.3033587Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3033686Z   --> tests/unit/test_episode_summarizer.py:96:1
2025-11-18T07:14:11.3033743Z    |
2025-11-18T07:14:11.3033876Z 95 |     TAGS: python, programming, python313, technical-discussion
2025-11-18T07:14:11.3033935Z 96 |     
2025-11-18T07:14:11.3033994Z    | ^^^^
2025-11-18T07:14:11.3034063Z 97 |     KEY_POINTS:
2025-11-18T07:14:11.3034189Z 98 |     - Improved error messages enhance debugging experience
2025-11-18T07:14:11.3034247Z    |
2025-11-18T07:14:11.3034329Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3034335Z 
2025-11-18T07:14:11.3034410Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3034509Z    --> tests/unit/test_episode_summarizer.py:461:1
2025-11-18T07:14:11.3034569Z     |
2025-11-18T07:14:11.3034642Z 459 |     gemini_response = """
2025-11-18T07:14:11.3034739Z 460 |     TOPIC: Code Review Session Planning
2025-11-18T07:14:11.3034801Z 461 |     
2025-11-18T07:14:11.3034859Z     | ^^^^
2025-11-18T07:14:11.3035068Z 462 |     SUMMARY: Team members coordinate to set up a code review session for an API client
2025-11-18T07:14:11.3035242Z 463 |     implementation. The conversation is collaborative and productive.
2025-11-18T07:14:11.3035301Z     |
2025-11-18T07:14:11.3035384Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3035389Z 
2025-11-18T07:14:11.3035468Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3035573Z    --> tests/unit/test_episode_summarizer.py:464:1
2025-11-18T07:14:11.3035631Z     |
2025-11-18T07:14:11.3035835Z 462 |     SUMMARY: Team members coordinate to set up a code review session for an API client
2025-11-18T07:14:11.3036000Z 463 |     implementation. The conversation is collaborative and productive.
2025-11-18T07:14:11.3036058Z 464 |     
2025-11-18T07:14:11.3036116Z     | ^^^^
2025-11-18T07:14:11.3036198Z 465 |     EMOTIONAL_VALENCE: positive
2025-11-18T07:14:11.3036259Z     |
2025-11-18T07:14:11.3036341Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3036347Z 
2025-11-18T07:14:11.3036425Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3036523Z    --> tests/unit/test_episode_summarizer.py:466:1
2025-11-18T07:14:11.3036580Z     |
2025-11-18T07:14:11.3036657Z 465 |     EMOTIONAL_VALENCE: positive
2025-11-18T07:14:11.3036719Z 466 |     
2025-11-18T07:14:11.3036776Z     | ^^^^
2025-11-18T07:14:11.3036897Z 467 |     TAGS: code-review, collaboration, planning, api
2025-11-18T07:14:11.3037058Z     |
2025-11-18T07:14:11.3037148Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3037153Z 
2025-11-18T07:14:11.3037231Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3037325Z    --> tests/unit/test_episode_summarizer.py:468:1
2025-11-18T07:14:11.3037386Z     |
2025-11-18T07:14:11.3037496Z 467 |     TAGS: code-review, collaboration, planning, api
2025-11-18T07:14:11.3037553Z 468 |     
2025-11-18T07:14:11.3037613Z     | ^^^^
2025-11-18T07:14:11.3037679Z 469 |     KEY_POINTS:
2025-11-18T07:14:11.3037766Z 470 |     - Code review session proposed
2025-11-18T07:14:11.3037822Z     |
2025-11-18T07:14:11.3038028Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3038033Z 
2025-11-18T07:14:11.3038131Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3038216Z   --> tests/unit/test_exceptions.py:3:1
2025-11-18T07:14:11.3038276Z    |
2025-11-18T07:14:11.3038382Z  1 |   """Unit tests for custom exception hierarchy."""
2025-11-18T07:14:11.3038544Z  2 |
2025-11-18T07:14:11.3038612Z  3 | / import pytest
2025-11-18T07:14:11.3038704Z  4 | | from app.core.exceptions import (
2025-11-18T07:14:11.3038777Z  5 | |     GryagException,
2025-11-18T07:14:11.3038846Z  6 | |     DatabaseError,
2025-11-18T07:14:11.3038916Z  7 | |     GeminiError,
2025-11-18T07:14:11.3038998Z  8 | |     UserProfileNotFoundError,
2025-11-18T07:14:11.3039067Z  9 | |     ValidationError,
2025-11-18T07:14:11.3039124Z 10 | | )
2025-11-18T07:14:11.3039184Z    | |_^
2025-11-18T07:14:11.3039240Z    |
2025-11-18T07:14:11.3039311Z help: Organize imports
2025-11-18T07:14:11.3039316Z 
2025-11-18T07:14:11.3039401Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3039488Z  --> tests/unit/test_exceptions.py:3:8
2025-11-18T07:14:11.3039545Z   |
2025-11-18T07:14:11.3039651Z 1 | """Unit tests for custom exception hierarchy."""
2025-11-18T07:14:11.3039708Z 2 |
2025-11-18T07:14:11.3039773Z 3 | import pytest
2025-11-18T07:14:11.3039836Z   |        ^^^^^^
2025-11-18T07:14:11.3039924Z 4 | from app.core.exceptions import (
2025-11-18T07:14:11.3039994Z 5 |     GryagException,
2025-11-18T07:14:11.3040050Z   |
2025-11-18T07:14:11.3040132Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3040138Z 
2025-11-18T07:14:11.3040510Z B904 Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling
2025-11-18T07:14:11.3040600Z    --> tests/unit/test_exceptions.py:99:13
2025-11-18T07:14:11.3040659Z     |
2025-11-18T07:14:11.3040747Z  97 |             raise ValueError("Inner error")
2025-11-18T07:14:11.3040823Z  98 |         except ValueError as e:
2025-11-18T07:14:11.3041011Z  99 |             raise DatabaseError("Outer error", context={"operation": "save"}, cause=e)
2025-11-18T07:14:11.3041104Z     |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3041184Z 100 |     except DatabaseError as exc:
2025-11-18T07:14:11.3041276Z 101 |         assert exc.message == "Outer error"
2025-11-18T07:14:11.3041338Z     |
2025-11-18T07:14:11.3041343Z 
2025-11-18T07:14:11.3041440Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3041528Z  --> tests/unit/test_external_ids.py:3:1
2025-11-18T07:14:11.3041588Z   |
2025-11-18T07:14:11.3041741Z 1 |   """Unit tests for external ID storage (Phase A implementation)."""
2025-11-18T07:14:11.3041799Z 2 |
2025-11-18T07:14:11.3041863Z 3 | / import pytest
2025-11-18T07:14:11.3041928Z 4 | | import json
2025-11-18T07:14:11.3041990Z 5 | | import time
2025-11-18T07:14:11.3042055Z 6 | | import aiosqlite
2025-11-18T07:14:11.3042113Z 7 | |
2025-11-18T07:14:11.3042234Z 8 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.3042320Z   | |___________________________________________________^
2025-11-18T07:14:11.3042376Z   |
2025-11-18T07:14:11.3042450Z help: Organize imports
2025-11-18T07:14:11.3042456Z 
2025-11-18T07:14:11.3042527Z W291 Trailing whitespace
2025-11-18T07:14:11.3042621Z   --> tests/unit/test_external_ids.py:45:61
2025-11-18T07:14:11.3042682Z    |
2025-11-18T07:14:11.3042787Z 43 |     async with aiosqlite.connect(test_db) as db:
2025-11-18T07:14:11.3042866Z 44 |         cursor = await db.execute(
2025-11-18T07:14:11.3042983Z 45 |             """SELECT external_message_id, external_user_id, 
2025-11-18T07:14:11.3043073Z    |                                                             ^
2025-11-18T07:14:11.3043211Z 46 |                       reply_to_external_message_id, reply_to_external_user_id,
2025-11-18T07:14:11.3043280Z 47 |                       media
2025-11-18T07:14:11.3043338Z    |
2025-11-18T07:14:11.3043505Z help: Remove trailing whitespace
2025-11-18T07:14:11.3043512Z 
2025-11-18T07:14:11.3043582Z W291 Trailing whitespace
2025-11-18T07:14:11.3043674Z   --> tests/unit/test_external_ids.py:48:29
2025-11-18T07:14:11.3043731Z    |
2025-11-18T07:14:11.3043862Z 46 |                       reply_to_external_message_id, reply_to_external_user_id,
2025-11-18T07:14:11.3044005Z 47 |                       media
2025-11-18T07:14:11.3044077Z 48 |                FROM messages 
2025-11-18T07:14:11.3044141Z    |                             ^
2025-11-18T07:14:11.3044221Z 49 |                WHERE chat_id = ?""",
2025-11-18T07:14:11.3044292Z 50 |             (chat_id,),
2025-11-18T07:14:11.3044354Z    |
2025-11-18T07:14:11.3044442Z help: Remove trailing whitespace
2025-11-18T07:14:11.3044448Z 
2025-11-18T07:14:11.3044529Z W291 Trailing whitespace
2025-11-18T07:14:11.3044623Z    --> tests/unit/test_external_ids.py:171:36
2025-11-18T07:14:11.3044679Z     |
2025-11-18T07:14:11.3044786Z 169 |     async with aiosqlite.connect(test_db) as db:
2025-11-18T07:14:11.3044867Z 170 |         await db.execute(
2025-11-18T07:14:11.3044947Z 171 |             """INSERT INTO messages 
2025-11-18T07:14:11.3045017Z     |                                    ^
2025-11-18T07:14:11.3045141Z 172 |                (chat_id, thread_id, user_id, role, text, media, ts) 
2025-11-18T07:14:11.3045230Z 173 |                VALUES (?, ?, ?, ?, ?, ?, ?)""",
2025-11-18T07:14:11.3045287Z     |
2025-11-18T07:14:11.3045367Z help: Remove trailing whitespace
2025-11-18T07:14:11.3045372Z 
2025-11-18T07:14:11.3045441Z W291 Trailing whitespace
2025-11-18T07:14:11.3045531Z    --> tests/unit/test_external_ids.py:172:68
2025-11-18T07:14:11.3045588Z     |
2025-11-18T07:14:11.3045662Z 170 |         await db.execute(
2025-11-18T07:14:11.3045739Z 171 |             """INSERT INTO messages 
2025-11-18T07:14:11.3045857Z 172 |                (chat_id, thread_id, user_id, role, text, media, ts) 
2025-11-18T07:14:11.3045940Z     |                                                                    ^
2025-11-18T07:14:11.3046026Z 173 |                VALUES (?, ?, ?, ?, ?, ?, ?)""",
2025-11-18T07:14:11.3046090Z 174 |             (
2025-11-18T07:14:11.3046151Z     |
2025-11-18T07:14:11.3046230Z help: Remove trailing whitespace
2025-11-18T07:14:11.3046235Z 
2025-11-18T07:14:11.3046334Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3046452Z  --> tests/unit/test_gemini_empty_tool_response.py:3:1
2025-11-18T07:14:11.3046512Z   |
2025-11-18T07:14:11.3046657Z 1 |   """Test Gemini handling of empty responses after tool calls."""
2025-11-18T07:14:11.3046716Z 2 |
2025-11-18T07:14:11.3046802Z 3 | / from __future__ import annotations
2025-11-18T07:14:11.3046861Z 4 | |
2025-11-18T07:14:11.3046936Z 5 | | from typing import Any
2025-11-18T07:14:11.3047102Z 6 | | import pytest
2025-11-18T07:14:11.3047235Z 7 | | from unittest.mock import AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3047336Z 8 | | from app.services.gemini import GeminiClient
2025-11-18T07:14:11.3047410Z   | |____________________________________________^
2025-11-18T07:14:11.3047473Z   |
2025-11-18T07:14:11.3047544Z help: Organize imports
2025-11-18T07:14:11.3047550Z 
2025-11-18T07:14:11.3047676Z F841 Local variable `result` is assigned to but never used
2025-11-18T07:14:11.3047798Z   --> tests/unit/test_gemini_empty_tool_response.py:97:9
2025-11-18T07:14:11.3047860Z    |
2025-11-18T07:14:11.3048046Z 95 |         mock_invoke.side_effect = [second_response, third_response, fourth_response]
2025-11-18T07:14:11.3048103Z 96 |
2025-11-18T07:14:11.3048199Z 97 |         result = await client._handle_tools(
2025-11-18T07:14:11.3048259Z    |         ^^^^^^
2025-11-18T07:14:11.3048412Z 98 |             initial_contents=[{"role": "user", "parts": [{"text": "Test"}]}],
2025-11-18T07:14:11.3048497Z 99 |             response=first_response,
2025-11-18T07:14:11.3048554Z    |
2025-11-18T07:14:11.3048677Z help: Remove assignment to unused variable `result`
2025-11-18T07:14:11.3048682Z 
2025-11-18T07:14:11.3048780Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3049000Z  --> tests/unit/test_migrations_runner.py:1:1
2025-11-18T07:14:11.3049057Z   |
2025-11-18T07:14:11.3049123Z 1 | / import asyncio
2025-11-18T07:14:11.3049188Z 2 | | import os
2025-11-18T07:14:11.3049266Z 3 | | from pathlib import Path
2025-11-18T07:14:11.3049330Z 4 | | import types
2025-11-18T07:14:11.3049501Z 5 | | import pytest
2025-11-18T07:14:11.3049558Z 6 | |
2025-11-18T07:14:11.3049654Z 7 | | from app.infrastructure import db_utils
2025-11-18T07:14:11.3049725Z   | |_______________________________________^
2025-11-18T07:14:11.3049783Z   |
2025-11-18T07:14:11.3049853Z help: Organize imports
2025-11-18T07:14:11.3049858Z 
2025-11-18T07:14:11.3049936Z F401 [*] `asyncio` imported but unused
2025-11-18T07:14:11.3050030Z  --> tests/unit/test_migrations_runner.py:1:8
2025-11-18T07:14:11.3050088Z   |
2025-11-18T07:14:11.3050151Z 1 | import asyncio
2025-11-18T07:14:11.3050212Z   |        ^^^^^^^
2025-11-18T07:14:11.3050273Z 2 | import os
2025-11-18T07:14:11.3050354Z 3 | from pathlib import Path
2025-11-18T07:14:11.3050410Z   |
2025-11-18T07:14:11.3050500Z help: Remove unused import: `asyncio`
2025-11-18T07:14:11.3050506Z 
2025-11-18T07:14:11.3050582Z F401 [*] `os` imported but unused
2025-11-18T07:14:11.3050671Z  --> tests/unit/test_migrations_runner.py:2:8
2025-11-18T07:14:11.3050733Z   |
2025-11-18T07:14:11.3050795Z 1 | import asyncio
2025-11-18T07:14:11.3050856Z 2 | import os
2025-11-18T07:14:11.3050915Z   |        ^^
2025-11-18T07:14:11.3050991Z 3 | from pathlib import Path
2025-11-18T07:14:11.3051054Z 4 | import types
2025-11-18T07:14:11.3051111Z   |
2025-11-18T07:14:11.3051194Z help: Remove unused import: `os`
2025-11-18T07:14:11.3051200Z 
2025-11-18T07:14:11.3051352Z F841 Local variable `original_apply` is assigned to but never used
2025-11-18T07:14:11.3051450Z   --> tests/unit/test_migrations_runner.py:60:5
2025-11-18T07:14:11.3051509Z    |
2025-11-18T07:14:11.3051632Z 59 |     # Wrap original function to override directory search
2025-11-18T07:14:11.3051733Z 60 |     original_apply = db_utils.apply_migrations
2025-11-18T07:14:11.3051800Z    |     ^^^^^^^^^^^^^^
2025-11-18T07:14:11.3051860Z 61 |
2025-11-18T07:14:11.3051953Z 62 |     async def _apply_with_tmp_dir(url: str):
2025-11-18T07:14:11.3052010Z    |
2025-11-18T07:14:11.3052147Z help: Remove assignment to unused variable `original_apply`
2025-11-18T07:14:11.3052156Z 
2025-11-18T07:14:11.3052253Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3052334Z  --> tests/unit/test_migrator.py:3:1
2025-11-18T07:14:11.3052391Z   |
2025-11-18T07:14:11.3052480Z 1 |   """Unit tests for database migrator."""
2025-11-18T07:14:11.3052536Z 2 |
2025-11-18T07:14:11.3052603Z 3 | / import pytest
2025-11-18T07:14:11.3052683Z 4 | | from pathlib import Path
2025-11-18T07:14:11.3052751Z 5 | | import aiosqlite
2025-11-18T07:14:11.3052987Z 6 | | from app.infrastructure.database.migrator import DatabaseMigrator, Migration
2025-11-18T07:14:11.3053107Z   | |____________________________________________________________________________^
2025-11-18T07:14:11.3053167Z   |
2025-11-18T07:14:11.3053236Z help: Organize imports
2025-11-18T07:14:11.3053241Z 
2025-11-18T07:14:11.3053333Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.3053418Z  --> tests/unit/test_migrator.py:4:21
2025-11-18T07:14:11.3053474Z   |
2025-11-18T07:14:11.3053542Z 3 | import pytest
2025-11-18T07:14:11.3053621Z 4 | from pathlib import Path
2025-11-18T07:14:11.3053686Z   |                     ^^^^
2025-11-18T07:14:11.3053752Z 5 | import aiosqlite
2025-11-18T07:14:11.3053955Z 6 | from app.infrastructure.database.migrator import DatabaseMigrator, Migration
2025-11-18T07:14:11.3054014Z   |
2025-11-18T07:14:11.3054108Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.3054114Z 
2025-11-18T07:14:11.3054209Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3054348Z  --> tests/unit/test_multi_level_context_improvements.py:5:1
2025-11-18T07:14:11.3054404Z   |
2025-11-18T07:14:11.3054462Z 3 |   """
2025-11-18T07:14:11.3054606Z 4 |
2025-11-18T07:14:11.3054673Z 5 | / import pytest
2025-11-18T07:14:11.3054754Z 6 | | from unittest.mock import Mock
2025-11-18T07:14:11.3054811Z 7 | |
2025-11-18T07:14:11.3055013Z 8 | | from app.services.context.multi_level_context import MultiLevelContextManager
2025-11-18T07:14:11.3055131Z   | |_____________________________________________________________________________^
2025-11-18T07:14:11.3055295Z   |
2025-11-18T07:14:11.3058969Z help: Organize imports
2025-11-18T07:14:11.3058993Z 
2025-11-18T07:14:11.3059132Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3059262Z   --> tests/unit/test_multi_level_context_media.py:8:1
2025-11-18T07:14:11.3059320Z    |
2025-11-18T07:14:11.3059386Z  6 |   """
2025-11-18T07:14:11.3059442Z  7 |
2025-11-18T07:14:11.3059514Z  8 | / import pytest
2025-11-18T07:14:11.3059615Z  9 | | from unittest.mock import MagicMock
2025-11-18T07:14:11.3059829Z 10 | | from app.services.context.multi_level_context import MultiLevelContextManager
2025-11-18T07:14:11.3059956Z    | |_____________________________________________________________________________^
2025-11-18T07:14:11.3060015Z    |
2025-11-18T07:14:11.3060092Z help: Organize imports
2025-11-18T07:14:11.3060098Z 
2025-11-18T07:14:11.3060182Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3060304Z  --> tests/unit/test_persona_loader_timestamp.py:3:8
2025-11-18T07:14:11.3060367Z   |
2025-11-18T07:14:11.3060517Z 1 | """Tests for PersonaLoader timestamp variable substitution."""
2025-11-18T07:14:11.3060574Z 2 |
2025-11-18T07:14:11.3060643Z 3 | import pytest
2025-11-18T07:14:11.3060703Z   |        ^^^^^^
2025-11-18T07:14:11.3060758Z 4 |
2025-11-18T07:14:11.3060894Z 5 | from app.services.persona.loader import PersonaLoader
2025-11-18T07:14:11.3060953Z   |
2025-11-18T07:14:11.3061038Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3061044Z 
2025-11-18T07:14:11.3061126Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3061246Z   --> tests/unit/test_persona_loader_timestamp.py:11:1
2025-11-18T07:14:11.3061306Z    |
2025-11-18T07:14:11.3061451Z  9 |     """Test that {timestamp} variable is substituted correctly."""
2025-11-18T07:14:11.3061533Z 10 |     loader = PersonaLoader()
2025-11-18T07:14:11.3061592Z 11 |     
2025-11-18T07:14:11.3061648Z    | ^^^^
2025-11-18T07:14:11.3061758Z 12 |     # Create a test prompt with timestamp variable
2025-11-18T07:14:11.3061930Z 13 |     loader.persona.system_prompt = "The current time is {timestamp}."
2025-11-18T07:14:11.3061985Z    |
2025-11-18T07:14:11.3062072Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3062077Z 
2025-11-18T07:14:11.3062158Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3062266Z   --> tests/unit/test_persona_loader_timestamp.py:14:1
2025-11-18T07:14:11.3062322Z    |
2025-11-18T07:14:11.3062424Z 12 |     # Create a test prompt with timestamp variable
2025-11-18T07:14:11.3062579Z 13 |     loader.persona.system_prompt = "The current time is {timestamp}."
2025-11-18T07:14:11.3062635Z 14 |     
2025-11-18T07:14:11.3062696Z    | ^^^^
2025-11-18T07:14:11.3062778Z 15 |     # Get prompt with current_time
2025-11-18T07:14:11.3062894Z 16 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3062950Z    |
2025-11-18T07:14:11.3063035Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3063041Z 
2025-11-18T07:14:11.3063121Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3063231Z   --> tests/unit/test_persona_loader_timestamp.py:18:1
2025-11-18T07:14:11.3063289Z    |
2025-11-18T07:14:11.3063397Z 16 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3063539Z 17 |     result = loader.get_system_prompt(current_time=current_time)
2025-11-18T07:14:11.3063595Z 18 |     
2025-11-18T07:14:11.3063654Z    | ^^^^
2025-11-18T07:14:11.3063740Z 19 |     assert "{timestamp}" not in result
2025-11-18T07:14:11.3063819Z 20 |     assert current_time in result
2025-11-18T07:14:11.3063877Z    |
2025-11-18T07:14:11.3063958Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3064118Z 
2025-11-18T07:14:11.3064205Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3064321Z   --> tests/unit/test_persona_loader_timestamp.py:27:1
2025-11-18T07:14:11.3064381Z    |
2025-11-18T07:14:11.3064538Z 25 |     """Test that {current_year} variable is extracted and substituted."""
2025-11-18T07:14:11.3064720Z 26 |     loader = PersonaLoader()
2025-11-18T07:14:11.3064781Z 27 |     
2025-11-18T07:14:11.3064838Z    | ^^^^
2025-11-18T07:14:11.3064949Z 28 |     # Create a test prompt with current_year variable
2025-11-18T07:14:11.3065098Z 29 |     loader.persona.system_prompt = "The year is {current_year}."
2025-11-18T07:14:11.3065154Z    |
2025-11-18T07:14:11.3065240Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3065246Z 
2025-11-18T07:14:11.3065324Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3065435Z   --> tests/unit/test_persona_loader_timestamp.py:30:1
2025-11-18T07:14:11.3065490Z    |
2025-11-18T07:14:11.3065596Z 28 |     # Create a test prompt with current_year variable
2025-11-18T07:14:11.3065747Z 29 |     loader.persona.system_prompt = "The year is {current_year}."
2025-11-18T07:14:11.3065804Z 30 |     
2025-11-18T07:14:11.3065860Z    | ^^^^
2025-11-18T07:14:11.3065942Z 31 |     # Get prompt with current_time
2025-11-18T07:14:11.3066055Z 32 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3066116Z    |
2025-11-18T07:14:11.3066199Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3066204Z 
2025-11-18T07:14:11.3066284Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3066393Z   --> tests/unit/test_persona_loader_timestamp.py:34:1
2025-11-18T07:14:11.3066450Z    |
2025-11-18T07:14:11.3066563Z 32 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3066697Z 33 |     result = loader.get_system_prompt(current_time=current_time)
2025-11-18T07:14:11.3066753Z 34 |     
2025-11-18T07:14:11.3066808Z    | ^^^^
2025-11-18T07:14:11.3066901Z 35 |     assert "{current_year}" not in result
2025-11-18T07:14:11.3067100Z 36 |     assert "2025" in result
2025-11-18T07:14:11.3067161Z    |
2025-11-18T07:14:11.3067250Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3067256Z 
2025-11-18T07:14:11.3067334Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3067442Z   --> tests/unit/test_persona_loader_timestamp.py:43:1
2025-11-18T07:14:11.3067504Z    |
2025-11-18T07:14:11.3067660Z 41 |     """Test that {current_date} variable is extracted and substituted."""
2025-11-18T07:14:11.3067737Z 42 |     loader = PersonaLoader()
2025-11-18T07:14:11.3067794Z 43 |     
2025-11-18T07:14:11.3067855Z    | ^^^^
2025-11-18T07:14:11.3067962Z 44 |     # Create a test prompt with current_date variable
2025-11-18T07:14:11.3068099Z 45 |     loader.persona.system_prompt = "Today is {current_date}."
2025-11-18T07:14:11.3068158Z    |
2025-11-18T07:14:11.3068242Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3068248Z 
2025-11-18T07:14:11.3068326Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3068438Z   --> tests/unit/test_persona_loader_timestamp.py:46:1
2025-11-18T07:14:11.3068494Z    |
2025-11-18T07:14:11.3068595Z 44 |     # Create a test prompt with current_date variable
2025-11-18T07:14:11.3068727Z 45 |     loader.persona.system_prompt = "Today is {current_date}."
2025-11-18T07:14:11.3068789Z 46 |     
2025-11-18T07:14:11.3068846Z    | ^^^^
2025-11-18T07:14:11.3068924Z 47 |     # Get prompt with current_time
2025-11-18T07:14:11.3069039Z 48 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3069094Z    |
2025-11-18T07:14:11.3069177Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3069183Z 
2025-11-18T07:14:11.3069261Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3069366Z   --> tests/unit/test_persona_loader_timestamp.py:50:1
2025-11-18T07:14:11.3069423Z    |
2025-11-18T07:14:11.3069529Z 48 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3069668Z 49 |     result = loader.get_system_prompt(current_time=current_time)
2025-11-18T07:14:11.3069846Z 50 |     
2025-11-18T07:14:11.3069903Z    | ^^^^
2025-11-18T07:14:11.3069992Z 51 |     assert "{current_date}" not in result
2025-11-18T07:14:11.3070087Z 52 |     assert "Monday, January 15, 2025" in result
2025-11-18T07:14:11.3070144Z    |
2025-11-18T07:14:11.3070326Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3070335Z 
2025-11-18T07:14:11.3070411Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3070517Z   --> tests/unit/test_persona_loader_timestamp.py:59:1
2025-11-18T07:14:11.3070573Z    |
2025-11-18T07:14:11.3070693Z 57 |     """Test that all timestamp variables work together."""
2025-11-18T07:14:11.3070767Z 58 |     loader = PersonaLoader()
2025-11-18T07:14:11.3070823Z 59 |     
2025-11-18T07:14:11.3070880Z    | ^^^^
2025-11-18T07:14:11.3070972Z 60 |     # Create a test prompt with all variables
2025-11-18T07:14:11.3071061Z 61 |     loader.persona.system_prompt = (
2025-11-18T07:14:11.3071117Z    |
2025-11-18T07:14:11.3071207Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3071213Z 
2025-11-18T07:14:11.3071289Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3071396Z   --> tests/unit/test_persona_loader_timestamp.py:64:1
2025-11-18T07:14:11.3071455Z    |
2025-11-18T07:14:11.3071617Z 62 |         "Timestamp: {timestamp}, Year: {current_year}, Date: {current_date}."
2025-11-18T07:14:11.3071679Z 63 |     )
2025-11-18T07:14:11.3071738Z 64 |     
2025-11-18T07:14:11.3071794Z    | ^^^^
2025-11-18T07:14:11.3071872Z 65 |     # Get prompt with current_time
2025-11-18T07:14:11.3071981Z 66 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3072039Z    |
2025-11-18T07:14:11.3072120Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3072126Z 
2025-11-18T07:14:11.3072203Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3072313Z   --> tests/unit/test_persona_loader_timestamp.py:68:1
2025-11-18T07:14:11.3072369Z    |
2025-11-18T07:14:11.3072475Z 66 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3072614Z 67 |     result = loader.get_system_prompt(current_time=current_time)
2025-11-18T07:14:11.3072672Z 68 |     
2025-11-18T07:14:11.3072728Z    | ^^^^
2025-11-18T07:14:11.3072813Z 69 |     assert "{timestamp}" not in result
2025-11-18T07:14:11.3072905Z 70 |     assert "{current_year}" not in result
2025-11-18T07:14:11.3072961Z    |
2025-11-18T07:14:11.3073050Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3073056Z 
2025-11-18T07:14:11.3073136Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3073243Z   --> tests/unit/test_persona_loader_timestamp.py:80:1
2025-11-18T07:14:11.3073300Z    |
2025-11-18T07:14:11.3073493Z 78 |     """Test that fallback timestamp is generated when current_time not provided."""
2025-11-18T07:14:11.3073572Z 79 |     loader = PersonaLoader()
2025-11-18T07:14:11.3073630Z 80 |     
2025-11-18T07:14:11.3073686Z    | ^^^^
2025-11-18T07:14:11.3073797Z 81 |     # Create a test prompt with timestamp variable
2025-11-18T07:14:11.3073966Z 82 |     loader.persona.system_prompt = "The current time is {timestamp}."
2025-11-18T07:14:11.3074021Z    |
2025-11-18T07:14:11.3074107Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3074112Z 
2025-11-18T07:14:11.3074190Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3074302Z   --> tests/unit/test_persona_loader_timestamp.py:83:1
2025-11-18T07:14:11.3074357Z    |
2025-11-18T07:14:11.3074460Z 81 |     # Create a test prompt with timestamp variable
2025-11-18T07:14:11.3074618Z 82 |     loader.persona.system_prompt = "The current time is {timestamp}."
2025-11-18T07:14:11.3074676Z 83 |     
2025-11-18T07:14:11.3074736Z    | ^^^^
2025-11-18T07:14:11.3074870Z 84 |     # Get prompt without current_time (should generate fallback)
2025-11-18T07:14:11.3074961Z 85 |     result = loader.get_system_prompt()
2025-11-18T07:14:11.3075017Z    |
2025-11-18T07:14:11.3075104Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3075109Z 
2025-11-18T07:14:11.3075272Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3075381Z   --> tests/unit/test_persona_loader_timestamp.py:86:1
2025-11-18T07:14:11.3075440Z    |
2025-11-18T07:14:11.3075570Z 84 |     # Get prompt without current_time (should generate fallback)
2025-11-18T07:14:11.3075654Z 85 |     result = loader.get_system_prompt()
2025-11-18T07:14:11.3075789Z 86 |     
2025-11-18T07:14:11.3075844Z    | ^^^^
2025-11-18T07:14:11.3075928Z 87 |     assert "{timestamp}" not in result
2025-11-18T07:14:11.3076019Z 88 |     assert "The current time is" in result
2025-11-18T07:14:11.3076080Z    |
2025-11-18T07:14:11.3076162Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3076168Z 
2025-11-18T07:14:11.3076245Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3076354Z   --> tests/unit/test_persona_loader_timestamp.py:96:1
2025-11-18T07:14:11.3076410Z    |
2025-11-18T07:14:11.3076564Z 94 |     """Test that custom variables passed via kwargs are substituted."""
2025-11-18T07:14:11.3076647Z 95 |     loader = PersonaLoader()
2025-11-18T07:14:11.3076703Z 96 |     
2025-11-18T07:14:11.3076759Z    | ^^^^
2025-11-18T07:14:11.3076855Z 97 |     # Create a test prompt with custom variable
2025-11-18T07:14:11.3077141Z 98 |     loader.persona.system_prompt = "Hello {name}, the year is {current_year}."
2025-11-18T07:14:11.3077202Z    |
2025-11-18T07:14:11.3077284Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3077290Z 
2025-11-18T07:14:11.3077371Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3077481Z    --> tests/unit/test_persona_loader_timestamp.py:99:1
2025-11-18T07:14:11.3077538Z     |
2025-11-18T07:14:11.3077641Z  97 |     # Create a test prompt with custom variable
2025-11-18T07:14:11.3077823Z  98 |     loader.persona.system_prompt = "Hello {name}, the year is {current_year}."
2025-11-18T07:14:11.3077882Z  99 |     
2025-11-18T07:14:11.3077938Z     | ^^^^
2025-11-18T07:14:11.3078068Z 100 |     # Get prompt with both current_time and custom variable
2025-11-18T07:14:11.3078190Z 101 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3078247Z     |
2025-11-18T07:14:11.3078333Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3078338Z 
2025-11-18T07:14:11.3078415Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3078534Z    --> tests/unit/test_persona_loader_timestamp.py:103:1
2025-11-18T07:14:11.3078595Z     |
2025-11-18T07:14:11.3078709Z 101 |     current_time = "Monday, January 15, 2025 at 14:30:45"
2025-11-18T07:14:11.3078904Z 102 |     result = loader.get_system_prompt(current_time=current_time, name="TestUser")
2025-11-18T07:14:11.3078961Z 103 |     
2025-11-18T07:14:11.3079019Z     | ^^^^
2025-11-18T07:14:11.3079097Z 104 |     assert "{name}" not in result
2025-11-18T07:14:11.3079188Z 105 |     assert "{current_year}" not in result
2025-11-18T07:14:11.3079249Z     |
2025-11-18T07:14:11.3079332Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3079338Z 
2025-11-18T07:14:11.3079414Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3079538Z    --> tests/unit/test_persona_loader_timestamp.py:113:1
2025-11-18T07:14:11.3079595Z     |
2025-11-18T07:14:11.3079733Z 111 |     """Test that prompt without variables is returned as-is."""
2025-11-18T07:14:11.3079811Z 112 |     loader = PersonaLoader()
2025-11-18T07:14:11.3079875Z 113 |     
2025-11-18T07:14:11.3079931Z     | ^^^^
2025-11-18T07:14:11.3080028Z 114 |     # Create a test prompt without variables
2025-11-18T07:14:11.3080185Z 115 |     original_prompt = "This is a plain prompt with no variables."
2025-11-18T07:14:11.3080241Z     |
2025-11-18T07:14:11.3080327Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3080332Z 
2025-11-18T07:14:11.3080409Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3080529Z    --> tests/unit/test_persona_loader_timestamp.py:117:1
2025-11-18T07:14:11.3080585Z     |
2025-11-18T07:14:11.3080730Z 115 |     original_prompt = "This is a plain prompt with no variables."
2025-11-18T07:14:11.3080849Z 116 |     loader.persona.system_prompt = original_prompt
2025-11-18T07:14:11.3081024Z 117 |     
2025-11-18T07:14:11.3081081Z     | ^^^^
2025-11-18T07:14:11.3081149Z 118 |     # Get prompt
2025-11-18T07:14:11.3081363Z 119 |     result = loader.get_system_prompt(current_time="Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.3081520Z     |
2025-11-18T07:14:11.3081606Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3081611Z 
2025-11-18T07:14:11.3081691Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3081807Z    --> tests/unit/test_persona_loader_timestamp.py:120:1
2025-11-18T07:14:11.3081863Z     |
2025-11-18T07:14:11.3081930Z 118 |     # Get prompt
2025-11-18T07:14:11.3082140Z 119 |     result = loader.get_system_prompt(current_time="Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.3082197Z 120 |     
2025-11-18T07:14:11.3082256Z     | ^^^^
2025-11-18T07:14:11.3082343Z 121 |     assert result == original_prompt
2025-11-18T07:14:11.3082401Z     |
2025-11-18T07:14:11.3082488Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3082495Z 
2025-11-18T07:14:11.3082575Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3082687Z    --> tests/unit/test_persona_loader_timestamp.py:127:1
2025-11-18T07:14:11.3082744Z     |
2025-11-18T07:14:11.3082881Z 125 |     """Test that missing variables are handled gracefully."""
2025-11-18T07:14:11.3082962Z 126 |     loader = PersonaLoader()
2025-11-18T07:14:11.3083026Z 127 |     
2025-11-18T07:14:11.3083082Z     | ^^^^
2025-11-18T07:14:11.3083191Z 128 |     # Create a test prompt with undefined variable
2025-11-18T07:14:11.3083331Z 129 |     loader.persona.system_prompt = "Hello {undefined_var}."
2025-11-18T07:14:11.3083387Z     |
2025-11-18T07:14:11.3083475Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3083481Z 
2025-11-18T07:14:11.3083558Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3083667Z    --> tests/unit/test_persona_loader_timestamp.py:130:1
2025-11-18T07:14:11.3083728Z     |
2025-11-18T07:14:11.3083834Z 128 |     # Create a test prompt with undefined variable
2025-11-18T07:14:11.3083967Z 129 |     loader.persona.system_prompt = "Hello {undefined_var}."
2025-11-18T07:14:11.3084024Z 130 |     
2025-11-18T07:14:11.3084083Z     | ^^^^
2025-11-18T07:14:11.3084192Z 131 |     # Get prompt - should log warning but not crash
2025-11-18T07:14:11.3084401Z 132 |     result = loader.get_system_prompt(current_time="Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.3084460Z     |
2025-11-18T07:14:11.3084544Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3084550Z 
2025-11-18T07:14:11.3084625Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3084738Z    --> tests/unit/test_persona_loader_timestamp.py:133:1
2025-11-18T07:14:11.3084794Z     |
2025-11-18T07:14:11.3084900Z 131 |     # Get prompt - should log warning but not crash
2025-11-18T07:14:11.3085105Z 132 |     result = loader.get_system_prompt(current_time="Monday, January 15, 2025 at 14:30:45")
2025-11-18T07:14:11.3085168Z 133 |     
2025-11-18T07:14:11.3085224Z     | ^^^^
2025-11-18T07:14:11.3085330Z 134 |     # Should leave placeholder or handle gracefully
2025-11-18T07:14:11.3085516Z 135 |     # The exact behavior depends on Python's format() - it will raise KeyError
2025-11-18T07:14:11.3085574Z     |
2025-11-18T07:14:11.3085658Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3085666Z 
2025-11-18T07:14:11.3085772Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3085887Z   --> tests/unit/test_placeholder_sanitization.py:8:1
2025-11-18T07:14:11.3085943Z    |
2025-11-18T07:14:11.3085999Z  6 |   """
2025-11-18T07:14:11.3086061Z  7 |
2025-11-18T07:14:11.3086138Z  8 | / import pytest
2025-11-18T07:14:11.3086247Z  9 | |
2025-11-18T07:14:11.3086454Z 10 | | from app.services.conversation_formatter import (
2025-11-18T07:14:11.3086576Z 11 | |     sanitize_placeholder_text,
2025-11-18T07:14:11.3086689Z 12 | |     format_message_compact,
2025-11-18T07:14:11.3086775Z 13 | | )
2025-11-18T07:14:11.3087162Z    | |_^
2025-11-18T07:14:11.3087259Z    |
2025-11-18T07:14:11.3087372Z help: Organize imports
2025-11-18T07:14:11.3087381Z 
2025-11-18T07:14:11.3087515Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3087741Z   --> tests/unit/test_placeholder_sanitization.py:8:8
2025-11-18T07:14:11.3087832Z    |
2025-11-18T07:14:11.3088097Z  6 | """
2025-11-18T07:14:11.3088194Z  7 |
2025-11-18T07:14:11.3088338Z  8 | import pytest
2025-11-18T07:14:11.3088444Z    |        ^^^^^^
2025-11-18T07:14:11.3088564Z  9 |
2025-11-18T07:14:11.3088752Z 10 | from app.services.conversation_formatter import (
2025-11-18T07:14:11.3088834Z    |
2025-11-18T07:14:11.3088964Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3088972Z 
2025-11-18T07:14:11.3089125Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3089261Z  --> tests/unit/test_pronouns_tool.py:1:1
2025-11-18T07:14:11.3089361Z   |
2025-11-18T07:14:11.3089499Z 1 | / import json
2025-11-18T07:14:11.3089624Z 2 | |
2025-11-18T07:14:11.3089773Z 3 | | import pytest
2025-11-18T07:14:11.3089906Z 4 | |
2025-11-18T07:14:11.3090184Z 5 | | from app.services.user_profile import UserProfileStore
2025-11-18T07:14:11.3090419Z 6 | | from app.services.tools.memory_tools import set_pronouns_tool
2025-11-18T07:14:11.3090618Z   | |_____________________________________________________________^
2025-11-18T07:14:11.3090758Z   |
2025-11-18T07:14:11.3090907Z help: Organize imports
2025-11-18T07:14:11.3090919Z 
2025-11-18T07:14:11.3091105Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3091289Z   --> tests/unit/test_reply_context.py:8:1
2025-11-18T07:14:11.3091415Z    |
2025-11-18T07:14:11.3091515Z  6 |   """
2025-11-18T07:14:11.3091637Z  7 |
2025-11-18T07:14:11.3091752Z  8 | / import pytest
2025-11-18T07:14:11.3091980Z  9 | | from unittest.mock import Mock, AsyncMock, MagicMock
2025-11-18T07:14:11.3092174Z 10 | | from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3092303Z 11 | | from datetime import datetime
2025-11-18T07:14:11.3092405Z 12 | |
2025-11-18T07:14:11.3092617Z 13 | | from app.services.conversation_formatter import (
2025-11-18T07:14:11.3092747Z 14 | |     format_message_compact,
2025-11-18T07:14:11.3092895Z 15 | |     format_history_compact,
2025-11-18T07:14:11.3093018Z 16 | | )
2025-11-18T07:14:11.3093141Z    | |_^
2025-11-18T07:14:11.3093245Z    |
2025-11-18T07:14:11.3093355Z help: Organize imports
2025-11-18T07:14:11.3093363Z 
2025-11-18T07:14:11.3093537Z F401 [*] `unittest.mock.AsyncMock` imported but unused
2025-11-18T07:14:11.3093688Z   --> tests/unit/test_reply_context.py:9:33
2025-11-18T07:14:11.3093773Z    |
2025-11-18T07:14:11.3093874Z  8 | import pytest
2025-11-18T07:14:11.3094060Z  9 | from unittest.mock import Mock, AsyncMock, MagicMock
2025-11-18T07:14:11.3094188Z    |                                 ^^^^^^^^^
2025-11-18T07:14:11.3094356Z 10 | from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3094479Z 11 | from datetime import datetime
2025-11-18T07:14:11.3094576Z    |
2025-11-18T07:14:11.3094709Z help: Remove unused import
2025-11-18T07:14:11.3094720Z 
2025-11-18T07:14:11.3094909Z F401 [*] `unittest.mock.MagicMock` imported but unused
2025-11-18T07:14:11.3095077Z   --> tests/unit/test_reply_context.py:9:44
2025-11-18T07:14:11.3095172Z    |
2025-11-18T07:14:11.3095282Z  8 | import pytest
2025-11-18T07:14:11.3095504Z  9 | from unittest.mock import Mock, AsyncMock, MagicMock
2025-11-18T07:14:11.3095642Z    |                                            ^^^^^^^^^
2025-11-18T07:14:11.3095821Z 10 | from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3095957Z 11 | from datetime import datetime
2025-11-18T07:14:11.3096059Z    |
2025-11-18T07:14:11.3096191Z help: Remove unused import
2025-11-18T07:14:11.3096199Z 
2025-11-18T07:14:11.3096364Z F401 [*] `aiogram.types.Chat` imported but unused
2025-11-18T07:14:11.3096523Z   --> tests/unit/test_reply_context.py:10:42
2025-11-18T07:14:11.3096617Z    |
2025-11-18T07:14:11.3096720Z  8 | import pytest
2025-11-18T07:14:11.3096916Z  9 | from unittest.mock import Mock, AsyncMock, MagicMock
2025-11-18T07:14:11.3097552Z 10 | from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3097674Z    |                                          ^^^^
2025-11-18T07:14:11.3097805Z 11 | from datetime import datetime
2025-11-18T07:14:11.3097903Z    |
2025-11-18T07:14:11.3098083Z help: Remove unused import: `aiogram.types.Chat`
2025-11-18T07:14:11.3098250Z 
2025-11-18T07:14:11.3098506Z F841 Local variable `reply_context` is assigned to but never used
2025-11-18T07:14:11.3098680Z    --> tests/unit/test_reply_context.py:138:9
2025-11-18T07:14:11.3098785Z     |
2025-11-18T07:14:11.3098915Z 137 |         # Mock a reply_context
2025-11-18T07:14:11.3099038Z 138 |         reply_context = {
2025-11-18T07:14:11.3099151Z     |         ^^^^^^^^^^^^^
2025-11-18T07:14:11.3099328Z 139 |             "text": "What is the capital of Ukraine?",
2025-11-18T07:14:11.3099446Z 140 |             "name": "Alice",
2025-11-18T07:14:11.3099548Z     |
2025-11-18T07:14:11.3099778Z help: Remove assignment to unused variable `reply_context`
2025-11-18T07:14:11.3099795Z 
2025-11-18T07:14:11.3100044Z F841 Local variable `reply_context` is assigned to but never used
2025-11-18T07:14:11.3100209Z    --> tests/unit/test_reply_context.py:245:9
2025-11-18T07:14:11.3100311Z     |
2025-11-18T07:14:11.3100465Z 244 |         # Mock reply_context_for_history
2025-11-18T07:14:11.3100589Z 245 |         reply_context = {
2025-11-18T07:14:11.3100693Z     |         ^^^^^^^^^^^^^
2025-11-18T07:14:11.3100812Z 246 |             "message_id": 1,
2025-11-18T07:14:11.3100934Z 247 |             "user_id": 123,
2025-11-18T07:14:11.3101035Z     |
2025-11-18T07:14:11.3101264Z help: Remove assignment to unused variable `reply_context`
2025-11-18T07:14:11.3101274Z 
2025-11-18T07:14:11.3101440Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3101590Z  --> tests/unit/test_repositories.py:3:1
2025-11-18T07:14:11.3101686Z   |
2025-11-18T07:14:11.3101845Z 1 |   """Unit tests for repository base class."""
2025-11-18T07:14:11.3101958Z 2 |
2025-11-18T07:14:11.3102077Z 3 | / import pytest
2025-11-18T07:14:11.3102201Z 4 | | from pathlib import Path
2025-11-18T07:14:11.3102337Z 5 | | from dataclasses import dataclass
2025-11-18T07:14:11.3102515Z 6 | | from app.repositories.base import Repository
2025-11-18T07:14:11.3102684Z 7 | | from app.core.exceptions import DatabaseError
2025-11-18T07:14:11.3102830Z   | |_____________________________________________^
2025-11-18T07:14:11.3102978Z   |
2025-11-18T07:14:11.3103115Z help: Organize imports
2025-11-18T07:14:11.3103127Z 
2025-11-18T07:14:11.3103287Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.3103458Z  --> tests/unit/test_repositories.py:4:21
2025-11-18T07:14:11.3103573Z   |
2025-11-18T07:14:11.3103698Z 3 | import pytest
2025-11-18T07:14:11.3103833Z 4 | from pathlib import Path
2025-11-18T07:14:11.3103950Z   |                     ^^^^
2025-11-18T07:14:11.3104106Z 5 | from dataclasses import dataclass
2025-11-18T07:14:11.3104290Z 6 | from app.repositories.base import Repository
2025-11-18T07:14:11.3104412Z   |
2025-11-18T07:14:11.3104590Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.3104602Z 
2025-11-18T07:14:11.3104826Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3105010Z  --> tests/unit/test_response_cleaning.py:8:1
2025-11-18T07:14:11.3105129Z   |
2025-11-18T07:14:11.3105236Z 6 |   """
2025-11-18T07:14:11.3105338Z 7 |
2025-11-18T07:14:11.3105452Z 8 | / import pytest
2025-11-18T07:14:11.3105666Z 9 | | from app.handlers.chat import _clean_response_text
2025-11-18T07:14:11.3105826Z   | |__________________________________________________^
2025-11-18T07:14:11.3105933Z   |
2025-11-18T07:14:11.3106067Z help: Organize imports
2025-11-18T07:14:11.3106077Z 
2025-11-18T07:14:11.3106224Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3106399Z  --> tests/unit/test_response_cleaning.py:8:8
2025-11-18T07:14:11.3106509Z   |
2025-11-18T07:14:11.3106618Z 6 | """
2025-11-18T07:14:11.3106722Z 7 |
2025-11-18T07:14:11.3107267Z 8 | import pytest
2025-11-18T07:14:11.3107394Z   |        ^^^^^^
2025-11-18T07:14:11.3107624Z 9 | from app.handlers.chat import _clean_response_text
2025-11-18T07:14:11.3107739Z   |
2025-11-18T07:14:11.3107898Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3107910Z 
2025-11-18T07:14:11.3108091Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3108475Z   --> tests/unit/test_retention.py:3:1
2025-11-18T07:14:11.3108579Z    |
2025-11-18T07:14:11.3108790Z  1 |   """Unit tests for retention and pruning logic."""
2025-11-18T07:14:11.3108894Z  2 |
2025-11-18T07:14:11.3109018Z  3 | / import pytest
2025-11-18T07:14:11.3109157Z  4 | | import pytest_asyncio
2025-11-18T07:14:11.3109276Z  5 | | import time
2025-11-18T07:14:11.3109389Z  6 | | import json
2025-11-18T07:14:11.3109528Z  7 | | from pathlib import Path
2025-11-18T07:14:11.3109662Z  8 | | import aiosqlite
2025-11-18T07:14:11.3109767Z  9 | |
2025-11-18T07:14:11.3109993Z 10 | | from app.services.context_store import ContextStore
2025-11-18T07:14:11.3110167Z    | |___________________________________________________^
2025-11-18T07:14:11.3110275Z    |
2025-11-18T07:14:11.3110412Z help: Organize imports
2025-11-18T07:14:11.3110424Z 
2025-11-18T07:14:11.3110608Z F401 [*] `pytest_asyncio` imported but unused
2025-11-18T07:14:11.3110767Z  --> tests/unit/test_retention.py:4:8
2025-11-18T07:14:11.3110878Z   |
2025-11-18T07:14:11.3111001Z 3 | import pytest
2025-11-18T07:14:11.3111147Z 4 | import pytest_asyncio
2025-11-18T07:14:11.3111266Z   |        ^^^^^^^^^^^^^^
2025-11-18T07:14:11.3111384Z 5 | import time
2025-11-18T07:14:11.3111494Z 6 | import json
2025-11-18T07:14:11.3111596Z   |
2025-11-18T07:14:11.3111776Z help: Remove unused import: `pytest_asyncio`
2025-11-18T07:14:11.3111785Z 
2025-11-18T07:14:11.3111950Z F401 [*] `pathlib.Path` imported but unused
2025-11-18T07:14:11.3112111Z  --> tests/unit/test_retention.py:7:21
2025-11-18T07:14:11.3112217Z   |
2025-11-18T07:14:11.3112336Z 5 | import time
2025-11-18T07:14:11.3112457Z 6 | import json
2025-11-18T07:14:11.3112609Z 7 | from pathlib import Path
2025-11-18T07:14:11.3112722Z   |                     ^^^^
2025-11-18T07:14:11.3112827Z 8 | import aiosqlite
2025-11-18T07:14:11.3112920Z   |
2025-11-18T07:14:11.3113088Z help: Remove unused import: `pathlib.Path`
2025-11-18T07:14:11.3113101Z 
2025-11-18T07:14:11.3113255Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3113442Z  --> tests/unit/test_telegram_formatting.py:3:8
2025-11-18T07:14:11.3113542Z   |
2025-11-18T07:14:11.3113742Z 1 | """Tests for Telegram HTML formatting utilities."""
2025-11-18T07:14:11.3113847Z 2 |
2025-11-18T07:14:11.3113962Z 3 | import pytest
2025-11-18T07:14:11.3114064Z   |        ^^^^^^
2025-11-18T07:14:11.3114164Z   |
2025-11-18T07:14:11.3114314Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3114323Z 
2025-11-18T07:14:11.3114502Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3114672Z  --> tests/unit/test_text_processing.py:5:1
2025-11-18T07:14:11.3114781Z   |
2025-11-18T07:14:11.3114892Z 3 |   """
2025-11-18T07:14:11.3114989Z 4 |
2025-11-18T07:14:11.3115108Z 5 | / import pytest
2025-11-18T07:14:11.3115222Z 6 | |
2025-11-18T07:14:11.3115564Z 7 | | from app.utils.text_processing import extract_keywords, cosine_similarity
2025-11-18T07:14:11.3115829Z   | |_________________________________________________________________________^
2025-11-18T07:14:11.3115945Z   |
2025-11-18T07:14:11.3116073Z help: Organize imports
2025-11-18T07:14:11.3116082Z 
2025-11-18T07:14:11.3116226Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3116379Z  --> tests/unit/test_text_processing.py:5:8
2025-11-18T07:14:11.3116474Z   |
2025-11-18T07:14:11.3116575Z 3 | """
2025-11-18T07:14:11.3116676Z 4 |
2025-11-18T07:14:11.3116802Z 5 | import pytest
2025-11-18T07:14:11.3116905Z   |        ^^^^^^
2025-11-18T07:14:11.3117240Z 6 |
2025-11-18T07:14:11.3117579Z 7 | from app.utils.text_processing import extract_keywords, cosine_similarity
2025-11-18T07:14:11.3117704Z   |
2025-11-18T07:14:11.3117860Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3118109Z 
2025-11-18T07:14:11.3118275Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3118469Z  --> tests/unit/test_token_budget_base.py:1:8
2025-11-18T07:14:11.3118571Z   |
2025-11-18T07:14:11.3118689Z 1 | import pytest
2025-11-18T07:14:11.3118801Z   |        ^^^^^^
2025-11-18T07:14:11.3119179Z 2 |
2025-11-18T07:14:11.3119532Z 3 | from app.services.context.token_optimizer import calculate_dynamic_budget
2025-11-18T07:14:11.3119637Z   |
2025-11-18T07:14:11.3119796Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3119809Z 
2025-11-18T07:14:11.3120000Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3120188Z   --> tests/unit/test_token_optimizer.py:5:1
2025-11-18T07:14:11.3120301Z    |
2025-11-18T07:14:11.3120414Z  3 |   """
2025-11-18T07:14:11.3120519Z  4 |
2025-11-18T07:14:11.3120650Z  5 | / import pytest
2025-11-18T07:14:11.3120764Z  6 | |
2025-11-18T07:14:11.3120992Z  7 | | from app.services.context.token_optimizer import (
2025-11-18T07:14:11.3121142Z  8 | |     format_metadata_compact,
2025-11-18T07:14:11.3121278Z  9 | |     summarize_media_compact,
2025-11-18T07:14:11.3121411Z 10 | |     estimate_tokens_accurate,
2025-11-18T07:14:11.3121541Z 11 | |     estimate_message_tokens,
2025-11-18T07:14:11.3121680Z 12 | |     deduplicate_messages,
2025-11-18T07:14:11.3121824Z 13 | |     calculate_dynamic_budget,
2025-11-18T07:14:11.3121956Z 14 | |     summarize_old_messages,
2025-11-18T07:14:11.3122089Z 15 | |     prune_low_relevance,
2025-11-18T07:14:11.3122237Z 16 | |     limit_consecutive_messages,
2025-11-18T07:14:11.3122343Z 17 | | )
2025-11-18T07:14:11.3122446Z    | |_^
2025-11-18T07:14:11.3122550Z    |
2025-11-18T07:14:11.3122674Z help: Organize imports
2025-11-18T07:14:11.3122684Z 
2025-11-18T07:14:11.3122825Z F401 [*] `pytest` imported but unused
2025-11-18T07:14:11.3122990Z  --> tests/unit/test_token_optimizer.py:5:8
2025-11-18T07:14:11.3123094Z   |
2025-11-18T07:14:11.3123190Z 3 | """
2025-11-18T07:14:11.3123288Z 4 |
2025-11-18T07:14:11.3123415Z 5 | import pytest
2025-11-18T07:14:11.3123519Z   |        ^^^^^^
2025-11-18T07:14:11.3123615Z 6 |
2025-11-18T07:14:11.3123831Z 7 | from app.services.context.token_optimizer import (
2025-11-18T07:14:11.3123938Z   |
2025-11-18T07:14:11.3124094Z help: Remove unused import: `pytest`
2025-11-18T07:14:11.3124110Z 
2025-11-18T07:14:11.3124286Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3124470Z  --> tests/unit/test_tool_call_filtering.py:7:1
2025-11-18T07:14:11.3124569Z   |
2025-11-18T07:14:11.3124674Z 5 | """
2025-11-18T07:14:11.3124779Z 6 |
2025-11-18T07:14:11.3124882Z 7 | import re
2025-11-18T07:14:11.3124984Z   | ^^^^^^^^^
2025-11-18T07:14:11.3125085Z   |
2025-11-18T07:14:11.3125213Z help: Organize imports
2025-11-18T07:14:11.3125222Z 
2025-11-18T07:14:11.3125400Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3125586Z   --> tests/unit/test_unanswered_trigger.py:12:1
2025-11-18T07:14:11.3125695Z    |
2025-11-18T07:14:11.3125802Z 10 |   """
2025-11-18T07:14:11.3125912Z 11 |
2025-11-18T07:14:11.3126034Z 12 | / import pytest
2025-11-18T07:14:11.3126155Z 13 | | import time
2025-11-18T07:14:11.3126424Z 14 | | from unittest.mock import Mock, AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3126530Z 15 | |
2025-11-18T07:14:11.3126689Z 16 | | from app.handlers.chat import (
2025-11-18T07:14:11.3126831Z 17 | |     _check_unanswered_trigger,
2025-11-18T07:14:11.3127214Z 18 | |     _check_and_handle_rate_limit,
2025-11-18T07:14:11.3127377Z 19 | |     UNANSWERED_TRIGGER_THRESHOLD_SECONDS,
2025-11-18T07:14:11.3127506Z 20 | |     MAX_SKIP_ATTEMPTS,
2025-11-18T07:14:11.3127637Z 21 | |     _build_user_message_query,
2025-11-18T07:14:11.3127757Z 22 | |     _get_skip_count,
2025-11-18T07:14:11.3127888Z 23 | |     _increment_skip_count,
2025-11-18T07:14:11.3128012Z 24 | |     _reset_skip_count,
2025-11-18T07:14:11.3128114Z 25 | | )
2025-11-18T07:14:11.3128417Z 26 | | from app.services.context_store import ContextStore, MessageSender
2025-11-18T07:14:11.3128836Z    | |__________________________________________________________________^
2025-11-18T07:14:11.3128938Z    |
2025-11-18T07:14:11.3129065Z help: Organize imports
2025-11-18T07:14:11.3129074Z 
2025-11-18T07:14:11.3129283Z F401 [*] `unittest.mock.MagicMock` imported but unused
2025-11-18T07:14:11.3129470Z   --> tests/unit/test_unanswered_trigger.py:14:44
2025-11-18T07:14:11.3129726Z    |
2025-11-18T07:14:11.3129850Z 12 | import pytest
2025-11-18T07:14:11.3129962Z 13 | import time
2025-11-18T07:14:11.3130226Z 14 | from unittest.mock import Mock, AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3130357Z    |                                            ^^^^^^^^^
2025-11-18T07:14:11.3130463Z 15 |
2025-11-18T07:14:11.3130607Z 16 | from app.handlers.chat import (
2025-11-18T07:14:11.3130707Z    |
2025-11-18T07:14:11.3130845Z help: Remove unused import
2025-11-18T07:14:11.3130855Z 
2025-11-18T07:14:11.3131038Z F401 [*] `unittest.mock.patch` imported but unused
2025-11-18T07:14:11.3131218Z   --> tests/unit/test_unanswered_trigger.py:14:55
2025-11-18T07:14:11.3131331Z    |
2025-11-18T07:14:11.3131445Z 12 | import pytest
2025-11-18T07:14:11.3131558Z 13 | import time
2025-11-18T07:14:11.3131812Z 14 | from unittest.mock import Mock, AsyncMock, MagicMock, patch
2025-11-18T07:14:11.3131956Z    |                                                       ^^^^^
2025-11-18T07:14:11.3132063Z 15 |
2025-11-18T07:14:11.3132212Z 16 | from app.handlers.chat import (
2025-11-18T07:14:11.3132314Z    |
2025-11-18T07:14:11.3132470Z help: Remove unused import
2025-11-18T07:14:11.3132480Z 
2025-11-18T07:14:11.3132796Z F401 [*] `app.handlers.chat._check_and_handle_rate_limit` imported but unused
2025-11-18T07:14:11.3132975Z   --> tests/unit/test_unanswered_trigger.py:18:5
2025-11-18T07:14:11.3133081Z    |
2025-11-18T07:14:11.3133224Z 16 | from app.handlers.chat import (
2025-11-18T07:14:11.3133359Z 17 |     _check_unanswered_trigger,
2025-11-18T07:14:11.3133501Z 18 |     _check_and_handle_rate_limit,
2025-11-18T07:14:11.3133614Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3133779Z 19 |     UNANSWERED_TRIGGER_THRESHOLD_SECONDS,
2025-11-18T07:14:11.3133919Z 20 |     MAX_SKIP_ATTEMPTS,
2025-11-18T07:14:11.3134021Z    |
2025-11-18T07:14:11.3134155Z help: Remove unused import
2025-11-18T07:14:11.3134165Z 
2025-11-18T07:14:11.3134461Z F401 [*] `app.handlers.chat._build_user_message_query` imported but unused
2025-11-18T07:14:11.3134652Z   --> tests/unit/test_unanswered_trigger.py:21:5
2025-11-18T07:14:11.3134754Z    |
2025-11-18T07:14:11.3134938Z 19 |     UNANSWERED_TRIGGER_THRESHOLD_SECONDS,
2025-11-18T07:14:11.3135072Z 20 |     MAX_SKIP_ATTEMPTS,
2025-11-18T07:14:11.3135206Z 21 |     _build_user_message_query,
2025-11-18T07:14:11.3135322Z    |     ^^^^^^^^^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3135446Z 22 |     _get_skip_count,
2025-11-18T07:14:11.3135572Z 23 |     _increment_skip_count,
2025-11-18T07:14:11.3135670Z    |
2025-11-18T07:14:11.3135799Z help: Remove unused import
2025-11-18T07:14:11.3135810Z 
2025-11-18T07:14:11.3136085Z F401 [*] `app.handlers.chat._reset_skip_count` imported but unused
2025-11-18T07:14:11.3136289Z   --> tests/unit/test_unanswered_trigger.py:24:5
2025-11-18T07:14:11.3136392Z    |
2025-11-18T07:14:11.3136527Z 22 |     _get_skip_count,
2025-11-18T07:14:11.3136662Z 23 |     _increment_skip_count,
2025-11-18T07:14:11.3136791Z 24 |     _reset_skip_count,
2025-11-18T07:14:11.3136918Z    |     ^^^^^^^^^^^^^^^^^
2025-11-18T07:14:11.3137284Z 25 | )
2025-11-18T07:14:11.3137613Z 26 | from app.services.context_store import ContextStore, MessageSender
2025-11-18T07:14:11.3137728Z    |
2025-11-18T07:14:11.3137880Z help: Remove unused import
2025-11-18T07:14:11.3137891Z 
2025-11-18T07:14:11.3138192Z F401 [*] `app.services.context_store.ContextStore` imported but unused
2025-11-18T07:14:11.3138372Z   --> tests/unit/test_unanswered_trigger.py:26:40
2025-11-18T07:14:11.3138465Z    |
2025-11-18T07:14:11.3138594Z 24 |     _reset_skip_count,
2025-11-18T07:14:11.3138695Z 25 | )
2025-11-18T07:14:11.3138996Z 26 | from app.services.context_store import ContextStore, MessageSender
2025-11-18T07:14:11.3139376Z    |                                        ^^^^^^^^^^^^
2025-11-18T07:14:11.3139481Z    |
2025-11-18T07:14:11.3139793Z help: Remove unused import: `app.services.context_store.ContextStore`
2025-11-18T07:14:11.3139804Z 
2025-11-18T07:14:11.3140069Z F841 Local variable `lock_key` is assigned to but never used
2025-11-18T07:14:11.3140486Z    --> tests/unit/test_unanswered_trigger.py:231:5
2025-11-18T07:14:11.3140599Z     |
2025-11-18T07:14:11.3140902Z 230 |     # Don't add bot response, but simulate processing is active
2025-11-18T07:14:11.3141055Z 231 |     lock_key = (chat_id, user_id)
2025-11-18T07:14:11.3141173Z     |     ^^^^^^^^
2025-11-18T07:14:11.3141534Z 232 |     processing_check = AsyncMock(return_value=True)  # Processing is active
2025-11-18T07:14:11.3141761Z 233 |     data = {"_processing_lock_check": processing_check}
2025-11-18T07:14:11.3141862Z     |
2025-11-18T07:14:11.3142073Z help: Remove assignment to unused variable `lock_key`
2025-11-18T07:14:11.3142095Z 
2025-11-18T07:14:11.3142286Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3142469Z    --> tests/unit/test_unanswered_trigger.py:297:5
2025-11-18T07:14:11.3142573Z     |
2025-11-18T07:14:11.3142887Z 295 |   async def test_check_and_handle_rate_limit_returns_response_message():
2025-11-18T07:14:11.3143178Z 296 |       """Test that rate limit check returns response message when sent."""
2025-11-18T07:14:11.3143446Z 297 | /     from app.handlers.chat import _check_and_handle_rate_limit
2025-11-18T07:14:11.3143648Z 298 | |     from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3143825Z 299 | |     from unittest.mock import AsyncMock
2025-11-18T07:14:11.3143958Z     | |_______________________________________^
2025-11-18T07:14:11.3144066Z 300 |
2025-11-18T07:14:11.3144201Z 301 |       message = Message(
2025-11-18T07:14:11.3144304Z     |
2025-11-18T07:14:11.3144437Z help: Organize imports
2025-11-18T07:14:11.3144448Z 
2025-11-18T07:14:11.3144773Z F811 [*] Redefinition of unused `_check_and_handle_rate_limit` from line 18
2025-11-18T07:14:11.3144965Z    --> tests/unit/test_unanswered_trigger.py:297:35
2025-11-18T07:14:11.3145071Z     |
2025-11-18T07:14:11.3145370Z 295 | async def test_check_and_handle_rate_limit_returns_response_message():
2025-11-18T07:14:11.3145669Z 296 |     """Test that rate limit check returns response message when sent."""
2025-11-18T07:14:11.3145935Z 297 |     from app.handlers.chat import _check_and_handle_rate_limit
2025-11-18T07:14:11.3146152Z     |                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `_check_and_handle_rate_limit` redefined here
2025-11-18T07:14:11.3146359Z 298 |     from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3146528Z 299 |     from unittest.mock import AsyncMock
2025-11-18T07:14:11.3146632Z     |
2025-11-18T07:14:11.3146869Z    ::: tests/unit/test_unanswered_trigger.py:18:5
2025-11-18T07:14:11.3147186Z     |
2025-11-18T07:14:11.3147350Z  16 | from app.handlers.chat import (
2025-11-18T07:14:11.3147502Z  17 |     _check_unanswered_trigger,
2025-11-18T07:14:11.3147658Z  18 |     _check_and_handle_rate_limit,
2025-11-18T07:14:11.3148002Z     |     ---------------------------- previous definition of `_check_and_handle_rate_limit` here
2025-11-18T07:14:11.3148167Z  19 |     UNANSWERED_TRIGGER_THRESHOLD_SECONDS,
2025-11-18T07:14:11.3148309Z  20 |     MAX_SKIP_ATTEMPTS,
2025-11-18T07:14:11.3148408Z     |
2025-11-18T07:14:11.3148622Z help: Remove definition: `_check_and_handle_rate_limit`
2025-11-18T07:14:11.3148632Z 
2025-11-18T07:14:11.3148817Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3148999Z    --> tests/unit/test_unanswered_trigger.py:342:5
2025-11-18T07:14:11.3149108Z     |
2025-11-18T07:14:11.3149426Z 340 |   async def test_check_and_handle_rate_limit_returns_none_when_not_sent():
2025-11-18T07:14:11.3149797Z 341 |       """Test that rate limit check returns None when error message not sent (cooldown)."""
2025-11-18T07:14:11.3150055Z 342 | /     from app.handlers.chat import _check_and_handle_rate_limit
2025-11-18T07:14:11.3150486Z 343 | |     from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3150645Z     | |_________________________________________________^
2025-11-18T07:14:11.3150748Z 344 |
2025-11-18T07:14:11.3150876Z 345 |       message = Message(
2025-11-18T07:14:11.3151148Z     |
2025-11-18T07:14:11.3151279Z help: Organize imports
2025-11-18T07:14:11.3151289Z 
2025-11-18T07:14:11.3151591Z F811 [*] Redefinition of unused `_check_and_handle_rate_limit` from line 18
2025-11-18T07:14:11.3151788Z    --> tests/unit/test_unanswered_trigger.py:342:35
2025-11-18T07:14:11.3151888Z     |
2025-11-18T07:14:11.3152204Z 340 | async def test_check_and_handle_rate_limit_returns_none_when_not_sent():
2025-11-18T07:14:11.3152570Z 341 |     """Test that rate limit check returns None when error message not sent (cooldown)."""
2025-11-18T07:14:11.3152911Z 342 |     from app.handlers.chat import _check_and_handle_rate_limit
2025-11-18T07:14:11.3153147Z     |                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `_check_and_handle_rate_limit` redefined here
2025-11-18T07:14:11.3153344Z 343 |     from aiogram.types import Message, User, Chat
2025-11-18T07:14:11.3153449Z     |
2025-11-18T07:14:11.3153645Z    ::: tests/unit/test_unanswered_trigger.py:18:5
2025-11-18T07:14:11.3153753Z     |
2025-11-18T07:14:11.3153907Z  16 | from app.handlers.chat import (
2025-11-18T07:14:11.3154050Z  17 |     _check_unanswered_trigger,
2025-11-18T07:14:11.3154196Z  18 |     _check_and_handle_rate_limit,
2025-11-18T07:14:11.3154536Z     |     ---------------------------- previous definition of `_check_and_handle_rate_limit` here
2025-11-18T07:14:11.3154711Z  19 |     UNANSWERED_TRIGGER_THRESHOLD_SECONDS,
2025-11-18T07:14:11.3154842Z  20 |     MAX_SKIP_ATTEMPTS,
2025-11-18T07:14:11.3154945Z     |
2025-11-18T07:14:11.3155162Z help: Remove definition: `_check_and_handle_rate_limit`
2025-11-18T07:14:11.3155171Z 
2025-11-18T07:14:11.3155425Z F841 Local variable `user_msg_ts` is assigned to but never used
2025-11-18T07:14:11.3155624Z    --> tests/unit/test_unanswered_trigger.py:404:9
2025-11-18T07:14:11.3155738Z     |
2025-11-18T07:14:11.3155967Z 402 |             "SELECT ts FROM messages WHERE id = $1", user_msg_id
2025-11-18T07:14:11.3156084Z 403 |         )
2025-11-18T07:14:11.3156350Z 404 |         user_msg_ts = user_row["ts"] if user_row else int(time.time())
2025-11-18T07:14:11.3156490Z     |         ^^^^^^^^^^^
2025-11-18T07:14:11.3156599Z 405 |
2025-11-18T07:14:11.3156916Z 406 |     # Add bot response with same timestamp (simulating race condition where
2025-11-18T07:14:11.3157240Z     |
2025-11-18T07:14:11.3157477Z help: Remove assignment to unused variable `user_msg_ts`
2025-11-18T07:14:11.3157490Z 
2025-11-18T07:14:11.3157646Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3157843Z    --> tests/unit/test_unanswered_trigger.py:550:1
2025-11-18T07:14:11.3157944Z     |
2025-11-18T07:14:11.3158162Z 548 |         # Should skip for first MAX_SKIP_ATTEMPTS attempts
2025-11-18T07:14:11.3158475Z 549 |         assert should_skip is True, f"Should skip on attempt {attempt + 1}"
2025-11-18T07:14:11.3158588Z 550 |     
2025-11-18T07:14:11.3158693Z     | ^^^^
2025-11-18T07:14:11.3159016Z 551 |     # The next call (after MAX_SKIP_ATTEMPTS skips) should allow due to override
2025-11-18T07:14:11.3159228Z 552 |     should_skip = await _check_unanswered_trigger(
2025-11-18T07:14:11.3159330Z     |
2025-11-18T07:14:11.3159486Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3159495Z 
2025-11-18T07:14:11.3159743Z F841 Local variable `lock_key` is assigned to but never used
2025-11-18T07:14:11.3159921Z    --> tests/unit/test_unanswered_trigger.py:716:5
2025-11-18T07:14:11.3160023Z     |
2025-11-18T07:14:11.3160176Z 715 |     # Simulate processing is active
2025-11-18T07:14:11.3160316Z 716 |     lock_key = (chat_id, user_id)
2025-11-18T07:14:11.3160421Z     |     ^^^^^^^^
2025-11-18T07:14:11.3160755Z 717 |     processing_check = AsyncMock(return_value=True)  # Processing is active
2025-11-18T07:14:11.3161202Z 718 |     data = {"_processing_lock_check": processing_check}
2025-11-18T07:14:11.3161304Z     |
2025-11-18T07:14:11.3161514Z help: Remove assignment to unused variable `lock_key`
2025-11-18T07:14:11.3161523Z 
2025-11-18T07:14:11.3161673Z W293 Blank line contains whitespace
2025-11-18T07:14:11.3162107Z    --> tests/unit/test_unanswered_trigger.py:737:1
2025-11-18T07:14:11.3162222Z     |
2025-11-18T07:14:11.3162653Z 735 | async def test_unanswered_trigger_allows_when_non_trigger_message_before(context_store):
2025-11-18T07:14:11.3163163Z 736 |     """Test that unanswered trigger check allows trigger messages even when non-trigger message came before.
2025-11-18T07:14:11.3163278Z 737 |     
2025-11-18T07:14:11.3163387Z     | ^^^^
2025-11-18T07:14:11.3163753Z 738 |     This is the bug fix: non-trigger messages (context-only messages) should not cause
2025-11-18T07:14:11.3164133Z 739 |     throttling of subsequent trigger messages. Only previous TRIGGER messages should
2025-11-18T07:14:11.3164250Z     |
2025-11-18T07:14:11.3164416Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3164427Z 
2025-11-18T07:14:11.3164561Z W291 [*] Trailing whitespace
2025-11-18T07:14:11.3164749Z    --> tests/unit/test_unanswered_trigger.py:792:6
2025-11-18T07:14:11.3164851Z     |
2025-11-18T07:14:11.3165185Z 790 |     # - The fix: We check if the last bot response came AFTER the last user message.
2025-11-18T07:14:11.3165526Z 791 |     #   If so, allow (previous was answered). Otherwise, check for unanswered trigger.
2025-11-18T07:14:11.3165633Z 792 |     # 
2025-11-18T07:14:11.3165746Z     |      ^
2025-11-18T07:14:11.3165874Z 793 |     # In this scenario:
2025-11-18T07:14:11.3166042Z 794 |     # - Last bot response: step 1 (id=1)
2025-11-18T07:14:11.3166148Z     |
2025-11-18T07:14:11.3166294Z help: Remove trailing whitespace
2025-11-18T07:14:11.3166303Z 
2025-11-18T07:14:11.3166431Z W291 [*] Trailing whitespace
2025-11-18T07:14:11.3166619Z    --> tests/unit/test_unanswered_trigger.py:801:6
2025-11-18T07:14:11.3166727Z     |
2025-11-18T07:14:11.3167334Z 799 |     # - However, my implementation should allow this because we can't distinguish
2025-11-18T07:14:11.3167648Z 800 |     #   trigger from non-trigger messages, so we err on the side of allowing.
2025-11-18T07:14:11.3167741Z 801 |     # 
2025-11-18T07:14:11.3167810Z     |      ^
2025-11-18T07:14:11.3168018Z 802 |     # Actually wait - I realize the fix needs a different approach. The issue is that
2025-11-18T07:14:11.3168213Z 803 |     # non-trigger messages come after bot responses too. We need to ensure that
2025-11-18T07:14:11.3168274Z     |
2025-11-18T07:14:11.3168359Z help: Remove trailing whitespace
2025-11-18T07:14:11.3168365Z 
2025-11-18T07:14:11.3168509Z F841 Local variable `should_skip` is assigned to but never used
2025-11-18T07:14:11.3168621Z    --> tests/unit/test_unanswered_trigger.py:825:5
2025-11-18T07:14:11.3168680Z     |
2025-11-18T07:14:11.3168826Z 823 |     # expected behavior once we figure out the right heuristic.
2025-11-18T07:14:11.3168898Z 824 |     data = {}
2025-11-18T07:14:11.3169013Z 825 |     should_skip = await _check_unanswered_trigger(
2025-11-18T07:14:11.3169077Z     |     ^^^^^^^^^^^
2025-11-18T07:14:11.3169152Z 826 |         chat_id=chat_id,
2025-11-18T07:14:11.3169227Z 827 |         thread_id=thread_id,
2025-11-18T07:14:11.3169288Z     |
2025-11-18T07:14:11.3169410Z help: Remove assignment to unused variable `should_skip`
2025-11-18T07:14:11.3169420Z 
2025-11-18T07:14:11.3169513Z W293 [*] Blank line contains whitespace
2025-11-18T07:14:11.3169612Z    --> tests/unit/test_unanswered_trigger.py:852:1
2025-11-18T07:14:11.3169668Z     |
2025-11-18T07:14:11.3169878Z 850 |     # TODO: Improve _check_unanswered_trigger to handle non-trigger messages correctly
2025-11-18T07:14:11.3170104Z 851 |     # This may require tracking trigger status in the database or using a different heuristic.
2025-11-18T07:14:11.3170164Z 852 |     
2025-11-18T07:14:11.3170227Z     | ^^^^
2025-11-18T07:14:11.3170441Z 853 |     # Current behavior: The function will return True (skip) due to the limitation above.
2025-11-18T07:14:11.3170782Z 854 |     # This is documented but not asserted to avoid false test failures.
2025-11-18T07:14:11.3170844Z     |
2025-11-18T07:14:11.3170931Z help: Remove whitespace from blank line
2025-11-18T07:14:11.3170937Z 
2025-11-18T07:14:11.3171144Z I001 [*] Import block is un-sorted or un-formatted
2025-11-18T07:14:11.3171260Z   --> tests/unit/test_video_sticker_context.py:11:1
2025-11-18T07:14:11.3171321Z    |
2025-11-18T07:14:11.3171380Z  9 |   """
2025-11-18T07:14:11.3171438Z 10 |
2025-11-18T07:14:11.3171512Z 11 | / import pytest
2025-11-18T07:14:11.3171607Z 12 | | from unittest.mock import MagicMock
2025-11-18T07:14:11.3171665Z 13 | |
2025-11-18T07:14:11.3171895Z 14 | | from app.services.conversation_formatter import describe_media, format_history_compact
2025-11-18T07:14:11.3172028Z    | |______________________________________________________________________________________^
2025-11-18T07:14:11.3172089Z    |
2025-11-18T07:14:11.3172162Z help: Organize imports
2025-11-18T07:14:11.3172168Z 
2025-11-18T07:14:11.3172291Z F401 [*] `unittest.mock.MagicMock` imported but unused
2025-11-18T07:14:11.3172406Z   --> tests/unit/test_video_sticker_context.py:12:27
2025-11-18T07:14:11.3172465Z    |
2025-11-18T07:14:11.3172534Z 11 | import pytest
2025-11-18T07:14:11.3172627Z 12 | from unittest.mock import MagicMock
2025-11-18T07:14:11.3172693Z    |                           ^^^^^^^^^
2025-11-18T07:14:11.3172751Z 13 |
2025-11-18T07:14:11.3172979Z 14 | from app.services.conversation_formatter import describe_media, format_history_compact
2025-11-18T07:14:11.3173037Z    |
2025-11-18T07:14:11.3173158Z help: Remove unused import: `unittest.mock.MagicMock`
2025-11-18T07:14:11.3173164Z 
2025-11-18T07:14:11.3173230Z Found 997 errors.
2025-11-18T07:14:11.3173496Z [*] 789 fixable with the `--fix` option (150 hidden fixes can be enabled with the `--unsafe-fixes` option).
2025-11-18T07:14:11.3182521Z ##[error]Process completed with exit code 2.
